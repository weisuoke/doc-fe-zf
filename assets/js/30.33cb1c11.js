(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{352:function(t,n,e){"use strict";e.r(n);var s=e(33),a=Object(s.a)({},(function(){var t=this,n=t.$createElement,e=t._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"_07-react-source"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_07-react-source"}},[t._v("#")]),t._v(" 07. React source")]),t._v(" "),e("h2",{attrs:{id:"_1-初始化项目"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-初始化项目"}},[t._v("#")]),t._v(" 1.初始化项目")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("create"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("react"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("app zhufeng_react5\ncd zhufeng_react5\ncnpm i jquery "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S")]),t._v("\nnpm start\n")])])]),e("h2",{attrs:{id:"_2-渲染文本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-渲染文本"}},[t._v("#")]),t._v(" 2. 渲染文本")]),t._v(" "),e("h3",{attrs:{id:"_2-1-渲染效果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-渲染效果"}},[t._v("#")]),t._v(" 2.1 渲染效果")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013824.png",alt:"initrenderhtml"}})]),t._v(" "),e("h3",{attrs:{id:"_2-2-实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-实现"}},[t._v("#")]),t._v(" 2.2 实现")]),t._v(" "),e("h4",{attrs:{id:"_2-2-1-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-index-js"}},[t._v("#")]),t._v(" 2.2.1 index.js")]),t._v(" "),e("p",[t._v("src\\index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h4",{attrs:{id:"_2-2-2-react-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-react-js"}},[t._v("#")]),t._v(" 2.2.2 react.js")]),t._v(" "),e("p",[t._v("src\\react.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" $ "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'jquery'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    rootIndex"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    render\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("container")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   container"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("innerHTML "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token template-string"}},[e("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('<span data-reactid="')]),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rootIndex"),e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('">')]),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("</span>")]),e("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h2",{attrs:{id:"_3-重构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-重构"}},[t._v("#")]),t._v(" 3. 重构")]),t._v(" "),e("h3",{attrs:{id:"_3-2-类图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-类图"}},[t._v("#")]),t._v(" 3.2 类图")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013831.png",alt:"2.rendertext"}})]),t._v(" "),e("h3",{attrs:{id:"_3-3-实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-实现"}},[t._v("#")]),t._v(" 3.3 实现")]),t._v(" "),e("h4",{attrs:{id:"_3-3-1-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-1-index-js"}},[t._v("#")]),t._v(" 3.3.1 index.js")]),t._v(" "),e("p",[t._v("src\\index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h4",{attrs:{id:"_3-3-2-react-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-2-react-index-js"}},[t._v("#")]),t._v(" 3.3.2 react\\index.js")]),t._v(" "),e("p",[t._v("src\\react\\index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" $ "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'jquery'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("createUnit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./unit'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    rootIndex"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    render\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("container")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" unit "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUnit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" markup "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" unit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMarkUp")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rootIndex"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("$")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("container"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("html")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("markup"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("$")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("trigger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mounted'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//componentDidMount")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h4",{attrs:{id:"_3-3-3-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-3-react-unit-js"}},[t._v("#")]),t._v(" 3.3.3 react\\unit.js")]),t._v(" "),e("p",[t._v("src\\react\\unit.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Unit")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("element")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_currentElement "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMarkUp")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'不能调用此方法'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TextUnit")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Unit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMarkUp")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("reactid")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n         "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_reactid "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" reactid"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//保存记录rootId")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//返回文本节点对应的HTML字符串")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token template-string"}},[e("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('<span data-reactid="')]),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("reactid"),e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('">')]),e("span",{pre:!0,attrs:{class:"token interpolation"}},[e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_currentElement"),e("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("</span>")]),e("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createUnit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("element")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typeof")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'number'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TextUnit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    createUnit\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"_4-渲染原生dom组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-渲染原生dom组件"}},[t._v("#")]),t._v(" 4. 渲染原生DOM组件")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"http://https//babeljs.io/repl/",target:"_blank",rel:"noopener noreferrer"}},[t._v("babeljs"),e("OutboundLink")],1)])]),t._v(" "),e("h3",{attrs:{id:"_4-1-渲染效果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-渲染效果"}},[t._v("#")]),t._v(" 4.1 渲染效果")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013836.png",alt:"renderdom"}})]),t._v(" "),e("h3",{attrs:{id:"_4-2-类图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-类图"}},[t._v("#")]),t._v(" 4.2 类图")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013842.png",alt:"20rendernativeunit"}})]),t._v(" "),e("h3",{attrs:{id:"_4-3-jsx语法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-jsx语法"}},[t._v("#")]),t._v(" 4.3 JSX语法")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013849.png",alt:"compile"}})]),t._v(" "),e("h4",{attrs:{id:"_4-3-1-jsx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1-jsx"}},[t._v("#")]),t._v(" 4.3.1 JSX")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("button id"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sayHello"')]),t._v(" onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("sayHello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("say"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("b style"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("color"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'red'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("Hello"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("b"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("button"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),e("h4",{attrs:{id:"_4-3-2-javascript"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2-javascript"}},[t._v("#")]),t._v(" 4.3.2 JavaScript")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"button"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    id"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sayHello"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" sayHello\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"say"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"b"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("style"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("color"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'red'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"_4-4-实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-实现"}},[t._v("#")]),t._v(" 4.4 实现")]),t._v(" "),e("h4",{attrs:{id:"_4-4-1-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-1-index-js"}},[t._v("#")]),t._v(" 4.4.1 index.js")]),t._v(" "),e("p",[t._v("src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sayHello")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'button'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("id"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'sayHello'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("sayHello"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'say'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'b'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("style"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("color"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'green'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h4",{attrs:{id:"_4-4-2-react-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-2-react-index-js"}},[t._v("#")]),t._v(" 4.4.2 react/index.js")]),t._v(" "),e("p",[t._v("src/react/index.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import $ from 'jquery';\nimport {createUnit} from './unit';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+import {createElement} from './element';\n")]),t._v("let React = {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    rootIndex:0,\n    render,\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+    createElement\n")]),t._v("}\nfunction render(element,container){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   let unit = createUnit(element);\n   let markup = unit.getMarkUp(React.rootIndex);\n   $(container).html(markup);\n   $(document).trigger('mounted');//componentDidMount\n")]),t._v("}\n\nexport default React;\n")])])]),e("h4",{attrs:{id:"_4-4-3-react-element-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-3-react-element-js"}},[t._v("#")]),t._v(" 4.4.3 react/element.js")]),t._v(" "),e("p",[t._v("src/react/element.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Element")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("type"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" type"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("props "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("type"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("children")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    props"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("children  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" children"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Element")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    createElement\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h4",{attrs:{id:"_4-4-4-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-4-react-unit-js"}},[t._v("#")]),t._v(" 4.4.4 react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+import {Element} from './element';\n+import $ from 'jquery';\n")]),t._v("class Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n')]),t._v("}\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+class NativeUnit extends Unit {\n+     getMarkUp(reactid){\n+         this._reactid = reactid;//保存记录reactid\n+        //返回文本节点对应的HTML字符串\n+        let {type,props} = this._currentElement;\n+        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n+        let tagClose = `</$type>`;\n+        let content = '';\n+        for(let propName in props){\n+            if(/^on[A-Z]/.test(propName)){\n+                let eventName = propName.slice(2).toLowerCase();\n+                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n+            }else if(propName === 'style'){\n+                let styleObj = props[propName];\n+                let styles = Object.keys(styleObj).map(attr=>`${attr}:${styleObj[attr]}`).join(';');\n+                tagOpen += (` style=\"${styles}\" `);\n+            }else if (propName === 'children'){\n+                let children = props.children||[];\n+                children.map((child,index)=>{\n+                    let childUnit = createUnit(child);\n+                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n+                    content += childMarkUp;\n+                });\n+            }else{\n+                tagOpen += ` ${propName}=${props[propName]} `;\n+            }\n+        }\n+        return tagOpen + '>' + content + tagClose;\n+    }\n+}\n")]),t._v("function createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+  if(element instanceof Element && typeof element.type === 'string'){\n+      return new NativeUnit(element);\n+  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_5-渲染自定义组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-渲染自定义组件"}},[t._v("#")]),t._v(" 5. 渲染自定义组件")]),t._v(" "),e("h3",{attrs:{id:"_5-1-渲染效果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-渲染效果"}},[t._v("#")]),t._v(" 5.1 渲染效果")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://img.zhufengpeixun.cn/5.customercomponent.png",alt:"customercomponent"}})]),t._v(" "),e("h3",{attrs:{id:"_5-2-类图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-类图"}},[t._v("#")]),t._v(" 5.2 类图")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013859.png",alt:"20rendercustomerunit"}})]),t._v(" "),e("h3",{attrs:{id:"_5-3-实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-实现"}},[t._v("#")]),t._v(" 5.3 实现")]),t._v(" "),e("h4",{attrs:{id:"_5-3-1-src-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-1-src-index-js"}},[t._v("#")]),t._v(" 5.3.1 src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Counter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentWillMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Counter componentWillMount'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Counter componentDidMount'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("handleClick")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" p "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'p'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("style"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("color"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'red'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" button "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'button'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handleClick"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'+'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'div'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("id"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'counter'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("button"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Counter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h4",{attrs:{id:"_5-3-2-react-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-2-react-index-js"}},[t._v("#")]),t._v(" 5.3.2 react/index.js")]),t._v(" "),e("p",[t._v("src/react/index.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import $ from 'jquery';\nimport {createUnit} from './unit';\nimport {createElement} from './element';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+import {Component} from './component';\n")]),t._v("let React = {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    rootIndex:0,\n    render,\n    createElement,\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+    Component\n")]),t._v("}\nfunction render(element,container){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   let unit = createUnit(element);\n   let markup = unit.getMarkUp(React.rootIndex);\n   $(container).html(markup);\n   $(document).trigger('mounted');//componentDidMount\n")]),t._v("}\n\nexport default React;\n")])])]),e("h4",{attrs:{id:"_5-3-3-react-component-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-3-react-component-js"}},[t._v("#")]),t._v(" 5.3.3 react/component.js")]),t._v(" "),e("p",[t._v("src/react/component.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("props "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Component"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h4",{attrs:{id:"_5-3-4-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-4-react-unit-js"}},[t._v("#")]),t._v(" 5.3.4 react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\nclass Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n')]),t._v("}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n                let styleObj = props[propName];\n                let styles = Object.keys(styleObj).map(attr=>`${attr}:${styleObj[attr]}`).join(';');\n                tagOpen += (` style=\"${styles}\" `);\n            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n        return tagOpen + '>' + content + tagClose;\n    }\n")]),t._v("}\n\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+class CompositeUnit extends Unit{\n+    getMarkUp(reactid){\n+        this._reactid = reactid;\n+        //type是一个自定义组件的类的定义\n+        let {type:Component,props} = this._currentElement;\n+        //创建Component类的实例\n+        let componentInstance = new Component(props);\n+        //组件将要渲染\n+        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n+        //执行render方法获得虚拟DOM元素实例\n+        let renderedElement = componentInstance.render();\n+        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n+        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n+        //获得此unit的HTML标记字符串\n+        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n+        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n+        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n+        return renderedMarkUp;\n+    }\n+}\n")]),t._v("\nfunction createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+  if(element instanceof Element && typeof element.type === 'function'){\n+      return new CompositeUnit(element);\n+  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_6-实现setstate"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-实现setstate"}},[t._v("#")]),t._v(" 6. 实现setState")]),t._v(" "),e("h3",{attrs:{id:"_6-1-src-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-src-index-js"}},[t._v("#")]),t._v(" 6.1 src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Counter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentWillMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Counter componentWillMount'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setInterval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n       "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n     "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Counter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"_6-2-react-component-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-react-component-js"}},[t._v("#")]),t._v(" 6.2 react/component.js")]),t._v(" "),e("p",[t._v("src/react/component.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("props "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("partialState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("_currentUnit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("update")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("partialState"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Component"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h3",{attrs:{id:"_6-3-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-react-unit-js"}},[t._v("#")]),t._v(" 6.3 react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\nclass Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n')]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v('+    update(nextElement){\n+        if(this._currentElement != nextElement){\n+            this._currentElement = nextElement;\n+            $(`[data-reactid="${this._reactid}"]`).html(this._currentElement);\n+        }\n+    }\n')]),t._v("}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n                let styleObj = props[propName];\n                let styles = Object.keys(styleObj).map(attr=>`${attr}:${styleObj[attr]}`).join(';');\n                tagOpen += (` style=\"${styles}\" `);\n            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n        return tagOpen + '>' + content + tagClose;\n    }\n")]),t._v("}\n\nclass CompositeUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v('+    update(nextElement,partialState){\n+        //如果传过来了新的元素，则使用新的元素\n+        this._currentElement = nextElement||this._currentElement;\n+        //获取新的状态对象和属性对象\n+        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);\n+        let nextProps = this._currentElement.props;\n+        //如果shouldComponentUpdate返回了false则不需要继续更新\n+        if(this._componentInstance.shouldComponentUpdate&&this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}\n+        //获得上次渲染出来的unit实例 \n+        let prevRenderedUnitInstance = this._renderedUnitInstance;\n+        //从unit实例中获取\n+        let prevRenderedElement = prevRenderedUnitInstance._currentElement;\n+        //获取新的虚拟DOM\n+        let nextRenderElement = this._componentInstance.render();\n+        //进行domdiff对比\n+        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){\n+            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点\n+            prevRenderedUnitInstance.update(nextRenderElement);\n+            this._componentInstance.componentDidUpdate&&this._componentInstance.componentDidUpdate();\n+        }else{\n+            //如果发现不需要对比，干脆重新渲染\n+            this._renderedUnitInstance =  createUnit(nextRenderElement);\n+            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);\n+            //替换整个节点\n+            $(`[data-reactid="${this._reactid}"]`).replaceWith(nextMarkUp);\n+        }\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n    getMarkUp(reactid){\n        this._reactid = reactid;\n        //type是一个自定义组件的类的定义\n        let {type:Component,props} = this._currentElement;\n        //创建Component类的实例\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+        let componentInstance = this._componentInstance = new Component(props);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("        //组件实例关联上自己的unit实例\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+        componentInstance._currentUnit  = this;\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("        //组件将要渲染\n        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n        //执行render方法获得虚拟DOM元素实例\n        let renderedElement = componentInstance.render();\n        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n        //获得此unit的HTML标记字符串\n        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n        return renderedMarkUp;\n    }\n")]),t._v("}\n\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+function shouldDeepCompare(prevElement,nextElement){\n+   if(prevElement!==null && nextElement!=null){\n+       let prevType = typeof prevElement;\n+       let nextType = typeof nextElement;\n+       //如果新老节点都是文本可以进行比较\n+       if((prevType === 'string' ||prevType === 'number')&&(nextType === 'string' ||nextType === 'number')){\n+           return true;\n+       }\n+       if(prevElement instanceof Element && nextElement instanceof Element){\n+           return prevElement.type === nextElement.type;\n+       }\n+   }  \n+   return false;\n+}\n")]),t._v("function createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'function'){\n      return new CompositeUnit(element);\n  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h3",{attrs:{id:"_6-4-react-element-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-react-element-js"}},[t._v("#")]),t._v(" 6.4 react/element.js")]),t._v(" "),e("p",[t._v("src/react/element.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("class Element{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(type,props){\n        this.type = type;\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+       this.key = props.key;\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("        this.props = props;\n    }\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_7-对比属性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-对比属性"}},[t._v("#")]),t._v(" 7. 对比属性")]),t._v(" "),e("ul",[e("li",[t._v("实现点击加1功能")])]),t._v(" "),e("h3",{attrs:{id:"_7-1-src-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-src-index-js"}},[t._v("#")]),t._v(" 7.1 src/index.js")]),t._v(" "),e("p",[t._v("src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Counter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentWillMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Counter componentWillMount'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n     console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Counter componentDidMount'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("handleClick")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" p "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'p'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" button "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'button'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("handleClick"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'+'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'div'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("id"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'counter'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("style"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("color"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'red'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'green'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("backgroundColor"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("number"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("%")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'green'")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'red'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("p"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("button"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Counter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"_7-2-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-react-unit-js"}},[t._v("#")]),t._v(" 7.2 react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\nclass Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n    update(nextElement){\n        if(this._currentElement != nextElement){\n            this._currentElement = nextElement;\n            $(`[data-reactid="${this._reactid}"]`).html(this._currentElement);\n        }\n    }\n')]),t._v("\n}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+                let styleObj = props[propName];\n+                let styles = Object.keys(styleObj).map(attr=>{\n+                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){\n+                        return `-${group.toLowerCase()}`;\n+                    })\n+                    return `${attrName}:${styleObj[attr]}`;\n+                }).join(';');\n+                tagOpen += (` style=\"${styles}\" `);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n        return tagOpen + '>' + content + tagClose;\n    }\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v('+    update(nextElement){\n+        let oldProps = this._currentElement.props;\n+        let newProps = nextElement.props;\n+        this.updateDOMproperties(oldProps,newProps);\n+        //this.updateDOMChildren(nextElement.props.children);\n+    }\n+    updateDOMproperties(oldProps,newProps){\n+        let propName;\n+        //把新属性对象上没有属性给删除掉\n+        for(propName in oldProps){\n+            if(!newProps.hasOwnProperty(propName)){\n+                $(`[data-reactid="${this._reactid}"]`).removeAttr(propName);\n+            }\n+            if(/^on[A-Z]/.test(propName)){\n+                $(document).undelegate(`.${this.reactid}`);\n+            }\n+        }\n+        for(propName in newProps){\n+            if(propName == \'children\'){\n+                \n+            }else if(/^on[A-Z]/.test(propName)){\n+                let eventName = propName.slice(2).toLowerCase();\n+                $(document).delegate(`[data-reactid="${this._reactid}"]`,`${eventName}.${this._reactid}`,newProps[propName]);\n+            }else if(propName === \'style\'){\n+                let styleObj = newProps[propName];\n+                Object.entries(styleObj).forEach(([attr,value])=>{\n+                  $(`[data-reactid="${this._reactid}"]`).css(attr,value);\n+                })\n+            }else{\n+                $(`[data-reactid="${this._reactid}"]`).prop(propName,newProps[propName]);\n+            }\n+        }\n+    }\n+}\n')]),t._v("\nclass CompositeUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数\n    update(nextElement,partialState){\n        //如果传过来了新的元素，则使用新的元素\n        this._currentElement = nextElement||this._currentElement;\n        //获取新的状态对象和属性对象\n        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);\n        let nextProps = this._currentElement.props;\n        //如果shouldComponentUpdate返回了false则不需要继续更新\n        if(this._componentInstance.shouldComponentUpdate&&this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}\n        //获得上次渲染出来的unit实例 \n        let prevRenderedUnitInstance = this._renderedUnitInstance;\n        //从unit实例中获取\n        let prevRenderedElement = prevRenderedUnitInstance._currentElement;\n        //获取新的虚拟DOM\n        let nextRenderElement = this._componentInstance.render();\n        //进行domdiff对比\n        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){\n            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点\n            prevRenderedUnitInstance.update(nextRenderElement);\n            this._componentInstance.componentDidUpdate&&this._componentInstance.componentDidUpdate();\n        }else{\n            //如果发现不需要对比，干脆重新渲染\n            this._renderedUnitInstance =  createUnit(nextRenderElement);\n            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);\n            //替换整个节点\n            $(`[data-reactid="${this._reactid}"]`).replaceWith(nextMarkUp);\n        }\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n    getMarkUp(reactid){\n        this._reactid = reactid;\n        //type是一个自定义组件的类的定义\n        let {type:Component,props} = this._currentElement;\n        //创建Component类的实例\n        let componentInstance = this._componentInstance = new Component(props);\n        //组件实例关联上自己的unit实例\n        componentInstance._currentUnit  = this;\n        //组件将要渲染\n        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n        //执行render方法获得虚拟DOM元素实例\n        let renderedElement = componentInstance.render();\n        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n        //获得此unit的HTML标记字符串\n        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n        return renderedMarkUp;\n    }\n")]),t._v("}\n\nfunction shouldDeepCompare(prevElement,nextElement){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   if(prevElement!==null && nextElement!=null){\n       let prevType = typeof prevElement;\n       let nextType = typeof nextElement;\n       //如果新老节点都是文本可以进行比较\n       if((prevType === 'string' ||prevType === 'number')&&(nextType === 'string' ||nextType === 'number')){\n           return true;\n       }\n       if(prevElement instanceof Element && nextElement instanceof Element){\n           return prevElement.type === nextElement.type;\n       }\n   }  \n   return false;\n")]),t._v("}\nfunction createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'function'){\n      return new CompositeUnit(element);\n  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_8-对比子元素"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-对比子元素"}},[t._v("#")]),t._v(" 8. 对比子元素")]),t._v(" "),e("h3",{attrs:{id:"_8-1-src-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-src-unit-js"}},[t._v("#")]),t._v(" 8.1 src/unit.js")]),t._v(" "),e("p",[t._v("src\\unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+ let diffQueue = [];\n")]),t._v("class Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n    update(nextElement){\n        if(this._currentElement != nextElement){\n            this._currentElement = nextElement;\n            $(`[data-reactid="${this._reactid}"]`).html(this._currentElement);\n        }\n    }\n')]),t._v("\n}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+        let renderedChildUnits=[];\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n                let styleObj = props[propName];\n                let styles = Object.keys(styleObj).map(attr=>{\n                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){\n                        return `-${group.toLowerCase()}`;\n                    })\n                    return `${attrName}:${styleObj[attr]}`;\n                }).join(';');\n                tagOpen += (` style=\"${styles}\" `);\n            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+                    renderedChildUnits.push(childUnit);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+        this._renderedChildUnits = renderedChildUnits;\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("        return tagOpen + '>' + content + tagClose;\n    }\n    update(nextElement){\n        let oldProps = this._currentElement.props;\n        let newProps = nextElement.props;\n        this.updateDOMproperties(oldProps,newProps);\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+        this.updateDOMChildren(nextElement.props.children);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+    //对比子元素\n+    updateDOMChildren(newChildrenElements){\n+        this.diff(diffQueue,newChildrenElements);\n+    }\n+    diff(diffQueue,newChildrenElements){\n+        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);\n+        let newChildren = this.getNewChildren(oldChildUnitsMap,newChildrenElements);\n+    }\n+    getNewChildren(oldChildUnitsMap,newChildrenElements){\n+        let newChildren = [];\n+        newChildrenElements.forEach((newElement,index)=>{\n+            let newKey = newElement.key||index.toString();\n+            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit\n+            let oldElement = oldUnit&&oldUnit._currentElement;//获得老的element\n+            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较\n+                oldUnit.update(newElement);\n+                newChildren.push(oldUnit);\n+            }else{\n+                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit\n+                newChildren.push(newChildUnit);\n+            }\n+        });\n+        return newChildren;\n+    }\n+    getChildrenMap(childUnits=[]){\n+        let map = {};\n+        for(let i=0;i<childUnits.length;i++){\n+            let key = childUnits[i].key||i.toString();\n+            map[key]=childUnits[i];\n+        }\n+        return map;\n+    }\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    updateDOMproperties(oldProps,newProps){\n        let propName;\n        //把新属性对象上没有属性给删除掉\n        for(propName in oldProps){\n            if(!newProps.hasOwnProperty(propName)){\n                $(`[data-reactid=\"${this._reactid}\"]`).removeAttr(propName);\n            }\n            if(/^on[A-Z]/.test(propName)){\n                $(document).undelegate(`.${this._reactid}`);\n            }\n        }\n        for(propName in newProps){\n            if(propName == 'children'){\n")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('            }else if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).undelegate(`.${this._reactid}`);\n                $(document).delegate(`[data-reactid="${this._reactid}"]`,`${eventName}.${this._reactid}`,newProps[propName]);\n            }else if(propName === \'style\'){\n                let styleObj = newProps[propName];\n                Object.entries(styleObj).forEach(([attr,value])=>{\n                  $(`[data-reactid="${this._reactid}"]`).css(attr,value);\n                })\n            }else{\n                $(`[data-reactid="${this._reactid}"]`).prop(propName,newProps[propName]);\n            }\n        }\n    }\n')]),t._v("}\n\nclass CompositeUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数\n    update(nextElement,partialState){\n        //如果传过来了新的元素，则使用新的元素\n        this._currentElement = nextElement||this._currentElement;\n        //获取新的状态对象和属性对象\n        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);\n        let nextProps = this._currentElement.props;\n        //如果shouldComponentUpdate返回了false则不需要继续更新\n        if(this._componentInstance.shouldComponentUpdate&&this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}\n        //获得上次渲染出来的unit实例 \n        let prevRenderedUnitInstance = this._renderedUnitInstance;\n        //从unit实例中获取\n        let prevRenderedElement = prevRenderedUnitInstance._currentElement;\n        //获取新的虚拟DOM\n        let nextRenderElement = this._componentInstance.render();\n        //进行domdiff对比\n        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){\n            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点\n            prevRenderedUnitInstance.update(nextRenderElement);\n            this._componentInstance.componentDidUpdate&&this._componentInstance.componentDidUpdate();\n        }else{\n            //如果发现不需要对比，干脆重新渲染\n            this._renderedUnitInstance =  createUnit(nextRenderElement);\n            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);\n            //替换整个节点\n            $(`[data-reactid="${this._reactid}"]`).replaceWith(nextMarkUp);\n        }\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n    getMarkUp(reactid){\n        this._reactid = reactid;\n        //type是一个自定义组件的类的定义\n        let {type:Component,props} = this._currentElement;\n        //创建Component类的实例\n        let componentInstance = this._componentInstance = new Component(props);\n        //组件实例关联上自己的unit实例\n        componentInstance._currentUnit  = this;\n        //组件将要渲染\n        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n        //执行render方法获得虚拟DOM元素实例\n        let renderedElement = componentInstance.render();\n        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n        //获得此unit的HTML标记字符串\n        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n        return renderedMarkUp;\n    }\n")]),t._v("}\n\nfunction shouldDeepCompare(prevElement,nextElement){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   if(prevElement!==null && nextElement!=null){\n       let prevType = typeof prevElement;\n       let nextType = typeof nextElement;\n       //如果新老节点都是文本可以进行比较\n       if((prevType === 'string' ||prevType === 'number')&&(nextType === 'string' ||nextType === 'number')){\n           return true;\n       }\n       if(prevElement instanceof Element && nextElement instanceof Element){\n           return prevElement.type === nextElement.type;\n       }\n   }  \n   return false;\n")]),t._v("}\nfunction createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'function'){\n      return new CompositeUnit(element);\n  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_9-获得补丁数组"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-获得补丁数组"}},[t._v("#")]),t._v(" 9. 获得补丁数组")]),t._v(" "),e("p",[e("img",{attrs:{src:"http://img.zhufengpeixun.cn/diffold.png",alt:"diffold"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"http://img.zhufengpeixun.cn/diffnew.png",alt:"diffnew"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"http://img.zhufengpeixun.cn/domdiff2.gif",alt:"domdiff2"}})]),t._v(" "),e("h3",{attrs:{id:"_9-1-src-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-src-index-js"}},[t._v("#")]),t._v(" 9.1 src/index.js")]),t._v(" "),e("p",[t._v("src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Counter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ul'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'wrapper'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'D'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'D'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ul'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'wrapper'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'E'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'E1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'F'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'F1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Counter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"_9-2-src-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-src-react-unit-js"}},[t._v("#")]),t._v(" 9.2 src/react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+import types from './types';\n+let diffQueue = [];\n+let updateDepth=0;\n")]),t._v("class Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n    update(nextElement){\n        if(this._currentElement != nextElement){\n            this._currentElement = nextElement;\n            $(`[data-reactid="${this._reactid}"]`).html(this._currentElement);\n        }\n    }\n')]),t._v("\n}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n        let renderedChildUnits=[];\n        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n                let styleObj = props[propName];\n                let styles = Object.keys(styleObj).map(attr=>{\n                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){\n                        return `-${group.toLowerCase()}`;\n                    })\n                    return `${attrName}:${styleObj[attr]}`;\n                }).join(';');\n                tagOpen += (` style=\"${styles}\" `);\n            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n                    childUnit._mountIndex = index;\n                    renderedChildUnits.push(childUnit);\n                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n        this._renderedChildUnits = renderedChildUnits;\n        return tagOpen + '>' + content + tagClose;\n    }\n    update(nextElement){\n        let oldProps = this._currentElement.props;\n        let newProps = nextElement.props;\n        this.updateDOMproperties(oldProps,newProps);\n        this.updateDOMChildren(nextElement.props.children);\n    }\n    //对比子元素\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v('+    updateDOMChildren(newChildrenElements){\n+        updateDepth++;\n+        this.diff(diffQueue,newChildrenElements);\n+        updateDepth--;\n+        if(updateDepth===0){\n+            console.log(\'diffQueue\',diffQueue);\n+            diffQueue=[];\n+        }\n+    }\n+    diff(diffQueue,newChildrenElements){\n+        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);\n+        let {newChildrenMap,newChildren} = this.getNewChildren(oldChildUnitsMap,newChildrenElements);\n+        // lastIndex里存放着被复用的子元素的最大索引\n+        let lastIndex = 0;\n+        for(let i=0;i<newChildren.length;i++){\n+            let newChild = newChildren[i];//取得新元素\n+            let newKey = (newChild._currentElement.props&&newChild._currentElement.key)||i.toString();//取得新key\n+            let oldChild = oldChildUnitsMap[newKey];\n+            if(oldChild === newChild){\n+                if(oldChild._mountIndex < lastIndex){\n+                    diffQueue.push({\n+                        parentId:this._reactid,\n+                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n+                        type:types.MOVE,\n+                        fromIndex:oldChild._mountIndex,\n+                        toIndex:i\n+                    });\n+                }\n+                lastIndex = Math.max(oldChild._mountIndex,lastIndex);\n+                //否则根本不用移动，直接修改挂载索引为新索引i即可\n+            }else{\n+                if(oldChild){\n+                    diffQueue.push({\n+                        parentId:this._reactid,\n+                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n+                        type:types.REMOVE,\n+                        fromIndex:oldChild._mountIndex\n+                    });\n+                    $(document).undelegate(`.${oldChild._reactid}`);\n+                }\n+                 diffQueue.push({\n+                        parentId:this._reactid,\n+                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n+                        type:types.INSERT,\n+                        toIndex:i,\n+                        markUp:newChild.getMarkUp(`${this._reactid}.${i}`)\n+                });\n+            }\n+            newChild._mountIndex = i;\n+        }\n+        for(let oldKey in oldChildUnitsMap){\n+            if(!newChildrenMap.hasOwnProperty(oldKey)){\n+                let oldChild = oldChildUnitsMap[oldKey];\n+                diffQueue.push({\n+                        parentId:this._reactid,\n+                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n+                        type:types.REMOVE,\n+                        fromIndex:oldChild._mountIndex\n+                });\n+            }\n+        }\n+    }\n+    getNewChildren(oldChildUnitsMap,newChildrenElements){\n+        let newChildren = [];\n+        let newChildrenMap={};\n+        newChildrenElements.forEach((newElement,index)=>{\n+            let newKey = newElement.key||index.toString();\n+            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit\n+            let oldElement = oldUnit&&oldUnit._currentElement;//获得老的element\n+            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较\n+                oldUnit.update(newElement);\n+                newChildren.push(oldUnit);\n+                newChildrenMap[newKey]=oldUnit;\n+            }else{\n+                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit\n+                newChildren.push(newChildUnit);\n+                 newChildrenMap[newKey]=newChildUnit;\n+            }\n+        });\n+        return {newChildrenMap,newChildren};\n+    }\n+    getChildrenMap(childUnits=[]){\n+        let map = {};\n+        for(let i=0;i<childUnits.length;i++){\n+            let key = (childUnits[i]._currentElement.props&&childUnits[i]._currentElement.props.key)||i.toString();\n+            map[key]=childUnits[i];\n+        }\n+        return map;\n+    }\n+    updateDOMproperties(oldProps,newProps){\n+        let propName;\n+        //把新属性对象上没有属性给删除掉\n+        for(propName in oldProps){\n+            if(!newProps.hasOwnProperty(propName)){\n+                $(`[data-reactid="${this._reactid}"]`).removeAttr(propName);\n+            }\n+            if(/^on[A-Z]/.test(propName)){\n+                $(document).undelegate(`.${this._reactid}`);\n+            }\n+        }\n+        for(propName in newProps){\n+            if(propName == \'children\'){\n+                \n+            }else if(/^on[A-Z]/.test(propName)){\n+                let eventName = propName.slice(2).toLowerCase();\n+                $(document).undelegate(`.${this._reactid}`);\n+                $(document).delegate(`[data-reactid="${this._reactid}"]`,`${eventName}.${this._reactid}`,newProps[propName]);\n+            }else if(propName === \'style\'){\n+                let styleObj = newProps[propName];\n+                Object.entries(styleObj).forEach(([attr,value])=>{\n+                  $(`[data-reactid="${this._reactid}"]`).css(attr,value);\n+                })\n+            }else{\n+                $(`[data-reactid="${this._reactid}"]`).prop(propName,newProps[propName]);\n+            }\n+        }\n+    }\n+}\n')]),t._v("\nclass CompositeUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数\n    update(nextElement,partialState){\n        //如果传过来了新的元素，则使用新的元素\n        this._currentElement = nextElement||this._currentElement;\n        //获取新的状态对象和属性对象\n        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);\n        let nextProps = this._currentElement.props;\n        //如果shouldComponentUpdate返回了false则不需要继续更新\n        if(this._componentInstance.shouldComponentUpdate&&this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}\n        //获得上次渲染出来的unit实例 \n        let prevRenderedUnitInstance = this._renderedUnitInstance;\n        //从unit实例中获取\n        let prevRenderedElement = prevRenderedUnitInstance._currentElement;\n        //获取新的虚拟DOM\n        let nextRenderElement = this._componentInstance.render();\n        //进行domdiff对比\n        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){\n            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点\n            prevRenderedUnitInstance.update(nextRenderElement);\n            this._componentInstance.componentDidUpdate&&this._componentInstance.componentDidUpdate();\n        }else{\n            //如果发现不需要对比，干脆重新渲染\n            this._renderedUnitInstance =  createUnit(nextRenderElement);\n            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);\n            //替换整个节点\n            $(`[data-reactid="${this._reactid}"]`).replaceWith(nextMarkUp);\n        }\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n    getMarkUp(reactid){\n        this._reactid = reactid;\n        //type是一个自定义组件的类的定义\n        let {type:Component,props} = this._currentElement;\n        //创建Component类的实例\n        let componentInstance = this._componentInstance = new Component(props);\n        //组件实例关联上自己的unit实例\n        componentInstance._currentUnit  = this;\n        //组件将要渲染\n        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n        //执行render方法获得虚拟DOM元素实例\n        let renderedElement = componentInstance.render();\n        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n        //获得此unit的HTML标记字符串\n        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n        return renderedMarkUp;\n    }\n")]),t._v("}\n\nfunction shouldDeepCompare(prevElement,nextElement){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   if(prevElement!==null && nextElement!=null){\n       let prevType = typeof prevElement;\n       let nextType = typeof nextElement;\n       //如果新老节点都是文本可以进行比较\n       if((prevType === 'string' ||prevType === 'number')&&(nextType === 'string' ||nextType === 'number')){\n           return true;\n       }\n       if(prevElement instanceof Element && nextElement instanceof Element){\n           return prevElement.type === nextElement.type;\n       }\n   }  \n   return false;\n")]),t._v("}\nfunction createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'function'){\n      return new CompositeUnit(element);\n  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h3",{attrs:{id:"_9-3-types-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-3-types-js"}},[t._v("#")]),t._v(" 9.3 types.js")]),t._v(" "),e("p",[t._v("src\\types.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default")]),t._v("  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MOVE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'MOVE'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("INSERT")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"INSERT"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token constant"}},[t._v("REMOVE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"REMOVE"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h2",{attrs:{id:"_10-打补丁"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-打补丁"}},[t._v("#")]),t._v(" 10. 打补丁")]),t._v(" "),e("h3",{attrs:{id:"_10-1-src-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-src-index-js"}},[t._v("#")]),t._v(" 10.1 src/index.js")]),t._v(" "),e("p",[t._v("src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Counter")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("componentDidMount")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("odd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ul'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'wrapper'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'D'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'D'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'ul'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'wrapper'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'C1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'E'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'E1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'li'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'F'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'F1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" element "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Counter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("element"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"_10-2-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-react-unit-js"}},[t._v("#")]),t._v(" 10.2 react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\nimport types from './types';\nlet diffQueue = [];\nlet updateDepth=0;\nclass Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n    update(nextElement){\n        if(this._currentElement != nextElement){\n            this._currentElement = nextElement;\n            $(`[data-reactid="${this._reactid}"]`).html(this._currentElement);\n        }\n    }\n')]),t._v("\n}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n        let renderedChildUnits=[];\n        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n                let styleObj = props[propName];\n                let styles = Object.keys(styleObj).map(attr=>{\n                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){\n                        return `-${group.toLowerCase()}`;\n                    })\n                    return `${attrName}:${styleObj[attr]}`;\n                }).join(';');\n                tagOpen += (` style=\"${styles}\" `);\n            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n                    childUnit._mountIndex = index;\n                    renderedChildUnits.push(childUnit);\n                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n        this._renderedChildUnits = renderedChildUnits;\n        return tagOpen + '>' + content + tagClose;\n    }\n    update(nextElement){\n        let oldProps = this._currentElement.props;\n        let newProps = nextElement.props;\n        this.updateDOMproperties(oldProps,newProps);\n        this.updateDOMChildren(nextElement.props.children);\n    }\n    //对比子元素\n    updateDOMChildren(newChildrenElements){\n        updateDepth++;\n        this.diff(diffQueue,newChildrenElements);\n        updateDepth--;\n        if(updateDepth===0){\n            console.log('diffQueue',diffQueue);\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+            this.patch(diffQueue);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("            diffQueue=[];\n        }\n    }\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+    patch(diffQueue){\n+        let deleteChildren = [];\n+        let deleteMap={};\n+        for(let i=0;i<diffQueue.length;i++){\n+            let difference = diffQueue[i];\n+            if(difference.type===types.MOVE || difference.type===types.REMOVE){\n+                let fromIndex = difference.fromIndex;\n+                let oldChild = $(difference.parentNode.children().get(fromIndex));\n+                deleteMap[fromIndex]=oldChild;\n+                deleteChildren.push(oldChild);\n+            }\n+        }\n+        $.each(deleteChildren,(idx,child)=>{\n+            $(child).remove();\n+        });\n")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+        for(let k=0;k<diffQueue.length;k++){\n+            let difference = diffQueue[k];\n+            switch(difference.type){\n+              case types.INSERT:\n+                this.insertChildAt(difference.parentNode,$(difference.markUp),difference.toIndex);\n+                break;\n+              case types.MOVE:\n+                this.insertChildAt(difference.parentNode,deleteMap[difference.fromIndex],difference.toIndex);\n+                break;\n+              default:\n+               break;   \n+            }\n+        }\n+    }\n+    insertChildAt(parentNode,childNode,index){\n+        let oldChild = parentNode.children().get(index);\n+        oldChild?childNode.insertBefore(oldChild):childNode.appendTo(parentNode);\n+    }\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    diff(diffQueue,newChildrenElements){\n        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);\n        let {newChildrenMap,newChildren} = this.getNewChildren(oldChildUnitsMap,newChildrenElements);\n        // lastIndex里存放着被复用的子元素的最大索引\n        let lastIndex = 0;\n        for(let i=0;i<newChildren.length;i++){\n            let newChild = newChildren[i];//取得新元素\n            let newKey = (newChild._currentElement.props&&newChild._currentElement.key)||i.toString();//取得新key\n            let oldChild = oldChildUnitsMap[newKey];\n            if(oldChild === newChild){\n                if(oldChild._mountIndex < lastIndex){\n                    diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.MOVE,\n                        fromIndex:oldChild._mountIndex,\n                        toIndex:i\n                    });\n                }\n                lastIndex = Math.max(oldChild._mountIndex,lastIndex);\n                //否则根本不用移动，直接修改挂载索引为新索引i即可\n            }else{\n                if(oldChild){\n                    diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.REMOVE,\n                        fromIndex:oldChild._mountIndex\n                    });\n                    $(document).undelegate(`.${oldChild._reactid}`);\n                }\n                 diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.INSERT,\n                        toIndex:i,\n                        markUp:newChild.getMarkUp(`${this._reactid}.${i}`)\n                });\n            }\n            newChild._mountIndex = i;\n        }\n        for(let oldKey in oldChildUnitsMap){\n            if(!newChildrenMap.hasOwnProperty(oldKey)){\n                let oldChild = oldChildUnitsMap[oldKey];\n                diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.REMOVE,\n                        fromIndex:oldChild._mountIndex\n                });\n            }\n        }\n    }\n    getNewChildren(oldChildUnitsMap,newChildrenElements){\n        let newChildren = [];\n        let newChildrenMap={};\n        newChildrenElements.forEach((newElement,index)=>{\n            let newKey = newElement.key||index.toString();\n            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit\n            let oldElement = oldUnit&&oldUnit._currentElement;//获得老的element\n            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较\n                oldUnit.update(newElement);\n                newChildren.push(oldUnit);\n                newChildrenMap[newKey]=oldUnit;\n            }else{\n                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit\n                newChildren.push(newChildUnit);\n                 newChildrenMap[newKey]=newChildUnit;\n            }\n        });\n        return {newChildrenMap,newChildren};\n    }\n    getChildrenMap(childUnits=[]){\n        let map = {};\n        for(let i=0;i<childUnits.length;i++){\n            let key = (childUnits[i]._currentElement.props&&childUnits[i]._currentElement.props.key)||i.toString();\n            map[key]=childUnits[i];\n        }\n        return map;\n    }\n    updateDOMproperties(oldProps,newProps){\n        let propName;\n        //把新属性对象上没有属性给删除掉\n        for(propName in oldProps){\n            if(!newProps.hasOwnProperty(propName)){\n                $(`[data-reactid="${this._reactid}"]`).removeAttr(propName);\n            }\n            if(/^on[A-Z]/.test(propName)){\n                $(document).undelegate(`.${this._reactid}`);\n            }\n        }\n        for(propName in newProps){\n            if(propName == \'children\'){\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('            }else if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).undelegate(`.${this._reactid}`);\n                $(document).delegate(`[data-reactid="${this._reactid}"]`,`${eventName}.${this._reactid}`,newProps[propName]);\n            }else if(propName === \'style\'){\n                let styleObj = newProps[propName];\n                Object.entries(styleObj).forEach(([attr,value])=>{\n                  $(`[data-reactid="${this._reactid}"]`).css(attr,value);\n                })\n            }else{\n                $(`[data-reactid="${this._reactid}"]`).prop(propName,newProps[propName]);\n            }\n        }\n    }\n')]),t._v("}\n\nclass CompositeUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数\n    update(nextElement,partialState){\n        //如果传过来了新的元素，则使用新的元素\n        this._currentElement = nextElement||this._currentElement;\n        //获取新的状态对象和属性对象\n        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);\n        let nextProps = this._currentElement.props;\n        //如果shouldComponentUpdate返回了false则不需要继续更新\n        if(this._componentInstance.shouldComponentUpdate&&this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}\n        //获得上次渲染出来的unit实例 \n        let prevRenderedUnitInstance = this._renderedUnitInstance;\n        //从unit实例中获取\n        let prevRenderedElement = prevRenderedUnitInstance._currentElement;\n        //获取新的虚拟DOM\n        let nextRenderElement = this._componentInstance.render();\n        //进行domdiff对比\n        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){\n            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点\n            prevRenderedUnitInstance.update(nextRenderElement);\n            this._componentInstance.componentDidUpdate&&this._componentInstance.componentDidUpdate();\n        }else{\n            //如果发现不需要对比，干脆重新渲染\n            this._renderedUnitInstance =  createUnit(nextRenderElement);\n            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);\n            //替换整个节点\n            $(`[data-reactid="${this._reactid}"]`).replaceWith(nextMarkUp);\n        }\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n    getMarkUp(reactid){\n        this._reactid = reactid;\n        //type是一个自定义组件的类的定义\n        let {type:Component,props} = this._currentElement;\n        //创建Component类的实例\n        let componentInstance = this._componentInstance = new Component(props);\n        //组件实例关联上自己的unit实例\n        componentInstance._currentUnit  = this;\n        //组件将要渲染\n        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n        //执行render方法获得虚拟DOM元素实例\n        let renderedElement = componentInstance.render();\n        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n        //获得此unit的HTML标记字符串\n        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n        return renderedMarkUp;\n    }\n")]),t._v("}\n\nfunction shouldDeepCompare(prevElement,nextElement){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   if(prevElement!==null && nextElement!=null){\n       let prevType = typeof prevElement;\n       let nextType = typeof nextElement;\n       //如果新老节点都是文本可以进行比较\n       if((prevType === 'string' ||prevType === 'number')&&(nextType === 'string' ||nextType === 'number')){\n           return true;\n       }\n       if(prevElement instanceof Element && nextElement instanceof Element){\n           return prevElement.type === nextElement.type;\n       }\n   }  \n   return false;\n")]),t._v("}\nfunction createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'function'){\n      return new CompositeUnit(element);\n  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_11-todos"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11-todos"}},[t._v("#")]),t._v(" 11. todos")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://gitee.com/zhufengpeixun/zhufeng_react2/commit/466915a20e4bb8d0d019b3325ad47867a3891fae",target:"_blank",rel:"noopener noreferrer"}},[t._v("commit"),e("OutboundLink")],1)]),t._v(" "),e("h3",{attrs:{id:"_11-1-src-index-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11-1-src-index-js"}},[t._v("#")]),t._v(" 11.1 src/index.js")]),t._v(" "),e("p",[t._v("src/index.js")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" React "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./react'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Todos")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Component")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("constructor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("props")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("super")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("props"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onChange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" event"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("target"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onDel")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("index")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("splice")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("index"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setState")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("createItem")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("itemText"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("index")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"div"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" itemText"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'button'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onDel")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("index"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'X'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" lists "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("list"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("map")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("createItem"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" input "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"input"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("onKeyup"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("onChange")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("value"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" button "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"button"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("onClick"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("bind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Add'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'div'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("input"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("button"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("lists"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" todos "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" React"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Todos"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nReact"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("render")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("todos"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementById")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'root'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("h3",{attrs:{id:"_11-2-react-unit-js"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11-2-react-unit-js"}},[t._v("#")]),t._v(" 11.2 react/unit.js")]),t._v(" "),e("p",[t._v("src/react/unit.js")]),t._v(" "),e("div",{staticClass:"language-diff extra-class"},[e("pre",{pre:!0,attrs:{class:"language-diff"}},[e("code",[t._v("import {Element} from './element';\nimport $ from 'jquery';\nimport types from './types';\nlet diffQueue = [];\nlet updateDepth=0;\nclass Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    constructor(element){\n        this._currentElement = element;\n    }\n    getMarkUp(){\n        throw new Error('不能调用此方法');\n    }\n")]),t._v("}\nclass TextUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        return `<span data-reactid="${reactid}">${this._currentElement}</span>`;\n    }\n    update(nextElement){\n        if(this._currentElement != nextElement){\n            this._currentElement = nextElement;\n            $(`[data-reactid="${this._reactid}"]`).html(this._currentElement);\n        }\n    }\n')]),t._v("\n}\nclass NativeUnit extends Unit {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("     getMarkUp(reactid){\n         this._reactid = reactid;//保存记录reactid\n        //返回文本节点对应的HTML字符串\n        let {type,props} = this._currentElement;\n        let tagOpen = `<${type} data-reactid=\"${reactid}\" `;\n        let tagClose = `</$type>`;\n        let content = '';\n        let renderedChildUnits=[];\n        for(let propName in props){\n            if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).delegate(`[data-reactid=\"${reactid}\"]`,`${eventName}.${reactid}`,props[propName]);\n            }else if(propName === 'style'){\n                let styleObj = props[propName];\n                let styles = Object.keys(styleObj).map(attr=>{\n                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){\n                        return `-${group.toLowerCase()}`;\n                    })\n                    return `${attrName}:${styleObj[attr]}`;\n                }).join(';');\n                tagOpen += (` style=\"${styles}\" `);\n            }else if (propName === 'children'){\n                let children = props.children||[];\n                children.map((child,index)=>{\n                    let childUnit = createUnit(child);\n                    childUnit._mountIndex = index;\n                    renderedChildUnits.push(childUnit);\n                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);\n                    content += childMarkUp;\n                });\n            }else{\n                tagOpen += ` ${propName}=${props[propName]} `;\n            }\n        }\n        this._renderedChildUnits = renderedChildUnits;\n        return tagOpen + '>' + content + tagClose;\n    }\n    update(nextElement){\n        let oldProps = this._currentElement.props;\n        let newProps = nextElement.props;\n        this.updateDOMproperties(oldProps,newProps);\n        this.updateDOMChildren(nextElement.props.children);\n    }\n    //对比子元素\n    updateDOMChildren(newChildrenElements){\n        updateDepth++;\n        this.diff(diffQueue,newChildrenElements);\n        updateDepth--;\n        if(updateDepth===0){\n            console.log('diffQueue',diffQueue);\n            this.patch(diffQueue);\n            diffQueue=[];\n        }\n    }\n    patch(diffQueue){\n        let deleteChildren = [];\n        let deleteMap={};\n        for(let i=0;i<diffQueue.length;i++){\n            let difference = diffQueue[i];\n            if(difference.type===types.MOVE || difference.type===types.REMOVE){\n                let fromIndex = difference.fromIndex;\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+                let parentId = difference.parentId;\n+                let oldChild = $(difference.parentNode.children().get(fromIndex));\n+                deleteMap[parentId]={};\n+                deleteMap[parentId][fromIndex]=oldChild;\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("                deleteChildren.push(oldChild);\n            }\n        }\n        $.each(deleteChildren,(idx,child)=>{\n            $(child).remove();\n        });\n")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("        for(let k=0;k<diffQueue.length;k++){\n            let difference = diffQueue[k];\n            switch(difference.type){\n              case types.INSERT:\n                this.insertChildAt(difference.parentNode,$(difference.markUp),difference.toIndex);\n                break;\n              case types.MOVE:\n")]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+                this.insertChildAt(difference.parentNode,deleteMap[difference.parentId][difference.fromIndex],difference.toIndex);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('                break;\n              default:\n               break;   \n            }\n        }\n    }\n    insertChildAt(parentNode,childNode,index){\n        let oldChild = parentNode.children().get(index);\n        oldChild?childNode.insertBefore(oldChild):childNode.appendTo(parentNode);\n    }\n    diff(diffQueue,newChildrenElements){\n        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);\n        let {newChildrenMap,newChildren} = this.getNewChildren(oldChildUnitsMap,newChildrenElements);\n        // lastIndex里存放着被复用的子元素的最大索引\n        let lastIndex = 0;\n        for(let i=0;i<newChildren.length;i++){\n            let newChild = newChildren[i];//取得新元素\n            let newKey = (newChild._currentElement.props&&newChild._currentElement.key)||i.toString();//取得新key\n            let oldChild = oldChildUnitsMap[newKey];\n            if(oldChild === newChild){\n                if(oldChild._mountIndex < lastIndex){\n                    diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.MOVE,\n                        fromIndex:oldChild._mountIndex,\n                        toIndex:i\n                    });\n                }\n                lastIndex = Math.max(oldChild._mountIndex,lastIndex);\n                //否则根本不用移动，直接修改挂载索引为新索引i即可\n            }else{\n                if(oldChild){\n                    diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.REMOVE,\n                        fromIndex:oldChild._mountIndex\n                    });\n                    $(document).undelegate(`.${oldChild._reactid}`);\n                }\n                 diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.INSERT,\n                        toIndex:i,\n                        markUp:newChild.getMarkUp(`${this._reactid}.${i}`)\n                });\n            }\n            newChild._mountIndex = i;\n        }\n        for(let oldKey in oldChildUnitsMap){\n            if(!newChildrenMap.hasOwnProperty(oldKey)){\n                let oldChild = oldChildUnitsMap[oldKey];\n                diffQueue.push({\n                        parentId:this._reactid,\n                        parentNode:$(`[data-reactid="${this._reactid}"]`),\n                        type:types.REMOVE,\n                        fromIndex:oldChild._mountIndex\n                });\n')]),e("span",{pre:!0,attrs:{class:"token inserted-sign inserted"}},[t._v("+                this._renderedChildUnits = this._renderedChildUnits.filter(item=>item != oldChild);\n+                $(document).undelegate(`.${oldChild._reactid}`);\n")]),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("            }\n        }\n    }\n    getNewChildren(oldChildUnitsMap,newChildrenElements){\n        let newChildren = [];\n        let newChildrenMap={};\n        newChildrenElements.forEach((newElement,index)=>{\n            let newKey = newElement.key||index.toString();\n            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit\n            let oldElement = oldUnit&&oldUnit._currentElement;//获得老的element\n            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较\n                oldUnit.update(newElement);\n                newChildren.push(oldUnit);\n                newChildrenMap[newKey]=oldUnit;\n            }else{\n                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit\n                newChildren.push(newChildUnit);\n                newChildrenMap[newKey]=newChildUnit;\n                this._renderedChildUnits[index]=newChildUnit;\n            }\n        });\n        return {newChildrenMap,newChildren};\n    }\n    getChildrenMap(childUnits=[]){\n        let map = {};\n        for(let i=0;i<childUnits.length;i++){\n            let key = (childUnits[i]._currentElement.props&&childUnits[i]._currentElement.props.key)||i.toString();\n            map[key]=childUnits[i];\n        }\n        return map;\n    }\n    updateDOMproperties(oldProps,newProps){\n        let propName;\n        //把新属性对象上没有属性给删除掉\n        for(propName in oldProps){\n            if(!newProps.hasOwnProperty(propName)){\n                $(`[data-reactid=\"${this._reactid}\"]`).removeAttr(propName);\n            }\n            if(/^on[A-Z]/.test(propName)){\n                $(document).undelegate(`.${this._reactid}`);\n            }\n        }\n        for(propName in newProps){\n            if(propName == 'children'){\n")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('            }else if(/^on[A-Z]/.test(propName)){\n                let eventName = propName.slice(2).toLowerCase();\n                $(document).undelegate(`.${this._reactid}`);\n                $(document).delegate(`[data-reactid="${this._reactid}"]`,`${eventName}.${this._reactid}`,newProps[propName]);\n            }else if(propName === \'style\'){\n                let styleObj = newProps[propName];\n                Object.entries(styleObj).forEach(([attr,value])=>{\n                  $(`[data-reactid="${this._reactid}"]`).css(attr,value);\n                })\n            }else{\n                $(`[data-reactid="${this._reactid}"]`).prop(propName,newProps[propName]);\n            }\n        }\n    }\n')]),t._v("}\n\nclass CompositeUnit extends Unit{\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v('    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数\n    update(nextElement,partialState){\n        //如果传过来了新的元素，则使用新的元素\n        this._currentElement = nextElement||this._currentElement;\n        //获取新的状态对象和属性对象\n        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);\n        let nextProps = this._currentElement.props;\n        //如果shouldComponentUpdate返回了false则不需要继续更新\n        if(this._componentInstance.shouldComponentUpdate&&this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}\n        //获得上次渲染出来的unit实例 \n        let prevRenderedUnitInstance = this._renderedUnitInstance;\n        //从unit实例中获取\n        let prevRenderedElement = prevRenderedUnitInstance._currentElement;\n        //获取新的虚拟DOM\n        let nextRenderElement = this._componentInstance.render();\n        //进行domdiff对比\n        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){\n            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点\n            prevRenderedUnitInstance.update(nextRenderElement);\n            this._componentInstance.componentDidUpdate&&this._componentInstance.componentDidUpdate();\n        }else{\n            //如果发现不需要对比，干脆重新渲染\n            this._renderedUnitInstance =  createUnit(nextRenderElement);\n            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);\n            //替换整个节点\n            $(`[data-reactid="${this._reactid}"]`).replaceWith(nextMarkUp);\n        }\n')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    }\n    getMarkUp(reactid){\n        this._reactid = reactid;\n        //type是一个自定义组件的类的定义\n        let {type:Component,props} = this._currentElement;\n        //创建Component类的实例\n        let componentInstance = this._componentInstance = new Component(props);\n        //组件实例关联上自己的unit实例\n        componentInstance._currentUnit  = this;\n        //组件将要渲染\n        componentInstance.componentWillMount&&componentInstance.componentWillMount();\n        //执行render方法获得虚拟DOM元素实例\n        let renderedElement = componentInstance.render();\n        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit\n        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);\n        //获得此unit的HTML标记字符串\n        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);\n        //注册挂载完成的监听，越底层的组件越先监听，越先执行\n        $(document).on('mounted',()=>componentInstance.componentDidMount&&componentInstance.componentDidMount());\n        return renderedMarkUp;\n    }\n")]),t._v("}\n\nfunction shouldDeepCompare(prevElement,nextElement){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("   if(prevElement!==null && nextElement!=null){\n       let prevType = typeof prevElement;\n       let nextType = typeof nextElement;\n       //如果新老节点都是文本可以进行比较\n       if((prevType === 'string' ||prevType === 'number')&&(nextType === 'string' ||nextType === 'number')){\n           return true;\n       }\n       if(prevElement instanceof Element && nextElement instanceof Element){\n           return prevElement.type === nextElement.type;\n       }\n   }  \n   return false;\n")]),t._v("}\nfunction createUnit(element){\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("  if(typeof element =='string' || typeof element =='number'){\n      return new TextUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'string'){\n      return new NativeUnit(element);\n  }\n  if(element instanceof Element && typeof element.type === 'function'){\n      return new CompositeUnit(element);\n  }\n")]),t._v("}\n\nexport {\n"),e("span",{pre:!0,attrs:{class:"token unchanged"}},[t._v("    createUnit\n")]),t._v("}\n")])])]),e("h2",{attrs:{id:"_10-diff-策略"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-diff-策略"}},[t._v("#")]),t._v(" 10. diff 策略")]),t._v(" "),e("ul",[e("li",[t._v("Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。")]),t._v(" "),e("li",[t._v("拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构。")]),t._v(" "),e("li",[t._v("对于同一层级的一组子节点，它们可以通过唯一"),e("code",[t._v("key")]),t._v("进行区分。")])]),t._v(" "),e("h3",{attrs:{id:"_10-1-tree-diff"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-1-tree-diff"}},[t._v("#")]),t._v(" 10.1 tree diff")]),t._v(" "),e("ul",[e("li",[t._v("React 对树的算法进行了简洁明了的优化，即对树进行分层比较，两棵树只会对同一层次的节点进行比较")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013924.png",alt:"sametree"}})]),t._v(" "),e("ul",[e("li",[t._v("当出现节点跨层级移动时，并不会出现想象中的移动操作，而是以 A 为根节点的树被整个重新创建")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013928.png",alt:"movemytree"}})]),t._v(" "),e("h3",{attrs:{id:"_10-2-component-diff"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-2-component-diff"}},[t._v("#")]),t._v(" 10.2 component diff")]),t._v(" "),e("ul",[e("li",[t._v("如果是同一类型的组件，按照原策略继续比较 "),e("code",[t._v("virtual DOM tree")])]),t._v(" "),e("li",[t._v("如果不是，则将该组件判断为"),e("code",[t._v("dirty component")]),t._v(",从而替换整个组件下的所有子节点")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013932.png",alt:"deleteall"}})]),t._v(" "),e("h3",{attrs:{id:"_10-3-element-diff"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-3-element-diff"}},[t._v("#")]),t._v(" 10.3 element diff")]),t._v(" "),e("ul",[e("li",[t._v("当节点处于同一层级时，React diff 提供了三种节点操作,分别为：INSERT(插入)、MOVE(移动)和 REMOVE(删除)")]),t._v(" "),e("li",[t._v("INSERT 新的 component 类型不在老集合里， 即是全新的节点，需要对新节点执行插入操作")]),t._v(" "),e("li",[t._v("MOVE 在老集合有新 component 类型，就需要做移动操作，可以复用以前的 DOM 节点")]),t._v(" "),e("li",[t._v("REMOVE 老 component 不在新集合里的，也需要执行删除操作")])]),t._v(" "),e("h3",{attrs:{id:"_10-4-key"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_10-4-key"}},[t._v("#")]),t._v(" 10.4 key")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013936.png",alt:"oldnewmove"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013941.png",alt:"oldnewmove2"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013945.png",alt:"oldnewmove3"}})]),t._v(" "),e("h2",{attrs:{id:"_11-delegate"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_11-delegate"}},[t._v("#")]),t._v(" 11.delegate")]),t._v(" "),e("ul",[e("li",[t._v("delegate() 方法为指定的元素(属于被选元素的子元素)添加一个或多个事件处理程序，并规定当这些事件发生时运行的函数，使用 delegate() 方法的事件处理程序适用于当前或未来的元素(比如由脚本创建的新元素)")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",{staticStyle:{"text-align":"left"}},[t._v("参数名称")]),t._v(" "),e("th",{staticStyle:{"text-align":"left"}},[t._v("参数含义")])])]),t._v(" "),e("tbody",[e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("childSelector")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("必需,规定要附加事件处理程序的一个或多个子元素")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("event")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("必需,规定附加到元素的一个或多个事件,由空格分隔多个事件值。必须是有效的事件")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("data")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("可选,规定传递到函数的额外数据")])]),t._v(" "),e("tr",[e("td",{staticStyle:{"text-align":"left"}},[t._v("function")]),t._v(" "),e("td",{staticStyle:{"text-align":"left"}},[t._v("必需,规定当事件发生时运行的函数")])])])]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://api.jquery.com/delegate/",target:"_blank",rel:"noopener noreferrer"}},[t._v("delegate"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://api.jquery.com/undelegate/",target:"_blank",rel:"noopener noreferrer"}},[t._v("undelegate"),e("OutboundLink")],1)]),t._v(" "),e("li",[t._v("参数"),e("code",[t._v("events")]),t._v("还支持为事件类型附加额外的命名空间")]),t._v(" "),e("li",[t._v("当为同一元素绑定多个相同类型的事件处理函数时。使用命名空间，可以在触发事件、移除事件时限定触发或移除的范围。")])]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" $document "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("$")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//为#btn1元素绑定click事件，定义在foo和bar两个命名空间下")]),t._v("\n$document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("delegate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#btn1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click.foo.bar"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click-1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//为#btn1元素绑定click事件，定义在test命名空间下")]),t._v("\n$document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("delegate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#btn1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click.test"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click-2"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//为#btn1元素绑定click事件，定义在test和foo两个命名空间下")]),t._v("\n$document"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("delegate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#btn1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click.test.foo"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("event")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click-3"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发所有click事件")]),t._v("\n$btn1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("trigger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 触发A和B (event.namespace = "")')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发定义在foo命名空间下的click事件")]),t._v("\n$btn1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("trigger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click.foo"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 触发A (event.namespace = "foo")')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 触发定义在bar命名空间下的click事件")]),t._v("\n$btn1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("trigger")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click.bar"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// 触发A (event.namespace = "bar")')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 移除所有btn1元素定义在foo命名空间下的click事件处理函数")]),t._v("\n$btn1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("undelegate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"click.foo"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 移除A")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// $document.undelegate(".test"); // 移除click-2、click-3')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// $document.undelegate(".foo");  // 移除click-1、click-3')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// $document.undelegate(".foo.bar");  // 移除click-1')]),t._v("\n")])])])])}),[],!1,null,null,null);n.default=a.exports}}]);