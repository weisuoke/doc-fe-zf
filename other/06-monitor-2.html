<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>06. 工业级前端监控2 | 珠峰架构</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.1657c744.css" as="style"><link rel="preload" href="/assets/js/app.2af561cb.js" as="script"><link rel="preload" href="/assets/js/2.b2a5c435.js" as="script"><link rel="preload" href="/assets/js/17.5ecf2b4f.js" as="script"><link rel="prefetch" href="/assets/js/10.2b2c8443.js"><link rel="prefetch" href="/assets/js/11.689524dc.js"><link rel="prefetch" href="/assets/js/12.849e2da9.js"><link rel="prefetch" href="/assets/js/13.c798d95d.js"><link rel="prefetch" href="/assets/js/14.380c4ee7.js"><link rel="prefetch" href="/assets/js/15.d5753b2e.js"><link rel="prefetch" href="/assets/js/16.49eb1f17.js"><link rel="prefetch" href="/assets/js/18.da9c8265.js"><link rel="prefetch" href="/assets/js/19.59d827ef.js"><link rel="prefetch" href="/assets/js/20.73eb42bb.js"><link rel="prefetch" href="/assets/js/21.8570b5b4.js"><link rel="prefetch" href="/assets/js/22.34094913.js"><link rel="prefetch" href="/assets/js/23.5209939b.js"><link rel="prefetch" href="/assets/js/24.53d92201.js"><link rel="prefetch" href="/assets/js/25.7241adf1.js"><link rel="prefetch" href="/assets/js/26.fecc2611.js"><link rel="prefetch" href="/assets/js/27.e50fca48.js"><link rel="prefetch" href="/assets/js/28.4c168acc.js"><link rel="prefetch" href="/assets/js/29.f5186710.js"><link rel="prefetch" href="/assets/js/3.ba1dcccd.js"><link rel="prefetch" href="/assets/js/30.33cb1c11.js"><link rel="prefetch" href="/assets/js/31.c088791d.js"><link rel="prefetch" href="/assets/js/32.3b724af5.js"><link rel="prefetch" href="/assets/js/33.f975c942.js"><link rel="prefetch" href="/assets/js/34.7d1f4bd2.js"><link rel="prefetch" href="/assets/js/35.26c11750.js"><link rel="prefetch" href="/assets/js/36.e8890e58.js"><link rel="prefetch" href="/assets/js/37.516eba46.js"><link rel="prefetch" href="/assets/js/38.4f8b8525.js"><link rel="prefetch" href="/assets/js/39.26f95568.js"><link rel="prefetch" href="/assets/js/4.fca74266.js"><link rel="prefetch" href="/assets/js/40.b9a8ffbb.js"><link rel="prefetch" href="/assets/js/41.fd02ea5f.js"><link rel="prefetch" href="/assets/js/42.d2483185.js"><link rel="prefetch" href="/assets/js/43.70bff2de.js"><link rel="prefetch" href="/assets/js/44.219702ca.js"><link rel="prefetch" href="/assets/js/45.aba93af9.js"><link rel="prefetch" href="/assets/js/46.447ba87c.js"><link rel="prefetch" href="/assets/js/47.519ddc28.js"><link rel="prefetch" href="/assets/js/48.fd8af347.js"><link rel="prefetch" href="/assets/js/49.b3783fa9.js"><link rel="prefetch" href="/assets/js/5.cc992e8b.js"><link rel="prefetch" href="/assets/js/50.0bb20f92.js"><link rel="prefetch" href="/assets/js/51.37ba1a59.js"><link rel="prefetch" href="/assets/js/52.054af132.js"><link rel="prefetch" href="/assets/js/53.5aca78a0.js"><link rel="prefetch" href="/assets/js/54.78c43f89.js"><link rel="prefetch" href="/assets/js/55.8ecaadc1.js"><link rel="prefetch" href="/assets/js/56.e844f110.js"><link rel="prefetch" href="/assets/js/57.530db0e9.js"><link rel="prefetch" href="/assets/js/58.8c839289.js"><link rel="prefetch" href="/assets/js/59.6634b409.js"><link rel="prefetch" href="/assets/js/6.b8b36e50.js"><link rel="prefetch" href="/assets/js/60.7ebe5787.js"><link rel="prefetch" href="/assets/js/61.bfe89a8b.js"><link rel="prefetch" href="/assets/js/62.4cdf6e8c.js"><link rel="prefetch" href="/assets/js/63.a0e80f0d.js"><link rel="prefetch" href="/assets/js/64.62a1b782.js"><link rel="prefetch" href="/assets/js/65.7be0994b.js"><link rel="prefetch" href="/assets/js/66.5a592a8e.js"><link rel="prefetch" href="/assets/js/67.40b4291c.js"><link rel="prefetch" href="/assets/js/68.2ac34b58.js"><link rel="prefetch" href="/assets/js/69.728773d5.js"><link rel="prefetch" href="/assets/js/7.0414e914.js"><link rel="prefetch" href="/assets/js/70.30137f66.js"><link rel="prefetch" href="/assets/js/71.7735c9fc.js"><link rel="prefetch" href="/assets/js/72.e9f43339.js"><link rel="prefetch" href="/assets/js/73.2d754e71.js"><link rel="prefetch" href="/assets/js/74.bf70dd09.js"><link rel="prefetch" href="/assets/js/75.18c28356.js"><link rel="prefetch" href="/assets/js/76.a0626bc9.js"><link rel="prefetch" href="/assets/js/77.dfde57e0.js"><link rel="prefetch" href="/assets/js/78.b380a0d6.js"><link rel="prefetch" href="/assets/js/79.f7bafb5d.js"><link rel="prefetch" href="/assets/js/8.c3544379.js"><link rel="prefetch" href="/assets/js/80.ade6c33e.js"><link rel="prefetch" href="/assets/js/81.6335ba85.js"><link rel="prefetch" href="/assets/js/82.9d01c14e.js"><link rel="prefetch" href="/assets/js/83.47911fdd.js"><link rel="prefetch" href="/assets/js/9.844fca3b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1657c744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">珠峰架构</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable"><span>react</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/flutter/" class="sidebar-heading clickable"><span>flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/" class="sidebar-heading clickable"><span>interview</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/other/" class="sidebar-heading clickable router-link-active open"><span>other</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/other/01-https.html" class="sidebar-link">01. HTTPS简介</a></li><li><a href="/other/02-serverless.html" class="sidebar-link">02. Serverless</a></li><li><a href="/other/03-rbac.html" class="sidebar-link">03. RBAC</a></li><li><a href="/other/04-websocket.html" class="sidebar-link">04. WebSocket</a></li><li><a href="/other/05-monitor.html" class="sidebar-link">05. 工业级前端监控</a></li><li><a href="/other/06-monitor-2.html" class="active sidebar-link">06. 工业级前端监控2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_06-工业级前端监控2" class="sidebar-link">06. 工业级前端监控2</a></li><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_2-配置nginx" class="sidebar-link">2. 配置nginx</a></li><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_3-下载项目" class="sidebar-link">3. 下载项目</a></li><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_4-埋点上报" class="sidebar-link">4.埋点上报</a></li><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_5-数据处理" class="sidebar-link">5.数据处理</a></li><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_6-计划任务" class="sidebar-link">6.计划任务</a></li><li class="sidebar-sub-header"><a href="/other/06-monitor-2.html#_7-前台展示" class="sidebar-link">7.前台展示</a></li></ul></li><li><a href="/other/07-binary.html" class="sidebar-link">07. 二进制</a></li><li><a href="/other/08-binary-2.html" class="sidebar-link">08. 二进制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_06-工业级前端监控2"><a href="#_06-工业级前端监控2" class="header-anchor">#</a> 06. 工业级前端监控2</h2> <h3 id="_1-1-安装mysql"><a href="#_1-1-安装mysql" class="header-anchor">#</a> 1.1.安装mysql</h3> <ul><li><a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener noreferrer">mysql<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_1-2-安装redis"><a href="#_1-2-安装redis" class="header-anchor">#</a> 1.2.安装redis</h3> <ul><li><a href="https://redis.io/" target="_blank" rel="noopener noreferrer">redis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_1-3-安装nginx"><a href="#_1-3-安装nginx" class="header-anchor">#</a> 1.3.安装nginx</h3> <ul><li><a href="https://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">nginx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="_2-配置nginx"><a href="#_2-配置nginx" class="header-anchor">#</a> 2. 配置nginx</h2> <h3 id="_2-1-nginx-conf"><a href="#_2-1-nginx-conf" class="header-anchor">#</a> 2.1 nginx.conf</h3> <div class="language-js extra-class"><pre class="language-js"><code>http <span class="token punctuation">{</span>
    include       mime<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
    default_type  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>

    log_format  main <span class="token string">'$time_iso8601    -    -    $remote_addr    $http_host    $status    $request_time    $request_length    $body_bytes_sent    15d04347-be16-b9ab-0029-24e4b6645950    -    -    9689c3ea-5155-2df7-a719-e90d2dedeb2c 937ba755-116a-18e6-0735-312cba23b00c    -    -    $request_uri    $http_user_agent    -    sample=-&amp;_UC_agent=-&amp;device_id=-&amp;-    -    -    -'</span><span class="token punctuation">;</span>
    access_log  logs<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
    server <span class="token punctuation">{</span>
        listen       <span class="token number">80</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>$time_iso8601 <span class="token operator">~</span> <span class="token string">&quot;^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">set</span> $year $<span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token keyword">set</span> $month $<span class="token number">2</span><span class="token punctuation">;</span>
         <span class="token keyword">set</span> $day $<span class="token number">3</span><span class="token punctuation">;</span>
         <span class="token keyword">set</span> $hour $<span class="token number">4</span><span class="token punctuation">;</span>
         <span class="token keyword">set</span> $minute $<span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        access_log  logs<span class="token operator">/</span>$year$month<span class="token operator">-</span>$day<span class="token operator">-</span>$hour<span class="token operator">-</span>$minute<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span>
        location <span class="token operator">/</span> <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
            index  index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> <span class="token operator">/</span><span class="token number">50</span>x<span class="token punctuation">.</span>html <span class="token punctuation">{</span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">$time_iso8601</td> <td style="text-align:left;">服务器时间的ISO 8610格式</td></tr> <tr><td style="text-align:left;">$remote_addr</td> <td style="text-align:left;">客户端地址</td></tr> <tr><td style="text-align:left;">$http_host</td> <td style="text-align:left;">主机名</td></tr> <tr><td style="text-align:left;">$status</td> <td style="text-align:left;">HTTP响应代码</td></tr> <tr><td style="text-align:left;">$request_time</td> <td style="text-align:left;">处理客户端请求使用的时间</td></tr> <tr><td style="text-align:left;">$request_length</td> <td style="text-align:left;">请求的长度</td></tr> <tr><td style="text-align:left;">$body_bytes_sent</td> <td style="text-align:left;">传输给客户端的字节数</td></tr> <tr><td style="text-align:left;">$request_uri</td> <td style="text-align:left;">包含一些客户端请求参数的原始URI</td></tr> <tr><td style="text-align:left;">$http_user_agent</td> <td style="text-align:left;">客户端用户代理</td></tr></tbody></table> <h2 id="_3-下载项目"><a href="#_3-下载项目" class="header-anchor">#</a> 3. 下载项目</h2> <div class="language-js extra-class"><pre class="language-js"><code>git clone https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>gitee<span class="token punctuation">.</span>com<span class="token operator">/</span>zhufengpeixun<span class="token operator">/</span>monitor<span class="token punctuation">.</span>git
</code></pre></div><h2 id="_4-埋点上报"><a href="#_4-埋点上报" class="header-anchor">#</a> 4.埋点上报</h2> <h3 id="_4-1-安装"><a href="#_4-1-安装" class="header-anchor">#</a> 4.1 安装</h3> <div class="language-js extra-class"><pre class="language-js"><code>cd monitor<span class="token operator">/</span>sdk
cnpm install
</code></pre></div><h3 id="_4-2-配置"><a href="#_4-2-配置" class="header-anchor">#</a> 4.2 配置</h3> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span>dt <span class="token operator">&amp;&amp;</span> dt<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  pid<span class="token operator">:</span> <span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token comment">// [必填]项目id,</span>
  uuid<span class="token operator">:</span> <span class="token string">'uuid'</span><span class="token punctuation">,</span> <span class="token comment">// [可选]设备唯一id, 用于计算uv数&amp;设备分布. 一般在cookie中可以取到, 没有uuid可用设备macidfa/imei替代. 或者在storage的key中存入随机数字, 模拟设备唯一id.</span>
  ucid<span class="token operator">:</span> <span class="token string">'ucid'</span><span class="token punctuation">,</span> <span class="token comment">// [可选]用户ucid, 用于发生异常时追踪用户信息, 一般在cookie中可以取到, 没有可传空字符串</span>
  is_test<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否为测试数据, 默认为false(测试模式下打点数据仅供浏览, 不会展示在系统中)</span>
  record<span class="token operator">:</span> <span class="token punctuation">{</span>
    time_on_page<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否监控用户在线时长数据, 默认为true</span>
    performance<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否监控页面载入性能, 默认为true</span>
    js_error<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//  是否监控页面报错信息, 默认为true</span>
    <span class="token comment">// 配置需要监控的页面报错类别, 仅在js_error为true时生效, 默认均为true(可以将配置改为false, 以屏蔽不需要报的错误类别)</span>
    js_error_report_config<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token constant">ERROR_RUNTIME</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// js运行时报错</span>
      <span class="token constant">ERROR_SCRIPT</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// js资源加载失败</span>
      <span class="token constant">ERROR_STYLE</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// css资源加载失败</span>
      <span class="token constant">ERROR_IMAGE</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 图片资源加载失败</span>
      <span class="token constant">ERROR_AUDIO</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 音频资源加载失败</span>
      <span class="token constant">ERROR_VIDEO</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 视频资源加载失败</span>
      <span class="token constant">ERROR_CONSOLE</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// vue运行时报错</span>
      <span class="token constant">ERROR_TRY_CATCH</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 未catch错误</span>
      <span class="token comment">// 自定义检测函数, 上报前最后判断是否需要报告该错误</span>
      <span class="token comment">// 回调函数说明</span>
      <span class="token comment">// 传入参数 =&gt; </span>
      <span class="token comment">//            desc:  字符串, 错误描述</span>
      <span class="token comment">//            stack: 字符串, 错误堆栈信息</span>
      <span class="token comment">// 返回值 =&gt;  </span>
      <span class="token comment">//            true  : 上报打点请求</span>
      <span class="token comment">//            false : 不需要上报</span>
      <span class="token function-variable function">checkErrrorNeedReport</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">desc<span class="token punctuation">,</span> stack</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 业务方的js版本号, 会随着打点数据一起上传, 方便区分数据来源</span>
  <span class="token comment">// 可以不填, 默认为1.0.0</span>
  version<span class="token operator">:</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
  <span class="token comment">// test.com/detail/1.html</span>
  <span class="token comment">// test.com/detail/2.html</span>
  <span class="token comment">// test.com/detail/3.html</span>
  <span class="token comment">// 这种页面来说, 虽然url不同, 但他们本质上是同一个页面</span>
  <span class="token comment">// 因此需要业务方传入一个处理函数, 根据当前url解析出真实的页面类型</span>
  <span class="token function-variable function">getPageType</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">location</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>location<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_4-3-监控类型"><a href="#_4-3-监控类型" class="header-anchor">#</a> 4.3 监控类型</h3> <h4 id="_4-3-1-time-on-page-用户在线时长统计"><a href="#_4-3-1-time-on-page-用户在线时长统计" class="header-anchor">#</a> 4.3.1 time_on_page(用户在线时长统计)</h4> <ul><li>t_r_duration_distribution</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 用户在线时长统计</span>
<span class="token keyword">const</span> <span class="token constant">OFFLINE_MILL</span> <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 15分钟不操作认为不在线</span>
<span class="token keyword">const</span> <span class="token constant">SEND_MILL</span> <span class="token operator">=</span> <span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 每5s打点一次</span>

<span class="token keyword">let</span> lastTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查是否监控用户在线时长</span>
  <span class="token keyword">const</span> isTimeOnPageFlagOn <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    commonConfig<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'record'</span><span class="token punctuation">,</span> <span class="token string">'time_on_page'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_CONFIG</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'record'</span><span class="token punctuation">,</span> <span class="token string">'time_on_page'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> isOldTimeOnPageFlagOn <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>commonConfig<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'online'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> needRecordTimeOnPage <span class="token operator">=</span> isTimeOnPageFlagOn <span class="token operator">||</span> isOldTimeOnPageFlagOn
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needRecordTimeOnPage <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugLogger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">config.record.time_on_page值为false, 跳过停留时长打点</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> duration <span class="token operator">=</span> now <span class="token operator">-</span> lastTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&gt;</span> <span class="token constant">OFFLINE_MILL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>duration <span class="token operator">&gt;</span> <span class="token constant">SEND_MILL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">debugLogger</span><span class="token punctuation">(</span><span class="token string">'发送用户留存时间埋点, 埋点内容 =&gt; '</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> duration_ms<span class="token operator">:</span> duration <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 用户在线时长</span>
    log<span class="token punctuation">.</span><span class="token function">product</span><span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> duration_ms<span class="token operator">:</span> duration <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">10001</span><span class="token punctuation">,</span>
        <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;duration_ms&quot;</span><span class="token operator">:</span> <span class="token number">21553</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-2-performance-页面载入性能"><a href="#_4-3-2-performance-页面载入性能" class="header-anchor">#</a> 4.3.2 performance(页面载入性能)</h4> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/2020-06-17-095311.png" alt="renderscope3"></p> <h4 id="_4-3-2-1-sdk-src-index-js"><a href="#_4-3-2-1-sdk-src-index-js" class="header-anchor">#</a> 4.3.2.1 sdk\src\index.js</h4> <p>sdk\src\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查是否监控性能指标</span>
  <span class="token keyword">const</span> isPerformanceFlagOn <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    commonConfig<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token string">'record'</span><span class="token punctuation">,</span> <span class="token string">'performance'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_CONFIG</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'record'</span><span class="token punctuation">,</span> <span class="token string">'performance'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token keyword">const</span> isOldPerformanceFlagOn <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>commonConfig<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'performance'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> needRecordPerformance <span class="token operator">=</span> isPerformanceFlagOn <span class="token operator">||</span> isOldPerformanceFlagOn
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needRecordPerformance <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debugLogger</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">config.record.performance值为false, 跳过性能指标打点</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> performance <span class="token operator">=</span> window<span class="token punctuation">.</span>performance
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>performance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 当前浏览器不支持</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'你的浏览器不支持 performance 接口'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> times <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token function">debugLogger</span><span class="token punctuation">(</span><span class="token string">'发送页面性能指标数据, 上报内容 =&gt; '</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>times<span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'perf'</span><span class="token punctuation">,</span> <span class="token number">20001</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>times<span class="token punctuation">,</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;perf&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">20001</span><span class="token punctuation">,</span>
        <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;connectStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165386</span><span class="token punctuation">,</span>
            <span class="token string">&quot;navigationStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165383</span><span class="token punctuation">,</span>
            <span class="token string">&quot;loadEventEnd&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domLoading&quot;</span><span class="token operator">:</span> <span class="token number">1592020165401</span><span class="token punctuation">,</span>
            <span class="token string">&quot;secureConnectionStart&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token string">&quot;fetchStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165386</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domContentLoadedEventStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165630</span><span class="token punctuation">,</span>
            <span class="token string">&quot;responseStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165393</span><span class="token punctuation">,</span>
            <span class="token string">&quot;responseEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592020165394</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domInteractive&quot;</span><span class="token operator">:</span> <span class="token number">1592020165630</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domainLookupEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592020165386</span><span class="token punctuation">,</span>
            <span class="token string">&quot;redirectStart&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token string">&quot;requestStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165387</span><span class="token punctuation">,</span>
            <span class="token string">&quot;unloadEventEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592020165398</span><span class="token punctuation">,</span>
            <span class="token string">&quot;unloadEventStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165397</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domComplete&quot;</span><span class="token operator">:</span> <span class="token number">1592020165630</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domainLookupStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165386</span><span class="token punctuation">,</span>
            <span class="token string">&quot;loadEventStart&quot;</span><span class="token operator">:</span> <span class="token number">1592020165630</span><span class="token punctuation">,</span>
            <span class="token string">&quot;domContentLoadedEventEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592020165630</span><span class="token punctuation">,</span>
            <span class="token string">&quot;redirectEnd&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token string">&quot;connectEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592020165386</span><span class="token punctuation">,</span>
            <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost:9000/&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-3-js-error-页面报错"><a href="#_4-3-3-js-error-页面报错" class="header-anchor">#</a> 4.3.3 js_error(页面报错)</h4> <table><thead><tr><th style="text-align:left;">错误类型</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">ERROR_RUNTIME</td> <td style="text-align:left;">js运行时报错</td></tr> <tr><td style="text-align:left;">ERROR_SCRIPT</td> <td style="text-align:left;">js资源加载失败</td></tr> <tr><td style="text-align:left;">ERROR_IMAGE</td> <td style="text-align:left;">图片资源加载失败</td></tr> <tr><td style="text-align:left;">ERROR_AUDIO</td> <td style="text-align:left;">音频资源加载失败</td></tr> <tr><td style="text-align:left;">ERROR_VIDEO</td> <td style="text-align:left;">视频资源加载失败</td></tr> <tr><td style="text-align:left;">ERROR_CONSOLE</td> <td style="text-align:left;">vue运行时报错</td></tr> <tr><td style="text-align:left;">ERROR_TRY_CATCH</td> <td style="text-align:left;">未catch错误</td></tr></tbody></table> <h5 id="_4-3-3-1-error-runtime"><a href="#_4-3-3-1-error-runtime" class="header-anchor">#</a> 4.3.3.1 ERROR_RUNTIME</h5> <div class="language-js extra-class"><pre class="language-js"><code>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 过滤 target 为 window 的异常，避免与上面的 onerror 重复</span>
    <span class="token keyword">var</span> errorTarget <span class="token operator">=</span> event<span class="token punctuation">.</span>target
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorTarget <span class="token operator">!==</span> window <span class="token operator">&amp;&amp;</span> errorTarget<span class="token punctuation">.</span>nodeName <span class="token operator">&amp;&amp;</span> <span class="token constant">LOAD_ERROR_TYPE</span><span class="token punctuation">[</span>errorTarget<span class="token punctuation">.</span>nodeName<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token function">formatLoadError</span><span class="token punctuation">(</span>errorTarget<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// onerror会被覆盖, 因此转为使用Listener进行监控</span>
      <span class="token keyword">let</span> <span class="token punctuation">{</span> message<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> event
      <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token function">formatRuntimerError</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">formatRuntimerError</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> source<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> colno<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token constant">ERROR_RUNTIME</span><span class="token punctuation">,</span>
    desc<span class="token operator">:</span> message <span class="token operator">+</span> <span class="token string">' at '</span> <span class="token operator">+</span> source <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> lineno <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> colno<span class="token punctuation">,</span>
    stack<span class="token operator">:</span> error <span class="token operator">&amp;&amp;</span> error<span class="token punctuation">.</span>stack <span class="token operator">?</span> error<span class="token punctuation">.</span>stack <span class="token operator">:</span> <span class="token string">'no stack'</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;error_no&quot;</span><span class="token operator">:</span> <span class="token string">&quot;页面报错_JS_RUNTIME_ERROR&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost:9000/&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Uncaught ReferenceError: a is not defined at http://localhost:9000/:53:21&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ReferenceError: a is not defined\n    at http://localhost:9000/:53:21&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4-3-3-2-load-error"><a href="#_4-3-3-2-load-error" class="header-anchor">#</a> 4.3.3.2 LOAD_ERROR</h5> <div class="language-html extra-class"><pre class="language-html"><code>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/error.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stylesheet<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/error.css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/error.gif<span class="token punctuation">&quot;</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>audio</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/error.mp3<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>audio</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/error.mp4<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
function formatLoadError (errorTarget) {
  return {
    type: LOAD_ERROR_TYPE[errorTarget.nodeName.toUpperCase()],
    desc: errorTarget.baseURI + '@' + (errorTarget.src || errorTarget.href),
    stack: 'no stack'
  }
}
{
    &quot;d&quot;: {
        &quot;type&quot;: &quot;error&quot;,
        &quot;code&quot;: 7,
        &quot;detail&quot;: {
            &quot;error_no&quot;: &quot;页面报错_SCRIPT_LOAD_ERROR&quot;,
            &quot;url&quot;: &quot;localhost:9000/&quot;
        },
        &quot;extra&quot;: {
            &quot;desc&quot;: &quot;http://localhost:9000/@http://localhost:9000/error.js&quot;,
            &quot;stack&quot;: &quot;no stack&quot;
        }
    }
}
{
    &quot;d&quot;: {
        &quot;type&quot;: &quot;error&quot;,
        &quot;code&quot;: 7,
        &quot;detail&quot;: {
            &quot;error_no&quot;: &quot;页面报错_CSS_LOAD_ERROR&quot;,
            &quot;url&quot;: &quot;localhost:9000/&quot;
        },
        &quot;extra&quot;: {
            &quot;desc&quot;: &quot;http://localhost:9000/@http://localhost:9000/error.css&quot;,
            &quot;stack&quot;: &quot;no stack&quot;
        }
    }
}
{
    &quot;d&quot;: {
        &quot;type&quot;: &quot;error&quot;,
        &quot;code&quot;: 7,
        &quot;detail&quot;: {
            &quot;error_no&quot;: &quot;页面报错_IMAGE_LOAD_ERROR&quot;,
            &quot;url&quot;: &quot;localhost:9000/&quot;
        },
        &quot;extra&quot;: {
            &quot;desc&quot;: &quot;http://localhost:9000/@http://localhost:9000/error.gif&quot;,
            &quot;stack&quot;: &quot;no stack&quot;
        }
    }
}
{
    &quot;d&quot;: {
        &quot;type&quot;: &quot;error&quot;,
        &quot;code&quot;: 7,
        &quot;detail&quot;: {
            &quot;error_no&quot;: &quot;页面报错_VIDEO_LOAD_ERROR&quot;,
            &quot;url&quot;: &quot;localhost:9000/&quot;
        },
        &quot;extra&quot;: {
            &quot;desc&quot;: &quot;http://localhost:9000/@http://localhost:9000/error.mp4&quot;,
            &quot;stack&quot;: &quot;no stack&quot;
        }
    }
}
{
    &quot;d&quot;: {
        &quot;type&quot;: &quot;error&quot;,
        &quot;code&quot;: 7,
        &quot;detail&quot;: {
            &quot;error_no&quot;: &quot;页面报错_AUDIO_LOAD_ERROR&quot;,
            &quot;url&quot;: &quot;localhost:9000/&quot;
        },
        &quot;extra&quot;: {
            &quot;desc&quot;: &quot;http://localhost:9000/@http://localhost:9000/error.mp3&quot;,
            &quot;stack&quot;: &quot;no stack&quot;
        }
    }
}
</code></pre></div><h5 id="_4-3-3-2-load-error-2"><a href="#_4-3-3-2-load-error-2" class="header-anchor">#</a> 4.3.3.2 LOAD_ERROR</h5> <div class="language-js extra-class"><pre class="language-js"><code> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'vue error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;error_no&quot;</span><span class="token operator">:</span> <span class="token string">&quot;页面报错_CONSOLE_ERROR&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost:9000/&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vue error&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_4-3-3-3-error-try-catch"><a href="#_4-3-3-3-error-try-catch" class="header-anchor">#</a> 4.3.3.3 ERROR_TRY_CATCH</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'未捕获错误'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span>dt<span class="token punctuation">.</span>tryJS<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>exec<span class="token punctuation">)</span><span class="token punctuation">;</span>
exec<span class="token punctuation">.</span><span class="token function">_wrapped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
        <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;error_no&quot;</span><span class="token operator">:</span> <span class="token string">&quot;页面报错_TRY_CATCH_ERROR&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost:9000/&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;desc&quot;</span><span class="token operator">:</span> <span class="token string">&quot;未捕获错误&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Error: 未捕获错误\n    at Function.exec (http://localhost:9000/:56:17)\n    at Function.func._wrapped (webpack-internal:///./src/js-tracker/try.js:31:21)\n    at http://localhost:9000/:59:14&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-4-手工上报"><a href="#_4-3-4-手工上报" class="header-anchor">#</a> 4.3.4 手工上报</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//错误上报</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Elog <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function-variable function">error</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> extra</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> extra<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//产品数据上报</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Plog <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function-variable function">product</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> extra</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'product'</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> extra<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//普通信息上报</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> Ilog <span class="token operator">=</span> log<span class="token punctuation">.</span><span class="token function-variable function">info</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> extra</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'info'</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> detail<span class="token punctuation">,</span> extra<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
window<span class="token punctuation">.</span>dt<span class="token punctuation">.</span><span class="token function">product</span><span class="token punctuation">(</span><span class="token parameter"><span class="token number">19999</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;d&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;product&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">19999</span><span class="token punctuation">,</span>
        <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-数据处理"><a href="#_5-数据处理" class="header-anchor">#</a> 5.数据处理</h2> <h3 id="_5-1-安装server"><a href="#_5-1-安装server" class="header-anchor">#</a> 5.1 安装server</h3> <div class="language-js extra-class"><pre class="language-js"><code>cd server 
npm install
</code></pre></div><h3 id="_5-2-配置"><a href="#_5-2-配置" class="header-anchor">#</a> 5.2 配置</h3> <h4 id="_5-2-1-配置mysql"><a href="#_5-2-1-配置mysql" class="header-anchor">#</a> 5.2.1 配置mysql</h4> <p>server\src\configs\mysql.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> development <span class="token operator">=</span> <span class="token punctuation">{</span>
  host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token string">'3306'</span><span class="token punctuation">,</span>
  user<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">'5f8b8a5d650637f8'</span><span class="token punctuation">,</span>
  database<span class="token operator">:</span> <span class="token string">'platform'</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-2-2-配置redis"><a href="#_5-2-2-配置redis" class="header-anchor">#</a> 5.2.2 配置redis</h4> <p>server\src\configs\redis.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> development <span class="token operator">=</span> <span class="token punctuation">{</span>
  host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token string">'6379'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-3-数据解析"><a href="#_5-3-数据解析" class="header-anchor">#</a> 5.3 数据解析</h3> <h3 id="_5-3-1-数据存储"><a href="#_5-3-1-数据存储" class="header-anchor">#</a> 5.3.1 数据存储</h3> <h3 id="_5-3-1-1-表名说明"><a href="#_5-3-1-1-表名说明" class="header-anchor">#</a> 5.3.1.1 表名说明</h3> <ul><li>所有表都以<code>t_</code>开头</li> <li>原始表添加<code>_o</code>后缀，即<code>t_o_</code></li> <li>结果表添加<code>-r</code>后续，即<code>t_r_</code></li> <li>表名、字段名默认使用下划线方式命名，不区分大小写</li> <li>数据库编码字符集为<code>utf8mb4</code></li> <li>记录ID用<code>unsigned bigint</code></li> <li>如果字段名有关键字，需要加<code>_c</code>前缀</li> <li>所有表中必须有<code>update_time</code> 和<code>create_time</code>字段</li></ul> <h3 id="_5-3-1-2-数据库表"><a href="#_5-3-1-2-数据库表" class="header-anchor">#</a> 5.3.1.2 数据库表</h3> <p>t_o_project 项目名</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>display_name</code> varchar(50) NOT NULL DEFAULT '' COMMENT '项目名称'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_name</code> varchar(50) NOT NULL DEFAULT '' COMMENT '项目代号(替代项目id, 方便debug)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>c_desc</code> varchar(100) NOT NULL DEFAULT '' COMMENT '备注信息'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>rate</code> int(10) NOT NULL DEFAULT '10000' COMMENT '数据抽样比率'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>is_delete</code> tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已删除(1 =&gt; 是, 0 =&gt; 否)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '创建人ucid'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '更新人ucid'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_behavior_distribution</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>code</code> varchar(50) NOT NULL DEFAULT '' COMMENT '用户行为标识'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>name</code> varchar(50) NOT NULL DEFAULT '' COMMENT '用户点击名称'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>url</code> varchar(200) NOT NULL DEFAULT '' COMMENT '用户点击页面'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) NOT NULL DEFAULT '0' COMMENT '点击总量'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(30) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同有三种可能, hour =&gt; YYYY-MM-DD_HH, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(20) NOT NULL DEFAULT 'day' COMMENT '统计尺度(hour/day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布详情记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_duration_distribution 用户停留时间表</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_stay_ms</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '总停留毫秒数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_uv</code> int(10) NOT NULL DEFAULT '0' COMMENT '总uv数(从uv表中获取)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(30) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同有两种可能, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(20) NOT NULL DEFAULT 'day' COMMENT '统计尺度(day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布详情记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_http_error_distribution</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'http响应码总数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>http_code_2xx_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'http响应码2xx总数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>http_code_3xx_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'http响应码3xx总数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>http_code_4xx_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'http响应码4xx总数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>http_code_5xx_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'http响应码5xx总数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>http_code_other_count</code> int(10) NOT NULL DEFAULT '0' COMMENT '其他http响应码总数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布详情记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(30) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同有三种可能, hour =&gt; YYYY-MM-DD_HH, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(20) NOT NULL DEFAULT 'hour' COMMENT '统计尺度(hour/day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_page_view</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'pv数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(30) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同有三种可能, hour =&gt; YYYY-MM-DD_HH, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(20) NOT NULL DEFAULT 'hour' COMMENT '统计尺度(hour/day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_system_browser</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>browser</code> varchar(20) NOT NULL DEFAULT '' COMMENT '浏览器品牌'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>browser_version</code> varchar(50) NOT NULL DEFAULT '' COMMENT '浏览器详情'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '数量总和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_month</code> varchar(15) NOT NULL DEFAULT '' COMMENT '统计时间段, YYYY-MM格式 =&gt; 2018-09'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_system_runtime_version</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>runtime_version</code> varchar(50) NOT NULL DEFAULT '' COMMENT '应用版本号'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '数量总和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_month</code> varchar(15) NOT NULL DEFAULT '' COMMENT '统计时间段, YYYY-MM格式 =&gt; 2018-09'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_system_device</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>device_vendor</code> varchar(50) NOT NULL DEFAULT '' COMMENT '设备制造商'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>device_model</code> varchar(50) NOT NULL DEFAULT '' COMMENT '设备详情'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '数量总和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_month</code> varchar(15) NOT NULL DEFAULT '' COMMENT '统计时间段, YYYY-MM格式 =&gt; 2018-09'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_system_os</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>os</code> varchar(50) NOT NULL DEFAULT '' COMMENT '操作系统名'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>os_version</code> varchar(50) NOT NULL DEFAULT '' COMMENT '操作系统版本'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '数量总和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_month</code> varchar(15) NOT NULL DEFAULT '' COMMENT '统计时间段, YYYY-MM格式 =&gt; 2018-09'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_unique_view</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) NOT NULL DEFAULT '0' COMMENT 'uv数'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(30) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同有三种可能, hour =&gt; YYYY-MM-DD_HH, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(20) NOT NULL DEFAULT 'hour' COMMENT '统计尺度(hour/day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_alarm_config</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '要报警项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>owner_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '项目所有人id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_type</code> varchar(20) NOT NULL DEFAULT '' COMMENT '报警错误类型'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_name</code> varchar(255) NOT NULL DEFAULT '' COMMENT '要报警错误名字'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>time_range_s</code> int(20) unsigned NOT NULL DEFAULT '0' COMMENT '报警时间范围_秒'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>max_error_count</code> int(20) unsigned NOT NULL DEFAULT '0' COMMENT '报警错误数阈值'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>alarm_interval_s</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '报警时间间隔_秒'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>is_enable</code> tinyint(1) unsigned NOT NULL DEFAULT '1' COMMENT '是否开启本条报警配置1：是0：否'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>note</code> varchar(255) NOT NULL DEFAULT '' COMMENT '配置说明'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>is_delete</code> tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否删除(1 =&gt; 是, 0 =&gt; 否)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '创建此记录的人'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '更新此记录的人'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '创建此记录的时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '更新此记录的时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_user</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>ucid</code> varchar(50) NOT NULL DEFAULT '' COMMENT '贝壳ucid'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>account</code> varchar(50) NOT NULL DEFAULT '' COMMENT '账户名,不能重复'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>email</code> varchar(50) NOT NULL DEFAULT '' COMMENT '邮箱'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>password_md5</code> varchar(32) NOT NULL DEFAULT '' COMMENT 'md5后的password'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>nickname</code> varchar(20) NOT NULL DEFAULT '' COMMENT '昵称'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>role</code> varchar(50) NOT NULL DEFAULT 'dev' COMMENT '角色(dev =&gt; 开发者,admin =&gt; 管理员)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>register_type</code> varchar(20) NOT NULL DEFAULT 'site' COMMENT '注册类型(site =&gt; 网站注册, third =&gt; 第三方登录)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>avatar_url</code> varchar(200) NOT NULL DEFAULT '<a href="https://ww1.sinaimg.cn/large/00749HCsly1fwofq2t1kaj30qn0qnaai.jpg'" target="_blank" rel="noopener noreferrer">http://ww1.sinaimg.cn/large/00749HCsly1fwofq2t1kaj30qn0qnaai.jpg'<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> COMMENT '头像地址, 默认使用贝壳logo'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>mobile</code> varchar(20) NOT NULL DEFAULT '' COMMENT '手机号'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>is_delete</code> tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否删除(1 =&gt; 是, 0 =&gt; 否)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_project_member</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '项目参与者ucid'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>role</code> varchar(20) NOT NULL DEFAULT '' COMMENT '参与者角色(owner =&gt; 组长, dev =&gt; 成员)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>need_alarm</code> tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否需要报警(0 =&gt; 不需要, 1 =&gt; 需要)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>is_delete</code> tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '是否已删除(0 =&gt; 未删除, 1 =&gt; 已删除)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '创建者ucid'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '更新者ucid'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '创建此记录的时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '更新此记录的时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_new_user_summary</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>total_count</code> int(10) NOT NULL DEFAULT '0' COMMENT '数量总和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(20) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同三两种可能, hour =&gt; YYYY-MM-DD_HH, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(10) NOT NULL DEFAULT 'day' COMMENT '统计尺度(hour/day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(10) NOT NULL DEFAULT 0 COMMENT '城市分布详情记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_alarm_log</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>project_id</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '要报警项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>config_id</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '报警配置id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>send_at</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '报警时间戳'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_type</code> varchar(20) NOT NULL DEFAULT '' COMMENT '错误类型'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_name</code> varchar(255) NOT NULL DEFAULT '' COMMENT '错误名字'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>message</code> varchar(500) NOT NULL DEFAULT '' COMMENT '报警信息'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_monitor_1_202005</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_type</code> varchar(20) NOT NULL DEFAULT '' COMMENT '异常类型(目前是四种,分别对应前端的四种报错类型: api_data =&gt;前端数据结构报警, start_process =&gt; 启动过程异常, load_wv =&gt; Url加载空服务报警, api_code =&gt; 请求接口异常报警)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_name</code> varchar(255) NOT NULL DEFAULT '' COMMENT '错误名/错误代码,用于细分错误类别'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>http_code</code> int(10) NOT NULL DEFAULT '0' COMMENT 'http状态码, 没有则为0'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>monitor_ext_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '详情id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>during_ms</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '接口请求时长, 单位毫秒'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>request_size_b</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '接口请求体积, 单位b'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>response_size_b</code> int(10) unsigned NOT NULL DEFAULT '0' COMMENT '接口响应体积, 单位b'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>url</code> varchar(255) NOT NULL DEFAULT '' COMMENT '发生异常的url'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>country</code> varchar(10) NOT NULL DEFAULT '' COMMENT '所属国家'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>province</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属省份'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属城市'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>log_at</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '日志记录时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>md5</code> char(32) NOT NULL DEFAULT '' COMMENT '记录生成MD5'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_monitor_ext_1_202005</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>ext_json</code> text COMMENT '异常记录扩展信息'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_uv_record_1_202005</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '项目id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>uuid</code> varchar(50) NOT NULL DEFAULT '' COMMENT '设备唯一标识'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>country</code> varchar(10) NOT NULL DEFAULT '' COMMENT '所属国家'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>province</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属省份'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属城市'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>visit_at_hour</code> varchar(20) NOT NULL DEFAULT '' COMMENT '访问日期, 数据格式为 YYYY-MM-DD_HH demo =&gt; 2018-08-02_23'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>pv_count</code> int(10) NOT NULL DEFAULT '0' COMMENT '时间段内同一uuid访问次数, 用于计算总pv'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_city_distribution_1_202005</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_json</code> text COMMENT '扩展字段'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_performance_1_202005</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>sum_indicator_value</code> bigInt(10) NOT NULL DEFAULT '0' COMMENT '性能指标求和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>pv</code> bigInt(10) NOT NULL DEFAULT '0' COMMENT '性能指标pv数,用于计算平均时长'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>indicator</code> varchar(50) NOT NULL DEFAULT '' COMMENT '性能指标:DNS响应时间/TCP时间/404数量/etc'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>url</code> varchar(255) NOT NULL DEFAULT '' COMMENT '页面url'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribute_id</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '城市分布详情记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(20) NOT NULL DEFAULT '' COMMENT '统计日期,格式根据统计尺度不同有四种可能, minute =&gt; YYYY-MM-DD_HH:mm, hour =&gt; YYYY-MM-DD_HH, day =&gt; YYYY-MM-DD, month =&gt; YYYY-MM'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(10) NOT NULL DEFAULT 'minute' COMMENT '统计尺度(minute/hour/day/month)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_system_collection_1</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>uuid</code> varchar(50) NOT NULL DEFAULT '' COMMENT '设备唯一标识'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>browser</code> varchar(50) NOT NULL DEFAULT '' COMMENT '浏览器品牌'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>browser_version</code> varchar(100) NOT NULL DEFAULT '' COMMENT '浏览器版本详情'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>engine</code> varchar(100) NOT NULL DEFAULT '' COMMENT '内核名称'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>engine_version</code> varchar(100) NOT NULL DEFAULT '' COMMENT '内核版本详情'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>device_vendor</code> varchar(100) NOT NULL DEFAULT '' COMMENT '手机品牌'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>device_model</code> varchar(100) NOT NULL DEFAULT '' COMMENT '手机型号'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>os</code> varchar(50) NOT NULL DEFAULT '' COMMENT '操作系统'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>os_version</code> varchar(50) NOT NULL DEFAULT '' COMMENT '操作系统详情'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>country</code> varchar(10) NOT NULL DEFAULT '' COMMENT '所属国家'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>province</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属省份'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属城市'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>runtime_version</code> varchar(50) NOT NULL DEFAULT '' COMMENT '应用版本'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>visit_at_month</code> varchar(20) NOT NULL DEFAULT '' COMMENT '访问日期, 数据格式为 YYYY-MM demo =&gt; 2018-09'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>log_at</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '日志记录时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '数据库更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_o_user_first_login_at_1</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>ucid</code> varchar(20) NOT NULL DEFAULT '' COMMENT '用户id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>first_visit_at</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '用户首次访问时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>country</code> varchar(10) NOT NULL DEFAULT '' COMMENT '所属国家'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>province</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属省份'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city</code> varchar(15) NOT NULL DEFAULT '' COMMENT '所属城市'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> bigint(20) NOT NULL DEFAULT '0' COMMENT '更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <p>t_r_error_summary_1_202005</p> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>id</code> bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '记录id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_type</code> varchar(20) NOT NULL DEFAULT '' COMMENT '错误类型'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_name</code> varchar(255) NOT NULL DEFAULT '' COMMENT '错误名字'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>url_path</code> varchar(255) NOT NULL DEFAULT '' COMMENT '错误URL_PATH'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>city_distribution_id</code> bigint(20) unsigned NOT NULL DEFAULT '0' COMMENT '城市分布详情id'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_at_time</code> varchar(20) NOT NULL DEFAULT '' COMMENT '统计时间(按类型不同,day:YYYY-MM-DD;hour:YYYY-MM-DD_HH;minute:YYYY-MM-DD_HH:mm)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>count_type</code> varchar(10) NOT NULL DEFAULT 'day' COMMENT '统计类型(day天,hour小时,minute分)'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>error_count</code> int(10) NOT NULL DEFAULT '0' COMMENT '数量总和'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>create_time</code> int(20) NOT NULL DEFAULT '0' COMMENT '创建时间'</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>update_time</code> int(20) NOT NULL DEFAULT '0' COMMENT '更新时间'</td> <td style="text-align:left;"></td></tr></tbody></table> <h3 id="_5-3-2-指令"><a href="#_5-3-2-指令" class="header-anchor">#</a> 5.3.2 指令</h3> <h4 id="_5-3-2-1-指令帮助"><a href="#_5-3-2-1-指令帮助" class="header-anchor">#</a> 5.3.2.1 指令帮助</h4> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js <span class="token operator">-</span>h
Usage<span class="token operator">:</span>
  command <span class="token punctuation">[</span>arguments<span class="token punctuation">]</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span>

Global Options<span class="token operator">:</span>
  <span class="token operator">--</span>env                            Set <span class="token constant">NODE_ENV</span> before running the commands
  <span class="token operator">--</span>no<span class="token operator">-</span>ansi                        Disable colored output

Available Commands<span class="token operator">:</span>
 Command
  Command<span class="token operator">:</span>Demo                     解析nginx日志<span class="token punctuation">,</span> 分析pv
 CreateCache
  CreateCache<span class="token operator">:</span>UpdatePerOneMinute   <span class="token punctuation">[</span>每<span class="token number">10</span>分钟执行一次<span class="token punctuation">]</span> 主动调用方法<span class="token punctuation">,</span> 更新Redis缓存<span class="token punctuation">,</span> 每<span class="token number">10</span>分钟更新一次
 Parse
  Parse<span class="token operator">:</span>Device                     <span class="token punctuation">[</span>按天<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 分析指定时间范围Device
  Parse<span class="token operator">:</span>MenuClick                  <span class="token punctuation">[</span>按天<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 用户点击情况
  Parse<span class="token operator">:</span>Monitor                    <span class="token punctuation">[</span>按分钟<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 分析Monitor
  Parse<span class="token operator">:</span>Performance                <span class="token punctuation">[</span>按小时<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 分析分钟级别的指定时间范围内的性能指标
  Parse<span class="token operator">:</span>TimeOnSiteByHour           <span class="token punctuation">[</span>按小时<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 分析记录指定时间范围内用户停留时长
  Parse<span class="token operator">:</span><span class="token constant">UV</span>                         <span class="token punctuation">[</span>按小时<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 分析记录指定时间范围内的uv
  Parse<span class="token operator">:</span>UserFirstLoginAt           <span class="token punctuation">[</span>按天<span class="token punctuation">]</span> 解析nginx日志<span class="token punctuation">,</span> 记录用户首次登陆时间
 SaveLog
  SaveLog<span class="token operator">:</span>Nginx                    每一分钟读取Nginx日志文件，并解析
 Summary
  Summary<span class="token operator">:</span>Error                    <span class="token punctuation">[</span>按分钟<span class="token operator">/</span>按小时<span class="token operator">/</span>按天<span class="token punctuation">]</span> 根据历史数据<span class="token punctuation">,</span> 汇总分析错误数
  Summary<span class="token operator">:</span>HttpError                <span class="token punctuation">[</span>按天<span class="token operator">/</span>按月<span class="token punctuation">]</span> 基于数据表做统计<span class="token punctuation">,</span> 统计http error分布情况
  Summary<span class="token operator">:</span>NewUser                  <span class="token punctuation">[</span>按小时<span class="token operator">/</span>按天<span class="token operator">/</span>按月<span class="token punctuation">]</span> 根据历史数据<span class="token punctuation">,</span> 汇总分析记录指定时间范围内的新增用户数
  Summary<span class="token operator">:</span>Performance              <span class="token punctuation">[</span>按小时<span class="token operator">/</span>按天<span class="token operator">/</span>按月<span class="token punctuation">]</span> 根据历史数据<span class="token punctuation">,</span> 汇总分析记录指定时间范围内的性能指标数据
  Summary<span class="token operator">:</span>SystemBrowser            <span class="token punctuation">[</span>按月<span class="token punctuation">]</span> 基于数据库统计浏览器占比
  Summary<span class="token operator">:</span>SystemDevice             <span class="token punctuation">[</span>按月<span class="token punctuation">]</span> 基于数据库统计设备占比
  Summary<span class="token operator">:</span>SystemOS                 <span class="token punctuation">[</span>按月<span class="token punctuation">]</span>基于数据库统计操作系统占比
  Summary<span class="token operator">:</span>SystemRuntimeVersion     <span class="token punctuation">[</span>按月<span class="token punctuation">]</span> 基于数据库统计浏览器占比
  Summary<span class="token operator">:</span>TimeOnSite               <span class="token punctuation">[</span>按天<span class="token operator">/</span>按月<span class="token punctuation">]</span> 根据历史数据<span class="token punctuation">,</span> 汇总分析记录指定时间范围内用户停留时长
  Summary<span class="token operator">:</span><span class="token constant">UV</span>                       <span class="token punctuation">[</span>按小时<span class="token operator">/</span>按天<span class="token operator">/</span>按月<span class="token punctuation">]</span> 根据历史数据<span class="token punctuation">,</span> 汇总分析记录指定时间范围内的uv
 Task
  Task<span class="token operator">:</span>Manager                     任务调度主进程<span class="token punctuation">,</span> 只能启动一次
 Utils
  Utils<span class="token operator">:</span>CleanOldLog                只保留当前月内数据<span class="token punctuation">,</span> 每月<span class="token number">20</span>号之后自动删除上个月数据
  Utils<span class="token operator">:</span>GenerateSQL                生成项目在指定日期范围内的建表<span class="token constant">SQL</span>
  Utils<span class="token operator">:</span>TemplateSQL                生成项目在指定日期范围内的建表<span class="token constant">SQL</span>
  Utils<span class="token operator">:</span>Test                       专业粘贴调试代码
  Utils<span class="token operator">:</span>TestUC                     测试<span class="token constant">UC</span>接口
 WatchDog
  WatchDog<span class="token operator">:</span>Alarm                   <span class="token punctuation">[</span>根据报警配置<span class="token punctuation">]</span> 监测每一条报警配置对应的项目错误
  WatchDog<span class="token operator">:</span>Saas                    <span class="token punctuation">[</span>按分钟<span class="token punctuation">]</span> 检查最近<span class="token number">5</span>分钟内错误数是否超出阈值<span class="token punctuation">,</span> 自动报警
</code></pre></div><h4 id="_5-3-2-2-初始化数据库"><a href="#_5-3-2-2-初始化数据库" class="header-anchor">#</a> 5.3.2.2 初始化数据库</h4> <ul><li>创建<code>platform</code>数据库</li> <li><code>npm run watch</code></li> <li><code>node dist/fee.js Utils:GenerateSQL 1 '2020-06' '2020-06' &gt; init.sql</code></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//id, 抽样比率, 项目名(展示), 项目id, 负责人信息</span>
<span class="token constant">REPLACE</span> <span class="token constant">INTO</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">t_o_project</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">id</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">rate</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">display_name</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">project_name</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">c_desc</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">is_delete</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">create_ucid</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update_ucid</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">create_time</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">update_time</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token constant">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'示例项目'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token string">'负责人'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-3-2-3-savelog-nginx"><a href="#_5-3-2-3-savelog-nginx" class="header-anchor">#</a> 5.3.2.3 SaveLog:Nginx</h4> <ul><li>每一分钟读取Nginx日志文件，并解析</li></ul> <p>server\src\library\nginx\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> logPath <span class="token operator">=</span> appConfig<span class="token punctuation">.</span>absoluteLogPath
</code></pre></div><p>server\src\configs\app.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> development <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'fee监控平台开发环境'</span><span class="token punctuation">,</span>
  port<span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
  proxy<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  absoluteLogPath<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> <span class="token string">'log'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js SaveLog<span class="token operator">:</span>Nginx
收到数据<span class="token punctuation">,</span> 当前共记录<span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>条数据
清洗后的日志路径 <span class="token constant">C</span><span class="token operator">:</span>\afirst\monitor\server\log\nginx\raw\month_202006\day_13\<span class="token number">16</span>\<span class="token number">14.</span>log

清洗后的日志路径 <span class="token constant">C</span><span class="token operator">:</span>\afirst\monitor\server\log\nginx\json\month_202006\day_13\<span class="token number">16</span>\<span class="token number">14.</span>log
<span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;perf&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">20001</span><span class="token punctuation">,</span>
    <span class="token string">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;connectStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791666</span><span class="token punctuation">,</span>
        <span class="token string">&quot;navigationStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791361</span><span class="token punctuation">,</span>
        <span class="token string">&quot;loadEventEnd&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domLoading&quot;</span><span class="token operator">:</span> <span class="token number">1592036791677</span><span class="token punctuation">,</span>
        <span class="token string">&quot;secureConnectionStart&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">&quot;fetchStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791362</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domContentLoadedEventStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791976</span><span class="token punctuation">,</span>
        <span class="token string">&quot;responseStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791669</span><span class="token punctuation">,</span>
        <span class="token string">&quot;responseEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592036791670</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domInteractive&quot;</span><span class="token operator">:</span> <span class="token number">1592036791976</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domainLookupEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592036791365</span><span class="token punctuation">,</span>
        <span class="token string">&quot;redirectStart&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">&quot;requestStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791667</span><span class="token punctuation">,</span>
        <span class="token string">&quot;unloadEventEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592036791674</span><span class="token punctuation">,</span>
        <span class="token string">&quot;unloadEventStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791674</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domComplete&quot;</span><span class="token operator">:</span> <span class="token number">1592036791976</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domainLookupStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791365</span><span class="token punctuation">,</span>
        <span class="token string">&quot;loadEventStart&quot;</span><span class="token operator">:</span> <span class="token number">1592036791976</span><span class="token punctuation">,</span>
        <span class="token string">&quot;domContentLoadedEventEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592036791976</span><span class="token punctuation">,</span>
        <span class="token string">&quot;redirectEnd&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token string">&quot;connectEnd&quot;</span><span class="token operator">:</span> <span class="token number">1592036791667</span><span class="token punctuation">,</span>
        <span class="token string">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost:9000/&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;extra&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;common&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;pid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;template&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;uuid2&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;ucid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ucid&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;is_test&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token string">&quot;record&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;time_on_page&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">&quot;performance&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">&quot;js_error&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">&quot;js_error_report_config&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token string">&quot;ERROR_RUNTIME&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_SCRIPT&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_STYLE&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_IMAGE&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_AUDIO&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_VIDEO&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_CONSOLE&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token string">&quot;ERROR_TRY_CATCH&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;b47ca710747e96f1c523ebab8022c19e9abaa56b&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token number">1592036791977</span><span class="token punctuation">,</span>
        <span class="token string">&quot;runtime_version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;sdk_version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.40&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;page_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost:9000/&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;md5&quot;</span><span class="token operator">:</span> <span class="token string">&quot;382eecc357bb7c6629e139eb7eb6509e&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;project_id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token string">&quot;project_name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;template&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;time&quot;</span><span class="token operator">:</span> <span class="token number">1592036792</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ua&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;ua&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;browser&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Mobile Safari&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;13.0.3&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;major&quot;</span><span class="token operator">:</span> <span class="token string">&quot;13&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;engine&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;WebKit&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;605.1.15&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;os&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;iOS&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;13.2.3&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;device&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">&quot;vendor&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Apple&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;model&quot;</span><span class="token operator">:</span> <span class="token string">&quot;iPhone&quot;</span><span class="token punctuation">,</span>
            <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mobile&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">&quot;cpu&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;ip&quot;</span><span class="token operator">:</span> <span class="token string">&quot;59.109.146.215&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;country&quot;</span><span class="token operator">:</span> <span class="token string">&quot;中国&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;province&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;city&quot;</span><span class="token operator">:</span> <span class="token string">&quot;北京&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-3-2-4-parse-performance"><a href="#_5-3-2-4-parse-performance" class="header-anchor">#</a> 5.3.2.4 Parse:Performance</h4> <ul><li>[按小时] 解析nginx日志, 分析分钟级别的指定时间范围内的性能指标</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Parse<span class="token operator">:</span>Performance <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13_16</span><span class="token operator">:</span><span class="token number">26</span>  <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13_16</span><span class="token operator">:</span><span class="token number">26</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">[</span>项目<span class="token constant">ID</span><span class="token punctuation">,</span>url<span class="token punctuation">,</span>指标<span class="token punctuation">,</span>汇总的时间<span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span>国家<span class="token punctuation">,</span>省<span class="token punctuation">,</span>市<span class="token punctuation">]</span><span class="token punctuation">,</span>value：<span class="token punctuation">{</span>指标和<span class="token operator">:</span><span class="token number">614</span><span class="token punctuation">,</span>pv和<span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;localhost:9000/&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tcp_connect_ms&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;2020-06-13_16:26&quot;</span><span class="token punctuation">]</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">&quot;中国&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;北京&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>value：<span class="token punctuation">{</span><span class="token string">&quot;sum_indicator_value&quot;</span><span class="token operator">:</span><span class="token number">614</span><span class="token punctuation">,</span><span class="token string">&quot;pv&quot;</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-3-2-5-summary-performance"><a href="#_5-3-2-5-summary-performance" class="header-anchor">#</a> 5.3.2.5 Summary:Performance</h4> <ul><li>[按小时/按天/按月] 根据历史数据, 汇总分析记录指定时间范围内的性能指标数据</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>Performance <span class="token string">&quot;2020-06-13 16&quot;</span> hour
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>Performance <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">13</span> day
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>Performance <span class="token number">2020</span><span class="token operator">-</span><span class="token number">06</span> month
</code></pre></div><h4 id="_5-3-2-5-parse-timeonsitebyhour"><a href="#_5-3-2-5-parse-timeonsitebyhour" class="header-anchor">#</a> 5.3.2.5 Parse:TimeOnSiteByHour</h4> <ul><li>[按小时] 解析nginx日志, 分析记录指定时间范围内用户停留时长</li> <li>t_r_city_distribution_1_202006</li> <li>t_r_duration_distribution</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js SaveLog<span class="token operator">:</span>Nginx
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Parse<span class="token operator">:</span>TimeOnSiteByHour <span class="token string">&quot;2020-06-13 22:30&quot;</span>  <span class="token string">&quot;2020-06-13 22:30&quot;</span>
</code></pre></div><h4 id="_5-3-2-6-summary-timeonsite"><a href="#_5-3-2-6-summary-timeonsite" class="header-anchor">#</a> 5.3.2.6 Summary:TimeOnSite</h4> <ul><li>[按小时] 解析nginx日志, 分析记录指定时间范围内用户停留时长</li> <li>t_r_duration_distribution</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>TimeOnSite <span class="token string">&quot;2020-06 13&quot;</span>  day
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>TimeOnSite <span class="token string">&quot;2020-06&quot;</span>  month
</code></pre></div><h4 id="_5-3-2-7-parse-monitor"><a href="#_5-3-2-7-parse-monitor" class="header-anchor">#</a> 5.3.2.7 Parse:Monitor</h4> <ul><li>[按分钟] 解析nginx日志, 分析Monitor</li> <li>t_o_monitor_1_202006</li> <li>t_o_monitor_ext_1_202006</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Parse<span class="token operator">:</span>Monitor <span class="token string">&quot;2020-06-13 22:35&quot;</span>  <span class="token string">&quot;2020-06-13 22:35&quot;</span>
</code></pre></div><h4 id="_5-3-2-8-summary-error"><a href="#_5-3-2-8-summary-error" class="header-anchor">#</a> 5.3.2.8 Summary:Error</h4> <ul><li><p>[按分钟/按小时/按天] 根据历史数据, 汇总分析错误数</p></li> <li><p>t_r_error_summary_1_202006</p> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>Error <span class="token string">&quot;2020-06-13 22:35&quot;</span>  minute
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>Error <span class="token string">&quot;2020-06-13 22&quot;</span> hour
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>Error <span class="token string">&quot;2020-06-13&quot;</span> day
</code></pre></div></li></ul> <h4 id="_5-3-2-9-parse-device"><a href="#_5-3-2-9-parse-device" class="header-anchor">#</a> 5.3.2.9 Parse:Device</h4> <ul><li>[按天] 解析nginx日志, 分析指定时间范围Device</li> <li>t_o_system_collection_1</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Parse<span class="token operator">:</span>Device <span class="token string">&quot;2020-06-13 22:58&quot;</span>  <span class="token string">&quot;2020-06-13 22:58&quot;</span>
projectMap<span class="token operator">=</span><span class="token punctuation">{</span>
  <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token string">&quot;2020-06&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
      <span class="token string">&quot;uuid&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;browser&quot;</span><span class="token operator">:</span><span class="token string">&quot;Mobile Safari&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-3-2-10-summary"><a href="#_5-3-2-10-summary" class="header-anchor">#</a> 5.3.2.10 Summary</h4> <ul><li>Summary:SystemBrowser [按月] 基于数据库统计浏览器占比</li> <li>Summary:SystemDevice [按月] 基于数据库统计设备占比</li> <li>Summary:SystemOS [按月]基于数据库统计操作系统占比</li> <li>Summary:SystemRuntimeVersion [按月] 基于数据库统计浏览器占比</li> <li>t_r_system_browser</li> <li>t_r_system_device</li> <li>t_r_system_os</li> <li>t_r_system_runtime_version</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>SystemBrowser <span class="token string">&quot;2020-06&quot;</span>  month
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>SystemDevice <span class="token string">&quot;2020-06&quot;</span>  month
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>SystemOS <span class="token string">&quot;2020-06&quot;</span>  month
node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Summary<span class="token operator">:</span>SystemRuntimeVersion <span class="token string">&quot;2020-06&quot;</span>  month
</code></pre></div><h2 id="_6-计划任务"><a href="#_6-计划任务" class="header-anchor">#</a> 6.计划任务</h2> <ul><li>server\src\commands\task\manage.js</li></ul> <h3 id="_6-1-任务执行周期"><a href="#_6-1-任务执行周期" class="header-anchor">#</a> 6.1 任务执行周期</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token number">1.</span>  <span class="token function">每分钟一次</span><span class="token punctuation">(</span>准实时<span class="token punctuation">)</span>
    <span class="token number">1.</span>  原始数据入库
        <span class="token number">1.</span>  <span class="token function">错误数据入库</span><span class="token punctuation">(</span>延迟<span class="token number">2</span>分钟<span class="token punctuation">)</span>
    <span class="token number">2.</span>  按分钟统计
        <span class="token number">1.</span>  <span class="token function">错误数据统计</span><span class="token punctuation">(</span>延迟<span class="token number">2</span>分钟<span class="token punctuation">)</span>
<span class="token number">2.</span>  每<span class="token number">10</span>分钟一次
    <span class="token number">1.</span>  原始数据入库
        <span class="token number">1.</span>  uv
        <span class="token number">2.</span>  页面性能指标
        <span class="token number">3.</span>  用户停留时长
    <span class="token number">2.</span>  按小时统计
        <span class="token number">1.</span>  uv
        <span class="token number">2.</span>  新用户数
        <span class="token number">3.</span>  页面性能指标
        <span class="token number">4.</span>  错误数据统计
<span class="token number">3.</span>  每小时一次
    <span class="token number">1.</span>  原始数据入库
        <span class="token number">1.</span>  设备数据
        <span class="token number">2.</span>  用户点击
        <span class="token number">3.</span>  首次登陆用户
    <span class="token number">2.</span>  <span class="token function">按天统计</span><span class="token punctuation">(</span>当天<span class="token punctuation">)</span>
        <span class="token number">1.</span>  uv
        <span class="token number">2.</span>  新用户数
        <span class="token number">3.</span>  页面性能指标
        <span class="token number">4.</span>  错误数据统计
        <span class="token number">5.</span>  用户停留时长
<span class="token number">4.</span>  每六小时一次
    <span class="token number">1.</span>  <span class="token function">按天统计</span><span class="token punctuation">(</span>昨日<span class="token punctuation">)</span>
        <span class="token number">1.</span>  uv
        <span class="token number">2.</span>  新用户数
        <span class="token number">3.</span>  页面性能指标
        <span class="token number">4.</span>  错误数据统计
        <span class="token number">5.</span>  用户停留时长
    <span class="token number">2.</span>  按月统计
        <span class="token number">1.</span>  uv
        <span class="token number">2.</span>  新用户数
        <span class="token number">3.</span>  页面性能指标
        <span class="token number">4.</span>  错误数据统计
        <span class="token number">5.</span>  用户停留时长
        <span class="token number">6.</span>  操作系统分布
        <span class="token number">7.</span>  设备分布
        <span class="token number">8.</span>  浏览器分布
</code></pre></div><h3 id="_6-2-执行任务"><a href="#_6-2-执行任务" class="header-anchor">#</a> 6.2 执行任务</h3> <ul><li><a href="https://cron.qqe2.com/" target="_blank" rel="noopener noreferrer">cron<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>fee<span class="token punctuation">.</span>js Task<span class="token operator">:</span>saveLog
<span class="token keyword">async</span> <span class="token function">handle</span> <span class="token punctuation">(</span><span class="token parameter">args<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    schedule<span class="token punctuation">.</span><span class="token function">scheduleJob</span><span class="token punctuation">(</span><span class="token string">'0 */1 * * * * *'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      that<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'registerTaskRepeatPer1Minute 开始执行'</span><span class="token punctuation">)</span>
      that<span class="token punctuation">.</span><span class="token function">execCommand</span><span class="token punctuation">(</span><span class="token string">'SaveLog:Nginx'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>  <span class="token operator">*</span>
┬ ┬ ┬ ┬ ┬ ┬
│ │ │ │ │  <span class="token operator">|</span>
│ │ │ │ │ └ day <span class="token keyword">of</span> <span class="token function">week</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0</span> or <span class="token number">7</span> is Sun<span class="token punctuation">)</span>
│ │ │ │ └───── <span class="token function">month</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">12</span><span class="token punctuation">)</span>
│ │ │ └────────── day <span class="token keyword">of</span> <span class="token function">month</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token number">31</span><span class="token punctuation">)</span>
│ │ └─────────────── <span class="token function">hour</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">23</span><span class="token punctuation">)</span>
│ └──────────────────── <span class="token function">minute</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">59</span><span class="token punctuation">)</span>
└───────────────────────── <span class="token function">second</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token number">59</span><span class="token punctuation">,</span> <span class="token constant">OPTIONAL</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_7-前台展示"><a href="#_7-前台展示" class="header-anchor">#</a> 7.前台展示</h2> <h3 id="_7-1-启动接口"><a href="#_7-1-启动接口" class="header-anchor">#</a> 7.1 启动接口</h3> <div class="language-js extra-class"><pre class="language-js"><code>node dist<span class="token operator">/</span>app<span class="token punctuation">.</span>js
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>behavior<span class="token operator">/</span>menu
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>behavior<span class="token operator">/</span>online
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>os
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>browser<span class="token operator">/</span>list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>browser
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>browser<span class="token operator">/</span>
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>runtimeVersion
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>error<span class="token operator">/</span>viser<span class="token operator">/</span>area<span class="token operator">/</span>
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>error<span class="token operator">/</span>log<span class="token operator">/</span>list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>error<span class="token operator">/</span>distribution<span class="token operator">/</span>url
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>error<span class="token operator">/</span>distribution<span class="token operator">/</span>
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>error<span class="token operator">/</span>distribution<span class="token operator">/</span>
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>error<span class="token operator">/</span>distribution<span class="token operator">/</span>
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>log<span class="token operator">/</span>content<span class="token operator">/</span>test
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span>add
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span>query
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span>list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span><span class="token keyword">delete</span>
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span>update
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span>error_name_list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>config<span class="token operator">/</span>error_type_list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>log
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>alarm<span class="token operator">/</span>log<span class="token operator">/</span>line
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>detail
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>search
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>update
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span><span class="token keyword">delete</span>
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>search_uc
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>register
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>modify<span class="token operator">/</span>password
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>modify<span class="token operator">/</span>msg
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>user<span class="token operator">/</span>destroy
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>login<span class="token operator">/</span>site
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>login<span class="token operator">/</span>uc
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>logout
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>login<span class="token operator">/</span>normal
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>login<span class="token operator">/</span>type
<span class="token function">不需要登录</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>login
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>item<span class="token operator">/</span>detail
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>item<span class="token operator">/</span>add
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>item<span class="token operator">/</span>list
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>item<span class="token operator">/</span><span class="token keyword">delete</span>
需要登录<span class="token punctuation">,</span><span class="token function">但不需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>item<span class="token operator">/</span>update
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>member<span class="token operator">/</span>add
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>member<span class="token operator">/</span>list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>member<span class="token operator">/</span><span class="token keyword">delete</span>
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>member<span class="token operator">/</span>update
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>summary<span class="token operator">/</span>new_user<span class="token operator">/</span>distribution_line
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>project<span class="token operator">/</span>summary<span class="token operator">/</span>new_user<span class="token operator">/</span>distribution_map
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>url_list
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>url<span class="token operator">/</span>overview
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>project<span class="token operator">/</span>overview
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>url<span class="token operator">/</span>line_chart
需要登录<span class="token punctuation">,</span><span class="token function">也需要检验项目权限</span><span class="token punctuation">(</span><span class="token parameter">Method<span class="token operator">:</span> <span class="token keyword">get</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token operator">/</span>api<span class="token operator">/</span>uv<span class="token operator">/</span>count
</code></pre></div><h3 id="_7-2-启动前台"><a href="#_7-2-启动前台" class="header-anchor">#</a> 7.2 启动前台</h3> <div class="language-js extra-class"><pre class="language-js"><code>cd client
cnpm i 
npm run start
</code></pre></div><h3 id="_7-3-前端应用"><a href="#_7-3-前端应用" class="header-anchor">#</a> 7.3 前端应用</h3> <p>client\src\router\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token <span class="token operator">&amp;&amp;</span> to<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token constant">LOGIN_PAGE_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 未登录且要跳转的页面不是登录页</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token constant">LOGIN_PAGE_NAME</span> <span class="token comment">// 跳转到登录页</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>server\src\routes\api\user\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> register <span class="token operator">=</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token function">routerConfigBuilder</span><span class="token punctuation">(</span><span class="token string">'/api/user/register'</span><span class="token punctuation">,</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token constant">METHOD_TYPE_POST</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> body <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>server\src\model\project\user.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">register</span> <span class="token punctuation">(</span><span class="token parameter">account<span class="token punctuation">,</span> userInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tableName <span class="token operator">=</span> <span class="token function">getTableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// t_o_user</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-4-页面性能"><a href="#_7-4-页面性能" class="header-anchor">#</a> 7.4 页面性能</h3> <p>http://localhost:8080/project/1/monitor/performance</p> <h4 id="_7-4-1-urllist"><a href="#_7-4-1-urllist" class="header-anchor">#</a> 7.4.1 urlList</h4> <ul><li>用来提供某时间范围内的URL性能列表，因为在查看性能指标的时候会按页面的URL来进行，所以在页面的初始阶段会提供一个接口函数来获取 这些性能指标对应的URL列表</li></ul> <p>client\src\view\performance\index.vue</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">async</span> <span class="token function">getUrlList</span> <span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>
        st<span class="token punctuation">,</span>
        et<span class="token punctuation">,</span>
        summaryBy
      <span class="token punctuation">}</span> <span class="token operator">=</span> params
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchUrlList</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        st<span class="token operator">:</span> st <span class="token operator">||</span> <span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>dateRange<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        et<span class="token operator">:</span> et <span class="token operator">||</span> <span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>dateRange<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        summaryBy<span class="token operator">:</span> summaryBy <span class="token operator">||</span> <span class="token string">'minute'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>urlData <span class="token operator">=</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        name<span class="token operator">:</span> item
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'urlData'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTimeDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTimeLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>urlColumns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>urlLoading <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>client\src\api\performance\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">fetchUrlList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">project/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getProjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/performance/url_list</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>params
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
Request <span class="token constant">URL</span><span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>project<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>url_list<span class="token operator">?</span>st<span class="token operator">=</span><span class="token number">1591977600000</span><span class="token operator">&amp;</span>et<span class="token operator">=</span><span class="token number">1592051809707</span><span class="token operator">&amp;</span>summaryBy<span class="token operator">=</span>minute
</code></pre></div><p>server\src\routes\api\performance\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> urlList <span class="token operator">=</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token function">routerConfigBuilder</span><span class="token punctuation">(</span><span class="token string">'/api/performance/url_list'</span><span class="token punctuation">,</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token constant">METHOD_TYPE_GET</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> projectId <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'fee'</span><span class="token punctuation">,</span> <span class="token string">'project'</span><span class="token punctuation">,</span> <span class="token string">'projectId'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'projectId '</span><span class="token punctuation">,</span>projectId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> request <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 获取开始&amp;结束时间</span>
  <span class="token keyword">let</span> startAt <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'st'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> endAt <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'et'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> summaryBy <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">'summaryBy'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">DATE_FORMAT</span><span class="token punctuation">.</span><span class="token constant">UNIT</span><span class="token punctuation">.</span><span class="token constant">DAY</span><span class="token punctuation">,</span> <span class="token constant">DATE_FORMAT</span><span class="token punctuation">.</span><span class="token constant">UNIT</span><span class="token punctuation">.</span><span class="token constant">HOUR</span><span class="token punctuation">,</span> <span class="token constant">DATE_FORMAT</span><span class="token punctuation">.</span><span class="token constant">UNIT</span><span class="token punctuation">.</span><span class="token constant">MINUTE</span><span class="token punctuation">]</span><span class="token punctuation">,</span> summaryBy<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">API_RES</span><span class="token punctuation">.</span><span class="token function">showError</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">summaryBy参数不正确</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> currentStamp <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>startAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    startAt <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>startAt <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    startAt <span class="token operator">=</span> currentStamp
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>endAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    endAt <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>endAt <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    endAt <span class="token operator">=</span> currentStamp
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> urlList <span class="token operator">=</span> <span class="token keyword">await</span> MPerformance<span class="token punctuation">.</span><span class="token function">getDistinctUrlListInRange</span><span class="token punctuation">(</span>projectId<span class="token punctuation">,</span> MPerformance<span class="token punctuation">.</span><span class="token constant">INDICATOR_TYPE_LIST</span><span class="token punctuation">,</span> startAt<span class="token punctuation">,</span> endAt<span class="token punctuation">,</span> summaryBy<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">API_RES</span><span class="token punctuation">.</span><span class="token function">showResult</span><span class="token punctuation">(</span>urlList<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>server\src\model\parse\performance.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getDistinctUrlListInRange</span> <span class="token punctuation">(</span><span class="token parameter">projectId<span class="token punctuation">,</span> indicatorList<span class="token punctuation">,</span> startAt<span class="token punctuation">,</span> endAt<span class="token punctuation">,</span> countType <span class="token operator">=</span> <span class="token constant">DATE_FORMAT</span><span class="token punctuation">.</span><span class="token constant">UNIT</span><span class="token punctuation">.</span><span class="token constant">MINUTE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tableName <span class="token keyword">of</span> tableNameList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tableName,countType,indicatorList,countAtTimeList'</span><span class="token punctuation">,</span>tableName<span class="token punctuation">,</span>countType<span class="token punctuation">,</span>indicatorList<span class="token punctuation">,</span>countAtTimeList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> rawRecordList <span class="token operator">=</span> <span class="token keyword">await</span> Knex
      <span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>tableName<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        count_type<span class="token operator">:</span> countType
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">whereIn</span><span class="token punctuation">(</span><span class="token string">'indicator'</span><span class="token punctuation">,</span> indicatorList<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">whereIn</span><span class="token punctuation">(</span><span class="token string">'count_at_time'</span><span class="token punctuation">,</span> countAtTimeList<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        Logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'查询失败, 错误原因 =&gt;'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> rawRecord <span class="token keyword">of</span> rawRecordList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>rawRecord<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> url <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>rawRecord<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        urlList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// performance distinctUrlList[&quot;localhost:9000/&quot;]</span>
</code></pre></div><h4 id="_7-4-2-linechartdata"><a href="#_7-4-2-linechartdata" class="header-anchor">#</a> 7.4.2 lineChartData</h4> <ul><li>在获取 URL之后，根据对应的时间参数提供参数时间范围内的提定URL下面的所有指标折线图</li></ul> <p>client\src\view\performance\index.vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getTimeDetail</span> <span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>
        st<span class="token punctuation">,</span>
        et<span class="token punctuation">,</span>
        url<span class="token punctuation">,</span>
        summaryBy
      <span class="token punctuation">}</span> <span class="token operator">=</span> params
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchTimeDetail</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        st<span class="token operator">:</span> st <span class="token operator">||</span> <span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>dateRange<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        et<span class="token operator">:</span> et <span class="token operator">||</span> <span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>dateRange<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        url<span class="token operator">:</span> url <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        summaryBy<span class="token operator">:</span> summaryBy <span class="token operator">||</span> <span class="token string">'hour'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> dv <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSet<span class="token punctuation">.</span>View</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
      dv<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'rename'</span><span class="token punctuation">,</span>
        map<span class="token operator">:</span> <span class="token punctuation">{</span>
          dns_lookup_ms<span class="token operator">:</span> <span class="token string">'DNS查询耗时'</span><span class="token punctuation">,</span>
          response_request_ms<span class="token operator">:</span> <span class="token string">'请求响应耗时'</span><span class="token punctuation">,</span>
          dom_parse_ms<span class="token operator">:</span> <span class="token string">'DOM解析耗时'</span><span class="token punctuation">,</span>
          response_transfer_ms<span class="token operator">:</span> <span class="token string">'内容传输耗时'</span><span class="token punctuation">,</span>
          load_resource_ms<span class="token operator">:</span> <span class="token string">'资源加载耗时'</span><span class="token punctuation">,</span>
          dom_ready_ms<span class="token operator">:</span> <span class="token string">'DOM_READY_耗时'</span><span class="token punctuation">,</span>
          first_render_ms<span class="token operator">:</span> <span class="token string">'首次渲染耗'</span><span class="token punctuation">,</span>
          first_response_ms<span class="token operator">:</span> <span class="token string">'首次可交互耗时'</span><span class="token punctuation">,</span>
          first_tcp_ms<span class="token operator">:</span> <span class="token string">'首包时间耗时'</span><span class="token punctuation">,</span>
          load_complete_ms<span class="token operator">:</span> <span class="token string">'页面完全加载耗时'</span><span class="token punctuation">,</span>
          ssl_connect_ms<span class="token operator">:</span> <span class="token string">'SSL连接耗时'</span><span class="token punctuation">,</span>
          tcp_connect_ms<span class="token operator">:</span> <span class="token string">'TCP链接耗时'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      dv<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'fold'</span><span class="token punctuation">,</span>
        fields<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'DNS查询耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'请求响应耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'DOM解析耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'内容传输耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'资源加载耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'DOM_READY_耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'首次渲染耗'</span><span class="token punctuation">,</span>
          <span class="token string">'首次可交互耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'首包时间耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'页面完全加载耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'SSL连接耗时'</span><span class="token punctuation">,</span>
          <span class="token string">'TCP链接耗时'</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        key<span class="token operator">:</span> <span class="token string">'type'</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> <span class="token string">'ms'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> data <span class="token operator">=</span> dv<span class="token punctuation">.</span>rows
      <span class="token keyword">this</span><span class="token punctuation">.</span>lineData <span class="token operator">=</span> data
      <span class="token keyword">const</span> scale <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        dataKey<span class="token operator">:</span> <span class="token string">'ms'</span><span class="token punctuation">,</span>
        sync<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        alias<span class="token operator">:</span> <span class="token string">'ms'</span><span class="token punctuation">,</span>
        <span class="token function-variable function">formatter</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value <span class="token operator">+</span> <span class="token string">' ms'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        dataKey<span class="token operator">:</span> <span class="token string">'index_timestamp_ms'</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'time'</span><span class="token punctuation">,</span>
        tickCount<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        mask<span class="token operator">:</span> <span class="token string">'MM-DD HH:mm'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>lineScale <span class="token operator">=</span> scale
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lineData <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lineScale<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>isSpinShowDetail <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">fetchTimeDetail</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">project/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getProjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/performance/url/line_chart</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>params
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>project<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>url<span class="token operator">/</span>line_chart<span class="token operator">?</span>st<span class="token operator">=</span><span class="token number">1591977600000</span><span class="token operator">&amp;</span>et<span class="token operator">=</span><span class="token number">1592053122452</span><span class="token operator">&amp;</span>url<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">9000</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">&amp;</span>summaryBy<span class="token operator">=</span>hour
</code></pre></div><p>server\src\routes\api\performance\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> lineChartData <span class="token operator">=</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token function">routerConfigBuilder</span><span class="token punctuation">(</span><span class="token string">'/api/performance/url/line_chart'</span><span class="token punctuation">,</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token constant">METHOD_TYPE_GET</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> projectId <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'fee'</span><span class="token punctuation">,</span> <span class="token string">'project'</span><span class="token punctuation">,</span> <span class="token string">'projectId'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> request <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">API_RES</span><span class="token punctuation">.</span><span class="token function">showResult</span><span class="token punctuation">(</span>resultList<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>server\src\model\parse\performance.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getDistinctUrlListInRange</span> <span class="token punctuation">(</span><span class="token parameter">projectId<span class="token punctuation">,</span> indicatorList<span class="token punctuation">,</span> startAt<span class="token punctuation">,</span> endAt<span class="token punctuation">,</span> countType <span class="token operator">=</span> <span class="token constant">DATE_FORMAT</span><span class="token punctuation">.</span><span class="token constant">UNIT</span><span class="token punctuation">.</span><span class="token constant">MINUTE</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</code></pre></div><h4 id="_7-4-3-urloverview"><a href="#_7-4-3-urloverview" class="header-anchor">#</a> 7.4.3 urlOverview</h4> <ul><li>在获取 URL之后，可以根据此接口提供的时间范围指定的URL的各项指标平均值</li></ul> <p>client\src\view\performance\index.vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">getTimeLine</span> <span class="token punctuation">(</span><span class="token parameter">params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>st<span class="token punctuation">,</span>et<span class="token punctuation">}</span> <span class="token operator">=</span> params
      <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchTimeLine</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        st<span class="token operator">:</span> st <span class="token operator">||</span> <span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>dateRange<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        et<span class="token operator">:</span> et <span class="token operator">||</span> <span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>dateRange<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        url<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span>
        summaryBy<span class="token operator">:</span> <span class="token string">'minute'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>client\src\api\performance\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">fetchTimeLine</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> axios<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">project/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getProjectId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api/performance/url/overview</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
    params<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>params
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3000</span><span class="token operator">/</span>project<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span>api<span class="token operator">/</span>performance<span class="token operator">/</span>url<span class="token operator">/</span>overview<span class="token operator">?</span>st<span class="token operator">=</span><span class="token number">1591977600000</span><span class="token operator">&amp;</span>et<span class="token operator">=</span><span class="token number">1592054332424</span><span class="token operator">&amp;</span>url<span class="token operator">=</span>localhost<span class="token operator">:</span><span class="token number">9000</span><span class="token operator">%</span><span class="token number">2</span>F<span class="token operator">&amp;</span>summaryBy<span class="token operator">=</span>minute
</code></pre></div><p>server\src\routes\api\performance\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> urlOverview <span class="token operator">=</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token function">routerConfigBuilder</span><span class="token punctuation">(</span><span class="token string">'/api/performance/url/overview'</span><span class="token punctuation">,</span> RouterConfigBuilder<span class="token punctuation">.</span><span class="token constant">METHOD_TYPE_GET</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> projectId <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'fee'</span><span class="token punctuation">,</span> <span class="token string">'project'</span><span class="token punctuation">,</span> <span class="token string">'projectId'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> request <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'query'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUrlOverviewInSameMonth</span> <span class="token punctuation">(</span><span class="token parameter">projectId<span class="token punctuation">,</span> urlList<span class="token punctuation">,</span> startAt<span class="token punctuation">,</span> endAt<span class="token punctuation">,</span> countType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><a href="https://gitee.com/zhufengpeixun/front-monitor" target="_blank" rel="noopener noreferrer">front-monitor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>node dist/fee.js Utils:TemplateSQL</code></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">6/27/2020, 10:22:10 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/other/05-monitor.html" class="prev">
        05. 工业级前端监控
      </a></span> <span class="next"><a href="/other/07-binary.html">
        07. 二进制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2af561cb.js" defer></script><script src="/assets/js/2.b2a5c435.js" defer></script><script src="/assets/js/17.5ecf2b4f.js" defer></script>
  </body>
</html>
