<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>01. HTTPS简介 | 珠峰架构</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.1657c744.css" as="style"><link rel="preload" href="/assets/js/app.2af561cb.js" as="script"><link rel="preload" href="/assets/js/2.b2a5c435.js" as="script"><link rel="preload" href="/assets/js/12.849e2da9.js" as="script"><link rel="prefetch" href="/assets/js/10.2b2c8443.js"><link rel="prefetch" href="/assets/js/11.689524dc.js"><link rel="prefetch" href="/assets/js/13.c798d95d.js"><link rel="prefetch" href="/assets/js/14.380c4ee7.js"><link rel="prefetch" href="/assets/js/15.d5753b2e.js"><link rel="prefetch" href="/assets/js/16.49eb1f17.js"><link rel="prefetch" href="/assets/js/17.5ecf2b4f.js"><link rel="prefetch" href="/assets/js/18.da9c8265.js"><link rel="prefetch" href="/assets/js/19.59d827ef.js"><link rel="prefetch" href="/assets/js/20.73eb42bb.js"><link rel="prefetch" href="/assets/js/21.8570b5b4.js"><link rel="prefetch" href="/assets/js/22.34094913.js"><link rel="prefetch" href="/assets/js/23.5209939b.js"><link rel="prefetch" href="/assets/js/24.53d92201.js"><link rel="prefetch" href="/assets/js/25.7241adf1.js"><link rel="prefetch" href="/assets/js/26.fecc2611.js"><link rel="prefetch" href="/assets/js/27.e50fca48.js"><link rel="prefetch" href="/assets/js/28.4c168acc.js"><link rel="prefetch" href="/assets/js/29.f5186710.js"><link rel="prefetch" href="/assets/js/3.ba1dcccd.js"><link rel="prefetch" href="/assets/js/30.33cb1c11.js"><link rel="prefetch" href="/assets/js/31.c088791d.js"><link rel="prefetch" href="/assets/js/32.3b724af5.js"><link rel="prefetch" href="/assets/js/33.f975c942.js"><link rel="prefetch" href="/assets/js/34.7d1f4bd2.js"><link rel="prefetch" href="/assets/js/35.26c11750.js"><link rel="prefetch" href="/assets/js/36.e8890e58.js"><link rel="prefetch" href="/assets/js/37.516eba46.js"><link rel="prefetch" href="/assets/js/38.4f8b8525.js"><link rel="prefetch" href="/assets/js/39.26f95568.js"><link rel="prefetch" href="/assets/js/4.fca74266.js"><link rel="prefetch" href="/assets/js/40.b9a8ffbb.js"><link rel="prefetch" href="/assets/js/41.fd02ea5f.js"><link rel="prefetch" href="/assets/js/42.d2483185.js"><link rel="prefetch" href="/assets/js/43.70bff2de.js"><link rel="prefetch" href="/assets/js/44.219702ca.js"><link rel="prefetch" href="/assets/js/45.aba93af9.js"><link rel="prefetch" href="/assets/js/46.447ba87c.js"><link rel="prefetch" href="/assets/js/47.519ddc28.js"><link rel="prefetch" href="/assets/js/48.fd8af347.js"><link rel="prefetch" href="/assets/js/49.b3783fa9.js"><link rel="prefetch" href="/assets/js/5.cc992e8b.js"><link rel="prefetch" href="/assets/js/50.0bb20f92.js"><link rel="prefetch" href="/assets/js/51.37ba1a59.js"><link rel="prefetch" href="/assets/js/52.054af132.js"><link rel="prefetch" href="/assets/js/53.5aca78a0.js"><link rel="prefetch" href="/assets/js/54.78c43f89.js"><link rel="prefetch" href="/assets/js/55.8ecaadc1.js"><link rel="prefetch" href="/assets/js/56.e844f110.js"><link rel="prefetch" href="/assets/js/57.530db0e9.js"><link rel="prefetch" href="/assets/js/58.8c839289.js"><link rel="prefetch" href="/assets/js/59.6634b409.js"><link rel="prefetch" href="/assets/js/6.b8b36e50.js"><link rel="prefetch" href="/assets/js/60.7ebe5787.js"><link rel="prefetch" href="/assets/js/61.bfe89a8b.js"><link rel="prefetch" href="/assets/js/62.4cdf6e8c.js"><link rel="prefetch" href="/assets/js/63.a0e80f0d.js"><link rel="prefetch" href="/assets/js/64.62a1b782.js"><link rel="prefetch" href="/assets/js/65.7be0994b.js"><link rel="prefetch" href="/assets/js/66.5a592a8e.js"><link rel="prefetch" href="/assets/js/67.40b4291c.js"><link rel="prefetch" href="/assets/js/68.2ac34b58.js"><link rel="prefetch" href="/assets/js/69.728773d5.js"><link rel="prefetch" href="/assets/js/7.0414e914.js"><link rel="prefetch" href="/assets/js/70.30137f66.js"><link rel="prefetch" href="/assets/js/71.7735c9fc.js"><link rel="prefetch" href="/assets/js/72.e9f43339.js"><link rel="prefetch" href="/assets/js/73.2d754e71.js"><link rel="prefetch" href="/assets/js/74.bf70dd09.js"><link rel="prefetch" href="/assets/js/75.18c28356.js"><link rel="prefetch" href="/assets/js/76.a0626bc9.js"><link rel="prefetch" href="/assets/js/77.dfde57e0.js"><link rel="prefetch" href="/assets/js/78.b380a0d6.js"><link rel="prefetch" href="/assets/js/79.f7bafb5d.js"><link rel="prefetch" href="/assets/js/8.c3544379.js"><link rel="prefetch" href="/assets/js/80.ade6c33e.js"><link rel="prefetch" href="/assets/js/81.6335ba85.js"><link rel="prefetch" href="/assets/js/82.9d01c14e.js"><link rel="prefetch" href="/assets/js/83.47911fdd.js"><link rel="prefetch" href="/assets/js/9.844fca3b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1657c744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">珠峰架构</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable"><span>react</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/flutter/" class="sidebar-heading clickable"><span>flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/" class="sidebar-heading clickable"><span>interview</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/other/" class="sidebar-heading clickable router-link-active open"><span>other</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/other/01-https.html" class="active sidebar-link">01. HTTPS简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/01-https.html#_01-https简介" class="sidebar-link">01. HTTPS简介</a></li><li class="sidebar-sub-header"><a href="/other/01-https.html#_1-加密" class="sidebar-link">1. 加密</a></li><li class="sidebar-sub-header"><a href="/other/01-https.html#_2-udp服务器" class="sidebar-link">2. UDP服务器</a></li><li class="sidebar-sub-header"><a href="/other/01-https.html#_3-数字证书实战" class="sidebar-link">3. 数字证书实战</a></li></ul></li><li><a href="/other/02-serverless.html" class="sidebar-link">02. Serverless</a></li><li><a href="/other/03-rbac.html" class="sidebar-link">03. RBAC</a></li><li><a href="/other/04-websocket.html" class="sidebar-link">04. WebSocket</a></li><li><a href="/other/05-monitor.html" class="sidebar-link">05. 工业级前端监控</a></li><li><a href="/other/06-monitor-2.html" class="sidebar-link">06. 工业级前端监控2</a></li><li><a href="/other/07-binary.html" class="sidebar-link">07. 二进制</a></li><li><a href="/other/08-binary-2.html" class="sidebar-link">08. 二进制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_01-https简介"><a href="#_01-https简介" class="header-anchor">#</a> 01. HTTPS简介</h2> <h3 id="_0-1-ssl和tls"><a href="#_0-1-ssl和tls" class="header-anchor">#</a> 0.1. SSL和TLS</h3> <ul><li>传输层安全性协议(Transport Layer Security，缩写TLS），及其前身安全套接层(Secure Sockets Layer,缩写SSL）是一种安全协议，目的是为互联网通信，提供安全及数据完整性保障</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043435.png" alt="https_http"></p> <h3 id="_0-2-https"><a href="#_0-2-https" class="header-anchor">#</a> 0.2. HTTPS</h3> <ul><li>HTTPS 协议的主要功能基本都依赖于 TLS/SSL 协议，TLS/SSL 的功能实现主要依赖于三类基本算法
<ul><li>散列函数 散列函数验证信息的完整性</li> <li>对称加密 对称加密算法采用协商的密钥对数据加密</li> <li>非对称加密 非对称加密实现身份认证和密钥协商</li></ul></li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043440.png" alt="tls_ssl"></p> <h2 id="_1-加密"><a href="#_1-加密" class="header-anchor">#</a> 1. 加密</h2> <ul><li>加密就是研究如何安全通信的</li> <li>保证数据在传输过程中不会被窃听</li> <li><a href="https://nodejs.org/dist/latest-v13.x/docs/api/crypto.html" target="_blank" rel="noopener noreferrer">crypto<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_1-1-对称加密"><a href="#_1-1-对称加密" class="header-anchor">#</a> 1.1 对称加密</h3> <ul><li>对称加密是最快速、最简单的一种加密方式,加密(encryption)与解密(decryption)用的是同样的密钥(secret key)</li> <li>主流的有<code>AES</code>和<code>DES</code></li></ul> <h4 id="_1-1-1-描述"><a href="#_1-1-1-描述" class="header-anchor">#</a> 1.1.1 描述</h4> <h4 id="_1-1-2-简单实现"><a href="#_1-1-2-简单实现" class="header-anchor">#</a> 1.1.2 简单实现</h4> <ul><li>消息 <code>abc</code></li> <li>密钥 3</li> <li>密文 def</li> <li></li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043445.png" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> secretKey <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> secretKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buffer <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> secretKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">'abc'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> secret <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-1-3-aes"><a href="#_1-1-3-aes" class="header-anchor">#</a> 1.1.3 AES</h4> <ul><li>crypto.html
<ul><li>algorithm用于指定加密算法，如aes-128-ecb、aes-128-cbc等</li> <li>key是用于加密的密钥</li> <li>iv参数用于指定加密时所用的向量</li></ul></li> <li>如果加密算法是128，则对应的密钥是16位，加密算法是256，则对应的密钥是32位</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043450.png" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createCipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-128-cbc'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> decipher <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createDecipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-128-cbc'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token string">'1234567890123456'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> iv <span class="token operator">=</span> <span class="token string">'1234567890123456'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> encrypted <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;数据加密后:&quot;</span><span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> decrypted <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>encrypted<span class="token punctuation">,</span> key<span class="token punctuation">,</span> iv<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;数据解密后:&quot;</span><span class="token punctuation">,</span> decrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-2-非对称加密"><a href="#_1-2-非对称加密" class="header-anchor">#</a> 1.2 非对称加密</h3> <ul><li>互联网上没有办法安全的交换密钥</li></ul> <h4 id="_1-2-1-单向函数"><a href="#_1-2-1-单向函数" class="header-anchor">#</a> 1.2.1 单向函数</h4> <ul><li>单向函数顺向计算起来非常的容易，但求逆却非常的困难。也就是说，已知x，我们很容易计算出f(x)。但已知f(x)，却很难计算出x</li> <li>整数分解又称素因数分解,是将一个正整数写成几个约数的乘积</li> <li>给出<code>45</code>这个数，它可以分解成 <code>9×5</code>,这样的分解结果应该是独一无二的</li></ul> <h4 id="_1-2-2-rsa加密算法"><a href="#_1-2-2-rsa加密算法" class="header-anchor">#</a> 1.2.2 RSA加密算法</h4> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043455.png" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> q <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">;</span><span class="token comment">//计算完立刻销毁</span>
<span class="token keyword">let</span> <span class="token constant">N</span> <span class="token operator">=</span> p <span class="token operator">*</span> q<span class="token punctuation">;</span>
<span class="token keyword">let</span> fN <span class="token operator">=</span> <span class="token punctuation">(</span>p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>q <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//欧拉函数</span>
<span class="token keyword">let</span> e <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> d <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> e <span class="token operator">*</span> d <span class="token operator">%</span> fN <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">;</span> d<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//拓展欧几里得算法</span>
    d<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//d=3</span>
<span class="token keyword">let</span> publicKey <span class="token operator">=</span> <span class="token punctuation">{</span> e<span class="token punctuation">,</span> <span class="token constant">N</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> privateKey <span class="token operator">=</span> <span class="token punctuation">{</span> d<span class="token punctuation">,</span> <span class="token constant">N</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> publicKey<span class="token punctuation">.</span>e<span class="token punctuation">)</span> <span class="token operator">%</span> publicKey<span class="token punctuation">.</span><span class="token constant">N</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> privateKey<span class="token punctuation">.</span>d<span class="token punctuation">)</span> <span class="token operator">%</span> privateKey<span class="token punctuation">.</span><span class="token constant">N</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> secret <span class="token operator">=</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//14</span>

<span class="token keyword">let</span> _data <span class="token operator">=</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//5</span>
<span class="token comment">// 1024位二进制数分解</span>
<span class="token comment">/**
公开 N e c
私密 d
e * d % fN == 1
(p - 1) * (q - 1)
N = p * q
*/</span>
</code></pre></div><h4 id="_1-2-3-rsa加密"><a href="#_1-2-3-rsa加密" class="header-anchor">#</a> 1.2.3 RSA加密</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> generateKeyPairSync<span class="token punctuation">,</span> privateEncrypt<span class="token punctuation">,</span> publicDecrypt <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> rsa <span class="token operator">=</span> <span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    modulusLength<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    publicKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span>
        cipher<span class="token operator">:</span> <span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span>
        passphrase<span class="token operator">:</span> <span class="token string">'server_passphrase'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> enc_by_prv <span class="token operator">=</span> <span class="token function">privateEncrypt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    key<span class="token operator">:</span> rsa<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span> passphrase<span class="token operator">:</span> <span class="token string">'server_passphrase'</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encrypted by private key: '</span> <span class="token operator">+</span> enc_by_prv<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">let</span> dec_by_pub <span class="token operator">=</span> <span class="token function">publicDecrypt</span><span class="token punctuation">(</span>rsa<span class="token punctuation">.</span>publicKey<span class="token punctuation">,</span> enc_by_prv<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'decrypted by public key: '</span> <span class="token operator">+</span> dec_by_pub<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-3-哈希"><a href="#_1-3-哈希" class="header-anchor">#</a> 1.3 哈希</h3> <ul><li>hash 切碎的食物</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043502.jpg" alt="img"></p> <h4 id="_1-3-1-哈希函数"><a href="#_1-3-1-哈希函数" class="header-anchor">#</a> 1.3.1 哈希函数</h4> <ul><li>哈希函数的作用是给一个任意长度的数据生成出一个固定长度的数据</li> <li>安全性 可以从给定的数据X计算出哈希值Y，但不能从哈希值Y计算机数据X</li> <li>独一无二 不同的数据一定会产出不同的哈希值</li> <li>长度固定 不管输入多大的数据,输出长度都是固定的</li></ul> <h4 id="_1-3-2-哈希碰撞"><a href="#_1-3-2-哈希碰撞" class="header-anchor">#</a> 1.3.2 哈希碰撞</h4> <ul><li>所谓哈希(hash),就是将不同的输入映射成独一无二的、固定长度的值（又称&quot;哈希值&quot;）。它是最常见的软件运算之一</li> <li>如果不同的输入得到了同一个哈希值,就发生了哈希碰撞(collision)</li> <li>防止哈希碰撞的最有效方法，就是扩大哈希值的取值空间</li> <li>16个二进制位的哈希值，产生碰撞的可能性是 65536 分之一。也就是说，如果有65537个用户，就一定会产生碰撞。哈希值的长度扩大到32个二进制位，碰撞的可能性就会下降到 <code>4,294,967,296</code> 分之一</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//65536</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//42亿</span>
</code></pre></div><h4 id="_1-3-3-哈希分类"><a href="#_1-3-3-哈希分类" class="header-anchor">#</a> 1.3.3 哈希分类</h4> <ul><li>哈希还可以叫摘要(digest)、校验值(chunkSum)和指纹(fingerPrint)</li> <li>如果两段数据完全一样,就可以证明数据是一样的</li> <li>哈希有二种
<ul><li>普通哈希用来做完整性校验，流行的是MD5</li> <li>加密哈希用来做加密,目前最流行的加密算法是 SHA256( Secure Hash Algorithm) 系列</li></ul></li></ul> <h4 id="_1-3-4-hash使用"><a href="#_1-3-4-hash使用" class="header-anchor">#</a> 1.3.4 hash使用</h4> <h5 id="_1-3-4-1-简单哈希"><a href="#_1-3-4-1-简单哈希" class="header-anchor">#</a> 1.3.4.1 简单哈希</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> input <span class="token operator">%</span> <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> r1 <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> r2 <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token number">1124</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r1<span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-3-4-2-md5"><a href="#_1-3-4-2-md5" class="header-anchor">#</a> 1.3.4.2 md5</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> content <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> result <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&quot;hex&quot;</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//32位十六进制 = 128位二进制</span>
</code></pre></div><h5 id="_1-3-4-3-sha256"><a href="#_1-3-4-3-sha256" class="header-anchor">#</a> 1.3.4.3 sha256</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> salt <span class="token operator">=</span> <span class="token string">'123456'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">sha256</span> <span class="token operator">=</span> <span class="token parameter">str</span> <span class="token operator">=&gt;</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//64位十六进制 = 256位二进制</span>
</code></pre></div><h3 id="_1-4-数字签名"><a href="#_1-4-数字签名" class="header-anchor">#</a> 1.4 数字签名</h3> <ul><li>数字签名的基本原理是用私钥去签名，而用公钥去验证签名</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043511.png" alt="img"></p> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043515.png" alt="img"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> generateKeyPairSync<span class="token punctuation">,</span> createSign<span class="token punctuation">,</span> createVerify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> passphrase <span class="token operator">=</span> <span class="token string">'zhufeng'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> rsa <span class="token operator">=</span> <span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    modulusLength<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    publicKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span>
        cipher<span class="token operator">:</span> <span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span>
        passphrase
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token string">'hello'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token function">getSign</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> rsa<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span> passphrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> serverCertIsValid <span class="token operator">=</span> <span class="token function">verifySign</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> rsa<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'serverCertIsValid'</span><span class="token punctuation">,</span> serverCertIsValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> passphrase</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sign <span class="token operator">=</span> <span class="token function">createSign</span><span class="token punctuation">(</span><span class="token string">'RSA-SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sign<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sign<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> privateKey<span class="token punctuation">,</span> format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span> passphrase <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">verifySign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> publicKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> verify <span class="token operator">=</span> <span class="token function">createVerify</span><span class="token punctuation">(</span><span class="token string">'RSA-SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    verify<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> verify<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-5-数字证书"><a href="#_1-5-数字证书" class="header-anchor">#</a> 1.5 数字证书</h3> <ul><li>数字证书是一个由可信的第三方发出的，用来证明所有人身份以及所有人拥有某个公钥的电子文件</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043521.png" alt="img"></p> <h4 id="_1-5-1-数字证书原理"><a href="#_1-5-1-数字证书原理" class="header-anchor">#</a> 1.5.1 数字证书原理</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> generateKeyPairSync<span class="token punctuation">,</span> createSign<span class="token punctuation">,</span> createVerify<span class="token punctuation">,</span> createHash <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> passphrase <span class="token operator">=</span> <span class="token string">'zhufeng'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> rsa <span class="token operator">=</span> <span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    modulusLength<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    publicKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span>
        cipher<span class="token operator">:</span> <span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span>
        passphrase
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
    domain<span class="token operator">:</span> <span class="token string">&quot;http://127.0.0.1:8080&quot;</span><span class="token punctuation">,</span>
    publicKey<span class="token operator">:</span> rsa<span class="token punctuation">.</span>publicKey
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token function">getSign</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> rsa<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span> passphrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cert <span class="token operator">=</span> <span class="token punctuation">{</span> info<span class="token punctuation">,</span> sign <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> certIsValid <span class="token operator">=</span> <span class="token function">verifySign</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> cert<span class="token punctuation">.</span>sign<span class="token punctuation">,</span> rsa<span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'certIsValid'</span><span class="token punctuation">,</span> certIsValid<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> passphrase</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sign <span class="token operator">=</span> <span class="token function">createSign</span><span class="token punctuation">(</span><span class="token string">'RSA-SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sign<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sign<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> privateKey<span class="token punctuation">,</span> format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span> passphrase <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">verifySign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> publicKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> verify <span class="token operator">=</span> <span class="token function">createVerify</span><span class="token punctuation">(</span><span class="token string">'RSA-SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    verify<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> verify<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-6-diffie-hellman算法"><a href="#_1-6-diffie-hellman算法" class="header-anchor">#</a> 1.6 Diffie-Hellman算法</h3> <ul><li>Diffie-Hellman算法是一种密钥交换协议，它可以让双方在不泄漏密钥的情况下协商出一个密钥来</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043527.jpg" alt="img"></p> <h4 id="_1-6-1-diffie-hellman实现"><a href="#_1-6-1-diffie-hellman实现" class="header-anchor">#</a> 1.6.1 Diffie-Hellman实现</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token constant">N</span> <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> secret1 <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//这是密钥</span>
<span class="token keyword">let</span> <span class="token constant">A</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> secret1<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">N</span><span class="token punctuation">;</span><span class="token comment">//8</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p='</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">'N='</span><span class="token punctuation">,</span> <span class="token constant">N</span><span class="token punctuation">,</span> <span class="token string">'A='</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> secret2 <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">B</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> secret2<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">N</span><span class="token punctuation">;</span><span class="token comment">//19</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p='</span><span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token string">'N='</span><span class="token punctuation">,</span> <span class="token constant">N</span><span class="token punctuation">,</span> <span class="token string">'B='</span><span class="token punctuation">,</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> secret1<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">N</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token constant">A</span><span class="token punctuation">,</span> secret2<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">N</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-6-2-diffie-hellman算法"><a href="#_1-6-2-diffie-hellman算法" class="header-anchor">#</a> 1.6.2 Diffie-Hellman算法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createDiffieHellman <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token function">createDiffieHellman</span><span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> client_keys <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> prime <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getPrime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> generator <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">getGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> <span class="token function">createDiffieHellman</span><span class="token punctuation">(</span>prime<span class="token punctuation">,</span> generator<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server_keys <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> client_secret <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>server_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server_secret <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>client_keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'client_secret: '</span> <span class="token operator">+</span> client_secret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'server_secret: '</span> <span class="token operator">+</span> server_secret<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_1-7-ecc"><a href="#_1-7-ecc" class="header-anchor">#</a> 1.7 ECC</h3> <ul><li>椭圆曲线加密算法(ECC) 是基于椭圆曲线数学的一种公钥加密的算法</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043532.png" alt="img"></p> <h4 id="_1-7-1-ecc原理"><a href="#_1-7-1-ecc原理" class="header-anchor">#</a> 1.7.1 ECC原理</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token constant">G</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token constant">G</span> <span class="token operator">*</span> a<span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">B</span> <span class="token operator">=</span> <span class="token constant">G</span> <span class="token operator">*</span> b<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token constant">B</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b <span class="token operator">*</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_1-7-2-ecc使用"><a href="#_1-7-2-ecc使用" class="header-anchor">#</a> 1.7.2 ECC使用</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token punctuation">{</span> createECDH <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> clientDH <span class="token operator">=</span> <span class="token function">createECDH</span><span class="token punctuation">(</span><span class="token string">'secp521r1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> clientDHParams <span class="token operator">=</span> clientDH<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> serverDH <span class="token operator">=</span> <span class="token function">createECDH</span><span class="token punctuation">(</span><span class="token string">'secp521r1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serverDHParams <span class="token operator">=</span> serverDH<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> clientKey <span class="token operator">=</span> clientDH<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>serverDHParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serverKey <span class="token operator">=</span> serverDH<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>clientDHParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'clientKey'</span><span class="token punctuation">,</span> clientKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'serverKey'</span><span class="token punctuation">,</span> serverKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_2-udp服务器"><a href="#_2-udp服务器" class="header-anchor">#</a> 2. UDP服务器</h2> <p><img src="http://img.zhufengpeixun.cn/wiresharkhttp.png" alt="wiresharkhttp"></p> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043537.png" alt="img"></p> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-25-043542.png" alt="img"></p> <p>wireshark</p> <div class="language- extra-class"><pre class="language-text"><code>tls and (ip.src == 47.111.100.159 or ip.dst == 47.111.100.159)
</code></pre></div><h3 id="_2-1-createca-js"><a href="#_2-1-createca-js" class="header-anchor">#</a> 2.1 createCA.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> ca_passphrase <span class="token operator">=</span> <span class="token string">'ca'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">CA</span> <span class="token operator">=</span> <span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    modulusLength<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    publicKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span>
        cipher<span class="token operator">:</span> <span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span>
        passphrase<span class="token operator">:</span> ca_passphrase
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'CA.publicKey'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">CA</span><span class="token punctuation">.</span>publicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'CA.privateKey'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">CA</span><span class="token punctuation">.</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-2-ca-js"><a href="#_2-2-ca-js" class="header-anchor">#</a> 2.2 ca.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createHash <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getSign <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ca_passphrase <span class="token operator">=</span> <span class="token string">'ca'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> cAPrivateKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'CA.privateKey'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">requestCert</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> infoHash <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> sign <span class="token operator">=</span> <span class="token function">getSign</span><span class="token punctuation">(</span>infoHash<span class="token punctuation">,</span> cAPrivateKey<span class="token punctuation">,</span> ca_passphrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span> info<span class="token punctuation">,</span> sign <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>requestCert <span class="token operator">=</span> requestCert<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-3-utils-js"><a href="#_2-3-utils-js" class="header-anchor">#</a> 2.3 utils.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> createCipheriv<span class="token punctuation">,</span> createDecipheriv<span class="token punctuation">,</span> createSign<span class="token punctuation">,</span> createVerify <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> decipher <span class="token operator">=</span> <span class="token function">createCipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">'1234567890123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> decipher <span class="token operator">=</span> <span class="token function">createDecipheriv</span><span class="token punctuation">(</span><span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">'1234567890123456'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    decipher<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> decipher<span class="token punctuation">.</span><span class="token function">final</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getSign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> privateKey<span class="token punctuation">,</span> passphrase</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> sign <span class="token operator">=</span> <span class="token function">createSign</span><span class="token punctuation">(</span><span class="token string">'RSA-SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sign<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sign<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> key<span class="token operator">:</span> privateKey<span class="token punctuation">,</span> format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span> passphrase <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">verifySign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> publicKey</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> verify <span class="token operator">=</span> <span class="token function">createVerify</span><span class="token punctuation">(</span><span class="token string">'RSA-SHA256'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    verify<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> verify<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>publicKey<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    encrypt<span class="token punctuation">,</span> decrypt<span class="token punctuation">,</span> getSign<span class="token punctuation">,</span> verifySign
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-4-udp-server-js"><a href="#_2-4-udp-server-js" class="header-anchor">#</a> 2.4 udp_server.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dgram <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dgram'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> udp_server <span class="token operator">=</span> dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">'udp4'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> protocol <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./protocol'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> generateKeyPairSync<span class="token punctuation">,</span> randomBytes<span class="token punctuation">,</span> createHash<span class="token punctuation">,</span> createECDH <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server_passphrase <span class="token operator">=</span> <span class="token string">'server'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> getSign<span class="token punctuation">,</span> decrypt<span class="token punctuation">,</span> encrypt <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> requestCert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./ca'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> serverRSA <span class="token operator">=</span> <span class="token function">generateKeyPairSync</span><span class="token punctuation">(</span><span class="token string">'rsa'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    modulusLength<span class="token operator">:</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    publicKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'spki'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    privateKeyEncoding<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'pkcs8'</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> <span class="token string">'pem'</span><span class="token punctuation">,</span>
        cipher<span class="token operator">:</span> <span class="token string">'aes-256-cbc'</span><span class="token punctuation">,</span>
        passphrase<span class="token operator">:</span> server_passphrase
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> serverRandom <span class="token operator">=</span> <span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serverInfo <span class="token operator">=</span> <span class="token punctuation">{</span>
    domain<span class="token operator">:</span> <span class="token string">&quot;http://127.0.0.1:20000&quot;</span><span class="token punctuation">,</span>
    publicKey<span class="token operator">:</span> serverRSA<span class="token punctuation">.</span>publicKey
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> serverCert <span class="token operator">=</span> <span class="token function">requestCert</span><span class="token punctuation">(</span>serverInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> clientRandom<span class="token punctuation">;</span>
<span class="token keyword">const</span> serverDH <span class="token operator">=</span> <span class="token function">createECDH</span><span class="token punctuation">(</span><span class="token string">'secp521r1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ecDHServerParams <span class="token operator">=</span> serverDH<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ecDHServerParamsSign <span class="token operator">=</span> <span class="token function">getSign</span><span class="token punctuation">(</span>ecDHServerParams<span class="token punctuation">,</span> serverRSA<span class="token punctuation">.</span>privateKey<span class="token punctuation">,</span> server_passphrase<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> masterKey<span class="token punctuation">;</span>
<span class="token keyword">let</span> sessionKey<span class="token punctuation">;</span>
udp_server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> address <span class="token operator">=</span> udp_server<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">client running </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>address<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>address<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
udp_server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> remote</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>ClientHello<span class="token operator">:</span>
            <span class="token comment">//2.在服务器生成随机数，通过ServerHello发送给客户端</span>
            clientRandom <span class="token operator">=</span> message<span class="token punctuation">.</span>clientRandom<span class="token punctuation">;</span>
            udp_server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ServerHello<span class="token punctuation">,</span>
                serverRandom<span class="token punctuation">,</span><span class="token comment">//服务器端随机数</span>
                cipherSuite<span class="token operator">:</span> <span class="token string">'TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA'</span><span class="token comment">//约定的加密套件</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3.Certificate 服务器把包含自己公钥的证书发送给客户端进行验证</span>
            udp_server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>Certificate<span class="token punctuation">,</span>
                serverCert<span class="token punctuation">,</span><span class="token comment">//服务器公钥证书</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//4.ServerKeyExchange 服务器端生成DH参数，并用服务器私钥进行签名发给客户端</span>
            udp_server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ServerKeyExchange<span class="token punctuation">,</span>
                ecDHServerParams<span class="token punctuation">,</span>
                ecDHServerParamsSign
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//5.Server Hello Done 服务器发送完成</span>
            udp_server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ServerHelloDone
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>ClientKeyExchange<span class="token operator">:</span>
            <span class="token comment">//6.ClientKeyExchange 服务器收到客户端DH参数后加上服务器DH参数生成pre-master-key</span>
            <span class="token comment">//再由pre-master-key生成masterKey和sessionKey</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span> ecDHClientParams <span class="token punctuation">}</span> <span class="token operator">=</span> message<span class="token punctuation">;</span>
            preMasterKey <span class="token operator">=</span> serverDH<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ecDHClientParams<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            masterKey <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>preMasterKey <span class="token operator">+</span> clientRandom <span class="token operator">+</span> serverRandom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sessionKey <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>masterKey <span class="token operator">+</span> clientRandom <span class="token operator">+</span> serverRandom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>ChangeCipherSpec<span class="token operator">:</span>
            <span class="token comment">//9.服务器通知客户端服务器也已经准备好切换加密套件了</span>
            udp_server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ChangeCipherSpec
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>EncryptedHandshakeMessage<span class="token operator">:</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;服务器收到解密后的数据:&quot;</span><span class="token punctuation">,</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>data<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//10.服务器收到客户端的加密数据后向客户端回复加密数据</span>
            udp_server<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>EncryptedHandshakeMessage<span class="token punctuation">,</span>
                data<span class="token operator">:</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">&quot;i am server&quot;</span><span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">)</span>
udp_server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">udp_server</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-5-udp-client-js"><a href="#_2-5-udp-client-js" class="header-anchor">#</a> 2.5 udp_client.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dgram <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dgram'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> udp_client <span class="token operator">=</span> dgram<span class="token punctuation">.</span><span class="token function">createSocket</span><span class="token punctuation">(</span><span class="token string">'udp4'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> randomBytes<span class="token punctuation">,</span> createHash<span class="token punctuation">,</span> createECDH <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'crypto'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> verifySign<span class="token punctuation">,</span> encrypt<span class="token punctuation">,</span> decrypt <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> protocol <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./protocol'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cAPublicKey <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'CA.publicKey'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> clientRandom <span class="token operator">=</span> <span class="token function">randomBytes</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> serverRandom<span class="token punctuation">;</span>
<span class="token keyword">let</span> serverPublicKey<span class="token punctuation">;</span>
<span class="token keyword">let</span> ecDHServerParams<span class="token punctuation">;</span>
<span class="token keyword">let</span> clientDH <span class="token operator">=</span> <span class="token function">createECDH</span><span class="token punctuation">(</span><span class="token string">'secp521r1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ecDHClientParams <span class="token operator">=</span> clientDH<span class="token punctuation">.</span><span class="token function">generateKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> masterKey<span class="token punctuation">;</span>
<span class="token keyword">let</span> sessionKey<span class="token punctuation">;</span>
udp_client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> address <span class="token operator">=</span> udp_client<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">client running </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>address<span class="token punctuation">.</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>address<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
udp_client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> remote</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>ServerHello<span class="token operator">:</span>
            serverRandom <span class="token operator">=</span> message<span class="token punctuation">.</span>serverRandom<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>Certificate<span class="token operator">:</span>
            <span class="token comment">//3.Certificate 客户收到服务器证书后会用CA的公钥进行验证证书是否合法</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span> serverCert <span class="token punctuation">}</span> <span class="token operator">=</span> message<span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token punctuation">{</span> info<span class="token punctuation">,</span> sign <span class="token punctuation">}</span> <span class="token operator">=</span> serverCert<span class="token punctuation">;</span>
            serverPublicKey <span class="token operator">=</span> info<span class="token punctuation">.</span>publicKey<span class="token punctuation">;</span>
            <span class="token keyword">const</span> serverInfoHash <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> serverCertIsValid <span class="token operator">=</span> <span class="token function">verifySign</span><span class="token punctuation">(</span>serverInfoHash<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> cAPublicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'验证服务器端证书是否正确?'</span><span class="token punctuation">,</span> serverCertIsValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> urlObj <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> serverDomainIsValid <span class="token operator">=</span> urlObj<span class="token punctuation">.</span>hostname <span class="token operator">===</span> remote<span class="token punctuation">.</span>address <span class="token operator">&amp;&amp;</span> urlObj<span class="token punctuation">.</span>port <span class="token operator">==</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'验证服务器端域名正确?'</span><span class="token punctuation">,</span> serverDomainIsValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>ServerKeyExchange<span class="token operator">:</span>
            <span class="token comment">//4.ServerKeyExchange 客户端收到服务器的DH参数和参数签名后会用服务器的公钥进行签名，验证服务器拥有私钥</span>
            ecDHServerParams <span class="token operator">=</span> message<span class="token punctuation">.</span>ecDHServerParams<span class="token punctuation">;</span>
            ecDHServerParamsSign <span class="token operator">=</span> message<span class="token punctuation">.</span>ecDHServerParamsSign<span class="token punctuation">;</span>
            <span class="token keyword">let</span> serverDHParamIsValid <span class="token operator">=</span> <span class="token function">verifySign</span><span class="token punctuation">(</span>ecDHServerParams<span class="token punctuation">,</span> ecDHServerParamsSign<span class="token punctuation">,</span> serverPublicKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'验证服务器端证书DH参数是否正确?'</span><span class="token punctuation">,</span> serverDHParamIsValid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>ServerHelloDone<span class="token operator">:</span>
            <span class="token comment">//6.ClientKeyExchange 客户端生成DH参数并且发给服务器</span>
            udp_client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ClientKeyExchange<span class="token punctuation">,</span>
                ecDHClientParams
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//6.ClientKeyExchange 服务器收到客户端DH参数后加上服务器DH参数生成pre-master-key</span>
            <span class="token comment">//再由pre-master-key生成masterKey和sessionKey</span>
            preMasterKey <span class="token operator">=</span> clientDH<span class="token punctuation">.</span><span class="token function">computeSecret</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>ecDHServerParams<span class="token punctuation">,</span> <span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            masterKey <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>preMasterKey <span class="token operator">+</span> clientRandom <span class="token operator">+</span> serverRandom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sessionKey <span class="token operator">=</span> <span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>masterKey <span class="token operator">+</span> clientRandom <span class="token operator">+</span> serverRandom<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//7.Change Cipher Spec 通知服务器客户端已经准备好切换成加密通信了</span>
            udp_client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ChangeCipherSpec
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//8.加密握手信息并传送给服务器端</span>
            udp_client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>EncryptedHandshakeMessage<span class="token punctuation">,</span>
                data<span class="token operator">:</span> <span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token string">&quot;i am client&quot;</span><span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> remote<span class="token punctuation">.</span>port<span class="token punctuation">,</span> remote<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> protocol<span class="token punctuation">.</span>EncryptedHandshakeMessage<span class="token operator">:</span>
            <span class="token comment">//10.客户端你好到服务器的加密握手数据</span>
            <span class="token comment">//这个报文的目的就是告诉对端自己在整个握手过程中收到了什么数据，发送了什么数据。来保证中间没人篡改报文</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;客户端收到解密后的数据:&quot;</span><span class="token punctuation">,</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>data<span class="token punctuation">,</span> sessionKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
udp_client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//1.ClientHello 客户端向服务器发送客户端随机数，服务器需要保存在服务器端</span>
udp_client<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> protocol<span class="token punctuation">.</span>ClientHello<span class="token punctuation">,</span>
    clientRandom
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-数字证书实战"><a href="#_3-数字证书实战" class="header-anchor">#</a> 3. 数字证书实战</h2> <ul><li><a href="https://www.openssl.org/source/" target="_blank" rel="noopener noreferrer">OpenSSL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://slproweb.com/products/Win32OpenSSL.html" target="_blank" rel="noopener noreferrer">WinOpenSSL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>安装后要添加环境变量 <code>C:\Program Files\OpenSSL-Win64\bin</code></li></ul> <h3 id="_3-1-自建ca"><a href="#_3-1-自建ca" class="header-anchor">#</a> 3.1 自建CA</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.生成CA私匙</span>
openssl genrsa <span class="token operator">-</span>des3 <span class="token operator">-</span>out ca<span class="token punctuation">.</span>private<span class="token punctuation">.</span>pem <span class="token number">1024</span>
<span class="token comment">// 2.生成CA证书请求</span>
openssl req <span class="token operator">-</span><span class="token keyword">new</span> <span class="token operator">-</span>key ca<span class="token punctuation">.</span>private<span class="token punctuation">.</span>pem <span class="token operator">-</span>out ca<span class="token punctuation">.</span>csr
<span class="token comment">// 3.生成CA根证书</span>
openssl x509 <span class="token operator">-</span>req <span class="token operator">-</span><span class="token keyword">in</span> ca<span class="token punctuation">.</span>csr <span class="token operator">-</span>extensions v3_ca <span class="token operator">-</span>signkey ca<span class="token punctuation">.</span>private<span class="token punctuation">.</span>pem <span class="token operator">-</span>out ca<span class="token punctuation">.</span>crt
</code></pre></div><h3 id="_3-2-生成服务器ca证书"><a href="#_3-2-生成服务器ca证书" class="header-anchor">#</a> 3.2 生成服务器CA证书</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 1.生成server私匙</span>
openssl genrsa <span class="token operator">-</span>out server<span class="token punctuation">.</span>private<span class="token punctuation">.</span>pem <span class="token number">1024</span>
<span class="token comment">// 2.生成server证书请求</span>
openssl req <span class="token operator">-</span><span class="token keyword">new</span> <span class="token operator">-</span>key server<span class="token punctuation">.</span>private<span class="token punctuation">.</span>pem <span class="token operator">-</span>out server<span class="token punctuation">.</span>csr
<span class="token comment">// 3.生成server证书</span>
openssl x509 <span class="token operator">-</span>days <span class="token number">365</span> <span class="token operator">-</span>req <span class="token operator">-</span><span class="token keyword">in</span> server<span class="token punctuation">.</span>csr <span class="token operator">-</span>extensions  v3_req <span class="token operator">-</span>CAkey  ca<span class="token punctuation">.</span>private<span class="token punctuation">.</span>pem <span class="token operator">-</span><span class="token constant">CA</span> ca<span class="token punctuation">.</span>crt <span class="token operator">-</span>CAcreateserial <span class="token operator">-</span>out server<span class="token punctuation">.</span>crt  <span class="token operator">-</span>extfile openssl<span class="token punctuation">.</span>cnf
</code></pre></div><p>openssl.cnf</p> <div class="language- extra-class"><pre class="language-text"><code>[req]  
    distinguished_name = req_distinguished_name  
    req_extensions = v3_req  
    [req_distinguished_name]  
    countryName = CN 
    countryName_default = CN  
    stateOrProvinceName = Beijing  
    stateOrProvinceName_default = Beijing  
    localityName = Beijing 
    localityName_default = Beijing
    organizationalUnitName  = HD
    organizationalUnitName_default  = HD
    commonName = localhost  
    commonName_max  = 64  

    [ v3_req ]  
    # Extensions to add to a certificate request  
    basicConstraints = CA:FALSE  
    keyUsage = nonRepudiation, digitalSignature, keyEncipherment  
    subjectAltName = @alt_names  

    [alt_names]  
    #注意这个IP.1的设置，IP地址需要和你的服务器的监听地址一样 DNS为server网址，可设置多个ip和dns
    IP.1 = 127.0.0.1
    DNS.1 = localhost
</code></pre></div><h3 id="_3-3-服务端"><a href="#_3-3-服务端" class="header-anchor">#</a> 3.3 服务端</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    key<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'ssl/server.private.pem'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    cert<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'ssl/server.crt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


https<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'hello world\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server https is running 9000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-4-客户端"><a href="#_3-4-客户端" class="header-anchor">#</a> 3.4 客户端</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> https <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'https'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
    hostname<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    requestCert<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">//请求客户端证书</span>
    rejectUnauthorized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">//不拒绝不受信任的证书</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> req <span class="token operator">=</span> https<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> buffers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        buffers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffers<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
req<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">5/6/2020, 10:50:03 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/basic/m01-interview.html" class="prev">
        m01. 面试 - JS基础听课笔记
      </a></span> <span class="next"><a href="/other/02-serverless.html">
        02. Serverless
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2af561cb.js" defer></script><script src="/assets/js/2.b2a5c435.js" defer></script><script src="/assets/js/12.849e2da9.js" defer></script>
  </body>
</html>
