<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>05. 工业级前端监控 | 珠峰架构</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.1657c744.css" as="style"><link rel="preload" href="/assets/js/app.2af561cb.js" as="script"><link rel="preload" href="/assets/js/2.b2a5c435.js" as="script"><link rel="preload" href="/assets/js/16.49eb1f17.js" as="script"><link rel="prefetch" href="/assets/js/10.2b2c8443.js"><link rel="prefetch" href="/assets/js/11.689524dc.js"><link rel="prefetch" href="/assets/js/12.849e2da9.js"><link rel="prefetch" href="/assets/js/13.c798d95d.js"><link rel="prefetch" href="/assets/js/14.380c4ee7.js"><link rel="prefetch" href="/assets/js/15.d5753b2e.js"><link rel="prefetch" href="/assets/js/17.5ecf2b4f.js"><link rel="prefetch" href="/assets/js/18.da9c8265.js"><link rel="prefetch" href="/assets/js/19.59d827ef.js"><link rel="prefetch" href="/assets/js/20.73eb42bb.js"><link rel="prefetch" href="/assets/js/21.8570b5b4.js"><link rel="prefetch" href="/assets/js/22.34094913.js"><link rel="prefetch" href="/assets/js/23.5209939b.js"><link rel="prefetch" href="/assets/js/24.53d92201.js"><link rel="prefetch" href="/assets/js/25.7241adf1.js"><link rel="prefetch" href="/assets/js/26.fecc2611.js"><link rel="prefetch" href="/assets/js/27.e50fca48.js"><link rel="prefetch" href="/assets/js/28.4c168acc.js"><link rel="prefetch" href="/assets/js/29.f5186710.js"><link rel="prefetch" href="/assets/js/3.ba1dcccd.js"><link rel="prefetch" href="/assets/js/30.33cb1c11.js"><link rel="prefetch" href="/assets/js/31.c088791d.js"><link rel="prefetch" href="/assets/js/32.3b724af5.js"><link rel="prefetch" href="/assets/js/33.f975c942.js"><link rel="prefetch" href="/assets/js/34.7d1f4bd2.js"><link rel="prefetch" href="/assets/js/35.26c11750.js"><link rel="prefetch" href="/assets/js/36.e8890e58.js"><link rel="prefetch" href="/assets/js/37.516eba46.js"><link rel="prefetch" href="/assets/js/38.4f8b8525.js"><link rel="prefetch" href="/assets/js/39.26f95568.js"><link rel="prefetch" href="/assets/js/4.fca74266.js"><link rel="prefetch" href="/assets/js/40.b9a8ffbb.js"><link rel="prefetch" href="/assets/js/41.fd02ea5f.js"><link rel="prefetch" href="/assets/js/42.d2483185.js"><link rel="prefetch" href="/assets/js/43.70bff2de.js"><link rel="prefetch" href="/assets/js/44.219702ca.js"><link rel="prefetch" href="/assets/js/45.aba93af9.js"><link rel="prefetch" href="/assets/js/46.447ba87c.js"><link rel="prefetch" href="/assets/js/47.519ddc28.js"><link rel="prefetch" href="/assets/js/48.fd8af347.js"><link rel="prefetch" href="/assets/js/49.b3783fa9.js"><link rel="prefetch" href="/assets/js/5.cc992e8b.js"><link rel="prefetch" href="/assets/js/50.0bb20f92.js"><link rel="prefetch" href="/assets/js/51.37ba1a59.js"><link rel="prefetch" href="/assets/js/52.054af132.js"><link rel="prefetch" href="/assets/js/53.5aca78a0.js"><link rel="prefetch" href="/assets/js/54.78c43f89.js"><link rel="prefetch" href="/assets/js/55.8ecaadc1.js"><link rel="prefetch" href="/assets/js/56.e844f110.js"><link rel="prefetch" href="/assets/js/57.530db0e9.js"><link rel="prefetch" href="/assets/js/58.8c839289.js"><link rel="prefetch" href="/assets/js/59.6634b409.js"><link rel="prefetch" href="/assets/js/6.b8b36e50.js"><link rel="prefetch" href="/assets/js/60.7ebe5787.js"><link rel="prefetch" href="/assets/js/61.bfe89a8b.js"><link rel="prefetch" href="/assets/js/62.4cdf6e8c.js"><link rel="prefetch" href="/assets/js/63.a0e80f0d.js"><link rel="prefetch" href="/assets/js/64.62a1b782.js"><link rel="prefetch" href="/assets/js/65.7be0994b.js"><link rel="prefetch" href="/assets/js/66.5a592a8e.js"><link rel="prefetch" href="/assets/js/67.40b4291c.js"><link rel="prefetch" href="/assets/js/68.2ac34b58.js"><link rel="prefetch" href="/assets/js/69.728773d5.js"><link rel="prefetch" href="/assets/js/7.0414e914.js"><link rel="prefetch" href="/assets/js/70.30137f66.js"><link rel="prefetch" href="/assets/js/71.7735c9fc.js"><link rel="prefetch" href="/assets/js/72.e9f43339.js"><link rel="prefetch" href="/assets/js/73.2d754e71.js"><link rel="prefetch" href="/assets/js/74.bf70dd09.js"><link rel="prefetch" href="/assets/js/75.18c28356.js"><link rel="prefetch" href="/assets/js/76.a0626bc9.js"><link rel="prefetch" href="/assets/js/77.dfde57e0.js"><link rel="prefetch" href="/assets/js/78.b380a0d6.js"><link rel="prefetch" href="/assets/js/79.f7bafb5d.js"><link rel="prefetch" href="/assets/js/8.c3544379.js"><link rel="prefetch" href="/assets/js/80.ade6c33e.js"><link rel="prefetch" href="/assets/js/81.6335ba85.js"><link rel="prefetch" href="/assets/js/82.9d01c14e.js"><link rel="prefetch" href="/assets/js/83.47911fdd.js"><link rel="prefetch" href="/assets/js/9.844fca3b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1657c744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">珠峰架构</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable"><span>react</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/flutter/" class="sidebar-heading clickable"><span>flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/" class="sidebar-heading clickable"><span>interview</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/other/" class="sidebar-heading clickable router-link-active open"><span>other</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/other/01-https.html" class="sidebar-link">01. HTTPS简介</a></li><li><a href="/other/02-serverless.html" class="sidebar-link">02. Serverless</a></li><li><a href="/other/03-rbac.html" class="sidebar-link">03. RBAC</a></li><li><a href="/other/04-websocket.html" class="sidebar-link">04. WebSocket</a></li><li><a href="/other/05-monitor.html" class="active sidebar-link">05. 工业级前端监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/other/05-monitor.html#_1-为什么要做前端监控" class="sidebar-link">1.为什么要做前端监控</a></li><li class="sidebar-sub-header"><a href="/other/05-monitor.html#_2-前端监控目标" class="sidebar-link">2.前端监控目标</a></li><li class="sidebar-sub-header"><a href="/other/05-monitor.html#_3-前端监控流程" class="sidebar-link">3.前端监控流程</a></li><li class="sidebar-sub-header"><a href="/other/05-monitor.html#_4-编写监控采集脚本" class="sidebar-link">4.编写监控采集脚本</a></li><li class="sidebar-sub-header"><a href="/other/05-monitor.html#_5-查询报表" class="sidebar-link">5.查询报表</a></li><li class="sidebar-sub-header"><a href="/other/05-monitor.html#_6-参考" class="sidebar-link">6.参考</a></li></ul></li><li><a href="/other/06-monitor-2.html" class="sidebar-link">06. 工业级前端监控2</a></li><li><a href="/other/07-binary.html" class="sidebar-link">07. 二进制</a></li><li><a href="/other/08-binary-2.html" class="sidebar-link">08. 二进制</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_05-工业级前端监控"><a href="#_05-工业级前端监控" class="header-anchor">#</a> 05. 工业级前端监控</h1> <h2 id="_1-为什么要做前端监控"><a href="#_1-为什么要做前端监控" class="header-anchor">#</a> 1.为什么要做前端监控</h2> <ul><li>更快发现问题和解决问题</li> <li>做产品的决策依据</li> <li>提升前端工程师的技术深度和广度,打造简历亮点</li> <li>为业务扩展提供了更多可能性</li></ul> <h2 id="_2-前端监控目标"><a href="#_2-前端监控目标" class="header-anchor">#</a> 2.前端监控目标</h2> <h3 id="_2-1-稳定性-stability"><a href="#_2-1-稳定性-stability" class="header-anchor">#</a> 2.1 稳定性(stability)</h3> <table><thead><tr><th style="text-align:left;">错误名称</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;">JS错误</td> <td style="text-align:left;">JS执行错误或者promise异常</td></tr> <tr><td style="text-align:left;">资源异常</td> <td style="text-align:left;">script、link等资源加载异常</td></tr> <tr><td style="text-align:left;">接口错误</td> <td style="text-align:left;">ajax或fetch请求接口异常</td></tr> <tr><td style="text-align:left;">白屏</td> <td style="text-align:left;">页面空白</td></tr></tbody></table> <h3 id="_2-2-用户体验-experience"><a href="#_2-2-用户体验-experience" class="header-anchor">#</a> 2.2 用户体验(experience)</h3> <table><thead><tr><th style="text-align:left;">错误名称</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;">加载时间</td> <td style="text-align:left;">各个阶段的加载时间</td></tr> <tr><td style="text-align:left;">TTFB(time to first byte)(首字节时间)</td> <td style="text-align:left;">是指浏览器发起第一个请求到数据返回第一个字节所消耗的时间，这个时间包含了网络请求时间、后端处理时间</td></tr> <tr><td style="text-align:left;">FP(First Paint)(首次绘制)</td> <td style="text-align:left;">首次绘制包括了任何用户自定义的背景绘制，它是将第一个像素点绘制到屏幕的时刻</td></tr> <tr><td style="text-align:left;">FCP(First Content Paint)(首次内容绘制)</td> <td style="text-align:left;">首次内容绘制是浏览器将第一个DOM渲染到屏幕的时间,可以是任何文本、图像、SVG等的时间</td></tr> <tr><td style="text-align:left;">FMP(First Meaningful paint)(首次有意义绘制)</td> <td style="text-align:left;">首次有意义绘制是页面可用性的量度标准</td></tr> <tr><td style="text-align:left;">FID(First Input Delay)(首次输入延迟)</td> <td style="text-align:left;">用户首次和页面交互到页面响应交互的时间</td></tr> <tr><td style="text-align:left;">卡顿</td> <td style="text-align:left;">超过50ms的长任务</td></tr></tbody></table> <h3 id="_2-3-业务-business"><a href="#_2-3-业务-business" class="header-anchor">#</a> 2.3 业务(business)</h3> <table><thead><tr><th style="text-align:left;">错误名称</th> <th style="text-align:left;">备注</th></tr></thead> <tbody><tr><td style="text-align:left;">PV</td> <td style="text-align:left;">page view 即页面浏览量或点击量</td></tr> <tr><td style="text-align:left;">UV</td> <td style="text-align:left;">指访问某个站点的不同IP地址的人数</td></tr> <tr><td style="text-align:left;">页面的停留时间</td> <td style="text-align:left;">用户在每一个页面的停留时间</td></tr></tbody></table> <h2 id="_3-前端监控流程"><a href="#_3-前端监控流程" class="header-anchor">#</a> 3.前端监控流程</h2> <ul><li>前端埋点</li> <li>数据上报</li> <li>分析和计算 将采集到的数据进行加工汇总</li> <li>可视化展示 将数据按各种维度进行展示</li> <li>监控报警 发现问题后按一定的条件触发报警</li></ul> <p><img src="http://img.zhufengpeixun.cn/monitorplatform.jpg" alt="monitorplatform"></p> <h3 id="_3-1-常见的埋点方案"><a href="#_3-1-常见的埋点方案" class="header-anchor">#</a> 3.1 常见的埋点方案</h3> <h5 id="_3-1-1-代码埋点"><a href="#_3-1-1-代码埋点" class="header-anchor">#</a> 3.1.1 代码埋点</h5> <ul><li>代码埋点，就是以嵌入代码的形式进行埋点,比如需要监控用户的点击事件,会选择在用户点击时,插入一段代码，保存这个监听行为或者直接将监听行为以某一种数据格式直接传递给服务器端</li> <li>优点是可以在任意时刻，精确的发送或保存所需要的数据信息</li> <li>缺点是工作量较大</li></ul> <h5 id="_3-1-2-可视化埋点"><a href="#_3-1-2-可视化埋点" class="header-anchor">#</a> 3.1.2 可视化埋点</h5> <ul><li>通过可视化交互的手段，代替代码埋点</li> <li>将业务代码和埋点代码分离，提供一个可视化交互的页面，输入为业务代码，通过这个可视化系统，可以在业务代码中自定义的增加埋点事件等等,最后输出的代码耦合了业务代码和埋点代码</li> <li>可视化埋点其实是用系统来代替手工插入埋点代码</li></ul> <h5 id="_3-1-3-无痕埋点"><a href="#_3-1-3-无痕埋点" class="header-anchor">#</a> 3.1.3 无痕埋点</h5> <ul><li>前端的任意一个事件都被绑定一个标识，所有的事件都别记录下来</li> <li>通过定期上传记录文件,配合文件解析，解析出来我们想要的数据，并生成可视化报告供专业人员分析</li> <li>无痕埋点的优点是采集全量数据,不会出现漏埋和误埋等现象</li> <li>缺点是给数据传输和服务器增加压力，也无法灵活定制数据结构</li></ul> <h2 id="_4-编写监控采集脚本"><a href="#_4-编写监控采集脚本" class="header-anchor">#</a> 4.编写监控采集脚本</h2> <h3 id="_4-1-开通日志服务"><a href="#_4-1-开通日志服务" class="header-anchor">#</a> 4.1 开通日志服务</h3> <ul><li><a href="https://sls.console.aliyun.com/lognext/profile" target="_blank" rel="noopener noreferrer">日志服务(Log Service,简称 SLS)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是针对日志类数据一站式服务，用户无需开发就能快捷完成数据采集、消费、投递以及查询分析等功能，帮助提升运维、运营效率，建立 DT 时代海量日志处理能力</li> <li><a href="https://help.aliyun.com/product/28958.html" target="_blank" rel="noopener noreferrer">日志服务帮助文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://help.aliyun.com/document_detail/31752.html" target="_blank" rel="noopener noreferrer">Web Tracking<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_4-2-监控错误"><a href="#_4-2-监控错误" class="header-anchor">#</a> 4.2 监控错误</h3> <h4 id="_4-2-1-错误分类"><a href="#_4-2-1-错误分类" class="header-anchor">#</a> 4.2.1 错误分类</h4> <ul><li>JS错误
<ul><li>JS错误</li> <li>Promise异常</li></ul></li> <li>资源异常
<ul><li>监听error</li></ul></li></ul> <h4 id="_4-2-2-数据结构设计"><a href="#_4-2-2-数据结构设计" class="header-anchor">#</a> 4.2.2 数据结构设计</h4> <h5 id="_1-jserror"><a href="#_1-jserror" class="header-anchor">#</a> 1. jsError</h5> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面标题</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面URL</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590815288710&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问时间戳</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span><span class="token comment">//用户浏览器类型</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">//大类</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//小类</span>
  <span class="token property">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jsError&quot;</span><span class="token punctuation">,</span><span class="token comment">//错误类型</span>
  <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Uncaught TypeError: Cannot set property 'error' of undefined&quot;</span><span class="token punctuation">,</span><span class="token comment">//类型详情</span>
  <span class="token property">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问的文件名</span>
  <span class="token property">&quot;position&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0:0&quot;</span><span class="token punctuation">,</span><span class="token comment">//行列信息</span>
  <span class="token property">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;btnClick (http://localhost:8080/:20:39)^HTMLInputElement.onclick (http://localhost:8080/:14:72)&quot;</span><span class="token punctuation">,</span><span class="token comment">//堆栈信息</span>
  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content INPUT&quot;</span><span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-promiseerror"><a href="#_2-promiseerror" class="header-anchor">#</a> 2. promiseError</h5> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面标题</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面URL</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590815290600&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问时间戳</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span><span class="token comment">//用户浏览器类型</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">//大类</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//小类</span>
  <span class="token property">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;promiseError&quot;</span><span class="token punctuation">,</span><span class="token comment">//错误类型</span>
  <span class="token property">&quot;message&quot;</span><span class="token operator">:</span> <span class="token string">&quot;someVar is not defined&quot;</span><span class="token punctuation">,</span><span class="token comment">//类型详情</span>
  <span class="token property">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问的文件名</span>
  <span class="token property">&quot;position&quot;</span><span class="token operator">:</span> <span class="token string">&quot;24:29&quot;</span><span class="token punctuation">,</span><span class="token comment">//行列信息</span>
  <span class="token property">&quot;stack&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/:24:29^new Promise (&lt;anonymous&gt;)^btnPromiseClick (http://localhost:8080/:23:13)^HTMLInputElement.onclick (http://localhost:8080/:15:86)&quot;</span><span class="token punctuation">,</span><span class="token comment">//堆栈信息</span>
  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content INPUT&quot;</span><span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_3-resourceerror"><a href="#_3-resourceerror" class="header-anchor">#</a> 3. resourceError</h5> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面标题</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span><span class="token comment">//页面URL</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590816168643&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问时间戳</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span><span class="token comment">//用户浏览器类型</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span><span class="token comment">//大类</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span><span class="token comment">//小类</span>
  <span class="token property">&quot;errorType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;resourceError&quot;</span><span class="token punctuation">,</span><span class="token comment">//错误类型</span>
  <span class="token property">&quot;filename&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/error.js&quot;</span><span class="token punctuation">,</span><span class="token comment">//访问的文件名</span>
  <span class="token property">&quot;tagName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;SCRIPT&quot;</span><span class="token punctuation">,</span><span class="token comment">//标签名</span>
  <span class="token property">&quot;timeStamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;76&quot;</span><span class="token punctuation">,</span><span class="token comment">//时间</span>
  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY SCRIPT&quot;</span><span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-2-3-报表"><a href="#_4-2-3-报表" class="header-anchor">#</a> 4.2.3 报表</h4> <ul><li><a href="https://help.aliyun.com/document_detail/29060.html?spm=5176.2020520112.0.0.636c34c07HzVho" target="_blank" rel="noopener noreferrer">查询语句<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> kind<span class="token punctuation">,</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> kind
</code></pre></div><h4 id="_4-2-4-实现"><a href="#_4-2-4-实现" class="header-anchor">#</a> 4.2.4 实现</h4> <h5 id="_1-webpack-config-js"><a href="#_1-webpack-config-js" class="header-anchor">#</a> 1. webpack.config.js</h5> <p>webpack.config.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
    context<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        filename<span class="token operator">:</span> <span class="token string">'monitor.js'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
        contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            template<span class="token operator">:</span> <span class="token string">'./src/index.html'</span><span class="token punctuation">,</span>
            inject<span class="token operator">:</span> <span class="token string">'head'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-index-html"><a href="#_2-index-html" class="header-anchor">#</a> 2. index.html</h5> <p>src\index.html</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>monitor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>content<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>点击抛出错误<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btnClick()<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>点击抛出promise错误<span class="token punctuation">&quot;</span></span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btnPromiseClick()<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">function</span> <span class="token function">btnClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            window<span class="token punctuation">.</span>someVariable<span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token string">'someVariable'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">function</span> <span class="token function">btnPromiseClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>someVar<span class="token punctuation">.</span>some<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>error.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h5 id="_3-src-index-js"><a href="#_3-src-index-js" class="header-anchor">#</a> 3. src\index.js</h5> <p>src\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token string">'./monitor'</span>
</code></pre></div><h5 id="_4-monitor-index-js"><a href="#_4-monitor-index-js" class="header-anchor">#</a> 4. monitor\index.js</h5> <p>src\monitor\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> injectJsError <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./lib/jsError'</span><span class="token punctuation">;</span>
<span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_5-jserror-js"><a href="#_5-jserror-js" class="header-anchor">#</a> 5. jsError.js</h5> <p>src\monitor\lib\jsError.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">'../util/getLastEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">'../util/formatTime'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">injectJsError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//一般JS运行时错误使用window.onerror捕获处理</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">//资源加载错误</span>
                kind<span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">//稳定性指标</span>
                type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span><span class="token comment">//resource</span>
                errorType<span class="token operator">:</span> <span class="token string">'resourceError'</span><span class="token punctuation">,</span>
                filename<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>src <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>href<span class="token punctuation">,</span><span class="token comment">//加载失败的资源</span>
                tagName<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>tagName<span class="token punctuation">,</span><span class="token comment">//标签名</span>
                timeStamp<span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//时间</span>
                selector<span class="token operator">:</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>path <span class="token operator">||</span> event<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//选择器</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                kind<span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">//稳定性指标</span>
                type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span><span class="token comment">//error</span>
                errorType<span class="token operator">:</span> <span class="token string">'jsError'</span><span class="token punctuation">,</span><span class="token comment">//jsError</span>
                message<span class="token operator">:</span> event<span class="token punctuation">.</span>message<span class="token punctuation">,</span><span class="token comment">//报错信息</span>
                filename<span class="token operator">:</span> event<span class="token punctuation">.</span>filename<span class="token punctuation">,</span><span class="token comment">//报错链接</span>
                position<span class="token operator">:</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>lineNo <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>columnNo <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//行列号</span>
                stack<span class="token operator">:</span> <span class="token function">getLines</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>error<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//错误堆栈</span>
                selector<span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token comment">//CSS选择器</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true代表在捕获阶段调用,false代表在冒泡阶段捕获,使用true或false都可以</span>

    <span class="token comment">//当Promise 被 reject 且没有 reject 处理器的时候，会触发 unhandledrejection 事件</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> column <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> file <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> event<span class="token punctuation">.</span>reason <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            message <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> reason <span class="token operator">=</span> event<span class="token punctuation">.</span>reason<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> reason <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reason<span class="token punctuation">.</span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> matchResult <span class="token operator">=</span> reason<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/at\s+(.+):(\d+):(\d+)/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>matchResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    file <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    line <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    column <span class="token operator">=</span> matchResult<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                stack <span class="token operator">=</span> <span class="token function">getLines</span><span class="token punctuation">(</span>reason<span class="token punctuation">.</span>stack<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">//未捕获的promise错误</span>
            kind<span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">//稳定性指标</span>
            type<span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span><span class="token comment">//jsError</span>
            errorType<span class="token operator">:</span> <span class="token string">'promiseError'</span><span class="token punctuation">,</span><span class="token comment">//unhandledrejection</span>
            message<span class="token operator">:</span> message<span class="token punctuation">,</span><span class="token comment">//标签名</span>
            filename<span class="token operator">:</span> file<span class="token punctuation">,</span>
            position<span class="token operator">:</span> line <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> column<span class="token punctuation">,</span><span class="token comment">//行列</span>
            stack<span class="token punctuation">,</span>
            selector<span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// true代表在捕获阶段调用,false代表在冒泡阶段捕获,使用true或false都可以</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getLines</span><span class="token punctuation">(</span><span class="token parameter">stack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> stack<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/^\s+at\s+/g</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'^'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_6-formattime-js"><a href="#_6-formattime-js" class="header-anchor">#</a> 6. formatTime.js</h5> <p>src\monitor\util\formatTime.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_7-getlastevent-js"><a href="#_7-getlastevent-js" class="header-anchor">#</a> 7. getLastEvent.js</h5> <p>src\monitor\util\getLastEvent.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> lastEvent<span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token string">'click'</span><span class="token punctuation">,</span><span class="token string">'pointerdown'</span><span class="token punctuation">,</span> <span class="token string">'touchstart'</span><span class="token punctuation">,</span> <span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token string">'keydown'</span><span class="token punctuation">,</span> <span class="token string">'mouseover'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        lastEvent <span class="token operator">=</span> event<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        capture<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span><span class="token comment">//capture 控制监听器是在捕获阶段执行还是在冒泡阶段执行 </span>
        passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">//passive 的意思是顺从的，表示它不会对事件的默认行为说 no</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> lastEvent<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_8-getselector-js"><a href="#_8-getselector-js" class="header-anchor">#</a> 8. getSelector.js</h5> <p>src\monitor\util\getSelector.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">getSelector</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> element <span class="token operator">!==</span> window <span class="token operator">&amp;&amp;</span> element <span class="token operator">!==</span> document<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> selector<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            selector <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span>className <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> element<span class="token punctuation">.</span>className <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            selector <span class="token operator">=</span> <span class="token string">'.'</span> <span class="token operator">+</span> element<span class="token punctuation">.</span>className<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>item <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            selector <span class="token operator">=</span> element<span class="token punctuation">.</span>nodeName<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">pathsOrTarget</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>pathsOrTarget<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>pathsOrTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> element <span class="token operator">=</span> pathsOrTarget<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            paths<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            element <span class="token operator">=</span> element<span class="token punctuation">.</span>parentNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_9-tracker-js"><a href="#_9-tracker-js" class="header-anchor">#</a> 9. tracker.js</h5> <p>src\monitor\util\tracker.js</p> <ul><li><a href="https://help.aliyun.com/document_detail/120218.html" target="_blank" rel="noopener noreferrer">PutWebtracking<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> host <span class="token operator">=</span> <span class="token string">'cn-beijing.log.aliyuncs.com'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> project <span class="token operator">=</span> <span class="token string">'zhufengmonitor'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> logstore <span class="token operator">=</span> <span class="token string">'zhufengmonitor-store'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> userAgent <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'user-agent'</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">getExtraData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        title<span class="token operator">:</span> document<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
        url<span class="token operator">:</span> location<span class="token punctuation">.</span>href<span class="token punctuation">,</span>
        timestamp<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        userAgent<span class="token operator">:</span> userAgent<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>userAgent<span class="token punctuation">)</span><span class="token punctuation">.</span>name
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">SendTracker</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>project<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/logstores/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>logstore<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/track</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> extraData <span class="token operator">=</span> <span class="token function">getExtraData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> logs <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>extraData<span class="token punctuation">,</span> <span class="token operator">...</span>data <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> logs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> logs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>logs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>logs<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            __logs__<span class="token operator">:</span> <span class="token punctuation">[</span>logs<span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;POST&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'x-log-apiversion'</span><span class="token punctuation">,</span> <span class="token string">'0.6.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'x-log-bodyrawsize'</span><span class="token punctuation">,</span> body<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">&lt;=</span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">new</span> <span class="token class-name">SendTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-3-接口异常采集脚本"><a href="#_4-3-接口异常采集脚本" class="header-anchor">#</a> 4.3.接口异常采集脚本</h3> <h4 id="_4-3-1-数据设计"><a href="#_4-3-1-数据设计" class="header-anchor">#</a> 4.3.1 数据设计</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span> <span class="token comment">//标题</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span> <span class="token comment">//url</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590817024490&quot;</span><span class="token punctuation">,</span> <span class="token comment">//timestamp</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span> <span class="token comment">//浏览器版本</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span> <span class="token comment">//大类</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xhr&quot;</span><span class="token punctuation">,</span> <span class="token comment">//小类</span>
  <span class="token property">&quot;eventType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span> <span class="token comment">//事件类型</span>
  <span class="token property">&quot;pathname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/success&quot;</span><span class="token punctuation">,</span> <span class="token comment">//路径</span>
  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;200-OK&quot;</span><span class="token punctuation">,</span> <span class="token comment">//状态码</span>
  <span class="token property">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">,</span> <span class="token comment">//持续时间</span>
  <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{\&quot;id\&quot;:1}&quot;</span><span class="token punctuation">,</span> <span class="token comment">//响应内容</span>
  <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span>  <span class="token comment">//参数</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590817025617&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xhr&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eventType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;pathname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/error&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;500-Internal Server Error&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;7&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;response&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;params&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name=zhufeng&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-3-2-实现"><a href="#_4-3-2-实现" class="header-anchor">#</a> 4.3.2 实现</h4> <h5 id="_1-src-index-html"><a href="#_1-src-index-html" class="header-anchor">#</a> 1. src\index.html</h5> <p>src\index.html</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-arrow deleted">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
</span>
<span class="token deleted-arrow deleted">&lt;head&gt;
</span><span class="token unchanged">    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;monitor&lt;/title&gt;
</span><span class="token deleted-arrow deleted">&lt;/head&gt;
</span>
<span class="token deleted-arrow deleted">&lt;body&gt;
</span><span class="token unchanged">    &lt;div id=&quot;container&quot;&gt;
        &lt;div class=&quot;content&quot;&gt;
</span><span class="token inserted-sign inserted">+            &lt;input type=&quot;button&quot; value=&quot;发起ajax成功请求&quot; onclick=&quot;sendAjaxSuccess()&quot; /&gt;
+            &lt;input type=&quot;button&quot; value=&quot;发起ajax失败请求&quot; onclick=&quot;sendAjaxError()&quot; /&gt;
</span><span class="token unchanged">        &lt;/div&gt;
    &lt;/div&gt;
</span>
<span class="token unchanged">    &lt;script&gt;
</span><span class="token inserted-sign inserted">+        function sendAjaxSuccess() {
+            let xhr = new XMLHttpRequest;
+            xhr.open('GET', '/success', true);
+            xhr.responseType = 'json';
+            xhr.onload = function () {
+                console.log(xhr.response);
+            }
+            xhr.send();
+        }
+        function sendAjaxError() {
+            let xhr = new XMLHttpRequest;
+            xhr.open('POST', '/error', true);
+            xhr.responseType = 'json';
+            xhr.onload = function () {
+                console.log(xhr.response);
+            }
+            xhr.onerror = function (error) {
+                console.log(error);
+            }
+            xhr.send(&quot;name=zhufeng&quot;);
</span><span class="token unchanged">        }
    &lt;/script&gt;
</span><span class="token deleted-arrow deleted">&lt;/body&gt;
</span>
<span class="token deleted-arrow deleted">&lt;/html&gt;
</span></code></pre></div><h5 id="_2-monitor-index-js"><a href="#_2-monitor-index-js" class="header-anchor">#</a> 2. monitor\index.js</h5> <p>src\monitor\index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import { injectJsError } from './lib/jsError';
<span class="token inserted-sign inserted">+import { injectXHR } from './lib/xhr';
</span>injectJsError();
<span class="token inserted-sign inserted">+injectXHR();
</span></code></pre></div><h5 id="_3-webpack-config-js"><a href="#_3-webpack-config-js" class="header-anchor">#</a> 3. webpack.config.js</h5> <p>webpack.config.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
<span class="token unchanged">    mode: 'development',
    context: process.cwd(),
    entry: './src/index.js',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: 'monitor.js'
    },
    devServer: {
        contentBase: path.resolve(__dirname, 'dist'),
</span><span class="token inserted-sign inserted">+        before(router) {
+            router.get('/success', function (req, res) {
+                res.json({ id: 1 });
+            });
+            router.post('/error', function (req, res) {
+                res.sendStatus(500);
+            });
+        }
</span><span class="token unchanged">    },
    module: {},
    plugins: [
        new HtmlWebpackPlugin({
            template: './src/index.html',
            inject: 'head'
        })
    ],
</span>
}
</code></pre></div><h5 id="_4-xhr-js"><a href="#_4-xhr-js" class="header-anchor">#</a> 4. xhr.js</h5> <p>src\monitor\lib\xhr.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">injectXHR</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> XMLHttpRequest <span class="token operator">=</span> window<span class="token punctuation">.</span>XMLHttpRequest<span class="token punctuation">;</span>
    <span class="token keyword">let</span> oldOpen <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>open<span class="token punctuation">;</span>
    <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">open</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> async<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/logstores/</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/sockjs/</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logData <span class="token operator">=</span> <span class="token punctuation">{</span>
                method<span class="token punctuation">,</span> url<span class="token punctuation">,</span> async<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">oldOpen</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> oldSend <span class="token operator">=</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>send<span class="token punctuation">;</span>
    <span class="token keyword">let</span> start<span class="token punctuation">;</span>
    <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">body</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> <span class="token function-variable function">handler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">type</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
                <span class="token keyword">let</span> status <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">;</span>
                <span class="token keyword">let</span> statusText <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>statusText<span class="token punctuation">;</span>
                tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">//未捕获的promise错误</span>
                    kind<span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span><span class="token comment">//稳定性指标</span>
                    type<span class="token operator">:</span> <span class="token string">'xhr'</span><span class="token punctuation">,</span><span class="token comment">//xhr</span>
                    eventType<span class="token operator">:</span> type<span class="token punctuation">,</span><span class="token comment">//load error abort</span>
                    pathname<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logData<span class="token punctuation">.</span>url<span class="token punctuation">,</span><span class="token comment">//接口的url地址</span>
                    status<span class="token operator">:</span> status <span class="token operator">+</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">+</span> statusText<span class="token punctuation">,</span>
                    duration<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> duration<span class="token punctuation">,</span><span class="token comment">//接口耗时</span>
                    response<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                    params<span class="token operator">:</span> body <span class="token operator">||</span> <span class="token string">''</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">,</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token string">'abort'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">oldSend</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-4-白屏"><a href="#_4-4-白屏" class="header-anchor">#</a> 4.4 白屏</h3> <ul><li>白屏就是页面上什么都没有</li></ul> <h4 id="_4-4-1-数据设计"><a href="#_4-4-1-数据设计" class="header-anchor">#</a> 4.4.1 数据设计</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590822618759&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;stability&quot;</span><span class="token punctuation">,</span>      <span class="token comment">//大类</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;blank&quot;</span><span class="token punctuation">,</span>          <span class="token comment">//小类</span>
  <span class="token property">&quot;emptyPoints&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>       <span class="token comment">//空白点</span>
  <span class="token property">&quot;screen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2049x1152&quot;</span><span class="token punctuation">,</span>    <span class="token comment">//分辨率</span>
  <span class="token property">&quot;viewPoint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2048x994&quot;</span><span class="token punctuation">,</span>  <span class="token comment">//视口</span>
  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container&quot;</span> <span class="token comment">//选择器</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-4-2-实现"><a href="#_4-4-2-实现" class="header-anchor">#</a> 4.4.2 实现</h4> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/screen" target="_blank" rel="noopener noreferrer">screen<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 返回当前window的screen对象,返回当前渲染窗口中和屏幕有关的属性</li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/innerWidth" target="_blank" rel="noopener noreferrer">innerWidth<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 只读的 Window 属性 innerWidth 返回以像素为单位的窗口的内部宽度</li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/innerHeight" target="_blank" rel="noopener noreferrer">innerHeight<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 窗口的内部高度(布局视口)的高度</li> <li><a href="https://developer.mozilla.org/en-US/docs/Glossary/layout_viewport" target="_blank" rel="noopener noreferrer">layout_viewport<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/elementsFromPoint" target="_blank" rel="noopener noreferrer">elementsFromPoint<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法可以获取到当前视口内指定坐标处，由里到外排列的所有元素</li></ul> <h5 id="_1-src-index-html-2"><a href="#_1-src-index-html-2" class="header-anchor">#</a> 1. src\index.html</h5> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-arrow deleted">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
</span>
<span class="token deleted-arrow deleted">&lt;head&gt;
</span><span class="token unchanged">    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;monitor&lt;/title&gt;
</span><span class="token deleted-arrow deleted">&lt;/head&gt;
&lt;body&gt;
</span><span class="token unchanged">    &lt;div id=&quot;container&quot;&gt;
        &lt;div class=&quot;content&quot; style=&quot;width:600px;word-wrap:break-word;&quot;&gt;
</span>
<span class="token unchanged">        &lt;/div&gt;
    &lt;/div&gt;
</span>
<span class="token unchanged">    &lt;script&gt;
</span><span class="token inserted-sign inserted">+        let content = document.getElementsByClassName('content')[0];
+        content.innerHTML = '@'.repeat(10000);
</span><span class="token unchanged">    &lt;/script&gt;
</span><span class="token deleted-arrow deleted">&lt;/body&gt;
&lt;/html&gt;
</span></code></pre></div><h5 id="_2-monitor-index-js-2"><a href="#_2-monitor-index-js-2" class="header-anchor">#</a> 2. monitor\index.js</h5> <p>src\monitor\index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import { injectJsError } from './lib/jsError';
import { injectXHR } from './lib/xhr';
<span class="token inserted-sign inserted">+import { blankScreen } from './lib/blankScreen';
</span>injectJsError();
injectXHR();
<span class="token inserted-sign inserted">+blankScreen();
</span></code></pre></div><h5 id="_3-onload-js"><a href="#_3-onload-js" class="header-anchor">#</a> 3. onload.js</h5> <p>src\monitor\util\onload.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">'complete'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_4-blankscreen-js"><a href="#_4-blankscreen-js" class="header-anchor">#</a> 4. blankScreen.js</h5> <p>src\monitor\lib\blankScreen.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> onload <span class="token keyword">from</span> <span class="token string">'../util/onload'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">blankScreen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> wrapperSelectors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'body'</span><span class="token punctuation">,</span> <span class="token string">'html'</span><span class="token punctuation">,</span> <span class="token string">'#container'</span><span class="token punctuation">,</span> <span class="token string">'.content'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> emptyPoints <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">isWrapper</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapperSelectors<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token function">getSelector</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            emptyPoints<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> xElements<span class="token punctuation">,</span> yElements<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">9</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            xElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">*</span> i <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
            yElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">*</span> i <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">)</span>
            <span class="token function">isWrapper</span><span class="token punctuation">(</span>xElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">isWrapper</span><span class="token punctuation">(</span>yElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyPoints <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> centerElements <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">elementsFromPoint</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                kind<span class="token operator">:</span> <span class="token string">'stability'</span><span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'blank'</span><span class="token punctuation">,</span>
                emptyPoints<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> emptyPoints<span class="token punctuation">,</span>
                screen<span class="token operator">:</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">&quot;x&quot;</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
                viewPoint<span class="token operator">:</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">+</span> <span class="token string">'x'</span> <span class="token operator">+</span> window<span class="token punctuation">.</span>innerHeight<span class="token punctuation">,</span>
                selector<span class="token operator">:</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>centerElements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//screen.width  屏幕的宽度   screen.height 屏幕的高度</span>
<span class="token comment">//window.innerWidth 去除工具条与滚动条的窗口宽度 window.innerHeight 去除工具条与滚动条的窗口高度</span>
</code></pre></div><h3 id="_4-5-加载时间"><a href="#_4-5-加载时间" class="header-anchor">#</a> 4.5 加载时间</h3> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener noreferrer">PerformanceTiming<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/DOMContentLoaded" target="_blank" rel="noopener noreferrer">DOMContentLoaded<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view#" target="_blank" rel="noopener noreferrer">FMP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h4 id="_4-5-1-阶段含义"><a href="#_4-5-1-阶段含义" class="header-anchor">#</a> 4.5.1 阶段含义</h4> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">含义</th></tr></thead> <tbody><tr><td style="text-align:left;">navigationStart</td> <td style="text-align:left;">初始化页面，在同一个浏览器上下文中前一个页面unload的时间戳，如果没有前一个页面的unload,则与fetchStart值相等</td></tr> <tr><td style="text-align:left;">redirectStart</td> <td style="text-align:left;">第一个HTTP重定向发生的时间,有跳转且是同域的重定向,否则为0</td></tr> <tr><td style="text-align:left;">redirectEnd</td> <td style="text-align:left;">最后一个重定向完成时的时间,否则为0</td></tr> <tr><td style="text-align:left;">fetchStart</td> <td style="text-align:left;">浏览器准备好使用http请求获取文档的时间,这发生在检查缓存之前</td></tr> <tr><td style="text-align:left;">domainLookupStart</td> <td style="text-align:left;">DNS域名开始查询的时间,如果有本地的缓存或keep-alive则时间为0</td></tr> <tr><td style="text-align:left;">domainLookupEnd</td> <td style="text-align:left;">DNS域名结束查询的时间</td></tr> <tr><td style="text-align:left;">connectStart</td> <td style="text-align:left;">TCP开始建立连接的时间,如果是持久连接,则与<code>fetchStart</code>值相等</td></tr> <tr><td style="text-align:left;">secureConnectionStart</td> <td style="text-align:left;">https 连接开始的时间,如果不是安全连接则为0</td></tr> <tr><td style="text-align:left;">connectEnd</td> <td style="text-align:left;">TCP完成握手的时间，如果是持久连接则与<code>fetchStart</code>值相等</td></tr> <tr><td style="text-align:left;">requestStart</td> <td style="text-align:left;">HTTP请求读取真实文档开始的时间,包括从本地缓存读取</td></tr> <tr><td style="text-align:left;">requestEnd</td> <td style="text-align:left;">HTTP请求读取真实文档结束的时间,包括从本地缓存读取</td></tr> <tr><td style="text-align:left;">responseStart</td> <td style="text-align:left;">返回浏览器从服务器收到（或从本地缓存读取）第一个字节时的Unix毫秒时间戳</td></tr> <tr><td style="text-align:left;">responseEnd</td> <td style="text-align:left;">返回浏览器从服务器收到（或从本地缓存读取，或从本地资源读取）最后一个字节时的Unix毫秒时间戳</td></tr> <tr><td style="text-align:left;">unloadEventStart</td> <td style="text-align:left;">前一个页面的unload的时间戳 如果没有则为0</td></tr> <tr><td style="text-align:left;">unloadEventEnd</td> <td style="text-align:left;">与<code>unloadEventStart</code>相对应，返回的是<code>unload</code>函数执行完成的时间戳</td></tr> <tr><td style="text-align:left;">domLoading</td> <td style="text-align:left;">返回当前网页DOM结构开始解析时的时间戳,此时<code>document.readyState</code>变成loading,并将抛出<code>readyStateChange</code>事件</td></tr> <tr><td style="text-align:left;">domInteractive</td> <td style="text-align:left;">返回当前网页DOM结构结束解析、开始加载内嵌资源时时间戳,<code>document.readyState</code> 变成<code>interactive</code>，并将抛出<code>readyStateChange</code>事件(注意只是DOM树解析完成,这时候并没有开始加载网页内的资源)</td></tr> <tr><td style="text-align:left;">domContentLoadedEventStart</td> <td style="text-align:left;">网页domContentLoaded事件发生的时间</td></tr> <tr><td style="text-align:left;">domContentLoadedEventEnd</td> <td style="text-align:left;">网页domContentLoaded事件脚本执行完毕的时间,domReady的时间</td></tr> <tr><td style="text-align:left;">domComplete</td> <td style="text-align:left;">DOM树解析完成,且资源也准备就绪的时间,<code>document.readyState</code>变成<code>complete</code>.并将抛出<code>readystatechange</code>事件</td></tr> <tr><td style="text-align:left;">loadEventStart</td> <td style="text-align:left;">load 事件发送给文档，也即load回调函数开始执行的时间</td></tr> <tr><td style="text-align:left;">loadEventEnd</td> <td style="text-align:left;">load回调函数执行完成的时间</td></tr></tbody></table> <h4 id="_4-5-2-阶段计算"><a href="#_4-5-2-阶段计算" class="header-anchor">#</a> 4.5.2 阶段计算</h4> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">描述</th> <th style="text-align:left;">计算方式</th> <th style="text-align:left;">意义</th></tr></thead> <tbody><tr><td style="text-align:left;">unload</td> <td style="text-align:left;">前一个页面卸载耗时</td> <td style="text-align:left;">unloadEventEnd – unloadEventStart</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">redirect</td> <td style="text-align:left;">重定向耗时</td> <td style="text-align:left;">redirectEnd – redirectStart</td> <td style="text-align:left;">重定向的时间</td></tr> <tr><td style="text-align:left;">appCache</td> <td style="text-align:left;">缓存耗时</td> <td style="text-align:left;">domainLookupStart – fetchStart</td> <td style="text-align:left;">读取缓存的时间</td></tr> <tr><td style="text-align:left;">dns</td> <td style="text-align:left;">DNS 解析耗时</td> <td style="text-align:left;">domainLookupEnd – domainLookupStart</td> <td style="text-align:left;">可观察域名解析服务是否正常</td></tr> <tr><td style="text-align:left;">tcp</td> <td style="text-align:left;">TCP 连接耗时</td> <td style="text-align:left;">connectEnd – connectStart</td> <td style="text-align:left;">建立连接的耗时</td></tr> <tr><td style="text-align:left;">ssl</td> <td style="text-align:left;">SSL 安全连接耗时</td> <td style="text-align:left;">connectEnd – secureConnectionStart</td> <td style="text-align:left;">反映数据安全连接建立耗时</td></tr> <tr><td style="text-align:left;">ttfb</td> <td style="text-align:left;">Time to First Byte(TTFB)网络请求耗时</td> <td style="text-align:left;">responseStart – requestStart</td> <td style="text-align:left;">TTFB是发出页面请求到接收到应答数据第一个字节所花费的毫秒数</td></tr> <tr><td style="text-align:left;">response</td> <td style="text-align:left;">响应数据传输耗时</td> <td style="text-align:left;">responseEnd – responseStart</td> <td style="text-align:left;">观察网络是否正常</td></tr> <tr><td style="text-align:left;">dom</td> <td style="text-align:left;">DOM解析耗时</td> <td style="text-align:left;">domInteractive – responseEnd</td> <td style="text-align:left;">观察DOM结构是否合理，是否有JS阻塞页面解析</td></tr> <tr><td style="text-align:left;">dcl</td> <td style="text-align:left;">DOMContentLoaded 事件耗时</td> <td style="text-align:left;">domContentLoadedEventEnd – domContentLoadedEventStart</td> <td style="text-align:left;">当 HTML 文档被完全加载和解析完成之后，DOMContentLoaded 事件被触发，无需等待样式表、图像和子框架的完成加载</td></tr> <tr><td style="text-align:left;">resources</td> <td style="text-align:left;">资源加载耗时</td> <td style="text-align:left;">domComplete – domContentLoadedEventEnd</td> <td style="text-align:left;">可观察文档流是否过大</td></tr> <tr><td style="text-align:left;">domReady</td> <td style="text-align:left;">DOM阶段渲染耗时</td> <td style="text-align:left;">domContentLoadedEventEnd – fetchStart</td> <td style="text-align:left;">DOM树和页面资源加载完成时间，会触发<code>domContentLoaded</code>事件</td></tr> <tr><td style="text-align:left;">首次渲染耗时</td> <td style="text-align:left;">首次渲染耗时</td> <td style="text-align:left;">responseEnd-fetchStart</td> <td style="text-align:left;">加载文档到看到第一帧非空图像的时间，也叫白屏时间</td></tr> <tr><td style="text-align:left;">首次可交互时间</td> <td style="text-align:left;">首次可交互时间</td> <td style="text-align:left;">domInteractive-fetchStart</td> <td style="text-align:left;">DOM树解析完成时间，此时document.readyState为interactive</td></tr> <tr><td style="text-align:left;">首包时间耗时</td> <td style="text-align:left;">首包时间</td> <td style="text-align:left;">responseStart-domainLookupStart</td> <td style="text-align:left;">DNS解析到响应返回给浏览器第一个字节的时间</td></tr> <tr><td style="text-align:left;">页面完全加载时间</td> <td style="text-align:left;">页面完全加载时间</td> <td style="text-align:left;">loadEventStart - fetchStart</td> <td style="text-align:left;">-</td></tr> <tr><td style="text-align:left;">onLoad</td> <td style="text-align:left;">onLoad事件耗时</td> <td style="text-align:left;">loadEventEnd – loadEventStart</td> <td style="text-align:left;"></td></tr></tbody></table> <p><img src="http://img.zhufengpeixun.cn/renderscope3.jpg" alt="renderscope3"></p> <p><img src="http://img.zhufengpeixun.cn/browerrender.jpg" alt="browerrender"></p> <h4 id="_4-5-3-数据结构"><a href="#_4-5-3-数据结构" class="header-anchor">#</a> 4.5.3 数据结构</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828364183&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;timing&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;connectTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ttfbTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;responseTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;parseDOMTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;80&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;domContentLoadedTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timeToInteractive&quot;</span><span class="token operator">:</span> <span class="token string">&quot;88&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;loadTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;89&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-5-4-实现"><a href="#_4-5-4-实现" class="header-anchor">#</a> 4.5.4 实现</h4> <h5 id="_1-src-index-html-3"><a href="#_1-src-index-html-3" class="header-anchor">#</a> 1. src\index.html</h5> <p>src\index.html</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-arrow deleted">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
</span>
<span class="token deleted-arrow deleted">&lt;head&gt;
</span><span class="token unchanged">    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;monitor&lt;/title&gt;
</span><span class="token deleted-arrow deleted">&lt;/head&gt;
</span>
<span class="token deleted-arrow deleted">&lt;body&gt;
</span><span class="token unchanged">    &lt;div id=&quot;container&quot;&gt;
        &lt;div class=&quot;content&quot; style=&quot;width:600px;word-wrap:break-word;&quot;&gt;
</span>
<span class="token unchanged">        &lt;/div&gt;
    &lt;/div&gt;
</span>
<span class="token unchanged">    &lt;script&gt;
        let content = document.getElementsByClassName('content')[0];
        //content.innerHTML = '@'.repeat(10000);
        document.addEventListener('DOMContentLoaded', function () {
</span><span class="token inserted-sign inserted">+            let start = Date.now();
+            while ((Date.now() - start) &lt; 1000) {}
+        });
</span><span class="token unchanged">    &lt;/script&gt;
</span><span class="token deleted-arrow deleted">&lt;/body&gt;
</span>
<span class="token deleted-arrow deleted">&lt;/html&gt;
</span></code></pre></div><h5 id="_2-monitor-index-js-3"><a href="#_2-monitor-index-js-3" class="header-anchor">#</a> 2. monitor\index.js</h5> <p>src\monitor\index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import { injectJsError } from './lib/jsError';
import { injectXHR } from './lib/xhr';
import { blankScreen } from './lib/blankScreen';
<span class="token inserted-sign inserted">+import { timing } from './lib/timing';
</span>injectJsError();
injectXHR();
blankScreen();
<span class="token inserted-sign inserted">+timing();
</span></code></pre></div><h5 id="_3-timing-js"><a href="#_3-timing-js" class="header-anchor">#</a> 3. timing.js</h5> <p>src\monitor\lib\timing.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> onload <span class="token keyword">from</span> <span class="token string">'../util/onload'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">'../util/formatTime'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">'../util/getLastEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">timing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">onload</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>
                fetchStart<span class="token punctuation">,</span>
                connectStart<span class="token punctuation">,</span>
                connectEnd<span class="token punctuation">,</span>
                requestStart<span class="token punctuation">,</span>
                responseStart<span class="token punctuation">,</span>
                responseEnd<span class="token punctuation">,</span>
                domLoading<span class="token punctuation">,</span>
                domInteractive<span class="token punctuation">,</span>
                domContentLoadedEventStart<span class="token punctuation">,</span>
                domContentLoadedEventEnd<span class="token punctuation">,</span>
                loadEventStart <span class="token punctuation">}</span> <span class="token operator">=</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">;</span>
            tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
                type<span class="token operator">:</span> <span class="token string">'timing'</span><span class="token punctuation">,</span>
                connectTime<span class="token operator">:</span> connectEnd <span class="token operator">-</span> connectStart<span class="token punctuation">,</span><span class="token comment">//TCP连接耗时</span>
                ttfbTime<span class="token operator">:</span> responseStart <span class="token operator">-</span> requestStart<span class="token punctuation">,</span><span class="token comment">//ttfb</span>
                responseTime<span class="token operator">:</span> responseEnd <span class="token operator">-</span> responseStart<span class="token punctuation">,</span><span class="token comment">//Response响应耗时</span>
                parseDOMTime<span class="token operator">:</span> loadEventStart <span class="token operator">-</span> domLoading<span class="token punctuation">,</span><span class="token comment">//DOM解析渲染耗时</span>
                domContentLoadedTime<span class="token operator">:</span> domContentLoadedEventEnd <span class="token operator">-</span> domContentLoadedEventStart<span class="token punctuation">,</span><span class="token comment">//DOMContentLoaded事件回调耗时</span>
                timeToInteractive<span class="token operator">:</span> domInteractive <span class="token operator">-</span> fetchStart<span class="token punctuation">,</span><span class="token comment">//首次可交互时间</span>
                loadTime<span class="token operator">:</span> loadEventStart <span class="token operator">-</span> fetchStart<span class="token comment">//完整的加载时间</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-6-性能指标"><a href="#_4-6-性能指标" class="header-anchor">#</a> 4.6 性能指标</h3> <ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceObserver/observe" target="_blank" rel="noopener noreferrer">PerformanceObserver.observe<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法用于观察传入的参数中指定的性能条目类型的集合。当记录一个指定类型的性能条目时，性能监测对象的回调函数将会被调用</li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceEntry/entryType" target="_blank" rel="noopener noreferrer">entryType<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://w3c.github.io/paint-timing/" target="_blank" rel="noopener noreferrer">paint-timing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://wicg.github.io/event-timing/" target="_blank" rel="noopener noreferrer">event-timing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://wicg.github.io/largest-contentful-paint/" target="_blank" rel="noopener noreferrer">LCP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view" target="_blank" rel="noopener noreferrer">FMP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/WICG/time-to-interactive" target="_blank" rel="noopener noreferrer">time-to-interactive<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <table><thead><tr><th style="text-align:left;">字段</th> <th style="text-align:left;">描述</th> <th style="text-align:left;">备注</th> <th style="text-align:left;">计算方式</th></tr></thead> <tbody><tr><td style="text-align:left;">FP</td> <td style="text-align:left;">First Paint(首次绘制)</td> <td style="text-align:left;">包括了任何用户自定义的背景绘制，它是首先将像素绘制到屏幕的时刻</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">FCP</td> <td style="text-align:left;">First Content Paint(首次内容绘制)</td> <td style="text-align:left;">是浏览器将第一个 DOM 渲染到屏幕的时间,可能是文本、图像、SVG等,这其实就是白屏时间</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">FMP</td> <td style="text-align:left;">First Meaningful Paint(首次有意义绘制)</td> <td style="text-align:left;">页面有意义的内容渲染的时间</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">LCP</td> <td style="text-align:left;">(Largest Contentful Paint)(最大内容渲染)</td> <td style="text-align:left;">代表在viewport中最大的页面元素加载的时间</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">DCL</td> <td style="text-align:left;">(DomContentLoaded)(DOM加载完成)</td> <td style="text-align:left;">当 HTML 文档被完全加载和解析完成之后,<code>DOMContentLoaded</code> 事件被触发，无需等待样式表、图像和子框架的完成加载</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">L</td> <td style="text-align:left;">(onLoad)</td> <td style="text-align:left;">当依赖的资源全部加载完毕之后才会触发</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">TTI</td> <td style="text-align:left;">(Time to Interactive) 可交互时间</td> <td style="text-align:left;">用于标记应用已进行视觉渲染并能可靠响应用户输入的时间点</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;">FID</td> <td style="text-align:left;">First Input Delay(首次输入延迟)</td> <td style="text-align:left;">用户首次和页面交互(单击链接，点击按钮等)到页面响应交互的时间</td> <td style="text-align:left;"></td></tr></tbody></table> <p><img src="http://img.zhufengpeixun.cn/baidurender.png" alt="baidurender"></p> <p><img src="http://img.zhufengpeixun.cn/lcp.jpg" alt="lcp"></p> <h4 id="_4-6-1-数据结构设计"><a href="#_4-6-1-数据结构设计" class="header-anchor">#</a> 4.6.1 数据结构设计</h4> <h5 id="_1-paint"><a href="#_1-paint" class="header-anchor">#</a> 1. paint</h5> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828364186&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;paint&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;firstPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;102&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;firstContentPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2130&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;firstMeaningfulPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2130&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;largestContentfulPaint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2130&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="_2-firstinputdelay"><a href="#_2-firstinputdelay" class="header-anchor">#</a> 2. firstInputDelay</h5> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828477284&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;firstInputDelay&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;inputDelay&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4812.344999983907&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content H1&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-6-2-实现"><a href="#_4-6-2-实现" class="header-anchor">#</a> 4.6.2 实现</h4> <h5 id="_1-src-index-html-4"><a href="#_1-src-index-html-4" class="header-anchor">#</a> 1. src\index.html</h5> <p>src\index.html</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-arrow deleted">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
</span>
<span class="token deleted-arrow deleted">&lt;head&gt;
</span><span class="token unchanged">    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;monitor&lt;/title&gt;
</span><span class="token deleted-arrow deleted">&lt;/head&gt;
</span>
<span class="token deleted-arrow deleted">&lt;body style=&quot;background-color: green;&quot;&gt;
</span><span class="token unchanged">    &lt;div id=&quot;container&quot;&gt;
        &lt;div class=&quot;content&quot; style=&quot;width:600px;height:600px;word-wrap:break-word;&quot;&gt;
            &lt;input /&gt;
        &lt;/div&gt;
    &lt;/div&gt;
</span>
<span class="token unchanged">    &lt;script&gt;
        let content = document.getElementsByClassName('content')[0];
        //content.innerHTML = '@'.repeat(10000);
</span><span class="token inserted-sign inserted">+        setTimeout(() =&gt; {
+            let h1 = document.createElement('h1');
+            h1.innerHTML = '我是最有重要的内容';
+            h1.setAttribute('elementtiming', 'meaningful');
+            content.appendChild(h1);
+        }, 2000);
</span><span class="token unchanged">    &lt;/script&gt;
</span><span class="token deleted-arrow deleted">&lt;/body&gt;
</span>
<span class="token deleted-arrow deleted">&lt;/html&gt;
</span></code></pre></div><h5 id="_2-timing-js"><a href="#_2-timing-js" class="header-anchor">#</a> 2. timing.js</h5> <p>src\monitor\lib\timing.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import onload from '../util/onload';
import tracker from '../util/tracker';
import formatTime from '../util/formatTime';
import getLastEvent from '../util/getLastEvent';
import getSelector from '../util/getSelector';
export function timing() {
<span class="token inserted-sign inserted">+    let FMP, LCP;
+    new PerformanceObserver((entryList, observer) =&gt; {
+        let perfEntries = entryList.getEntries();
+        FMP = perfEntries[0];
+        observer.disconnect();
+    }).observe({ entryTypes: ['element'] });
</span>
<span class="token inserted-sign inserted">+    new PerformanceObserver((entryList, observer) =&gt; {
+        const perfEntries = entryList.getEntries();
+        const lastEntry = perfEntries[perfEntries.length - 1];
+        LCP = lastEntry;
+        observer.disconnect();
+    }).observe({ entryTypes: ['largest-contentful-paint'] });
</span>
<span class="token inserted-sign inserted">+    new PerformanceObserver(function (entryList, observer) {
+        let lastEvent = getLastEvent();
+        const firstInput = entryList.getEntries()[0];
+        if (firstInput) {
+            let inputDelay = firstInput.processingStart - firstInput.startTime;//处理延迟
+            let duration = firstInput.duration;//处理耗时
+            if (firstInput &gt; 0 || duration &gt; 0) {
+                tracker.send({
+                    kind: 'experience',
+                    type: 'firstInputDelay',
+                    inputDelay: inputDelay ? formatTime(inputDelay) : 0,
+                    duration: duration ? formatTime(duration) : 0,
+                    startTime: firstInput.startTime,
+                    selector: lastEvent ? getSelector(lastEvent.path || lastEvent.target) : ''
+                });
+            }
+        }
+        observer.disconnect();
+    }).observe({ type: 'first-input', buffered: true });
</span>

<span class="token unchanged">    onload(function () {
        setTimeout(() =&gt; {
            const {
                fetchStart,
                connectStart,
                connectEnd,
                requestStart,
                responseStart,
                responseEnd,
                domLoading,
                domInteractive,
                domContentLoadedEventStart,
                domContentLoadedEventEnd,
                loadEventStart } = performance.timing;
            tracker.send({
                kind: 'experience',
                type: 'timing',
                connectTime: connectEnd - connectStart,//TCP连接耗时
                ttfbTime: responseStart - requestStart,//ttfb
                responseTime: responseEnd - responseStart,//Response响应耗时
                parseDOMTime: loadEventStart - domLoading,//DOM解析渲染耗时
                domContentLoadedTime: domContentLoadedEventEnd - domContentLoadedEventStart,//DOMContentLoaded事件回调耗时
                timeToInteractive: domInteractive - fetchStart,//首次可交互时间
                loadTime: loadEventStart - fetchStart//完整的加载时间
            });
</span><span class="token inserted-sign inserted">+            const FP = performance.getEntriesByName('first-paint')[0];
+            const FCP = performance.getEntriesByName('first-contentful-paint')[0];
+            console.log('FP', FP);
+            console.log('FCP', FCP);
+            console.log('FMP', FMP);
+            console.log('LCP', LCP);
+            tracker.send({
+                kind: 'experience',
+                type: 'paint',
+                firstPaint: FP ? formatTime(FP.startTime) : 0,
+                firstContentPaint: FCP ? formatTime(FCP.startTime) : 0,
+                firstMeaningfulPaint: FMP ? formatTime(FMP.startTime) : 0,
+                largestContentfulPaint: LCP ? formatTime(LCP.renderTime || LCP.loadTime) : 0
+            });
</span><span class="token unchanged">        }, 3000);
    });
</span>}
</code></pre></div><h3 id="_4-7-卡顿"><a href="#_4-7-卡顿" class="header-anchor">#</a> 4.7 卡顿</h3> <ul><li>响应用户交互的响应时间如果大于100ms,用户就会感觉卡顿</li></ul> <h4 id="_4-7-1-数据设计"><a href="#_4-7-1-数据设计" class="header-anchor">#</a> 4.7.1 数据设计</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590828656781&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;experience&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;longTask&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;eventType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mouseover&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;startTime&quot;</span><span class="token operator">:</span> <span class="token string">&quot;9331&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;duration&quot;</span><span class="token operator">:</span> <span class="token string">&quot;200&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HTML BODY #container .content&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-7-2-实现"><a href="#_4-7-2-实现" class="header-anchor">#</a> 4.7.2 实现</h4> <h5 id="_1-src-index-html-5"><a href="#_1-src-index-html-5" class="header-anchor">#</a> 1. src\index.html</h5> <p>src\index.html</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-arrow deleted">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
</span>
<span class="token deleted-arrow deleted">&lt;head&gt;
</span><span class="token unchanged">    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;monitor&lt;/title&gt;
</span><span class="token deleted-arrow deleted">&lt;/head&gt;
</span>
<span class="token deleted-arrow deleted">&lt;body style=&quot;background-color: green;&quot;&gt;
</span><span class="token unchanged">    &lt;div id=&quot;container&quot;&gt;
        &lt;div class=&quot;content&quot; style=&quot;width:600px;height:600px;word-wrap:break-word;&quot;&gt;
</span><span class="token inserted-sign inserted">+            &lt;button id=&quot;longTaskBtn&quot;&gt;执行longTask&lt;/button&gt;
</span><span class="token unchanged">        &lt;/div&gt;
    &lt;/div&gt;
</span>
<span class="token unchanged">    &lt;script&gt;
        let content = document.getElementsByClassName('content')[0];
</span><span class="token inserted-sign inserted">+        let longTaskBtn = document.getElementById('longTaskBtn');
+        longTaskBtn.addEventListener('click', longTask);
+        function longTask() {
+            let start = Date.now();
+            console.log('longTask开始 start', start);
+            while (Date.now() &lt; (200 + start)) { }
+            console.log('longTask结束 end', (Date.now() - start));
+        }
</span><span class="token unchanged">    &lt;/script&gt;
</span><span class="token deleted-arrow deleted">&lt;/body&gt;
</span>
<span class="token deleted-arrow deleted">&lt;/html&gt;
</span></code></pre></div><h5 id="_2-monitor-index-js-4"><a href="#_2-monitor-index-js-4" class="header-anchor">#</a> 2. monitor\index.js</h5> <p>src\monitor\index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import { injectJsError } from './lib/jsError';
import { injectXHR } from './lib/xhr';
import { blankScreen } from './lib/blankScreen';
import { timing } from './lib/timing';
<span class="token inserted-sign inserted">+import { longTask } from './lib/longTask';
</span>injectJsError();
injectXHR();
blankScreen();
timing();
<span class="token inserted-sign inserted">+longTask();
</span></code></pre></div><h5 id="_3-longtask-js"><a href="#_3-longtask-js" class="header-anchor">#</a> 3. longTask.js</h5> <p>src\monitor\lib\longTask.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> formatTime <span class="token keyword">from</span> <span class="token string">'../util/formatTime'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getLastEvent <span class="token keyword">from</span> <span class="token string">'../util/getLastEvent'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> getSelector <span class="token keyword">from</span> <span class="token string">'../util/getSelector'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">longTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">list</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">entry</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>duration <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> lastEvent <span class="token operator">=</span> <span class="token function">getLastEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">requestIdleCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                        kind<span class="token operator">:</span> <span class="token string">'experience'</span><span class="token punctuation">,</span>
                        type<span class="token operator">:</span> <span class="token string">'longTask'</span><span class="token punctuation">,</span>
                        eventType<span class="token operator">:</span> lastEvent<span class="token punctuation">.</span>type<span class="token punctuation">,</span>
                        startTime<span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 开始时间</span>
                        duration<span class="token operator">:</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">// 持续时间</span>
                        selector<span class="token operator">:</span> lastEvent <span class="token operator">?</span> <span class="token function">getSelector</span><span class="token punctuation">(</span>lastEvent<span class="token punctuation">.</span>path <span class="token operator">||</span> lastEvent<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">''</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span> entryTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;longtask&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-8-pv"><a href="#_4-8-pv" class="header-anchor">#</a> 4.8 pv</h3> <ul><li><a href="https://wicg.github.io/netinfo" target="_blank" rel="noopener noreferrer">netinfo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>RTT(Round Trip Time)一个连接的往返时间，即数据发送时刻到接收到确认的时刻的差值</li> <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" target="_blank" rel="noopener noreferrer">navigator.sendBeacon()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法可用于通过HTTP将少量数据异步传输到Web服务器。</li></ul> <p><img src="http://img.zhufengpeixun.cn/rtttime2.jpg" alt="rtttime2"></p> <h4 id="_4-8-1-数据结构"><a href="#_4-8-1-数据结构" class="header-anchor">#</a> 4.8.1 数据结构</h4> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;前端监控系统&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;timestamp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1590829304423&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;userAgent&quot;</span><span class="token operator">:</span> <span class="token string">&quot;chrome&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kind&quot;</span><span class="token operator">:</span> <span class="token string">&quot;business&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;pv&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;effectiveType&quot;</span><span class="token operator">:</span> <span class="token string">&quot;4g&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;rtt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;50&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;screen&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2049x1152&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-8-2-实现"><a href="#_4-8-2-实现" class="header-anchor">#</a> 4.8.2 实现</h4> <h5 id="_1-src-index-html-6"><a href="#_1-src-index-html-6" class="header-anchor">#</a> 1. src\index.html</h5> <p>src\index.html</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token deleted-arrow deleted">&lt;head&gt;
</span><span class="token unchanged">    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;前端监控SDK&lt;/title&gt;
</span><span class="token deleted-arrow deleted">&lt;/head&gt;
</span></code></pre></div><h5 id="_2-src-monitor-index-js"><a href="#_2-src-monitor-index-js" class="header-anchor">#</a> 2. src\monitor\index.js</h5> <p>src\monitor\index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import { injectJsError } from './lib/jsError';
import { injectXHR } from './lib/xhr';
import { blankScreen } from './lib/blankScreen';
import { timing } from './lib/timing';
import { longTask } from './lib/longTask';
<span class="token inserted-sign inserted">+import { pv } from './lib/pv';
</span>injectJsError();
injectXHR();
blankScreen();
timing();
longTask();
<span class="token inserted-sign inserted">+pv();
</span></code></pre></div><h5 id="_3-pv-js"><a href="#_3-pv-js" class="header-anchor">#</a> 3. pv.js</h5> <p>src\monitor\lib\pv.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> tracker <span class="token keyword">from</span> <span class="token string">'../util/tracker'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">pv</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> connection <span class="token operator">=</span> navigator<span class="token punctuation">.</span>connection<span class="token punctuation">;</span>
    tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        kind<span class="token operator">:</span> <span class="token string">'business'</span><span class="token punctuation">,</span>
        type<span class="token operator">:</span> <span class="token string">'pv'</span><span class="token punctuation">,</span>
        effectiveType<span class="token operator">:</span> connection<span class="token punctuation">.</span>effectiveType<span class="token punctuation">,</span> <span class="token comment">//网络环境</span>
        rtt<span class="token operator">:</span> connection<span class="token punctuation">.</span>rtt<span class="token punctuation">,</span><span class="token comment">//往返时间</span>
        screen<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>width<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>window<span class="token punctuation">.</span>screen<span class="token punctuation">.</span>height<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token comment">//设备分辨率</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> stayTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
        tracker<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            kind<span class="token operator">:</span> <span class="token string">'business'</span><span class="token punctuation">,</span>
            type<span class="token operator">:</span> <span class="token string">'stayTime'</span><span class="token punctuation">,</span>
            stayTime
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5-查询报表"><a href="#_5-查询报表" class="header-anchor">#</a> 5.查询报表</h2> <ul><li><a href="https://help.aliyun.com/document_detail/69313.html" target="_blank" rel="noopener noreferrer">图表说明<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>查询日志数据</li> <li>聚类分析</li> <li>数据可视化
<ul><li>趋势 柱状图、拆线图、曲线图</li> <li>比例 饼图、环状图、面积图</li></ul></li> <li>仪表盘</li></ul> <h3 id="_5-1-监控项分布"><a href="#_5-1-监控项分布" class="header-anchor">#</a> 5.1 监控项分布</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> type<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> type <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre></div><h3 id="_5-2-浏览器分布"><a href="#_5-2-浏览器分布" class="header-anchor">#</a> 5.2 浏览器分布</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> userAgent<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> userAgent <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre></div><h3 id="_5-3-页面分辨率分布"><a href="#_5-3-页面分辨率分布" class="header-anchor">#</a> 5.3 页面分辨率分布</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">*</span> <span class="token operator">|</span> <span class="token constant">SELECT</span> screen<span class="token punctuation">,</span> <span class="token constant">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> number <span class="token constant">GROUP</span> <span class="token constant">BY</span> screen <span class="token constant">LIMIT</span> <span class="token number">10</span>
</code></pre></div><h2 id="_6-参考"><a href="#_6-参考" class="header-anchor">#</a> 6.参考</h2> <h3 id="_6-1-第三方"><a href="#_6-1-第三方" class="header-anchor">#</a> 6.1 第三方</h3> <h4 id="_6-1-1-商业产品"><a href="#_6-1-1-商业产品" class="header-anchor">#</a> 6.1.1 商业产品</h4> <ul><li><a href="https://www.sensorsdata.cn/" target="_blank" rel="noopener noreferrer">神策数据<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.growingio.com/" target="_blank" rel="noopener noreferrer">GrowingIO<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h4 id="_6-1-2-开源产品"><a href="#_6-1-2-开源产品" class="header-anchor">#</a> 6.1.2 开源产品</h4> <ul><li><a href="https://www.fundebug.com/" target="_blank" rel="noopener noreferrer">fundebug<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://github.com/BetterJS/doc" target="_blank" rel="noopener noreferrer">BetterJS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://sentry.io/" target="_blank" rel="noopener noreferrer">Sentry<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://sentry.io/onboarding/zhufeng/get-started/" target="_blank" rel="noopener noreferrer">@sentry/browser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_6-2-defer-和-async"><a href="#_6-2-defer-和-async" class="header-anchor">#</a> 6.2 defer 和 async</h3> <ul><li><p>defer异步下载JavaScript文件,会在HTML解析完成之后</p> <div class="language- extra-class"><pre class="language-text"><code>DOMContentLoaded
</code></pre></div><p>事件调用前执行,不会阻塞页面渲染</p> <ul><li>如果script标签设置了该属性，则浏览器会异步的下载该文件并且不会影响到后续DOM的渲染</li> <li>如果有多个设置了defer的script标签存在，则会按照顺序执行所有的script</li> <li>defer脚本会在文档渲染完毕后，<code>DOMContentLoaded</code>事件调用前执行</li></ul></li> <li><p>async异步下载JavaScript文件，下载完成之后会立即执行，有可能会阻塞页面渲染</p> <ul><li>async的设置,会使得script脚本异步的加载并在允许的情况下执行</li> <li>async的执行,并不会按着script在页面中的顺序来执行，而是谁先加载完谁执行</li></ul></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">5/30/2020, 10:54:49 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/other/04-websocket.html" class="prev">
        04. WebSocket
      </a></span> <span class="next"><a href="/other/06-monitor-2.html">
        06. 工业级前端监控2
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2af561cb.js" defer></script><script src="/assets/js/2.b2a5c435.js" defer></script><script src="/assets/js/16.49eb1f17.js" defer></script>
  </body>
</html>
