<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>02. dva source | 珠峰架构</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.1657c744.css" as="style"><link rel="preload" href="/assets/js/app.2af561cb.js" as="script"><link rel="preload" href="/assets/js/2.b2a5c435.js" as="script"><link rel="preload" href="/assets/js/36.e8890e58.js" as="script"><link rel="prefetch" href="/assets/js/10.2b2c8443.js"><link rel="prefetch" href="/assets/js/11.689524dc.js"><link rel="prefetch" href="/assets/js/12.849e2da9.js"><link rel="prefetch" href="/assets/js/13.c798d95d.js"><link rel="prefetch" href="/assets/js/14.380c4ee7.js"><link rel="prefetch" href="/assets/js/15.d5753b2e.js"><link rel="prefetch" href="/assets/js/16.49eb1f17.js"><link rel="prefetch" href="/assets/js/17.5ecf2b4f.js"><link rel="prefetch" href="/assets/js/18.da9c8265.js"><link rel="prefetch" href="/assets/js/19.59d827ef.js"><link rel="prefetch" href="/assets/js/20.73eb42bb.js"><link rel="prefetch" href="/assets/js/21.8570b5b4.js"><link rel="prefetch" href="/assets/js/22.34094913.js"><link rel="prefetch" href="/assets/js/23.5209939b.js"><link rel="prefetch" href="/assets/js/24.53d92201.js"><link rel="prefetch" href="/assets/js/25.7241adf1.js"><link rel="prefetch" href="/assets/js/26.fecc2611.js"><link rel="prefetch" href="/assets/js/27.e50fca48.js"><link rel="prefetch" href="/assets/js/28.4c168acc.js"><link rel="prefetch" href="/assets/js/29.f5186710.js"><link rel="prefetch" href="/assets/js/3.ba1dcccd.js"><link rel="prefetch" href="/assets/js/30.33cb1c11.js"><link rel="prefetch" href="/assets/js/31.c088791d.js"><link rel="prefetch" href="/assets/js/32.3b724af5.js"><link rel="prefetch" href="/assets/js/33.f975c942.js"><link rel="prefetch" href="/assets/js/34.7d1f4bd2.js"><link rel="prefetch" href="/assets/js/35.26c11750.js"><link rel="prefetch" href="/assets/js/37.516eba46.js"><link rel="prefetch" href="/assets/js/38.4f8b8525.js"><link rel="prefetch" href="/assets/js/39.26f95568.js"><link rel="prefetch" href="/assets/js/4.fca74266.js"><link rel="prefetch" href="/assets/js/40.b9a8ffbb.js"><link rel="prefetch" href="/assets/js/41.fd02ea5f.js"><link rel="prefetch" href="/assets/js/42.d2483185.js"><link rel="prefetch" href="/assets/js/43.70bff2de.js"><link rel="prefetch" href="/assets/js/44.219702ca.js"><link rel="prefetch" href="/assets/js/45.aba93af9.js"><link rel="prefetch" href="/assets/js/46.447ba87c.js"><link rel="prefetch" href="/assets/js/47.519ddc28.js"><link rel="prefetch" href="/assets/js/48.fd8af347.js"><link rel="prefetch" href="/assets/js/49.b3783fa9.js"><link rel="prefetch" href="/assets/js/5.cc992e8b.js"><link rel="prefetch" href="/assets/js/50.0bb20f92.js"><link rel="prefetch" href="/assets/js/51.37ba1a59.js"><link rel="prefetch" href="/assets/js/52.054af132.js"><link rel="prefetch" href="/assets/js/53.5aca78a0.js"><link rel="prefetch" href="/assets/js/54.78c43f89.js"><link rel="prefetch" href="/assets/js/55.8ecaadc1.js"><link rel="prefetch" href="/assets/js/56.e844f110.js"><link rel="prefetch" href="/assets/js/57.530db0e9.js"><link rel="prefetch" href="/assets/js/58.8c839289.js"><link rel="prefetch" href="/assets/js/59.6634b409.js"><link rel="prefetch" href="/assets/js/6.b8b36e50.js"><link rel="prefetch" href="/assets/js/60.7ebe5787.js"><link rel="prefetch" href="/assets/js/61.bfe89a8b.js"><link rel="prefetch" href="/assets/js/62.4cdf6e8c.js"><link rel="prefetch" href="/assets/js/63.a0e80f0d.js"><link rel="prefetch" href="/assets/js/64.62a1b782.js"><link rel="prefetch" href="/assets/js/65.7be0994b.js"><link rel="prefetch" href="/assets/js/66.5a592a8e.js"><link rel="prefetch" href="/assets/js/67.40b4291c.js"><link rel="prefetch" href="/assets/js/68.2ac34b58.js"><link rel="prefetch" href="/assets/js/69.728773d5.js"><link rel="prefetch" href="/assets/js/7.0414e914.js"><link rel="prefetch" href="/assets/js/70.30137f66.js"><link rel="prefetch" href="/assets/js/71.7735c9fc.js"><link rel="prefetch" href="/assets/js/72.e9f43339.js"><link rel="prefetch" href="/assets/js/73.2d754e71.js"><link rel="prefetch" href="/assets/js/74.bf70dd09.js"><link rel="prefetch" href="/assets/js/75.18c28356.js"><link rel="prefetch" href="/assets/js/76.a0626bc9.js"><link rel="prefetch" href="/assets/js/77.dfde57e0.js"><link rel="prefetch" href="/assets/js/78.b380a0d6.js"><link rel="prefetch" href="/assets/js/79.f7bafb5d.js"><link rel="prefetch" href="/assets/js/8.c3544379.js"><link rel="prefetch" href="/assets/js/80.ade6c33e.js"><link rel="prefetch" href="/assets/js/81.6335ba85.js"><link rel="prefetch" href="/assets/js/82.9d01c14e.js"><link rel="prefetch" href="/assets/js/83.47911fdd.js"><link rel="prefetch" href="/assets/js/9.844fca3b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1657c744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">珠峰架构</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable router-link-active open"><span>react</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/basic/" class="sidebar-heading clickable"><span>基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/fiber/" class="sidebar-heading clickable"><span>Fiber</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/router/" class="sidebar-heading clickable"><span>react router</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/redux/" class="sidebar-heading clickable"><span>redux</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/ssr/" class="sidebar-heading clickable"><span>SSR</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/nextjs/" class="sidebar-heading clickable"><span>nextjs</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/dva/" class="sidebar-heading clickable router-link-active open"><span>dva</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/dva/01-dva.html" class="sidebar-link">01. dva</a></li><li><a href="/react/dva/02-dva-source.html" class="active sidebar-link">02. dva source</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_1-dva介绍" class="sidebar-link">1.dva介绍</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_2-初始化项目" class="sidebar-link">2. 初始化项目</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_3-基本计数器" class="sidebar-link">3. 基本计数器</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_4-支持effects" class="sidebar-link">4. 支持effects</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_5-支持路由" class="sidebar-link">5. 支持路由</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_6-跳转路径" class="sidebar-link">6. 跳转路径</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_7-dva-loading" class="sidebar-link">7. dva-loading</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_8-dynamic" class="sidebar-link">8. dynamic</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_9-onaction中间件" class="sidebar-link">9. onAction中间件</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_10-statechange" class="sidebar-link">10. stateChange</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_11-onreducer" class="sidebar-link">11. onReducer</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_12-extraenhancers" class="sidebar-link">12. extraEnhancers</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_13-dva-immer" class="sidebar-link">13. dva-immer</a></li><li class="sidebar-sub-header"><a href="/react/dva/02-dva-source.html#_14-onerror" class="sidebar-link">14. onError</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/umi/" class="sidebar-heading clickable"><span>umi</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/component/" class="sidebar-heading clickable"><span>组件</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/interview/" class="sidebar-heading clickable"><span>面试</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/flutter/" class="sidebar-heading clickable"><span>flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/" class="sidebar-heading clickable"><span>interview</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/other/" class="sidebar-heading clickable"><span>other</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_02-dva-source"><a href="#_02-dva-source" class="header-anchor">#</a> 02. dva source</h1> <h2 id="_1-dva介绍"><a href="#_1-dva介绍" class="header-anchor">#</a> 1.dva介绍</h2> <ul><li><a href="https://github.com/dvajs/dva" target="_blank" rel="noopener noreferrer">dva<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>首先是一个基于 <code>redux</code> 和 <code>redux-saga</code> 的数据流方案，然后为了简化开发体验,dva 还额外内置了 <code>react-router</code> 和 <code>fetch</code>,所以也可以理解为一个轻量级的应用框架</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-020203.png" alt="dva"></p> <h3 id="_1-1-前置知识"><a href="#_1-1-前置知识" class="header-anchor">#</a> 1.1 前置知识</h3> <ul><li>react</li> <li>react-router-dom</li> <li>redux</li> <li>react-redux</li> <li>connected-react-router</li> <li>history</li> <li>dva</li></ul> <h2 id="_2-初始化项目"><a href="#_2-初始化项目" class="header-anchor">#</a> 2. 初始化项目</h2> <div class="language-js extra-class"><pre class="language-js"><code>create<span class="token operator">-</span>react<span class="token operator">-</span>app zhufeng<span class="token operator">-</span>dva<span class="token operator">-</span>source<span class="token operator">-</span>typescript <span class="token operator">--</span>typescript
cd  zhufeng<span class="token operator">-</span>dva<span class="token operator">-</span>source<span class="token operator">-</span>typescript
cnpm install dva@<span class="token number">2.6</span><span class="token number">.0</span><span class="token operator">-</span>beta<span class="token punctuation">.</span><span class="token number">20</span> redux react<span class="token operator">-</span>redux react<span class="token operator">-</span>router<span class="token operator">-</span>dom connected<span class="token operator">-</span>react<span class="token operator">-</span>router history <span class="token operator">--</span>save
npm start
</code></pre></div><h2 id="_3-基本计数器"><a href="#_3-基本计数器" class="header-anchor">#</a> 3. 基本计数器</h2> <h3 id="_3-1-使用"><a href="#_3-1-使用" class="header-anchor">#</a> 3.1 使用</h3> <h4 id="_3-1-1-index-tsx"><a href="#_3-1-1-index-tsx" class="header-anchor">#</a> 3.1.1 index.tsx</h4> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> dva<span class="token punctuation">,</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./dva'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">dva</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    namespace<span class="token operator">:</span> <span class="token string">'counter'</span><span class="token punctuation">,</span>
    state<span class="token operator">:</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> number<span class="token operator">:</span> state<span class="token punctuation">.</span>number <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">Counter</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
            </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;counter/add&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">+</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
        </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> ConnectedCounter <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>counter
<span class="token punctuation">)</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">router</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ConnectedCounter</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-2-实现"><a href="#_3-2-实现" class="header-anchor">#</a> 3.2 实现</h3> <h4 id="_3-2-1-dva-index-tsx"><a href="#_3-2-1-dva-index-tsx" class="header-anchor">#</a> 3.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore<span class="token punctuation">,</span> combineReducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect<span class="token punctuation">,</span> Provider <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> DvaInstance<span class="token punctuation">,</span> Router<span class="token punctuation">,</span> Model <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./typings'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> prefixNamespace <span class="token keyword">from</span> <span class="token string">'./prefixNamespace'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> app<span class="token operator">:</span> DvaInstance <span class="token operator">=</span> <span class="token punctuation">{</span>
        _models<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        router<span class="token punctuation">,</span>
        _router<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        start
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> initialReducers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token parameter">model<span class="token operator">:</span> Model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> prefixedModel <span class="token operator">=</span> <span class="token function">prefixNamespace</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        app<span class="token punctuation">.</span>_models<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>prefixedModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> prefixedModel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">router</span><span class="token punctuation">(</span><span class="token parameter">router<span class="token operator">:</span> Router</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span>_router <span class="token operator">=</span> router<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> model <span class="token keyword">of</span> app<span class="token punctuation">.</span>_models<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            initialReducers<span class="token punctuation">[</span>model<span class="token punctuation">.</span>namespace<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getReducer</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> rootReducer <span class="token operator">=</span> <span class="token function">createReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>rootReducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">store</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>app<span class="token punctuation">.</span><span class="token function">_router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">createReducer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>initialReducers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> app<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getReducer</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> reducers<span class="token punctuation">,</span> state<span class="token operator">:</span> defaultState <span class="token punctuation">}</span> <span class="token operator">=</span> model<span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token function-variable function">reducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> reducer <span class="token operator">=</span> reducers<span class="token punctuation">[</span>action<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reducer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> reducer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./typings'</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-2-2-prefixnamespace-tsx"><a href="#_3-2-2-prefixnamespace-tsx" class="header-anchor">#</a> 3.2.2 prefixNamespace.tsx</h4> <p>src\dva\prefixNamespace.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">NAMESPACE_SEP</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">prefix</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> namespace</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> newKey <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>namespace<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">NAMESPACE_SEP</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        memo<span class="token punctuation">[</span>newKey<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">prefixNamespace</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token punctuation">.</span>reducers<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>reducers <span class="token operator">=</span> <span class="token function">prefix</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>reducers<span class="token punctuation">,</span> model<span class="token punctuation">.</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> model<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-2-3-constants-tsx"><a href="#_3-2-3-constants-tsx" class="header-anchor">#</a> 3.2.3 constants.tsx</h4> <p>src\dva\constants.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">NAMESPACE_SEP</span> <span class="token operator">=</span> <span class="token string">'/'</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-2-4-typings-tsx"><a href="#_3-2-4-typings-tsx" class="header-anchor">#</a> 3.2.4 typings.tsx</h4> <p>src\dva\typings.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Dispatch<span class="token punctuation">,</span> Reducer<span class="token punctuation">,</span> AnyAction<span class="token punctuation">,</span> MiddlewareAPI<span class="token punctuation">,</span> StoreEnhancer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> History <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'history'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReducersMapObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Reducer<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReducerEnhancer</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>reducer<span class="token operator">:</span> Reducer<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">EffectsCommandMap</span> <span class="token punctuation">{</span>
    put<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name">AnyAction</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token operator">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> any<span class="token punctuation">,</span>
    call<span class="token operator">:</span> Function<span class="token punctuation">,</span>
    select<span class="token operator">:</span> Function<span class="token punctuation">,</span>
    take<span class="token operator">:</span> Function<span class="token punctuation">,</span>
    cancel<span class="token operator">:</span> Function<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> type EffectType <span class="token operator">=</span> <span class="token string">'takeEvery'</span> <span class="token operator">|</span> <span class="token string">'takeLatest'</span> <span class="token operator">|</span> <span class="token string">'watcher'</span> <span class="token operator">|</span> <span class="token string">'throttle'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> type EffectWithType <span class="token operator">=</span> <span class="token punctuation">[</span>Effect<span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> EffectType <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> type <span class="token function-variable function">Effect</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action<span class="token operator">:</span> AnyAction<span class="token punctuation">,</span> effects<span class="token operator">:</span> EffectsCommandMap</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> type ReducersMapObjectWithEnhancer <span class="token operator">=</span> <span class="token punctuation">[</span>ReducersMapObject<span class="token punctuation">,</span> ReducerEnhancer<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">EffectsMapObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Effect <span class="token operator">|</span> EffectWithType<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SubscriptionsMapObject</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> string<span class="token punctuation">]</span><span class="token operator">:</span> Subscription<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SubscriptionAPI</span> <span class="token punctuation">{</span>
    history<span class="token operator">:</span> History<span class="token punctuation">,</span>
    dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> type <span class="token function-variable function">Subscription</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">api<span class="token operator">:</span> SubscriptionAPI<span class="token punctuation">,</span> done<span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
    namespace<span class="token operator">:</span> string<span class="token punctuation">,</span>
    state<span class="token operator">?</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
    reducers<span class="token operator">?</span><span class="token operator">:</span> ReducersMapObject <span class="token operator">|</span> ReducersMapObjectWithEnhancer<span class="token punctuation">,</span>
    effects<span class="token operator">?</span><span class="token operator">:</span> EffectsMapObject<span class="token punctuation">,</span>
    subscriptions<span class="token operator">?</span><span class="token operator">:</span> SubscriptionsMapObject<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">RouterAPI</span> <span class="token punctuation">{</span>
    history<span class="token operator">:</span> History<span class="token punctuation">,</span>
    app<span class="token operator">:</span> DvaInstance<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Router</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>api<span class="token operator">?</span><span class="token operator">:</span> RouterAPI<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">JSX</span><span class="token punctuation">.</span>Element <span class="token operator">|</span> Object<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">onActionFunc</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>api<span class="token operator">:</span> MiddlewareAPI<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Hooks</span> <span class="token punctuation">{</span>
    onError<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">e<span class="token operator">:</span> Error<span class="token punctuation">,</span> dispatch<span class="token operator">:</span> Dispatch<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    onAction<span class="token operator">?</span><span class="token operator">:</span> onActionFunc <span class="token operator">|</span> onActionFunc<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    onStateChange<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    onReducer<span class="token operator">?</span><span class="token operator">:</span> ReducerEnhancer<span class="token punctuation">,</span>
    onEffect<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    onHmr<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    extraReducers<span class="token operator">?</span><span class="token operator">:</span> ReducersMapObject<span class="token punctuation">,</span>
    extraEnhancers<span class="token operator">?</span><span class="token operator">:</span> StoreEnhancer<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">DvaInstance</span> <span class="token keyword">extends</span> <span class="token class-name">Record</span><span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//use: (hooks: Hooks) =&gt; void,</span>
    <span class="token function-variable function">model</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">model<span class="token operator">:</span> Model</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    <span class="token comment">//unmodel: (namespace: string) =&gt; void,</span>
    <span class="token function-variable function">router</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">router<span class="token operator">:</span> Router</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
    <span class="token function-variable function">start</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">selector<span class="token operator">?</span><span class="token operator">:</span> HTMLElement <span class="token operator">|</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> any<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-支持effects"><a href="#_4-支持effects" class="header-anchor">#</a> 4. 支持effects</h2> <h3 id="_4-1-使用"><a href="#_4-1-使用" class="header-anchor">#</a> 4.1 使用</h3> <h4 id="_4-1-1-index-tsx"><a href="#_4-1-1-index-tsx" class="header-anchor">#</a> 4.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
const app = dva();
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
</span><span class="token inserted-sign inserted">+    effects: {
+        *asyncAdd(action, { call, put }) {
+            yield call(delay, 1000);
+            yield put({ type: 'counter/add' });
+        }
+    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt;{props.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
</span><span class="token inserted-sign inserted">+            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
</span><span class="token unchanged">        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state.counter
</span>)(Counter);
app.router(() =&gt; &lt;ConnectedCounter /&gt;);
app.start('#root');

<span class="token inserted-sign inserted">+function delay(ms) {
+    return new Promise((resolve) =&gt; {
+        setTimeout(function () {
+            resolve();
+        }, ms);
+    });
+}
</span></code></pre></div><h3 id="_4-2-实现"><a href="#_4-2-实现" class="header-anchor">#</a> 4.2 实现</h3> <h4 id="_4-2-1-dva-index-tsx"><a href="#_4-2-1-dva-index-tsx" class="header-anchor">#</a> 4.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
<span class="token inserted-sign inserted">+import { createStore, combineReducers, applyMiddleware } from 'redux';
+import createSagaMiddleware from 'redux-saga';
+import * as sagaEffects from 'redux-saga/effects';
+import { NAMESPACE_SEP } from './constants';
</span>import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
export { connect };

export default function () {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = {};
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
    function router(router: Router) {
        app._router = router;
    }
</span>
<span class="token unchanged">    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
</span><span class="token inserted-sign inserted">+        const sagas = getSagas(app);
+        const sagaMiddleware = createSagaMiddleware();
+        let store = createStore(rootReducer, applyMiddleware(sagaMiddleware));
+        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
+        ReactDOM.render(&lt;Provider store={store}&gt;{app._router()}&lt;/Provider&gt;, document.querySelector(root));
</span><span class="token unchanged">        function createReducer() {
           return combineReducers(initialReducers);
        }
    }
</span><span class="token inserted-sign inserted">+    function getSagas(app) {
+        let sagas: Array&lt;any&gt; = [];
+        for (const model of app._models) {
+            sagas.push(getSaga(model.effects, model));
+        }
+        return sagas;
+    }
</span>
<span class="token unchanged">    return app;
</span>}

<span class="token inserted-sign inserted">+function getSaga(effects, model) {
+    return function* () {
+        for (const key in effects) {
+            const watcher = getWatcher(key, model.effects[key], model);
+            yield sagaEffects.fork(watcher);
+        }
+    };
+}
+function getWatcher(key, effect, model) {
+    return function* () {
+        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
+            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
+        });
+    };
+}
+function prefixType(type, model) {
+    if (type.indexOf('/') === -1) {
+        return `${model.namespace}${NAMESPACE_SEP}${type}`;
+    }
+    return type;
+}
</span>function getReducer(model) {
<span class="token unchanged">    let { reducers, state: defaultState } = model;
    let reducer = (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
    return reducer;
</span>}
</code></pre></div><h4 id="_4-2-2-prefixnamespace-tsx"><a href="#_4-2-2-prefixnamespace-tsx" class="header-anchor">#</a> 4.2.2 prefixNamespace.tsx</h4> <p>src\dva\prefixNamespace.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import { NAMESPACE_SEP } from './constants';
function prefix(obj, namespace) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        const newKey = `${namespace}${NAMESPACE_SEP}${key}`;
        memo[newKey] = obj[key];
        return memo;
    }, {});
</span>}
export default function prefixNamespace(model) {
<span class="token unchanged">    if (model.reducers)
        model.reducers = prefix(model.reducers, model.namespace);
</span><span class="token inserted-sign inserted">+    if (model.effects) {
+        model.effects = prefix(model.effects, model.namespace);
+    }
</span><span class="token unchanged">    return model;
</span>}
</code></pre></div><h2 id="_5-支持路由"><a href="#_5-支持路由" class="header-anchor">#</a> 5. 支持路由</h2> <h3 id="_5-1-使用"><a href="#_5-1-使用" class="header-anchor">#</a> 5.1 使用</h3> <h4 id="_5-1-1-index-tsx"><a href="#_5-1-1-index-tsx" class="header-anchor">#</a> 5.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
<span class="token inserted-sign inserted">+import { Router, Route } from './dva/router';
</span>const app = dva();
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt;{props.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state.counter
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;
<span class="token inserted-sign inserted">+app.router((api: any) =&gt; (
+    &lt;Router history={api.history}&gt;
+        &lt;&gt;
+            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
+            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
+        &lt;/&gt;
+    &lt;/Router&gt;
+));
</span>app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_5-2-实现"><a href="#_5-2-实现" class="header-anchor">#</a> 5.2 实现</h3> <h4 id="_5-2-1-dva-index-tsx"><a href="#_5-2-1-dva-index-tsx" class="header-anchor">#</a> 5.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
<span class="token inserted-sign inserted">+import { createHashHistory } from 'history';
+let history = createHashHistory();
</span>export { connect };

export default function () {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = {};
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
    function router(router: Router) {
        app._router = router;
    }
</span>
<span class="token unchanged">    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        let store = createStore(rootReducer, applyMiddleware(sagaMiddleware));
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
</span><span class="token inserted-sign inserted">+        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
</span><span class="token unchanged">        function createReducer() {
           return combineReducers(initialReducers);
        }
    }
    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers, state: defaultState } = model;
    let reducer = (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
    return reducer;
</span>}
export * from './typings';
</code></pre></div><h4 id="_5-2-2-router-tsx"><a href="#_5-2-2-router-tsx" class="header-anchor">#</a> 5.2.2 router.tsx</h4> <p>src\dva\router.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>export * from 'react-router-dom';
</code></pre></div><h2 id="_6-跳转路径"><a href="#_6-跳转路径" class="header-anchor">#</a> 6. 跳转路径</h2> <h3 id="_6-1-使用"><a href="#_6-1-使用" class="header-anchor">#</a> 6.1 使用</h3> <h4 id="_6-1-1-index-tsx"><a href="#_6-1-1-index-tsx" class="header-anchor">#</a> 6.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
<span class="token inserted-sign inserted">+import { Router, Route, routerRedux } from './dva/router';
+import { ConnectedRouter } from 'connected-react-router';
</span>const app = dva();
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
</span><span class="token inserted-sign inserted">+        *goto({ to }, { put }) {
+            yield put(routerRedux.push(to));
+        }
</span><span class="token unchanged">    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt;{props.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
</span><span class="token inserted-sign inserted">+            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
</span><span class="token unchanged">        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state.counter
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;
app.router((api: any) =&gt; (
<span class="token inserted-sign inserted">+    &lt;ConnectedRouter history={api.history}&gt;
</span><span class="token unchanged">        &lt;&gt;
            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
        &lt;/&gt;
</span><span class="token inserted-sign inserted">+    &lt;/ConnectedRouter&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_6-2-实现"><a href="#_6-2-实现" class="header-anchor">#</a> 6.2 实现</h3> <h4 id="_6-2-1-dva-index-tsx"><a href="#_6-2-1-dva-index-tsx" class="header-anchor">#</a> 6.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
<span class="token inserted-sign inserted">+import { routerMiddleware, connectRouter, ConnectedRouter } from &quot;connected-react-router&quot;;
</span>let history = createHashHistory();
export { connect };

export default function () {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
</span><span class="token inserted-sign inserted">+    const initialReducers = { router: connectRouter(history) };
</span><span class="token unchanged">    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
    function router(router: Router) {
        app._router = router;
    }
</span>
<span class="token unchanged">    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
</span><span class="token inserted-sign inserted">+        let store = createStore(rootReducer, applyMiddleware(routerMiddleware(history), sagaMiddleware));
</span><span class="token unchanged">        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root));
        function createReducer() {
           return combineReducers(initialReducers);
        }
    }
    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers, state: defaultState } = model;
    let reducer = (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
    return reducer;
</span>}
export * from './typings';
</code></pre></div><h4 id="_6-2-2-src-dva-router-tsx"><a href="#_6-2-2-src-dva-router-tsx" class="header-anchor">#</a> 6.2.2 src\dva\router.tsx</h4> <p>src\dva\router.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import * as routerRedux from 'connected-react-router';
export * from 'react-router-dom';
export {
<span class="token unchanged">    routerRedux
</span>}
</code></pre></div><h2 id="_7-dva-loading"><a href="#_7-dva-loading" class="header-anchor">#</a> 7. dva-loading</h2> <ul><li>Auto loading data binding plugin for dva. You don't need to write showLoading and hideLoading any more.</li> <li><a href="https://github.com/dvajs/dva/tree/master/packages/dva-loading" target="_blank" rel="noopener noreferrer">dva-loading<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p><img src="http://img.zhufengpeixun.cn/dva-loading.png" alt="dva-loading"></p> <h3 id="_7-1-使用"><a href="#_7-1-使用" class="header-anchor">#</a> 7.1 使用</h3> <h4 id="_7-1-1-index-tsx"><a href="#_7-1-1-index-tsx" class="header-anchor">#</a> 7.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux } from './dva/router';
import { ConnectedRouter } from 'connected-react-router';
<span class="token inserted-sign inserted">+import createLoading from './dva-loading';
</span>const app = dva();
<span class="token inserted-sign inserted">+app.use(createLoading());
</span>app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
</span><span class="token inserted-sign inserted">+            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
</span><span class="token unchanged">            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token inserted-sign inserted">+    (state) =&gt; state
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;
app.router((api: any) =&gt; (
<span class="token inserted-sign inserted">+    &lt;Router history={api.history}&gt;
</span><span class="token unchanged">        &lt;&gt;
            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
        &lt;/&gt;
</span><span class="token inserted-sign inserted">+    &lt;/Router&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_7-2-实现"><a href="#_7-2-实现" class="header-anchor">#</a> 7.2 实现</h3> <h4 id="_7-2-1-dva-index-tsx"><a href="#_7-2-1-dva-index-tsx" class="header-anchor">#</a> 7.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
<span class="token inserted-sign inserted">+import Plugin, { filterHooks } from './plugin';
</span>import { routerMiddleware, connectRouter, ConnectedRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

<span class="token inserted-sign inserted">+export default function (opts = {}) {
</span><span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
    function router(router: Router) {
        app._router = router;
    }
</span><span class="token inserted-sign inserted">+    const plugin = new Plugin();
+    plugin.use(filterHooks(opts));
+    app.use = plugin.use.bind(plugin);
</span><span class="token unchanged">    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        let store = createStore(rootReducer, applyMiddleware(routerMiddleware(history), sagaMiddleware));
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root));
        function createReducer() {
</span><span class="token inserted-sign inserted">+        const extraReducers = plugin.get('extraReducers');
+        return combineReducers({
+            ...initialReducers,
+            ...extraReducers
+        });
</span><span class="token unchanged">       }
    }
    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
</span><span class="token inserted-sign inserted">+            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
</span><span class="token unchanged">        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

<span class="token inserted-sign inserted">+function getSaga(effects, model, onEffect) {
</span><span class="token unchanged">    return function* () {
        for (const key in effects) {
</span><span class="token inserted-sign inserted">+            const watcher = getWatcher(key, model.effects[key], model, onEffect);
</span><span class="token unchanged">            yield sagaEffects.fork(watcher);
        }
    };
</span>}
<span class="token inserted-sign inserted">+function getWatcher(key, effect, model, onEffect) {
</span><span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
</span><span class="token inserted-sign inserted">+            if (onEffect) {
+                for (const fn of onEffect) {
+                    effect = fn(effect, sagaEffects, model, key);
+                }
+            }
</span><span class="token unchanged">            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers, state: defaultState } = model;
    let reducer = (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
    return reducer;
</span>}
export * from './typings';
</code></pre></div><h4 id="_7-2-2-dva-loading-tsx"><a href="#_7-2-2-dva-loading-tsx" class="header-anchor">#</a> 7.2.2 dva-loading.tsx</h4> <p>src\dva-loading.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">SHOW</span> <span class="token operator">=</span> <span class="token string">'@@DVA_LOADING/SHOW'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">HIDE</span> <span class="token operator">=</span> <span class="token string">'@@DVA_LOADING/HIDE'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">NAMESPACE</span> <span class="token operator">=</span> <span class="token string">'loading'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createLoading</span><span class="token punctuation">(</span><span class="token parameter">opts<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
        global<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        models<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        effects<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> extraReducers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token constant">NAMESPACE</span><span class="token punctuation">]</span><span class="token punctuation">(</span>state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> <span class="token punctuation">{</span> type<span class="token punctuation">,</span> payload <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> namespace<span class="token punctuation">,</span> actionType <span class="token punctuation">}</span> <span class="token operator">=</span> payload <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> ret<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">SHOW</span><span class="token operator">:</span>
                    ret <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token operator">...</span>state<span class="token punctuation">,</span>
                        global<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                        models<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>models<span class="token punctuation">,</span> <span class="token punctuation">[</span>namespace<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        effects<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>effects<span class="token punctuation">,</span> <span class="token punctuation">[</span>actionType<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">HIDE</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>state<span class="token punctuation">.</span>effects<span class="token punctuation">,</span> <span class="token punctuation">[</span>actionType<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> models <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token operator">...</span>state<span class="token punctuation">.</span>models<span class="token punctuation">,</span>
                        <span class="token punctuation">[</span>namespace<span class="token punctuation">]</span><span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>effects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">actionType</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                            <span class="token keyword">const</span> _namespace <span class="token operator">=</span> actionType<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>_namespace <span class="token operator">!==</span> namespace<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> effects<span class="token punctuation">[</span>actionType<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> global <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>models<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">namespace</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> models<span class="token punctuation">[</span>namespace<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ret <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token operator">...</span>state<span class="token punctuation">,</span>
                        global<span class="token punctuation">,</span>
                        models<span class="token punctuation">,</span>
                        effects<span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    ret <span class="token operator">=</span> state<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">onEffect</span><span class="token punctuation">(</span><span class="token parameter">effect<span class="token punctuation">,</span> <span class="token punctuation">{</span> put <span class="token punctuation">}</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> actionType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> namespace <span class="token punctuation">}</span> <span class="token operator">=</span> model<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">SHOW</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token punctuation">{</span> namespace<span class="token punctuation">,</span> actionType <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">HIDE</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token punctuation">{</span> namespace<span class="token punctuation">,</span> actionType <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        extraReducers<span class="token punctuation">,</span>
        onEffect<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> createLoading<span class="token punctuation">;</span>
</code></pre></div><h4 id="_7-2-3-plugin-tsx"><a href="#_7-2-3-plugin-tsx" class="header-anchor">#</a> 7.2.3 plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> hooks <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'onEffect'</span><span class="token punctuation">,</span>
    <span class="token string">'extraReducers'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">filterHooks</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Plugin</span> <span class="token punctuation">{</span>
    hooks<span class="token operator">:</span> any
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> hooks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">memo<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            memo<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">plugin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> hooks <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> plugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>plugin<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> hooks <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'extraReducers'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getExtraReducers</span><span class="token punctuation">(</span>hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> hooks<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getExtraReducers</span><span class="token punctuation">(</span><span class="token parameter">hook</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> reducerObj <span class="token keyword">of</span> hook<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token operator">...</span>ret<span class="token punctuation">,</span> <span class="token operator">...</span>reducerObj <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_8-dynamic"><a href="#_8-dynamic" class="header-anchor">#</a> 8. dynamic</h2> <ul><li><div class="language- extra-class"><pre class="language-text"><code>dva/dynamic
</code></pre></div><p>是解决组件动态加载问题的方法。</p> <h3 id="_8-1-使用"><a href="#_8-1-使用" class="header-anchor">#</a> 8.1 使用</h3> <h4 id="_8-1-1-index-tsx"><a href="#_8-1-1-index-tsx" class="header-anchor">#</a> 8.1.1 index.tsx</h4></li></ul> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
<span class="token inserted-sign inserted">+import { Router, Route, routerRedux, Link } from './dva/router';
</span>import { ConnectedRouter } from 'connected-react-router';
import createLoading from './dva-loading';
<span class="token inserted-sign inserted">+import dynamic from './dva/dynamic';
</span>const app = dva();
app.use(createLoading());
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state
</span>)(Counter);
<span class="token inserted-sign inserted">+const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
+const UserPageComponent = (dynamic as any)({
+    app,
+    models: () =&gt; [
+        import('./models/users'),
+    ],
+    component: () =&gt; import('./routes/UserPage'),
+});
</span>app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;Router history={api.history}&gt;
        &lt;&gt;
</span><span class="token inserted-sign inserted">+            &lt;ul&gt;
+                &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
+                &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
+                &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
+            &lt;/ul&gt;
</span><span class="token unchanged">            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
</span><span class="token inserted-sign inserted">+           &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
</span><span class="token unchanged">        &lt;/&gt;
    &lt;/Router&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_8-2-实现"><a href="#_8-2-实现" class="header-anchor">#</a> 8.2 实现</h3> <h4 id="_8-2-1-dva-index-tsx"><a href="#_8-2-1-dva-index-tsx" class="header-anchor">#</a> 8.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter, ConnectedRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        let store = createStore(rootReducer, applyMiddleware(routerMiddleware(history), sagaMiddleware));
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
</span><span class="token inserted-sign inserted">+        app.model = injectModel.bind(app);
+        app._getSaga = getSaga;
+        function injectModel(m) {
+            m = model(m);
+            initialReducers[m.namespace] = getReducer(m);
+            store.replaceReducer(createReducer());
+            if (m.effects) {
+                sagaMiddleware.run(app._getSaga(m.effects, m));
+            }
+            if (m.subscriptions) {
+                runSubscription(m.subscriptions, m, app);
+            }
+        }
+        function runSubscription(subscriptions, model, app) {
+            for (const key in subscriptions) {
+                subscriptions[key](
+                    {
+                        dispatch: prefixedDispatch(store.dispatch, model),
+                        history: app._history,
+                    }
+                );
+            }
+        }
+        function prefixedDispatch(dispatch, model) {
+            return action =&gt; {
+                const { type } = action;
+                return dispatch({ ...action, type: prefixType(type, model) });
+            };
+        }
</span><span class="token unchanged">        function createReducer() {
            const extraReducers = plugin.get('extraReducers');
            return combineReducers({
                ...initialReducers,
                ...extraReducers
            });
        }
</span><span class="token inserted-sign inserted">+    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model, onEffect) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model, onEffect);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model, onEffect) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
</span><span class="token inserted-sign inserted">+    return (state = defaultState, action) =&gt; {
</span><span class="token unchanged">        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
</span>}
export * from './typings';
</code></pre></div><h4 id="_8-2-2-dynamic-tsx"><a href="#_8-2-2-dynamic-tsx" class="header-anchor">#</a> 8.2.2 dynamic.tsx</h4> <p>src\dva\dynamic.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> JSXElementConstructor <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">defaultLoadingComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>loading<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">dynamic</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> models<span class="token punctuation">,</span> component <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">DynamicComponent</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        LoadingComponent<span class="token operator">:</span> any <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>LoadingComponent <span class="token operator">=</span> config<span class="token punctuation">.</span>LoadingComponent <span class="token operator">||</span> defaultLoadingComponent<span class="token punctuation">;</span>
            <span class="token keyword">let</span> AsyncComponent<span class="token operator">:</span> JSXElementConstructor<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span> AsyncComponent <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token function">models</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>models<span class="token punctuation">,</span> component<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> resolveModels <span class="token operator">=</span> models<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">model</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>model <span class="token keyword">as</span> any<span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span>
                resolveModels<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">model</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    app<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> AsyncComponent <span class="token operator">=</span> component<span class="token punctuation">.</span>default <span class="token operator">||</span> component<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> AsyncComponent <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> AsyncComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> LoadingComponent <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>AsyncComponent<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">&lt;</span>AsyncComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">&lt;</span>LoadingComponent <span class="token punctuation">{</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_8-2-3-src-models-users-tsx"><a href="#_8-2-3-src-models-users-tsx" class="header-anchor">#</a> 8.2.3 src\models\users.tsx</h4> <p>src\models\users.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    namespace<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
    state<span class="token operator">:</span> <span class="token punctuation">{</span> list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'珠峰'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'架构'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span> list<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">:</span> action<span class="token punctuation">.</span>payload <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    effects<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span><span class="token function">asyncAdd</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> <span class="token punctuation">{</span> call<span class="token punctuation">,</span> put <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'add'</span><span class="token punctuation">,</span> payload<span class="token operator">:</span> <span class="token string">'学院'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_8-2-4-routes-userpage-tsx"><a href="#_8-2-4-routes-userpage-tsx" class="header-anchor">#</a> 8.2.4 routes\UserPage.tsx</h4> <p>src\routes\UserPage.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> connect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../dva&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">UserPage</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> list <span class="token operator">=</span> props<span class="token punctuation">.</span>list <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> props<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'users/asyncAdd'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
                <span class="token punctuation">{</span>
                    list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">user</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                        <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                    <span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">(</span>UserPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_9-onaction中间件"><a href="#_9-onaction中间件" class="header-anchor">#</a> 9. onAction中间件</h2> <div class="language-js extra-class"><pre class="language-js"><code>cnpm i redux<span class="token operator">-</span>logger <span class="token operator">-</span><span class="token constant">S</span>
</code></pre></div><h3 id="_9-1-使用"><a href="#_9-1-使用" class="header-anchor">#</a> 9.1 使用</h3> <h4 id="_9-1-1-index-tsx"><a href="#_9-1-1-index-tsx" class="header-anchor">#</a> 9.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux, Link } from './dva/router';
import createLoading from './dva-loading';
import dynamic from './dva/dynamic';
<span class="token inserted-sign inserted">+import { createLogger } from './redux-logger';
</span>
const app = dva();
<span class="token inserted-sign inserted">+app.use({ onAction: createLogger() });
</span>app.use(createLoading());
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
const UserPageComponent = (dynamic as any)({
<span class="token unchanged">    app,
    models: () =&gt; [
        import('./models/users'),
    ],
    component: () =&gt; import('./routes/UserPage'),
</span>});
app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;Router history={api.history}&gt;
        &lt;&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
                &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
                &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
            &lt;/ul&gt;
            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
            &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
        &lt;/&gt;
    &lt;/Router&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_9-2-实现"><a href="#_9-2-实现" class="header-anchor">#</a> 9.2 实现</h3> <h4 id="_9-2-1-dva-index-tsx"><a href="#_9-2-1-dva-index-tsx" class="header-anchor">#</a> 9.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
</span><span class="token inserted-sign inserted">+        const extraMiddlewares = plugin.get('onAction');
+        let store = createStore(rootReducer, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware));
</span><span class="token unchanged">        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
        app.model = injectModel.bind(app);
        app._getSaga = getSaga;
        function injectModel(m) {
            m = model(m);
            initialReducers[m.namespace] = getReducer(m);
            store.replaceReducer(createReducer());
            if (m.effects) {
                sagaMiddleware.run(app._getSaga(m.effects, m));
            }
            if (m.subscriptions) {
                runSubscription(m.subscriptions, m, app);
            }
        }
        function runSubscription(subscriptions, model, app) {
            for (const key in subscriptions) {
                subscriptions[key](
                    {
                        dispatch: prefixedDispatch(store.dispatch, model),
                        history: app._history,
                    }
                );
            }
        }
        function prefixedDispatch(dispatch, model) {
            return action =&gt; {
                const { type } = action;
                return dispatch({ ...action, type: prefixType(type, model) });
            };
        }
        function createReducer() {
            const extraReducers = plugin.get('extraReducers');
            return combineReducers({
                ...initialReducers,
                ...extraReducers
            });
        }
    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model, onEffect) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model, onEffect);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model, onEffect) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
    return (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
</span>}
export * from './typings';
</code></pre></div><h4 id="_9-2-2-src-dva-plugin-tsx"><a href="#_9-2-2-src-dva-plugin-tsx" class="header-anchor">#</a> 9.2.2 src\dva\plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const hooks = [
<span class="token unchanged">    'onEffect',
    'extraReducers',
</span><span class="token inserted-sign inserted">+    'onAction'
</span>];
export function filterHooks(obj) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        if (hooks.indexOf(key) &gt; -1) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
</span>}
export default class Plugin {
<span class="token unchanged">    hooks: any
    constructor() {
        this.hooks = hooks.reduce((memo, key) =&gt; {
            memo[key] = [];
            return memo;
        }, {});
    }
    use(plugin) {
        const { hooks } = this;
        for (const key in plugin) {
            hooks[key].push(plugin[key]);
        }
    }
    get(key) {
        const { hooks } = this;
        if (key === 'extraReducers') {
            return getExtraReducers(hooks[key]);
        } else {
            return hooks[key];
        }
</span>
<span class="token unchanged">    }
</span>}
function getExtraReducers(hook) {
<span class="token unchanged">    let ret = {};
    for (const reducerObj of hook) {
        ret = { ...ret, ...reducerObj };
    }
    return ret;
</span>}
</code></pre></div><h4 id="_9-2-3-src-redux-logger-tsx"><a href="#_9-2-3-src-redux-logger-tsx" class="header-anchor">#</a> 9.2.3 src\redux-logger.tsx</h4> <p>src\redux-logger.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//https://github.com/LogRocket/redux-logger/blob/5816a9fc8da9b417589380e381ed66f1114ebd9a/src/defaults.js#L12-L17</span>
<span class="token keyword">const</span> colors <span class="token operator">=</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'inherit'</span><span class="token punctuation">,</span>
    prevState<span class="token operator">:</span> <span class="token string">'#9E9E9E'</span><span class="token punctuation">,</span>
    action<span class="token operator">:</span> <span class="token string">'#03A9F4'</span><span class="token punctuation">,</span>
    nextState<span class="token operator">:</span> <span class="token string">'#4CAF50'</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">logger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> dispatch<span class="token punctuation">,</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token parameter">next</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> prevState <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> startedTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> returnedValue <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> took <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startedTime<span class="token punctuation">;</span>
    <span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> headerCSS<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    headerCSS<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'color: gray; font-weight: lighter;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headerCSS<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>colors<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headerCSS<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'color: gray; font-weight: lighter;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headerCSS<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'color: gray; font-weight: lighter;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">titleFormatter</span><span class="token punctuation">(</span>action<span class="token punctuation">,</span> startedTime<span class="token punctuation">,</span> took<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//action %c counter/add %c @ 下午11:17:59 %c (in 2.00 ms)  console.log(`%cred%cgreen`, 'color:red', 'color:green');</span>
    console<span class="token punctuation">.</span><span class="token function">groupCollapsed</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%c </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token operator">...</span>headerCSS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%c prev state'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>colors<span class="token punctuation">.</span>prevState<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; font-weight: bold</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> prevState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%c action    '</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>colors<span class="token punctuation">.</span>action<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; font-weight: bold</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%c next state'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">color: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>colors<span class="token punctuation">.</span>nextState<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; font-weight: bold</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> nextState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">groupEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> returnedValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">titleFormatter</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> time<span class="token punctuation">,</span> took</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'action'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    parts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%c</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">String</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%c@ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">%c(in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>took<span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ms)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> parts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> logger<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
    createLogger
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-statechange"><a href="#_10-statechange" class="header-anchor">#</a> 10. stateChange</h2> <h3 id="_10-1-使用"><a href="#_10-1-使用" class="header-anchor">#</a> 10.1 使用</h3> <h4 id="_10-1-1-index-tsx"><a href="#_10-1-1-index-tsx" class="header-anchor">#</a> 10.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux, Link } from './dva/router';
import createLoading from './dva-loading';
import dynamic from './dva/dynamic';
import { createLogger } from './redux-logger';

const app = dva({
<span class="token inserted-sign inserted">+    initialState: localStorage.getItem('state') ? JSON.parse(localStorage.getItem('state')!) : {},
+    onStateChange: function () {
+        localStorage.setItem('state', JSON.stringify(arguments[0]));
+    }
</span>});
app.use({ onAction: createLogger() });
app.use(createLoading());
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
const UserPageComponent = (dynamic as any)({
<span class="token unchanged">    app,
    models: () =&gt; [
        import('./models/users'),
    ],
    component: () =&gt; import('./routes/UserPage'),
</span>});
app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;Router history={api.history}&gt;
        &lt;&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
                &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
                &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
            &lt;/ul&gt;
            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
            &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
        &lt;/&gt;
    &lt;/Router&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_10-2-实现"><a href="#_10-2-实现" class="header-anchor">#</a> 10.2 实现</h3> <h4 id="_10-2-1-dva-index-tsx"><a href="#_10-2-1-dva-index-tsx" class="header-anchor">#</a> 10.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts: any = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        const extraMiddlewares = plugin.get('onAction');
</span><span class="token inserted-sign inserted">+        let store = createStore(rootReducer, opts.initialState, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware));
+        const listeners = plugin.get('onStateChange');
+        for (const listener of listeners) {
+            store.subscribe(() =&gt; {
+                listener(store.getState());
+            });
+        }
</span><span class="token unchanged">        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
        app.model = injectModel.bind(app);
        app._getSaga = getSaga;
        function injectModel(m) {
            m = model(m);
            initialReducers[m.namespace] = getReducer(m);
            store.replaceReducer(createReducer());
            if (m.effects) {
                sagaMiddleware.run(app._getSaga(m.effects, m));
            }
            if (m.subscriptions) {
                runSubscription(m.subscriptions, m, app);
            }
        }
        function runSubscription(subscriptions, model, app) {
            for (const key in subscriptions) {
                subscriptions[key](
                    {
                        dispatch: prefixedDispatch(store.dispatch, model),
                        history: app._history,
                    }
                );
            }
        }
        function prefixedDispatch(dispatch, model) {
            return action =&gt; {
                const { type } = action;
                return dispatch({ ...action, type: prefixType(type, model) });
            };
        }
        function createReducer() {
          const extraReducers = plugin.get('extraReducers');
          return combineReducers({
            ...initialReducers,
            ...extraReducers
          });
       }
    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model, onEffect) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model, onEffect);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model, onEffect) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
    return (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
</span>}
export * from './typings';
</code></pre></div><h4 id="_10-2-2-src-dva-plugin-tsx"><a href="#_10-2-2-src-dva-plugin-tsx" class="header-anchor">#</a> 10.2.2 src\dva\plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const hooks = [
<span class="token unchanged">    'onEffect',
    'extraReducers',
    'onAction',
</span><span class="token inserted-sign inserted">+    'onStateChange'
</span>];
export function filterHooks(obj) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        if (hooks.indexOf(key) &gt; -1) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
</span>}
export default class Plugin {
<span class="token unchanged">    hooks: any
    constructor() {
        this.hooks = hooks.reduce((memo, key) =&gt; {
            memo[key] = [];
            return memo;
        }, {});
    }
    use(plugin) {
        const { hooks } = this;
        for (const key in plugin) {
            hooks[key].push(plugin[key]);
        }
    }
    get(key) {
        const { hooks } = this;
        if (key === 'extraReducers') {
            return getExtraReducers(hooks[key]);
        } else {
            return hooks[key];
        }
</span>
<span class="token unchanged">    }
</span>}
function getExtraReducers(hook) {
<span class="token unchanged">    let ret = {};
    for (const reducerObj of hook) {
        ret = { ...ret, ...reducerObj };
    }
    return ret;
</span>}
</code></pre></div><h2 id="_11-onreducer"><a href="#_11-onreducer" class="header-anchor">#</a> 11. onReducer</h2> <ul><li><a href="https://github.com/omnidan/redux-undo" target="_blank" rel="noopener noreferrer">redux-undo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>利用高阶reducer来增强reducer的例子,它主要作用是使任意reducer变成可以执行撤销和重做的全新reducer</li></ul> <h3 id="_11-1-使用"><a href="#_11-1-使用" class="header-anchor">#</a> 11.1 使用</h3> <h4 id="_11-1-1-index-tsx"><a href="#_11-1-1-index-tsx" class="header-anchor">#</a> 11.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux, Link } from './dva/router';
import createLoading from './dva-loading';
import dynamic from './dva/dynamic';
import { createLogger } from './redux-logger';
<span class="token inserted-sign inserted">+import undoable, { ActionCreators } from './redux-undo';
</span>
const app = dva({
<span class="token unchanged">    initialState: localStorage.getItem('state') ? JSON.parse(localStorage.getItem('state')!) : undefined,
    onStateChange: function () {
        localStorage.setItem('state', JSON.stringify(arguments[0]));
    },
</span><span class="token inserted-sign inserted">+    onReducer: reducer =&gt; {
+        let undoReducer = undoable(reducer);
+        return (state, action) =&gt; {
+            let newState: any = undoReducer(state, action);
+            return { ...newState, router: newState.present.router };
+        }
+    }
</span>});
app.use({ onAction: createLogger() });
app.use(createLoading());
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步+&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
</span><span class="token inserted-sign inserted">+            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.undo())}&gt;undo&lt;/button&gt;
+            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.redo())}&gt;redo&lt;/button&gt;
</span><span class="token unchanged">        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token inserted-sign inserted">+    (state) =&gt; state.present
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
const UserPageComponent = (dynamic as any)({
<span class="token unchanged">    app,
    models: () =&gt; [
        import('./models/users'),
    ],
    component: () =&gt; import('./routes/UserPage'),
</span>});
app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;Router history={api.history}&gt;
        &lt;&gt;
            &lt;ul&gt;
                &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
                &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
                &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
            &lt;/ul&gt;
            &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
            &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
            &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
        &lt;/&gt;
    &lt;/Router&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_11-2-实现"><a href="#_11-2-实现" class="header-anchor">#</a> 11.2 实现</h3> <h4 id="_11-2-1-dva-index-tsx"><a href="#_11-2-1-dva-index-tsx" class="header-anchor">#</a> 11.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts: any = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
</span><span class="token inserted-sign inserted">+        const reducerEnhancer = plugin.get('onReducer');
</span><span class="token unchanged">        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        const extraMiddlewares = plugin.get('onAction');
        let store = createStore(rootReducer, opts.initialState, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware));
        const listeners = plugin.get('onStateChange');
        for (const listener of listeners) {
            store.subscribe(() =&gt; {
                listener(store.getState());
            });
        }
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
        app.model = injectModel.bind(app);
        app._getSaga = getSaga;
        function injectModel(m) {
            m = model(m);
            initialReducers[m.namespace] = getReducer(m);
            store.replaceReducer(createReducer());
            if (m.effects) {
                sagaMiddleware.run(app._getSaga(m.effects, m));
            }
            if (m.subscriptions) {
                runSubscription(m.subscriptions, m, app);
            }
        }
        function runSubscription(subscriptions, model, app) {
            for (const key in subscriptions) {
                subscriptions[key](
                    {
                        dispatch: prefixedDispatch(store.dispatch, model),
                        history: app._history,
                    }
                );
            }
        }
        function prefixedDispatch(dispatch, model) {
            return action =&gt; {
                const { type } = action;
                return dispatch({ ...action, type: prefixType(type, model) });
            };
        }
        function createReducer() {
            const extraReducers = plugin.get('extraReducers');
</span><span class="token inserted-sign inserted">+            return reducerEnhancer(combineReducers({
</span><span class="token unchanged">                ...initialReducers,
                ...extraReducers
            }));
        }
    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model, onEffect) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model, onEffect);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model, onEffect) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
    return (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
</span>}
export * from './typings';
</code></pre></div><h4 id="_11-2-2-src-dva-plugin-tsx"><a href="#_11-2-2-src-dva-plugin-tsx" class="header-anchor">#</a> 11.2.2 src\dva\plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const hooks = [
<span class="token unchanged">    'onEffect',
    'extraReducers',
    'onAction',
    'onStateChange',
</span><span class="token inserted-sign inserted">+    'onReducer'
</span>];
export function filterHooks(obj) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        if (hooks.indexOf(key) &gt; -1) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
</span>}
export default class Plugin {
<span class="token unchanged">    hooks: any
    constructor() {
        this.hooks = hooks.reduce((memo, key) =&gt; {
            memo[key] = [];
            return memo;
        }, {});
    }
    use(plugin) {
        const { hooks } = this;
        for (const key in plugin) {
            hooks[key].push(plugin[key]);
        }
    }
    get(key) {
        const { hooks } = this;
        if (key === 'extraReducers') {
            return getExtraReducers(hooks[key]);
</span><span class="token inserted-sign inserted">+        } else if (key === 'onReducer') {
+            return getOnReducer(hooks[key]);
+        } else {
</span><span class="token unchanged">            return hooks[key];
        }
</span>
<span class="token unchanged">    }
</span>}
<span class="token inserted-sign inserted">+function getOnReducer(hook) {
+    return function (reducer) {
+        for (const reducerEnhancer of hook) {
+            reducer = reducerEnhancer(reducer);
+        }
+        return reducer;
+    };
+}
</span>function getExtraReducers(hook) {
<span class="token unchanged">    let ret = {};
    for (const reducerObj of hook) {
        ret = { ...ret, ...reducerObj };
    }
    return ret;
</span>}
</code></pre></div><h4 id="_11-2-3-src-routes-userpage-tsx"><a href="#_11-2-3-src-routes-userpage-tsx" class="header-anchor">#</a> 11.2.3 src\routes\UserPage.tsx</h4> <p>src\routes\UserPage.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import { connect } from &quot;../dva&quot;;

function UserPage(props) {
<span class="token unchanged">    let list = props.list || [];
    return (
        &lt;&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: 'users/asyncAdd' })}&gt;+&lt;/button&gt;
            &lt;ul&gt;
                {
                    list.map(user =&gt; (
                        &lt;li key={user.id}&gt;{user.name}&lt;/li&gt;
                    ))
                }
            &lt;/ul&gt;
        &lt;/&gt;
    )
</span>}
<span class="token inserted-sign inserted">+export default connect(state =&gt; state.present.users)(UserPage);
</span></code></pre></div><h4 id="_11-2-4-src-redux-undo-tsx"><a href="#_11-2-4-src-redux-undo-tsx" class="header-anchor">#</a> 11.2.4 src\redux-undo.tsx</h4> <p>src\redux-undo.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">UNDO_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;@@redux-unto/UNDO&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">REDO_TYPE</span> <span class="token operator">=</span> <span class="token string">&quot;@@redux-unto/REDO&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> ActionCreators <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">UNDO_TYPE</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">REDO_TYPE</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">undoable</span><span class="token punctuation">(</span><span class="token parameter">reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> undoType <span class="token operator">=</span> <span class="token constant">UNDO_TYPE</span><span class="token punctuation">,</span> redoType <span class="token operator">=</span> <span class="token constant">REDO_TYPE</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
        past<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        future<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        present<span class="token operator">:</span> <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> past<span class="token punctuation">,</span> present<span class="token punctuation">,</span> future <span class="token punctuation">}</span> <span class="token operator">=</span> state<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> undoType<span class="token operator">:</span>
                <span class="token keyword">const</span> previous <span class="token operator">=</span> past<span class="token punctuation">[</span>past<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> newPast <span class="token operator">=</span> past<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> past<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    past<span class="token operator">:</span> newPast<span class="token punctuation">,</span>
                    present<span class="token operator">:</span> previous<span class="token punctuation">,</span>
                    future<span class="token operator">:</span> <span class="token punctuation">[</span>present<span class="token punctuation">,</span> <span class="token operator">...</span>future<span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token keyword">case</span> redoType<span class="token operator">:</span>
                <span class="token keyword">const</span> next <span class="token operator">=</span> future<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> newFuture <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    past<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>past<span class="token punctuation">,</span> present<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    present<span class="token operator">:</span> next<span class="token punctuation">,</span>
                    future<span class="token operator">:</span> newFuture
                <span class="token punctuation">}</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">const</span> newPresent <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>present<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">{</span>
                    past<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>past<span class="token punctuation">,</span> present<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    present<span class="token operator">:</span> newPresent<span class="token punctuation">,</span>
                    future<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_12-extraenhancers"><a href="#_12-extraenhancers" class="header-anchor">#</a> 12. extraEnhancers</h2> <ul><li><a href="https://github.com/rt2zz/redux-persist" target="_blank" rel="noopener noreferrer">redux-persist<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>会将redux的store中的数据缓存到浏览器的localStorage中</li></ul> <h3 id="_12-1-使用"><a href="#_12-1-使用" class="header-anchor">#</a> 12.1 使用</h3> <h4 id="_12-1-1-index-tsx"><a href="#_12-1-1-index-tsx" class="header-anchor">#</a> 12.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux, Link } from './dva/router';
import createLoading from './dva-loading';
import dynamic from './dva/dynamic';
import { createLogger } from './redux-logger';
import undoable, { ActionCreators } from './redux-undo';
<span class="token inserted-sign inserted">+import { persistStore, persistReducer } from './redux-persist';
+import storage from './redux-persist/lib/storage';
+import { PersistGate } from './redux-persist/lib/integration/react';
+const persistConfig = {
+    key: 'root',
+    storage
+}
</span>const app = dva({
<span class="token inserted-sign inserted">+    //initialState: localStorage.getItem('state') ? JSON.parse(localStorage.getItem('state')!) : undefined,
</span><span class="token unchanged">    onStateChange: function () {
</span><span class="token inserted-sign inserted">+        //localStorage.setItem('state', JSON.stringify(arguments[0]));
+        console.log('currentState', arguments[0]);
</span><span class="token unchanged">    },
    onReducer: reducer =&gt; {
        let undoReducer = undoable(reducer);
</span><span class="token inserted-sign inserted">+        let rootReducer = persistReducer(persistConfig, undoReducer);
</span><span class="token unchanged">        return (state, action) =&gt; {
</span><span class="token inserted-sign inserted">+            let newState: any = rootReducer(state, action);
</span><span class="token unchanged">            return { ...newState, router: newState.present.router };
        }
    },
</span><span class="token inserted-sign inserted">+    extraEnhancers: [
+        createStore =&gt; (...args) =&gt; {
+            const store: any = createStore(...args);
+            const persistor = persistStore(store);
+            store.persistor = persistor;
+            return store;
+        }
+    ]
</span>});
app.use({ onAction: createLogger() });
app.use(createLoading());
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.undo())}&gt;undo&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.redo())}&gt;redo&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state.present
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
const UserPageComponent = (dynamic as any)({
<span class="token unchanged">    app,
    models: () =&gt; [
        import('./models/users'),
    ],
    component: () =&gt; import('./routes/UserPage'),
</span>});
app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;PersistGate persistor={(app as any)._store.persistor}&gt;
        &lt;Router history={api.history}&gt;
            &lt;&gt;
                &lt;ul&gt;
                    &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
                &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
                &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
            &lt;/&gt;
        &lt;/Router&gt;
    &lt;/PersistGate&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_12-2-实现"><a href="#_12-2-实现" class="header-anchor">#</a> 12.2 实现</h3> <h4 id="_12-2-1-dva-index-tsx"><a href="#_12-2-1-dva-index-tsx" class="header-anchor">#</a> 12.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
<span class="token inserted-sign inserted">+import { createStore, combineReducers, applyMiddleware, compose } from 'redux';
</span>import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts: any = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model);
        }
        const reducerEnhancer = plugin.get('onReducer');
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        const extraMiddlewares = plugin.get('onAction');
</span><span class="token inserted-sign inserted">+        const extraEnhancers = plugin.get('extraEnhancers');
+        const enhancers = [...extraEnhancers, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware)];
+        //let store = createStore(rootReducer, opts.initialState, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware));
+        let store = createStore(rootReducer, opts.initialState, compose(...enhancers));
+        app._store = store;
</span><span class="token unchanged">        const listeners = plugin.get('onStateChange');
        for (const listener of listeners) {
            store.subscribe(() =&gt; {
                listener(store.getState());
            });
        }
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
        app.model = injectModel.bind(app);
        app._getSaga = getSaga;
        function injectModel(m) {
            m = model(m);
            initialReducers[m.namespace] = getReducer(m);
            store.replaceReducer(createReducer());
            if (m.effects) {
                sagaMiddleware.run(app._getSaga(m.effects, m));
            }
            if (m.subscriptions) {
                runSubscription(m.subscriptions, m, app);
            }
        }
        function runSubscription(subscriptions, model, app) {
            for (const key in subscriptions) {
                subscriptions[key](
                    {
                        dispatch: prefixedDispatch(store.dispatch, model),
                        history: app._history,
                    }
                );
            }
        }
        function prefixedDispatch(dispatch, model) {
            return action =&gt; {
                const { type } = action;
                return dispatch({ ...action, type: prefixType(type, model) });
            };
        }
        function createReducer() {
            const extraReducers = plugin.get('extraReducers');
            return reducerEnhancer(combineReducers({
                ...initialReducers,
                ...extraReducers
            }));
        }
    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model, onEffect) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model, onEffect);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model, onEffect) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
    return (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
</span>}
export * from './typings';
</code></pre></div><h4 id="_12-2-2-plugin-tsx"><a href="#_12-2-2-plugin-tsx" class="header-anchor">#</a> 12.2.2 plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const hooks = [
<span class="token unchanged">    'onEffect',
    'extraReducers',
    'onAction',
    'onStateChange',
    'onReducer',
</span><span class="token inserted-sign inserted">+    &quot;extraEnhancers&quot;
</span>];
export function filterHooks(obj) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        if (hooks.indexOf(key) &gt; -1) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
</span>}
export default class Plugin {
<span class="token unchanged">    hooks: any
    constructor() {
        this.hooks = hooks.reduce((memo, key) =&gt; {
            memo[key] = [];
            return memo;
        }, {});
    }
    use(plugin) {
        const { hooks } = this;
        for (const key in plugin) {
</span><span class="token inserted-sign inserted">+            if (key === 'extraEnhancers') {
+                hooks[key] = plugin[key];
+            } else {
+                hooks[key].push(plugin[key]);
+            }
</span><span class="token unchanged">        }
    }
    get(key) {
        const { hooks } = this;
        if (key === 'extraReducers') {
            return getExtraReducers(hooks[key]);
        } else if (key === 'onReducer') {
            return getOnReducer(hooks[key]);
        } else {
            return hooks[key];
        }
</span>
<span class="token unchanged">    }
</span>}
function getOnReducer(hook) {
<span class="token unchanged">    return function (reducer) {
        for (const reducerEnhancer of hook) {
            reducer = reducerEnhancer(reducer);
        }
        return reducer;
    };
</span>}
function getExtraReducers(hook) {
<span class="token unchanged">    let ret = {};
    for (const reducerObj of hook) {
        ret = { ...ret, ...reducerObj };
    }
    return ret;
</span>}
</code></pre></div><h4 id="_12-2-3-redux-persist-index-tsx"><a href="#_12-2-3-redux-persist-index-tsx" class="header-anchor">#</a> 12.2.3 redux-persist\index.tsx</h4> <p>src\redux-persist\index.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> persistReducer <span class="token keyword">from</span> <span class="token string">'./persistReducer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> persistStore <span class="token keyword">from</span> <span class="token string">'./persistStore'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
    persistReducer<span class="token punctuation">,</span>
    persistStore
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">REHYDRATE</span> <span class="token operator">=</span> <span class="token string">'REHYDRATE'</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_12-2-4-persistreducer-tsx"><a href="#_12-2-4-persistreducer-tsx" class="header-anchor">#</a> 12.2.4 persistReducer.tsx</h4> <p>src\redux-persist\persistReducer.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">persistConfig<span class="token punctuation">,</span> reducer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> isInited <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">'PERSIST_INIT'</span><span class="token operator">:</span>
                isInited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> value <span class="token operator">=</span> persistConfig<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'persist:'</span> <span class="token operator">+</span> persistConfig<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                state <span class="token operator">=</span> value <span class="token operator">?</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isInited<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    state <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    persistConfig<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'persist:'</span> <span class="token operator">+</span> persistConfig<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token function">reducer</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_12-2-5-persiststore-tsx"><a href="#_12-2-5-persiststore-tsx" class="header-anchor">#</a> 12.2.5 persistStore.tsx</h4> <p>src\redux-persist\persistStore.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> persistor <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>store<span class="token punctuation">,</span>
        <span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            persistor<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token string">'PERSIST_INIT'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> persistor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_12-2-6-redux-persist-lib-storage-tsx"><a href="#_12-2-6-redux-persist-lib-storage-tsx" class="header-anchor">#</a> 12.2.6 redux-persist\lib\storage.tsx</h4> <p>src\redux-persist\lib\storage.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> storage <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">setItem</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">getItem</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> storage<span class="token punctuation">;</span>
</code></pre></div><h4 id="_12-2-7-redux-persist-lib-integration-react-tsx"><a href="#_12-2-7-redux-persist-lib-integration-react-tsx" class="header-anchor">#</a> 12.2.7 redux-persist\lib\integration\react.tsx</h4> <p>src\redux-persist\lib\integration\react.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PersistGate</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>persistor<span class="token punctuation">.</span><span class="token function">initState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span> PersistGate <span class="token punctuation">}</span>
</code></pre></div><h2 id="_13-dva-immer"><a href="#_13-dva-immer" class="header-anchor">#</a> 13. dva-immer</h2> <ul><li><a href="https://immerjs.github.io/immer/docs/introduction" target="_blank" rel="noopener noreferrer">immer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>是<code>mobx</code>的作者写的一个<code>immutable</code> 库，核心实现是利用 ES6 的 proxy，几乎以最小的成本实现了 js 的不可变数据结构</li> <li>dva-immer
<ul><li><code>currentState</code> 被操作对象的最初状态</li> <li><code>draftState</code> 根据 currentState 生成的草稿状态，它是 currentState 的代理，对 draftState 所做的任何修改都将被记录并用于生成 nextState 。在此过程中，currentState 将不受影响</li> <li><code>nextState</code> 根据 draftState 生成的最终状态</li> <li><code>produce</code> 生产 用来生成 nextState的函数</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>cnpm i dva<span class="token operator">-</span>immer <span class="token operator">-</span><span class="token constant">S</span>
<span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">&quot;immer&quot;</span>
<span class="token keyword">const</span> baseState <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        todo<span class="token operator">:</span> <span class="token string">&quot;Learn typescript&quot;</span><span class="token punctuation">,</span>
        done<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        todo<span class="token operator">:</span> <span class="token string">&quot;Try immer&quot;</span><span class="token punctuation">,</span>
        done<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
<span class="token keyword">const</span> nextState <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> <span class="token parameter">draftState</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    draftState<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>todo<span class="token operator">:</span> <span class="token string">&quot;Tweet about it&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    draftState<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>done <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_13-1-使用"><a href="#_13-1-使用" class="header-anchor">#</a> 13.1 使用</h3> <h4 id="_13-1-1-index-tsx"><a href="#_13-1-1-index-tsx" class="header-anchor">#</a> 13.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux, Link } from './dva/router';
import createLoading from './dva-loading';
import dynamic from './dva/dynamic';
import { createLogger } from './redux-logger';
import undoable, { ActionCreators } from './redux-undo';
import { persistStore, persistReducer } from './redux-persist';
import storage from './redux-persist/lib/storage';
import { PersistGate } from './redux-persist/lib/integration/react';
<span class="token inserted-sign inserted">+import immer from './dva-immer';
</span>const persistConfig = {
<span class="token unchanged">    key: 'root',
    storage
</span>}
const app = dva({
<span class="token unchanged">    //initialState: localStorage.getItem('state') ? JSON.parse(localStorage.getItem('state')!) : undefined,
    onStateChange: function () {
        //localStorage.setItem('state', JSON.stringify(arguments[0]));
        console.log('currentState', arguments[0]);
    },
    onReducer: reducer =&gt; {
        let undoReducer = undoable(reducer);
        let rootReducer = persistReducer(persistConfig, undoReducer);
        return (state, action) =&gt; {
            let newState: any = rootReducer(state, action);
</span><span class="token inserted-sign inserted">+            return { ...newState, router: newState.present ? newState.present.router : null };
</span><span class="token unchanged">        }
    },
    extraEnhancers: [
        createStore =&gt; (...args) =&gt; {
            const store: any = createStore(...args);
            const persistor = persistStore(store);
            store.persistor = persistor;
            return store;
        }
    ]
</span>});
app.use({ onAction: createLogger() });
app.use(createLoading());
<span class="token inserted-sign inserted">+app.use(immer());
</span>app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.undo())}&gt;undo&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.redo())}&gt;redo&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state.present
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
const UserPageComponent = (dynamic as any)({
<span class="token unchanged">    app,
    models: () =&gt; [
        import('./models/users'),
    ],
    component: () =&gt; import('./routes/UserPage'),
</span>});
app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;PersistGate persistor={(app as any)._store.persistor}&gt;
        &lt;Router history={api.history}&gt;
            &lt;&gt;
                &lt;ul&gt;
                    &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
                &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
                &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
            &lt;/&gt;
        &lt;/Router&gt;
    &lt;/PersistGate&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_13-2-实现"><a href="#_13-2-实现" class="header-anchor">#</a> 13.2 实现</h3> <h4 id="_13-2-1-dva-index-tsx"><a href="#_13-2-1-dva-index-tsx" class="header-anchor">#</a> 13.2.1 dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware, compose } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts: any = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
</span><span class="token inserted-sign inserted">+            initialReducers[model.namespace] = getReducer(model, plugin._handleActions);
</span><span class="token unchanged">        }
        const reducerEnhancer = plugin.get('onReducer');
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        const extraMiddlewares = plugin.get('onAction');
        const extraEnhancers = plugin.get('extraEnhancers');
        const enhancers = [...extraEnhancers, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware)];
        //let store = createStore(rootReducer, opts.initialState, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware));
        let store = createStore(rootReducer, opts.initialState, compose(...enhancers));
        app._store = store;
        const listeners = plugin.get('onStateChange');
        for (const listener of listeners) {
            store.subscribe(() =&gt; {
                listener(store.getState());
            });
        }
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
        app.model = injectModel.bind(app);
        app._getSaga = getSaga;
        function injectModel(m) {
            m = model(m);
</span><span class="token inserted-sign inserted">+            initialReducers[m.namespace] = getReducer(m, plugin._handleActions);
</span><span class="token unchanged">            store.replaceReducer(createReducer());
            if (m.effects) {
                sagaMiddleware.run(app._getSaga(m.effects, m));
            }
            if (m.subscriptions) {
                runSubscription(m.subscriptions, m, app);
            }
        }
        function runSubscription(subscriptions, model, app) {
            for (const key in subscriptions) {
                subscriptions[key](
                    {
                        dispatch: prefixedDispatch(store.dispatch, model),
                        history: app._history,
                    }
                );
            }
        }
        function prefixedDispatch(dispatch, model) {
            return action =&gt; {
                const { type } = action;
                return dispatch({ ...action, type: prefixType(type, model) });
            };
        }
        function createReducer() {
            const extraReducers = plugin.get('extraReducers');
            return reducerEnhancer(combineReducers({
                ...initialReducers,
                ...extraReducers
            }));
        }
    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
            sagas.push(getSaga(model.effects, model, plugin.get('onEffect')));
        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

function getSaga(effects, model, onEffect) {
<span class="token unchanged">    return function* () {
        for (const key in effects) {
            const watcher = getWatcher(key, model.effects[key], model, onEffect);
            yield sagaEffects.fork(watcher);
        }
    };
</span>}
function getWatcher(key, effect, model, onEffect) {
<span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
            yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model, handleActions) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
</span><span class="token inserted-sign inserted">+    let reducer = (state = defaultState, action) =&gt; {
</span><span class="token unchanged">        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
</span><span class="token inserted-sign inserted">+    if (handleActions) {
+        return handleActions(reducers || {}, defaultState);
+    }
+    return reducer;
</span>}

export * from './typings';
</code></pre></div><h4 id="_13-2-2-dva-plugin-tsx"><a href="#_13-2-2-dva-plugin-tsx" class="header-anchor">#</a> 13.2.2 dva\plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const hooks = [
<span class="token unchanged">    'onEffect',
    'extraReducers',
    'onAction',
    'onStateChange',
    'onReducer',
    &quot;extraEnhancers&quot;,
</span><span class="token inserted-sign inserted">+    '_handleActions'
</span>];
export function filterHooks(obj) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        if (hooks.indexOf(key) &gt; -1) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
</span>}
export default class Plugin {
<span class="token unchanged">    hooks: any
</span><span class="token inserted-sign inserted">+    _handleActions: any = null
</span><span class="token unchanged">    constructor() {
        this.hooks = hooks.reduce((memo, key) =&gt; {
            memo[key] = [];
            return memo;
        }, {});
    }
    use(plugin) {
        const { hooks } = this;
        for (const key in plugin) {
</span><span class="token inserted-sign inserted">+            if (key === '_handleActions') {
+                this._handleActions = plugin[key];
</span><span class="token unchanged">            } else if (key === 'extraEnhancers') {
                hooks[key] = plugin[key];
            } else {
                hooks[key].push(plugin[key]);
            }
        }
    }
    get(key) {
        const { hooks } = this;
        if (key === 'extraReducers') {
            return getExtraReducers(hooks[key]);
        } else if (key === 'onReducer') {
            return getOnReducer(hooks[key]);
        } else {
            return hooks[key];
        }
</span>
<span class="token unchanged">    }
</span>}
function getOnReducer(hook) {
<span class="token unchanged">    return function (reducer) {
        for (const reducerEnhancer of hook) {
            reducer = reducerEnhancer(reducer);
        }
        return reducer;
    };
</span>}
function getExtraReducers(hook) {
<span class="token unchanged">    let ret = {};
    for (const reducerObj of hook) {
        ret = { ...ret, ...reducerObj };
    }
    return ret;
</span>}
</code></pre></div><h4 id="_13-2-3-dva-immer-tsx"><a href="#_13-2-3-dva-immer-tsx" class="header-anchor">#</a> 13.2.3 dva-immer.tsx</h4> <p>src\dva-immer.tsx</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> produce <span class="token keyword">from</span> <span class="token string">'immer'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token function">_handleActions</span><span class="token punctuation">(</span><span class="token parameter">handlers<span class="token punctuation">,</span> defaultState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span> type <span class="token punctuation">}</span> <span class="token operator">=</span> action<span class="token punctuation">;</span>
                <span class="token keyword">const</span> ret <span class="token operator">=</span> <span class="token function">produce</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token parameter">draft</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> handler <span class="token operator">=</span> handlers<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>draft<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> ret <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_14-onerror"><a href="#_14-onerror" class="header-anchor">#</a> 14. onError</h2> <h3 id="_14-1-使用"><a href="#_14-1-使用" class="header-anchor">#</a> 14.1 使用</h3> <h4 id="_14-1-1-index-tsx"><a href="#_14-1-1-index-tsx" class="header-anchor">#</a> 14.1.1 index.tsx</h4> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import dva, { connect } from './dva';
import { Router, Route, routerRedux, Link } from './dva/router';
import createLoading from './dva-loading';
import dynamic from './dva/dynamic';
import { createLogger } from './redux-logger';
import undoable, { ActionCreators } from './redux-undo';
import { persistStore, persistReducer } from './redux-persist';
import storage from './redux-persist/lib/storage';
import { PersistGate } from './redux-persist/lib/integration/react';
import immer from './dva-immer';
const persistConfig = {
<span class="token unchanged">    key: 'root',
    storage
</span>}
const app = dva({
<span class="token unchanged">    //initialState: localStorage.getItem('state') ? JSON.parse(localStorage.getItem('state')!) : undefined,
    onStateChange: function () {
        //localStorage.setItem('state', JSON.stringify(arguments[0]));
        console.log('currentState', arguments[0]);
    },
    onReducer: reducer =&gt; {
        let undoReducer = undoable(reducer);
        let rootReducer = persistReducer(persistConfig, undoReducer);
        return (state, action) =&gt; {
            let newState: any = rootReducer(state, action);
            return { ...newState, router: newState.present ? newState.present.router : null };
        }
    },
    extraEnhancers: [
        createStore =&gt; (...args) =&gt; {
            const store: any = createStore(...args);
            const persistor = persistStore(store);
            store.persistor = persistor;
            return store;
        }
    ],
</span><span class="token inserted-sign inserted">+    onError(err, dispatch) {
+        console.error('onError', err);
+    }
</span>});
app.use({ onAction: createLogger() });
app.use(createLoading());
app.use(immer());
app.model({
<span class="token unchanged">    namespace: 'counter',
    state: { number: 0 },
    reducers: {
        add(state) {
            return { number: state.number + 1 };
        }
    },
    effects: {
        *asyncAdd(action, { call, put }) {
            yield call(delay, 1000);
            yield put({ type: 'counter/add' });
</span><span class="token inserted-sign inserted">+            throw new Error('asyncAdd');
</span><span class="token unchanged">        },
        *goto({ to }, { put }) {
            yield put(routerRedux.push(to));
        }
    },
</span><span class="token inserted-sign inserted">+    subscriptions: {
+        changeTitle({ dispatch, history }, done) {
+            console.log('changeTitle');
+            done('出错啦');
+        }
+    }
</span>});
function Counter(props) {
<span class="token unchanged">    return (
        &lt;div&gt;
            &lt;p&gt; {props.loading.models.counter ? 'loading' : props.counter.number}&lt;/p&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/add&quot; })}&gt;加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/asyncAdd&quot; })}&gt;异步加1&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch({ type: &quot;counter/goto&quot;, to: '/' })}&gt;跳转到/&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.undo())}&gt;undo&lt;/button&gt;
            &lt;button onClick={() =&gt; props.dispatch(ActionCreators.redo())}&gt;redo&lt;/button&gt;
        &lt;/div&gt;
    )
</span>}
const ConnectedCounter = connect(
<span class="token unchanged">    (state) =&gt; state.present
</span>)(Counter);
const Home = () =&gt; &lt;div&gt;Home&lt;/div&gt;;
const UserPageComponent = (dynamic as any)({
<span class="token unchanged">    app,
    models: () =&gt; [
        import('./models/users'),
    ],
    component: () =&gt; import('./routes/UserPage'),
</span>});
app.router((api: any) =&gt; (
<span class="token unchanged">    &lt;PersistGate persistor={(app as any)._store.persistor}&gt;
        &lt;Router history={api.history}&gt;
            &lt;&gt;
                &lt;ul&gt;
                    &lt;li&gt;&lt;Link to=&quot;/&quot;&gt;Home&lt;/Link&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;Link to=&quot;/counter&quot;&gt;counter&lt;/Link&gt;&lt;/li&gt;
                    &lt;li&gt;&lt;Link to=&quot;/users&quot;&gt;users&lt;/Link&gt;&lt;/li&gt;
                &lt;/ul&gt;
                &lt;Route path=&quot;/&quot; exact={true} component={Home} /&gt;
                &lt;Route path=&quot;/counter&quot; component={ConnectedCounter} /&gt;
                &lt;Route path=&quot;/users&quot; component={UserPageComponent} /&gt;
            &lt;/&gt;
        &lt;/Router&gt;
    &lt;/PersistGate&gt;
</span>));
app.start('#root');

function delay(ms) {
<span class="token unchanged">    return new Promise((resolve) =&gt; {
        setTimeout(function () {
            resolve();
        }, ms);
    });
</span>}
</code></pre></div><h3 id="_14-2-实现"><a href="#_14-2-实现" class="header-anchor">#</a> 14.2 实现</h3> <h4 id="_14-2-1-src-dva-index-tsx"><a href="#_14-2-1-src-dva-index-tsx" class="header-anchor">#</a> 14.2.1 src\dva\index.tsx</h4> <p>src\dva\index.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import React from 'react';
import ReactDOM from 'react-dom';
import { createStore, combineReducers, applyMiddleware, compose } from 'redux';
import createSagaMiddleware from 'redux-saga';
import * as sagaEffects from 'redux-saga/effects';
import { NAMESPACE_SEP } from './constants';
import { connect, Provider } from 'react-redux';
import { DvaInstance, Router, Model } from './typings';
import prefixNamespace from './prefixNamespace';
import { createHashHistory } from 'history';
import Plugin, { filterHooks } from './plugin';
import { routerMiddleware, connectRouter } from &quot;connected-react-router&quot;;
let history = createHashHistory();
export { connect };

export default function (opts: any = {}) {
<span class="token unchanged">    const app: DvaInstance = {
        _models: [],
        model,
        router,
        _router: null,
        start
    }
    const initialReducers = { router: connectRouter(history) };
    function model(model: Model) {
        const prefixedModel = prefixNamespace(model);
        app._models.push(prefixedModel);
        return prefixedModel;
    }
</span>
<span class="token unchanged">    function router(router: Router) {
        app._router = router;
    }
    const plugin = new Plugin();
    plugin.use(filterHooks(opts));
    app.use = plugin.use.bind(plugin);
    function start(root) {
        for (const model of app._models) {
            initialReducers[model.namespace] = getReducer(model, plugin._handleActions);
        }
        const reducerEnhancer = plugin.get('onReducer');
        let rootReducer = createReducer();
        const sagas = getSagas(app);
        const sagaMiddleware = createSagaMiddleware();
        const extraMiddlewares = plugin.get('onAction');
        const extraEnhancers = plugin.get('extraEnhancers');
        const enhancers = [...extraEnhancers, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware)];
        //let store = createStore(rootReducer, opts.initialState, applyMiddleware(...extraMiddlewares, routerMiddleware(history), sagaMiddleware));
        let store = createStore(rootReducer, opts.initialState, compose(...enhancers));
        app._store = store;
        const listeners = plugin.get('onStateChange');
        for (const listener of listeners) {
            store.subscribe(() =&gt; {
                listener(store.getState());
            });
        }
        sagas.forEach(saga =&gt; sagaMiddleware.run(saga));
        ReactDOM.render(&lt;Provider store={store}&gt;{app._router({ history })}&lt;/Provider&gt;, document.querySelector(root))
        app.model = injectModel.bind(app);
        app._getSaga = getSaga;
</span><span class="token inserted-sign inserted">+        for (const model of app._models) {
+            if (model.subscriptions) {
+                runSubscription(model.subscriptions, model, app, plugin.get('onError'));
+            }
+        }
</span><span class="token unchanged">        function injectModel(m) {
            m = model(m);
            initialReducers[m.namespace] = getReducer(m, plugin._handleActions);
            store.replaceReducer(createReducer());
            if (m.effects) {
                sagaMiddleware.run(app._getSaga(m.effects, m));
            }
            if (m.subscriptions) {
                runSubscription(m.subscriptions, m, app, plugin.get('onError'));
            }
        }
</span><span class="token inserted-sign inserted">+        function runSubscription(subscriptions, model, app, onError) {
</span><span class="token unchanged">            for (const key in subscriptions) {
</span><span class="token inserted-sign inserted">+                let dispatch = prefixedDispatch(store.dispatch, model);
</span><span class="token unchanged">                subscriptions[key](
                    {
</span><span class="token inserted-sign inserted">+                        dispatch,
</span><span class="token unchanged">                        history: app._history,
</span><span class="token inserted-sign inserted">+                    }, err =&gt; {
+                        for (let fn of onError) {
+                            fn(err, dispatch);
+                        }
+                    }
</span><span class="token unchanged">                );
            }
        }
        function prefixedDispatch(dispatch, model) {
            return action =&gt; {
                const { type } = action;
                return dispatch({ ...action, type: prefixType(type, model) });
            };
        }
        function createReducer() {
            const extraReducers = plugin.get('extraReducers');
            return reducerEnhancer(combineReducers({
                ...initialReducers,
                ...extraReducers
            }));
        }
    }
</span>
<span class="token unchanged">    function getSagas(app) {
        let sagas: Array&lt;any&gt; = [];
        for (const model of app._models) {
</span><span class="token inserted-sign inserted">+            sagas.push(getSaga(model.effects, model, plugin.get('onEffect'), plugin.get('onError')));
</span><span class="token unchanged">        }
        return sagas;
    }
</span>
<span class="token unchanged">    return app;
</span>}

<span class="token inserted-sign inserted">+function getSaga(effects, model, onEffect, onError) {
</span><span class="token unchanged">    return function* () {
        for (const key in effects) {
</span><span class="token inserted-sign inserted">+            const watcher = getWatcher(key, model.effects[key], model, onEffect, onError);
</span><span class="token unchanged">            yield sagaEffects.fork(watcher);
        }
    };
</span>}
<span class="token inserted-sign inserted">+function getWatcher(key, effect, model, onEffect, onError) {
</span><span class="token unchanged">    return function* () {
        yield sagaEffects.takeEvery(key, function* sagaWithCatch(...args) {
            if (onEffect) {
                for (const fn of onEffect) {
                    effect = fn(effect, sagaEffects, model, key);
                }
            }
</span><span class="token inserted-sign inserted">+            try {
</span><span class="token unchanged">                yield effect(...args, { ...sagaEffects, put: action =&gt; sagaEffects.put({ ...action, type: prefixType(action.type, model) }) });
</span><span class="token inserted-sign inserted">+            } catch (err) {
+                for (const fn of onError) {
+                    fn(err);
+                }
+            }
</span><span class="token unchanged">        });
    };
</span>}
function prefixType(type, model) {
<span class="token unchanged">    if (type.indexOf('/') === -1) {
        return `${model.namespace}${NAMESPACE_SEP}${type}`;
    }
    return type;
</span>}
function getReducer(model, handleActions) {
<span class="token unchanged">    let { reducers = {}, state: defaultState } = model;
    let reducer = (state = defaultState, action) =&gt; {
        let reducer = reducers[action.type];
        if (reducer) {
            return reducer(state, action);
        }
        return state;
    }
    if (handleActions) {
        return handleActions(reducers || {}, defaultState);
    }
    return reducer;
</span>}

export * from './typings';
</code></pre></div><h4 id="_14-2-2-src-dva-plugin-tsx"><a href="#_14-2-2-src-dva-plugin-tsx" class="header-anchor">#</a> 14.2.2 src\dva\plugin.tsx</h4> <p>src\dva\plugin.tsx</p> <div class="language-diff extra-class"><pre class="language-diff"><code>const hooks = [
<span class="token unchanged">    'onEffect',
    'extraReducers',
    'onAction',
    'onStateChange',
    'onReducer',
    &quot;extraEnhancers&quot;,
    '_handleActions',
</span><span class="token inserted-sign inserted">+    &quot;onError&quot;
</span>];
export function filterHooks(obj) {
<span class="token unchanged">    return Object.keys(obj).reduce((memo, key) =&gt; {
        if (hooks.indexOf(key) &gt; -1) {
            memo[key] = obj[key];
        }
        return memo;
    }, {});
</span>}
export default class Plugin {
<span class="token unchanged">    hooks: any
    _handleActions: any = null
    constructor() {
        this.hooks = hooks.reduce((memo, key) =&gt; {
            memo[key] = [];
            return memo;
        }, {});
    }
    use(plugin) {
        const { hooks } = this;
        for (const key in plugin) {
            if (key === '_handleActions') {
                this._handleActions = plugin[key];
            } else if (key === 'extraEnhancers') {
                hooks[key] = plugin[key];
            } else {
                hooks[key].push(plugin[key]);
            }
        }
    }
    get(key) {
        const { hooks } = this;
        if (key === 'extraReducers') {
            return getExtraReducers(hooks[key]);
        } else if (key === 'onReducer') {
            return getOnReducer(hooks[key]);
        } else {
            return hooks[key];
        }
</span>
<span class="token unchanged">    }
</span>}
function getOnReducer(hook) {
<span class="token unchanged">    return function (reducer) {
        for (const reducerEnhancer of hook) {
            reducer = reducerEnhancer(reducer);
        }
        return reducer;
    };
</span>}
function getExtraReducers(hook) {
<span class="token unchanged">    let ret = {};
    for (const reducerObj of hook) {
        ret = { ...ret, ...reducerObj };
    }
    return ret;
</span>}
</code></pre></div><p><a href="https://gitee.com/zhufengpeixun/zhufeng-dva-source-typescript2" target="_blank" rel="noopener noreferrer">dva-source<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">4/23/2020, 10:12:56 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/dva/01-dva.html" class="prev">
        01. dva
      </a></span> <span class="next"><a href="/react/umi/01-umi.html">
        1.UmiJS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2af561cb.js" defer></script><script src="/assets/js/2.b2a5c435.js" defer></script><script src="/assets/js/36.e8890e58.js" defer></script>
  </body>
</html>
