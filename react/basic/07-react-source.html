<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>07. React source | 珠峰架构</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.1657c744.css" as="style"><link rel="preload" href="/assets/js/app.2af561cb.js" as="script"><link rel="preload" href="/assets/js/2.b2a5c435.js" as="script"><link rel="preload" href="/assets/js/30.33cb1c11.js" as="script"><link rel="prefetch" href="/assets/js/10.2b2c8443.js"><link rel="prefetch" href="/assets/js/11.689524dc.js"><link rel="prefetch" href="/assets/js/12.849e2da9.js"><link rel="prefetch" href="/assets/js/13.c798d95d.js"><link rel="prefetch" href="/assets/js/14.380c4ee7.js"><link rel="prefetch" href="/assets/js/15.d5753b2e.js"><link rel="prefetch" href="/assets/js/16.49eb1f17.js"><link rel="prefetch" href="/assets/js/17.5ecf2b4f.js"><link rel="prefetch" href="/assets/js/18.da9c8265.js"><link rel="prefetch" href="/assets/js/19.59d827ef.js"><link rel="prefetch" href="/assets/js/20.73eb42bb.js"><link rel="prefetch" href="/assets/js/21.8570b5b4.js"><link rel="prefetch" href="/assets/js/22.34094913.js"><link rel="prefetch" href="/assets/js/23.5209939b.js"><link rel="prefetch" href="/assets/js/24.53d92201.js"><link rel="prefetch" href="/assets/js/25.7241adf1.js"><link rel="prefetch" href="/assets/js/26.fecc2611.js"><link rel="prefetch" href="/assets/js/27.e50fca48.js"><link rel="prefetch" href="/assets/js/28.4c168acc.js"><link rel="prefetch" href="/assets/js/29.f5186710.js"><link rel="prefetch" href="/assets/js/3.ba1dcccd.js"><link rel="prefetch" href="/assets/js/31.c088791d.js"><link rel="prefetch" href="/assets/js/32.3b724af5.js"><link rel="prefetch" href="/assets/js/33.f975c942.js"><link rel="prefetch" href="/assets/js/34.7d1f4bd2.js"><link rel="prefetch" href="/assets/js/35.26c11750.js"><link rel="prefetch" href="/assets/js/36.e8890e58.js"><link rel="prefetch" href="/assets/js/37.516eba46.js"><link rel="prefetch" href="/assets/js/38.4f8b8525.js"><link rel="prefetch" href="/assets/js/39.26f95568.js"><link rel="prefetch" href="/assets/js/4.fca74266.js"><link rel="prefetch" href="/assets/js/40.b9a8ffbb.js"><link rel="prefetch" href="/assets/js/41.fd02ea5f.js"><link rel="prefetch" href="/assets/js/42.d2483185.js"><link rel="prefetch" href="/assets/js/43.70bff2de.js"><link rel="prefetch" href="/assets/js/44.219702ca.js"><link rel="prefetch" href="/assets/js/45.aba93af9.js"><link rel="prefetch" href="/assets/js/46.447ba87c.js"><link rel="prefetch" href="/assets/js/47.519ddc28.js"><link rel="prefetch" href="/assets/js/48.fd8af347.js"><link rel="prefetch" href="/assets/js/49.b3783fa9.js"><link rel="prefetch" href="/assets/js/5.cc992e8b.js"><link rel="prefetch" href="/assets/js/50.0bb20f92.js"><link rel="prefetch" href="/assets/js/51.37ba1a59.js"><link rel="prefetch" href="/assets/js/52.054af132.js"><link rel="prefetch" href="/assets/js/53.5aca78a0.js"><link rel="prefetch" href="/assets/js/54.78c43f89.js"><link rel="prefetch" href="/assets/js/55.8ecaadc1.js"><link rel="prefetch" href="/assets/js/56.e844f110.js"><link rel="prefetch" href="/assets/js/57.530db0e9.js"><link rel="prefetch" href="/assets/js/58.8c839289.js"><link rel="prefetch" href="/assets/js/59.6634b409.js"><link rel="prefetch" href="/assets/js/6.b8b36e50.js"><link rel="prefetch" href="/assets/js/60.7ebe5787.js"><link rel="prefetch" href="/assets/js/61.bfe89a8b.js"><link rel="prefetch" href="/assets/js/62.4cdf6e8c.js"><link rel="prefetch" href="/assets/js/63.a0e80f0d.js"><link rel="prefetch" href="/assets/js/64.62a1b782.js"><link rel="prefetch" href="/assets/js/65.7be0994b.js"><link rel="prefetch" href="/assets/js/66.5a592a8e.js"><link rel="prefetch" href="/assets/js/67.40b4291c.js"><link rel="prefetch" href="/assets/js/68.2ac34b58.js"><link rel="prefetch" href="/assets/js/69.728773d5.js"><link rel="prefetch" href="/assets/js/7.0414e914.js"><link rel="prefetch" href="/assets/js/70.30137f66.js"><link rel="prefetch" href="/assets/js/71.7735c9fc.js"><link rel="prefetch" href="/assets/js/72.e9f43339.js"><link rel="prefetch" href="/assets/js/73.2d754e71.js"><link rel="prefetch" href="/assets/js/74.bf70dd09.js"><link rel="prefetch" href="/assets/js/75.18c28356.js"><link rel="prefetch" href="/assets/js/76.a0626bc9.js"><link rel="prefetch" href="/assets/js/77.dfde57e0.js"><link rel="prefetch" href="/assets/js/78.b380a0d6.js"><link rel="prefetch" href="/assets/js/79.f7bafb5d.js"><link rel="prefetch" href="/assets/js/8.c3544379.js"><link rel="prefetch" href="/assets/js/80.ade6c33e.js"><link rel="prefetch" href="/assets/js/81.6335ba85.js"><link rel="prefetch" href="/assets/js/82.9d01c14e.js"><link rel="prefetch" href="/assets/js/83.47911fdd.js"><link rel="prefetch" href="/assets/js/9.844fca3b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1657c744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">珠峰架构</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable router-link-active open"><span>react</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/basic/" class="sidebar-heading clickable router-link-active open"><span>基础</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/basic/01-react-basic.html" class="sidebar-link">01. React basic</a></li><li><a href="/react/basic/02-react-state.html" class="sidebar-link">02. React state</a></li><li><a href="/react/basic/03-react-high.html" class="sidebar-link">03. React high</a></li><li><a href="/react/basic/04-react-optimize.html" class="sidebar-link">04. React optimize</a></li><li><a href="/react/basic/05-react-hooks.html" class="sidebar-link">05. React Hooks</a></li><li><a href="/react/basic/06-react-immutable.html" class="sidebar-link">06. React Immutable</a></li><li><a href="/react/basic/07-react-source.html" class="active sidebar-link">07. React source</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_1-初始化项目" class="sidebar-link">1.初始化项目</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_2-渲染文本" class="sidebar-link">2. 渲染文本</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_3-重构" class="sidebar-link">3. 重构</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_4-渲染原生dom组件" class="sidebar-link">4. 渲染原生DOM组件</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_5-渲染自定义组件" class="sidebar-link">5. 渲染自定义组件</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_6-实现setstate" class="sidebar-link">6. 实现setState</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_7-对比属性" class="sidebar-link">7. 对比属性</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_8-对比子元素" class="sidebar-link">8. 对比子元素</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_9-获得补丁数组" class="sidebar-link">9. 获得补丁数组</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_10-打补丁" class="sidebar-link">10. 打补丁</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_11-todos" class="sidebar-link">11. todos</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_10-diff-策略" class="sidebar-link">10. diff 策略</a></li><li class="sidebar-sub-header"><a href="/react/basic/07-react-source.html#_11-delegate" class="sidebar-link">11.delegate</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/fiber/" class="sidebar-heading clickable"><span>Fiber</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/router/" class="sidebar-heading clickable"><span>react router</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/redux/" class="sidebar-heading clickable"><span>redux</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/ssr/" class="sidebar-heading clickable"><span>SSR</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/nextjs/" class="sidebar-heading clickable"><span>nextjs</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/dva/" class="sidebar-heading clickable"><span>dva</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/umi/" class="sidebar-heading clickable"><span>umi</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/component/" class="sidebar-heading clickable"><span>组件</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/interview/" class="sidebar-heading clickable"><span>面试</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/flutter/" class="sidebar-heading clickable"><span>flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/" class="sidebar-heading clickable"><span>interview</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/other/" class="sidebar-heading clickable"><span>other</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_07-react-source"><a href="#_07-react-source" class="header-anchor">#</a> 07. React source</h1> <h2 id="_1-初始化项目"><a href="#_1-初始化项目" class="header-anchor">#</a> 1.初始化项目</h2> <div class="language-js extra-class"><pre class="language-js"><code>create<span class="token operator">-</span>react<span class="token operator">-</span>app zhufeng_react5
cd zhufeng_react5
cnpm i jquery <span class="token operator">-</span><span class="token constant">S</span>
npm start
</code></pre></div><h2 id="_2-渲染文本"><a href="#_2-渲染文本" class="header-anchor">#</a> 2. 渲染文本</h2> <h3 id="_2-1-渲染效果"><a href="#_2-1-渲染效果" class="header-anchor">#</a> 2.1 渲染效果</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013824.png" alt="initrenderhtml"></p> <h3 id="_2-2-实现"><a href="#_2-2-实现" class="header-anchor">#</a> 2.2 实现</h3> <h4 id="_2-2-1-index-js"><a href="#_2-2-1-index-js" class="header-anchor">#</a> 2.2.1 index.js</h4> <p>src\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_2-2-2-react-js"><a href="#_2-2-2-react-js" class="header-anchor">#</a> 2.2.2 react.js</h4> <p>src\react.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
    rootIndex<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    render
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>container</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>React<span class="token punctuation">.</span>rootIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>element<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre></div><h2 id="_3-重构"><a href="#_3-重构" class="header-anchor">#</a> 3. 重构</h2> <h3 id="_3-2-类图"><a href="#_3-2-类图" class="header-anchor">#</a> 3.2 类图</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013831.png" alt="2.rendertext"></p> <h3 id="_3-3-实现"><a href="#_3-3-实现" class="header-anchor">#</a> 3.3 实现</h3> <h4 id="_3-3-1-index-js"><a href="#_3-3-1-index-js" class="header-anchor">#</a> 3.3.1 index.js</h4> <p>src\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-3-2-react-index-js"><a href="#_3-3-2-react-index-js" class="header-anchor">#</a> 3.3.2 react\index.js</h4> <p>src\react\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> $ <span class="token keyword">from</span> <span class="token string">'jquery'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createUnit<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./unit'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> React <span class="token operator">=</span> <span class="token punctuation">{</span>
    rootIndex<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>
    render
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">element<span class="token punctuation">,</span>container</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">let</span> unit <span class="token operator">=</span> <span class="token function">createUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">let</span> markup <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">getMarkUp</span><span class="token punctuation">(</span>React<span class="token punctuation">.</span>rootIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">$</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">html</span><span class="token punctuation">(</span>markup<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">'mounted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//componentDidMount</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> React<span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-3-3-react-unit-js"><a href="#_3-3-3-react-unit-js" class="header-anchor">#</a> 3.3.3 react\unit.js</h4> <p>src\react\unit.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Unit</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement <span class="token operator">=</span> element<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'不能调用此方法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">TextUnit</span> <span class="token keyword">extends</span> <span class="token class-name">Unit</span><span class="token punctuation">{</span>
    <span class="token function">getMarkUp</span><span class="token punctuation">(</span><span class="token parameter">reactid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>_reactid <span class="token operator">=</span> reactid<span class="token punctuation">;</span><span class="token comment">//保存记录rootId</span>
        <span class="token comment">//返回文本节点对应的HTML字符串</span>
        <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span data-reactid=&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>reactid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>_currentElement<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createUnit</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">'string'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> element <span class="token operator">==</span><span class="token string">'number'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TextUnit</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
    createUnit
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4-渲染原生dom组件"><a href="#_4-渲染原生dom组件" class="header-anchor">#</a> 4. 渲染原生DOM组件</h2> <ul><li><a href="http://https//babeljs.io/repl/" target="_blank" rel="noopener noreferrer">babeljs<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="_4-1-渲染效果"><a href="#_4-1-渲染效果" class="header-anchor">#</a> 4.1 渲染效果</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013836.png" alt="renderdom"></p> <h3 id="_4-2-类图"><a href="#_4-2-类图" class="header-anchor">#</a> 4.2 类图</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013842.png" alt="20rendernativeunit"></p> <h3 id="_4-3-jsx语法"><a href="#_4-3-jsx语法" class="header-anchor">#</a> 4.3 JSX语法</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013849.png" alt="compile"></p> <h4 id="_4-3-1-jsx"><a href="#_4-3-1-jsx" class="header-anchor">#</a> 4.3.1 JSX</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">&lt;</span>button id<span class="token operator">=</span><span class="token string">&quot;sayHello&quot;</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>sayHello<span class="token punctuation">}</span><span class="token operator">&gt;</span>say<span class="token operator">&lt;</span>b style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>color<span class="token operator">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>Hello<span class="token operator">&lt;</span><span class="token operator">/</span>b<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
</code></pre></div><h4 id="_4-3-2-javascript"><a href="#_4-3-2-javascript" class="header-anchor">#</a> 4.3.2 JavaScript</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token string">&quot;sayHello&quot;</span><span class="token punctuation">,</span>
    onClick<span class="token operator">:</span> sayHello
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;say&quot;</span><span class="token punctuation">,</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>style<span class="token operator">:</span><span class="token punctuation">{</span>color<span class="token operator">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-4-实现"><a href="#_4-4-实现" class="header-anchor">#</a> 4.4 实现</h3> <h4 id="_4-4-1-index-js"><a href="#_4-4-1-index-js" class="header-anchor">#</a> 4.4.1 index.js</h4> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">sayHello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>
    <span class="token string">'button'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token operator">:</span><span class="token string">'sayHello'</span><span class="token punctuation">,</span>onClick<span class="token operator">:</span>sayHello<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'say'</span><span class="token punctuation">,</span>
    React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token operator">:</span><span class="token punctuation">{</span>color<span class="token operator">:</span><span class="token string">'green'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_4-4-2-react-index-js"><a href="#_4-4-2-react-index-js" class="header-anchor">#</a> 4.4.2 react/index.js</h4> <p>src/react/index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import $ from 'jquery';
import {createUnit} from './unit';
<span class="token inserted-sign inserted">+import {createElement} from './element';
</span>let React = {
<span class="token unchanged">    rootIndex:0,
    render,
</span><span class="token inserted-sign inserted">+    createElement
</span>}
function render(element,container){
<span class="token unchanged">   let unit = createUnit(element);
   let markup = unit.getMarkUp(React.rootIndex);
   $(container).html(markup);
   $(document).trigger('mounted');//componentDidMount
</span>}

export default React;
</code></pre></div><h4 id="_4-4-3-react-element-js"><a href="#_4-4-3-react-element-js" class="header-anchor">#</a> 4.4.3 react/element.js</h4> <p>src/react/element.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Element</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span>props<span class="token punctuation">,</span><span class="token operator">...</span>children</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    props<span class="token operator">=</span>props<span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    props<span class="token punctuation">.</span>children  <span class="token operator">=</span> children<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
    createElement
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4-4-4-react-unit-js"><a href="#_4-4-4-react-unit-js" class="header-anchor">#</a> 4.4.4 react/unit.js</h4> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code><span class="token inserted-sign inserted">+import {Element} from './element';
+import $ from 'jquery';
</span>class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
</span>}
<span class="token inserted-sign inserted">+class NativeUnit extends Unit {
+     getMarkUp(reactid){
+         this._reactid = reactid;//保存记录reactid
+        //返回文本节点对应的HTML字符串
+        let {type,props} = this._currentElement;
+        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
+        let tagClose = `&lt;/$type&gt;`;
+        let content = '';
+        for(let propName in props){
+            if(/^on[A-Z]/.test(propName)){
+                let eventName = propName.slice(2).toLowerCase();
+                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
+            }else if(propName === 'style'){
+                let styleObj = props[propName];
+                let styles = Object.keys(styleObj).map(attr=&gt;`${attr}:${styleObj[attr]}`).join(';');
+                tagOpen += (` style=&quot;${styles}&quot; `);
+            }else if (propName === 'children'){
+                let children = props.children||[];
+                children.map((child,index)=&gt;{
+                    let childUnit = createUnit(child);
+                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
+                    content += childMarkUp;
+                });
+            }else{
+                tagOpen += ` ${propName}=${props[propName]} `;
+            }
+        }
+        return tagOpen + '&gt;' + content + tagClose;
+    }
+}
</span>function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
</span><span class="token inserted-sign inserted">+  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
+      return new NativeUnit(element);
+  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h2 id="_5-渲染自定义组件"><a href="#_5-渲染自定义组件" class="header-anchor">#</a> 5. 渲染自定义组件</h2> <h3 id="_5-1-渲染效果"><a href="#_5-1-渲染效果" class="header-anchor">#</a> 5.1 渲染效果</h3> <p><img src="http://img.zhufengpeixun.cn/5.customercomponent.png" alt="customercomponent"></p> <h3 id="_5-2-类图"><a href="#_5-2-类图" class="header-anchor">#</a> 5.2 类图</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013859.png" alt="20rendercustomerunit"></p> <h3 id="_5-3-实现"><a href="#_5-3-实现" class="header-anchor">#</a> 5.3 实现</h3> <h4 id="_5-3-1-src-index-js"><a href="#_5-3-1-src-index-js" class="header-anchor">#</a> 5.3.1 src/index.js</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Counter componentWillMount'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Counter componentDidMount'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>style<span class="token operator">:</span><span class="token punctuation">{</span>color<span class="token operator">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>onClick<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token operator">:</span><span class="token string">'counter'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_5-3-2-react-index-js"><a href="#_5-3-2-react-index-js" class="header-anchor">#</a> 5.3.2 react/index.js</h4> <p>src/react/index.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import $ from 'jquery';
import {createUnit} from './unit';
import {createElement} from './element';
<span class="token inserted-sign inserted">+import {Component} from './component';
</span>let React = {
<span class="token unchanged">    rootIndex:0,
    render,
    createElement,
</span><span class="token inserted-sign inserted">+    Component
</span>}
function render(element,container){
<span class="token unchanged">   let unit = createUnit(element);
   let markup = unit.getMarkUp(React.rootIndex);
   $(container).html(markup);
   $(document).trigger('mounted');//componentDidMount
</span>}

export default React;
</code></pre></div><h4 id="_5-3-3-react-component-js"><a href="#_5-3-3-react-component-js" class="header-anchor">#</a> 5.3.3 react/component.js</h4> <p>src/react/component.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5-3-4-react-unit-js"><a href="#_5-3-4-react-unit-js" class="header-anchor">#</a> 5.3.4 react/unit.js</h4> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
</span>}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
                let styleObj = props[propName];
                let styles = Object.keys(styleObj).map(attr=&gt;`${attr}:${styleObj[attr]}`).join(';');
                tagOpen += (` style=&quot;${styles}&quot; `);
            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
        return tagOpen + '&gt;' + content + tagClose;
    }
</span>}

<span class="token inserted-sign inserted">+class CompositeUnit extends Unit{
+    getMarkUp(reactid){
+        this._reactid = reactid;
+        //type是一个自定义组件的类的定义
+        let {type:Component,props} = this._currentElement;
+        //创建Component类的实例
+        let componentInstance = new Component(props);
+        //组件将要渲染
+        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
+        //执行render方法获得虚拟DOM元素实例
+        let renderedElement = componentInstance.render();
+        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
+        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
+        //获得此unit的HTML标记字符串
+        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
+        //注册挂载完成的监听，越底层的组件越先监听，越先执行
+        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
+        return renderedMarkUp;
+    }
+}
</span>
function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
</span><span class="token inserted-sign inserted">+  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
+      return new CompositeUnit(element);
+  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h2 id="_6-实现setstate"><a href="#_6-实现setstate" class="header-anchor">#</a> 6. 实现setState</h2> <h3 id="_6-1-src-index-js"><a href="#_6-1-src-index-js" class="header-anchor">#</a> 6.1 src/index.js</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Counter componentWillMount'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-2-react-component-js"><a href="#_6-2-react-component-js" class="header-anchor">#</a> 6.2 react/component.js</h3> <p>src/react/component.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props <span class="token operator">=</span> props<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">partialState</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_currentUnit<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>partialState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>Component<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-3-react-unit-js"><a href="#_6-3-react-unit-js" class="header-anchor">#</a> 6.3 react/unit.js</h3> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
</span><span class="token inserted-sign inserted">+    update(nextElement){
+        if(this._currentElement != nextElement){
+            this._currentElement = nextElement;
+            $(`[data-reactid=&quot;${this._reactid}&quot;]`).html(this._currentElement);
+        }
+    }
</span>}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
                let styleObj = props[propName];
                let styles = Object.keys(styleObj).map(attr=&gt;`${attr}:${styleObj[attr]}`).join(';');
                tagOpen += (` style=&quot;${styles}&quot; `);
            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
        return tagOpen + '&gt;' + content + tagClose;
    }
</span>}

class CompositeUnit extends Unit{
<span class="token unchanged">    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数
</span><span class="token inserted-sign inserted">+    update(nextElement,partialState){
+        //如果传过来了新的元素，则使用新的元素
+        this._currentElement = nextElement||this._currentElement;
+        //获取新的状态对象和属性对象
+        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);
+        let nextProps = this._currentElement.props;
+        //如果shouldComponentUpdate返回了false则不需要继续更新
+        if(this._componentInstance.shouldComponentUpdate&amp;&amp;this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}
+        //获得上次渲染出来的unit实例 
+        let prevRenderedUnitInstance = this._renderedUnitInstance;
+        //从unit实例中获取
+        let prevRenderedElement = prevRenderedUnitInstance._currentElement;
+        //获取新的虚拟DOM
+        let nextRenderElement = this._componentInstance.render();
+        //进行domdiff对比
+        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){
+            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点
+            prevRenderedUnitInstance.update(nextRenderElement);
+            this._componentInstance.componentDidUpdate&amp;&amp;this._componentInstance.componentDidUpdate();
+        }else{
+            //如果发现不需要对比，干脆重新渲染
+            this._renderedUnitInstance =  createUnit(nextRenderElement);
+            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);
+            //替换整个节点
+            $(`[data-reactid=&quot;${this._reactid}&quot;]`).replaceWith(nextMarkUp);
+        }
</span>
<span class="token unchanged">    }
    getMarkUp(reactid){
        this._reactid = reactid;
        //type是一个自定义组件的类的定义
        let {type:Component,props} = this._currentElement;
        //创建Component类的实例
</span><span class="token inserted-sign inserted">+        let componentInstance = this._componentInstance = new Component(props);
</span><span class="token unchanged">        //组件实例关联上自己的unit实例
</span><span class="token inserted-sign inserted">+        componentInstance._currentUnit  = this;
</span><span class="token unchanged">        //组件将要渲染
        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
        //执行render方法获得虚拟DOM元素实例
        let renderedElement = componentInstance.render();
        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
        //获得此unit的HTML标记字符串
        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
        //注册挂载完成的监听，越底层的组件越先监听，越先执行
        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
        return renderedMarkUp;
    }
</span>}

<span class="token inserted-sign inserted">+function shouldDeepCompare(prevElement,nextElement){
+   if(prevElement!==null &amp;&amp; nextElement!=null){
+       let prevType = typeof prevElement;
+       let nextType = typeof nextElement;
+       //如果新老节点都是文本可以进行比较
+       if((prevType === 'string' ||prevType === 'number')&amp;&amp;(nextType === 'string' ||nextType === 'number')){
+           return true;
+       }
+       if(prevElement instanceof Element &amp;&amp; nextElement instanceof Element){
+           return prevElement.type === nextElement.type;
+       }
+   }  
+   return false;
+}
</span>function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
      return new CompositeUnit(element);
  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h3 id="_6-4-react-element-js"><a href="#_6-4-react-element-js" class="header-anchor">#</a> 6.4 react/element.js</h3> <p>src/react/element.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>class Element{
<span class="token unchanged">    constructor(type,props){
        this.type = type;
</span><span class="token inserted-sign inserted">+       this.key = props.key;
</span><span class="token unchanged">        this.props = props;
    }
</span>}
</code></pre></div><h2 id="_7-对比属性"><a href="#_7-对比属性" class="header-anchor">#</a> 7. 对比属性</h2> <ul><li>实现点击加1功能</li></ul> <h3 id="_7-1-src-index-js"><a href="#_7-1-src-index-js" class="header-anchor">#</a> 7.1 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentWillMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Counter componentWillMount'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Counter componentDidMount'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function-variable function">handleClick</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token keyword">let</span> p <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">let</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>onClick<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleClick<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>id<span class="token operator">:</span><span class="token string">'counter'</span><span class="token punctuation">,</span>style<span class="token operator">:</span><span class="token punctuation">{</span>color<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">%</span><span class="token number">2</span><span class="token operator">===</span><span class="token number">0</span><span class="token operator">?</span><span class="token string">'red'</span><span class="token operator">:</span><span class="token string">'green'</span><span class="token punctuation">,</span>backgroundColor<span class="token operator">:</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>number<span class="token operator">%</span><span class="token number">2</span><span class="token operator">===</span><span class="token number">0</span><span class="token operator">?</span><span class="token string">'green'</span><span class="token operator">:</span><span class="token string">'red'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>p<span class="token punctuation">,</span>button<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_7-2-react-unit-js"><a href="#_7-2-react-unit-js" class="header-anchor">#</a> 7.2 react/unit.js</h3> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
    update(nextElement){
        if(this._currentElement != nextElement){
            this._currentElement = nextElement;
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).html(this._currentElement);
        }
    }
</span>
}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
</span><span class="token inserted-sign inserted">+                let styleObj = props[propName];
+                let styles = Object.keys(styleObj).map(attr=&gt;{
+                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){
+                        return `-${group.toLowerCase()}`;
+                    })
+                    return `${attrName}:${styleObj[attr]}`;
+                }).join(';');
+                tagOpen += (` style=&quot;${styles}&quot; `);
</span><span class="token unchanged">            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
        return tagOpen + '&gt;' + content + tagClose;
    }
</span><span class="token inserted-sign inserted">+    update(nextElement){
+        let oldProps = this._currentElement.props;
+        let newProps = nextElement.props;
+        this.updateDOMproperties(oldProps,newProps);
+        //this.updateDOMChildren(nextElement.props.children);
+    }
+    updateDOMproperties(oldProps,newProps){
+        let propName;
+        //把新属性对象上没有属性给删除掉
+        for(propName in oldProps){
+            if(!newProps.hasOwnProperty(propName)){
+                $(`[data-reactid=&quot;${this._reactid}&quot;]`).removeAttr(propName);
+            }
+            if(/^on[A-Z]/.test(propName)){
+                $(document).undelegate(`.${this.reactid}`);
+            }
+        }
+        for(propName in newProps){
+            if(propName == 'children'){
+                
+            }else if(/^on[A-Z]/.test(propName)){
+                let eventName = propName.slice(2).toLowerCase();
+                $(document).delegate(`[data-reactid=&quot;${this._reactid}&quot;]`,`${eventName}.${this._reactid}`,newProps[propName]);
+            }else if(propName === 'style'){
+                let styleObj = newProps[propName];
+                Object.entries(styleObj).forEach(([attr,value])=&gt;{
+                  $(`[data-reactid=&quot;${this._reactid}&quot;]`).css(attr,value);
+                })
+            }else{
+                $(`[data-reactid=&quot;${this._reactid}&quot;]`).prop(propName,newProps[propName]);
+            }
+        }
+    }
+}
</span>
class CompositeUnit extends Unit{
<span class="token unchanged">    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数
    update(nextElement,partialState){
        //如果传过来了新的元素，则使用新的元素
        this._currentElement = nextElement||this._currentElement;
        //获取新的状态对象和属性对象
        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);
        let nextProps = this._currentElement.props;
        //如果shouldComponentUpdate返回了false则不需要继续更新
        if(this._componentInstance.shouldComponentUpdate&amp;&amp;this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}
        //获得上次渲染出来的unit实例 
        let prevRenderedUnitInstance = this._renderedUnitInstance;
        //从unit实例中获取
        let prevRenderedElement = prevRenderedUnitInstance._currentElement;
        //获取新的虚拟DOM
        let nextRenderElement = this._componentInstance.render();
        //进行domdiff对比
        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){
            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点
            prevRenderedUnitInstance.update(nextRenderElement);
            this._componentInstance.componentDidUpdate&amp;&amp;this._componentInstance.componentDidUpdate();
        }else{
            //如果发现不需要对比，干脆重新渲染
            this._renderedUnitInstance =  createUnit(nextRenderElement);
            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);
            //替换整个节点
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).replaceWith(nextMarkUp);
        }
</span>
<span class="token unchanged">    }
    getMarkUp(reactid){
        this._reactid = reactid;
        //type是一个自定义组件的类的定义
        let {type:Component,props} = this._currentElement;
        //创建Component类的实例
        let componentInstance = this._componentInstance = new Component(props);
        //组件实例关联上自己的unit实例
        componentInstance._currentUnit  = this;
        //组件将要渲染
        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
        //执行render方法获得虚拟DOM元素实例
        let renderedElement = componentInstance.render();
        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
        //获得此unit的HTML标记字符串
        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
        //注册挂载完成的监听，越底层的组件越先监听，越先执行
        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
        return renderedMarkUp;
    }
</span>}

function shouldDeepCompare(prevElement,nextElement){
<span class="token unchanged">   if(prevElement!==null &amp;&amp; nextElement!=null){
       let prevType = typeof prevElement;
       let nextType = typeof nextElement;
       //如果新老节点都是文本可以进行比较
       if((prevType === 'string' ||prevType === 'number')&amp;&amp;(nextType === 'string' ||nextType === 'number')){
           return true;
       }
       if(prevElement instanceof Element &amp;&amp; nextElement instanceof Element){
           return prevElement.type === nextElement.type;
       }
   }  
   return false;
</span>}
function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
      return new CompositeUnit(element);
  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h2 id="_8-对比子元素"><a href="#_8-对比子元素" class="header-anchor">#</a> 8. 对比子元素</h2> <h3 id="_8-1-src-unit-js"><a href="#_8-1-src-unit-js" class="header-anchor">#</a> 8.1 src/unit.js</h3> <p>src\unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
<span class="token inserted-sign inserted">+ let diffQueue = [];
</span>class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
    update(nextElement){
        if(this._currentElement != nextElement){
            this._currentElement = nextElement;
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).html(this._currentElement);
        }
    }
</span>
}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
</span><span class="token inserted-sign inserted">+        let renderedChildUnits=[];
</span><span class="token unchanged">        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
                let styleObj = props[propName];
                let styles = Object.keys(styleObj).map(attr=&gt;{
                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){
                        return `-${group.toLowerCase()}`;
                    })
                    return `${attrName}:${styleObj[attr]}`;
                }).join(';');
                tagOpen += (` style=&quot;${styles}&quot; `);
            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
</span><span class="token inserted-sign inserted">+                    renderedChildUnits.push(childUnit);
</span><span class="token unchanged">                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
</span><span class="token inserted-sign inserted">+        this._renderedChildUnits = renderedChildUnits;
</span><span class="token unchanged">        return tagOpen + '&gt;' + content + tagClose;
    }
    update(nextElement){
        let oldProps = this._currentElement.props;
        let newProps = nextElement.props;
        this.updateDOMproperties(oldProps,newProps);
</span><span class="token inserted-sign inserted">+        this.updateDOMChildren(nextElement.props.children);
</span><span class="token unchanged">    }
</span><span class="token inserted-sign inserted">+    //对比子元素
+    updateDOMChildren(newChildrenElements){
+        this.diff(diffQueue,newChildrenElements);
+    }
+    diff(diffQueue,newChildrenElements){
+        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);
+        let newChildren = this.getNewChildren(oldChildUnitsMap,newChildrenElements);
+    }
+    getNewChildren(oldChildUnitsMap,newChildrenElements){
+        let newChildren = [];
+        newChildrenElements.forEach((newElement,index)=&gt;{
+            let newKey = newElement.key||index.toString();
+            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit
+            let oldElement = oldUnit&amp;&amp;oldUnit._currentElement;//获得老的element
+            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较
+                oldUnit.update(newElement);
+                newChildren.push(oldUnit);
+            }else{
+                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit
+                newChildren.push(newChildUnit);
+            }
+        });
+        return newChildren;
+    }
+    getChildrenMap(childUnits=[]){
+        let map = {};
+        for(let i=0;i&lt;childUnits.length;i++){
+            let key = childUnits[i].key||i.toString();
+            map[key]=childUnits[i];
+        }
+        return map;
+    }
</span><span class="token unchanged">    updateDOMproperties(oldProps,newProps){
        let propName;
        //把新属性对象上没有属性给删除掉
        for(propName in oldProps){
            if(!newProps.hasOwnProperty(propName)){
                $(`[data-reactid=&quot;${this._reactid}&quot;]`).removeAttr(propName);
            }
            if(/^on[A-Z]/.test(propName)){
                $(document).undelegate(`.${this._reactid}`);
            }
        }
        for(propName in newProps){
            if(propName == 'children'){
</span>
<span class="token unchanged">            }else if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).undelegate(`.${this._reactid}`);
                $(document).delegate(`[data-reactid=&quot;${this._reactid}&quot;]`,`${eventName}.${this._reactid}`,newProps[propName]);
            }else if(propName === 'style'){
                let styleObj = newProps[propName];
                Object.entries(styleObj).forEach(([attr,value])=&gt;{
                  $(`[data-reactid=&quot;${this._reactid}&quot;]`).css(attr,value);
                })
            }else{
                $(`[data-reactid=&quot;${this._reactid}&quot;]`).prop(propName,newProps[propName]);
            }
        }
    }
</span>}

class CompositeUnit extends Unit{
<span class="token unchanged">    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数
    update(nextElement,partialState){
        //如果传过来了新的元素，则使用新的元素
        this._currentElement = nextElement||this._currentElement;
        //获取新的状态对象和属性对象
        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);
        let nextProps = this._currentElement.props;
        //如果shouldComponentUpdate返回了false则不需要继续更新
        if(this._componentInstance.shouldComponentUpdate&amp;&amp;this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}
        //获得上次渲染出来的unit实例 
        let prevRenderedUnitInstance = this._renderedUnitInstance;
        //从unit实例中获取
        let prevRenderedElement = prevRenderedUnitInstance._currentElement;
        //获取新的虚拟DOM
        let nextRenderElement = this._componentInstance.render();
        //进行domdiff对比
        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){
            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点
            prevRenderedUnitInstance.update(nextRenderElement);
            this._componentInstance.componentDidUpdate&amp;&amp;this._componentInstance.componentDidUpdate();
        }else{
            //如果发现不需要对比，干脆重新渲染
            this._renderedUnitInstance =  createUnit(nextRenderElement);
            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);
            //替换整个节点
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).replaceWith(nextMarkUp);
        }
</span>
<span class="token unchanged">    }
    getMarkUp(reactid){
        this._reactid = reactid;
        //type是一个自定义组件的类的定义
        let {type:Component,props} = this._currentElement;
        //创建Component类的实例
        let componentInstance = this._componentInstance = new Component(props);
        //组件实例关联上自己的unit实例
        componentInstance._currentUnit  = this;
        //组件将要渲染
        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
        //执行render方法获得虚拟DOM元素实例
        let renderedElement = componentInstance.render();
        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
        //获得此unit的HTML标记字符串
        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
        //注册挂载完成的监听，越底层的组件越先监听，越先执行
        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
        return renderedMarkUp;
    }
</span>}

function shouldDeepCompare(prevElement,nextElement){
<span class="token unchanged">   if(prevElement!==null &amp;&amp; nextElement!=null){
       let prevType = typeof prevElement;
       let nextType = typeof nextElement;
       //如果新老节点都是文本可以进行比较
       if((prevType === 'string' ||prevType === 'number')&amp;&amp;(nextType === 'string' ||nextType === 'number')){
           return true;
       }
       if(prevElement instanceof Element &amp;&amp; nextElement instanceof Element){
           return prevElement.type === nextElement.type;
       }
   }  
   return false;
</span>}
function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
      return new CompositeUnit(element);
  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h2 id="_9-获得补丁数组"><a href="#_9-获得补丁数组" class="header-anchor">#</a> 9. 获得补丁数组</h2> <p><img src="http://img.zhufengpeixun.cn/diffold.png" alt="diffold"></p> <p><img src="http://img.zhufengpeixun.cn/diffnew.png" alt="diffnew"></p> <p><img src="http://img.zhufengpeixun.cn/domdiff2.gif" alt="domdiff2"></p> <h3 id="_9-1-src-index-js"><a href="#_9-1-src-index-js" class="header-anchor">#</a> 9.1 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>odd<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>odd<span class="token operator">:</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'wrapper'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'A'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'B'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'C'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'D'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'wrapper'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'A'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'A1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'C'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'C1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'B'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'B1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'E'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'E1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'F'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'F1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_9-2-src-react-unit-js"><a href="#_9-2-src-react-unit-js" class="header-anchor">#</a> 9.2 src/react/unit.js</h3> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
<span class="token inserted-sign inserted">+import types from './types';
+let diffQueue = [];
+let updateDepth=0;
</span>class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
    update(nextElement){
        if(this._currentElement != nextElement){
            this._currentElement = nextElement;
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).html(this._currentElement);
        }
    }
</span>
}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
        let renderedChildUnits=[];
        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
                let styleObj = props[propName];
                let styles = Object.keys(styleObj).map(attr=&gt;{
                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){
                        return `-${group.toLowerCase()}`;
                    })
                    return `${attrName}:${styleObj[attr]}`;
                }).join(';');
                tagOpen += (` style=&quot;${styles}&quot; `);
            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
                    childUnit._mountIndex = index;
                    renderedChildUnits.push(childUnit);
                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
        this._renderedChildUnits = renderedChildUnits;
        return tagOpen + '&gt;' + content + tagClose;
    }
    update(nextElement){
        let oldProps = this._currentElement.props;
        let newProps = nextElement.props;
        this.updateDOMproperties(oldProps,newProps);
        this.updateDOMChildren(nextElement.props.children);
    }
    //对比子元素
</span><span class="token inserted-sign inserted">+    updateDOMChildren(newChildrenElements){
+        updateDepth++;
+        this.diff(diffQueue,newChildrenElements);
+        updateDepth--;
+        if(updateDepth===0){
+            console.log('diffQueue',diffQueue);
+            diffQueue=[];
+        }
+    }
+    diff(diffQueue,newChildrenElements){
+        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);
+        let {newChildrenMap,newChildren} = this.getNewChildren(oldChildUnitsMap,newChildrenElements);
+        // lastIndex里存放着被复用的子元素的最大索引
+        let lastIndex = 0;
+        for(let i=0;i&lt;newChildren.length;i++){
+            let newChild = newChildren[i];//取得新元素
+            let newKey = (newChild._currentElement.props&amp;&amp;newChild._currentElement.key)||i.toString();//取得新key
+            let oldChild = oldChildUnitsMap[newKey];
+            if(oldChild === newChild){
+                if(oldChild._mountIndex &lt; lastIndex){
+                    diffQueue.push({
+                        parentId:this._reactid,
+                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
+                        type:types.MOVE,
+                        fromIndex:oldChild._mountIndex,
+                        toIndex:i
+                    });
+                }
+                lastIndex = Math.max(oldChild._mountIndex,lastIndex);
+                //否则根本不用移动，直接修改挂载索引为新索引i即可
+            }else{
+                if(oldChild){
+                    diffQueue.push({
+                        parentId:this._reactid,
+                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
+                        type:types.REMOVE,
+                        fromIndex:oldChild._mountIndex
+                    });
+                    $(document).undelegate(`.${oldChild._reactid}`);
+                }
+                 diffQueue.push({
+                        parentId:this._reactid,
+                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
+                        type:types.INSERT,
+                        toIndex:i,
+                        markUp:newChild.getMarkUp(`${this._reactid}.${i}`)
+                });
+            }
+            newChild._mountIndex = i;
+        }
+        for(let oldKey in oldChildUnitsMap){
+            if(!newChildrenMap.hasOwnProperty(oldKey)){
+                let oldChild = oldChildUnitsMap[oldKey];
+                diffQueue.push({
+                        parentId:this._reactid,
+                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
+                        type:types.REMOVE,
+                        fromIndex:oldChild._mountIndex
+                });
+            }
+        }
+    }
+    getNewChildren(oldChildUnitsMap,newChildrenElements){
+        let newChildren = [];
+        let newChildrenMap={};
+        newChildrenElements.forEach((newElement,index)=&gt;{
+            let newKey = newElement.key||index.toString();
+            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit
+            let oldElement = oldUnit&amp;&amp;oldUnit._currentElement;//获得老的element
+            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较
+                oldUnit.update(newElement);
+                newChildren.push(oldUnit);
+                newChildrenMap[newKey]=oldUnit;
+            }else{
+                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit
+                newChildren.push(newChildUnit);
+                 newChildrenMap[newKey]=newChildUnit;
+            }
+        });
+        return {newChildrenMap,newChildren};
+    }
+    getChildrenMap(childUnits=[]){
+        let map = {};
+        for(let i=0;i&lt;childUnits.length;i++){
+            let key = (childUnits[i]._currentElement.props&amp;&amp;childUnits[i]._currentElement.props.key)||i.toString();
+            map[key]=childUnits[i];
+        }
+        return map;
+    }
+    updateDOMproperties(oldProps,newProps){
+        let propName;
+        //把新属性对象上没有属性给删除掉
+        for(propName in oldProps){
+            if(!newProps.hasOwnProperty(propName)){
+                $(`[data-reactid=&quot;${this._reactid}&quot;]`).removeAttr(propName);
+            }
+            if(/^on[A-Z]/.test(propName)){
+                $(document).undelegate(`.${this._reactid}`);
+            }
+        }
+        for(propName in newProps){
+            if(propName == 'children'){
+                
+            }else if(/^on[A-Z]/.test(propName)){
+                let eventName = propName.slice(2).toLowerCase();
+                $(document).undelegate(`.${this._reactid}`);
+                $(document).delegate(`[data-reactid=&quot;${this._reactid}&quot;]`,`${eventName}.${this._reactid}`,newProps[propName]);
+            }else if(propName === 'style'){
+                let styleObj = newProps[propName];
+                Object.entries(styleObj).forEach(([attr,value])=&gt;{
+                  $(`[data-reactid=&quot;${this._reactid}&quot;]`).css(attr,value);
+                })
+            }else{
+                $(`[data-reactid=&quot;${this._reactid}&quot;]`).prop(propName,newProps[propName]);
+            }
+        }
+    }
+}
</span>
class CompositeUnit extends Unit{
<span class="token unchanged">    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数
    update(nextElement,partialState){
        //如果传过来了新的元素，则使用新的元素
        this._currentElement = nextElement||this._currentElement;
        //获取新的状态对象和属性对象
        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);
        let nextProps = this._currentElement.props;
        //如果shouldComponentUpdate返回了false则不需要继续更新
        if(this._componentInstance.shouldComponentUpdate&amp;&amp;this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}
        //获得上次渲染出来的unit实例 
        let prevRenderedUnitInstance = this._renderedUnitInstance;
        //从unit实例中获取
        let prevRenderedElement = prevRenderedUnitInstance._currentElement;
        //获取新的虚拟DOM
        let nextRenderElement = this._componentInstance.render();
        //进行domdiff对比
        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){
            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点
            prevRenderedUnitInstance.update(nextRenderElement);
            this._componentInstance.componentDidUpdate&amp;&amp;this._componentInstance.componentDidUpdate();
        }else{
            //如果发现不需要对比，干脆重新渲染
            this._renderedUnitInstance =  createUnit(nextRenderElement);
            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);
            //替换整个节点
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).replaceWith(nextMarkUp);
        }
</span>
<span class="token unchanged">    }
    getMarkUp(reactid){
        this._reactid = reactid;
        //type是一个自定义组件的类的定义
        let {type:Component,props} = this._currentElement;
        //创建Component类的实例
        let componentInstance = this._componentInstance = new Component(props);
        //组件实例关联上自己的unit实例
        componentInstance._currentUnit  = this;
        //组件将要渲染
        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
        //执行render方法获得虚拟DOM元素实例
        let renderedElement = componentInstance.render();
        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
        //获得此unit的HTML标记字符串
        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
        //注册挂载完成的监听，越底层的组件越先监听，越先执行
        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
        return renderedMarkUp;
    }
</span>}

function shouldDeepCompare(prevElement,nextElement){
<span class="token unchanged">   if(prevElement!==null &amp;&amp; nextElement!=null){
       let prevType = typeof prevElement;
       let nextType = typeof nextElement;
       //如果新老节点都是文本可以进行比较
       if((prevType === 'string' ||prevType === 'number')&amp;&amp;(nextType === 'string' ||nextType === 'number')){
           return true;
       }
       if(prevElement instanceof Element &amp;&amp; nextElement instanceof Element){
           return prevElement.type === nextElement.type;
       }
   }  
   return false;
</span>}
function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
      return new CompositeUnit(element);
  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h3 id="_9-3-types-js"><a href="#_9-3-types-js" class="header-anchor">#</a> 9.3 types.js</h3> <p>src\types.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span>  <span class="token punctuation">{</span>
    <span class="token constant">MOVE</span><span class="token operator">:</span><span class="token string">'MOVE'</span><span class="token punctuation">,</span>
    <span class="token constant">INSERT</span><span class="token operator">:</span><span class="token string">&quot;INSERT&quot;</span><span class="token punctuation">,</span>
    <span class="token constant">REMOVE</span><span class="token operator">:</span><span class="token string">&quot;REMOVE&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10-打补丁"><a href="#_10-打补丁" class="header-anchor">#</a> 10. 打补丁</h2> <h3 id="_10-1-src-index-js"><a href="#_10-1-src-index-js" class="header-anchor">#</a> 10.1 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>odd<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>odd<span class="token operator">:</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>odd<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'wrapper'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'A'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'B'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'C'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'D'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'ul'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'wrapper'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'A'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'C'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'C1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'B'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'B1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'E'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'E1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'li'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>key<span class="token operator">:</span><span class="token string">'F'</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'F1'</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> element <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_10-2-react-unit-js"><a href="#_10-2-react-unit-js" class="header-anchor">#</a> 10.2 react/unit.js</h3> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
import types from './types';
let diffQueue = [];
let updateDepth=0;
class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
    update(nextElement){
        if(this._currentElement != nextElement){
            this._currentElement = nextElement;
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).html(this._currentElement);
        }
    }
</span>
}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
        let renderedChildUnits=[];
        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
                let styleObj = props[propName];
                let styles = Object.keys(styleObj).map(attr=&gt;{
                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){
                        return `-${group.toLowerCase()}`;
                    })
                    return `${attrName}:${styleObj[attr]}`;
                }).join(';');
                tagOpen += (` style=&quot;${styles}&quot; `);
            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
                    childUnit._mountIndex = index;
                    renderedChildUnits.push(childUnit);
                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
        this._renderedChildUnits = renderedChildUnits;
        return tagOpen + '&gt;' + content + tagClose;
    }
    update(nextElement){
        let oldProps = this._currentElement.props;
        let newProps = nextElement.props;
        this.updateDOMproperties(oldProps,newProps);
        this.updateDOMChildren(nextElement.props.children);
    }
    //对比子元素
    updateDOMChildren(newChildrenElements){
        updateDepth++;
        this.diff(diffQueue,newChildrenElements);
        updateDepth--;
        if(updateDepth===0){
            console.log('diffQueue',diffQueue);
</span><span class="token inserted-sign inserted">+            this.patch(diffQueue);
</span><span class="token unchanged">            diffQueue=[];
        }
    }
</span><span class="token inserted-sign inserted">+    patch(diffQueue){
+        let deleteChildren = [];
+        let deleteMap={};
+        for(let i=0;i&lt;diffQueue.length;i++){
+            let difference = diffQueue[i];
+            if(difference.type===types.MOVE || difference.type===types.REMOVE){
+                let fromIndex = difference.fromIndex;
+                let oldChild = $(difference.parentNode.children().get(fromIndex));
+                deleteMap[fromIndex]=oldChild;
+                deleteChildren.push(oldChild);
+            }
+        }
+        $.each(deleteChildren,(idx,child)=&gt;{
+            $(child).remove();
+        });
</span>
<span class="token inserted-sign inserted">+        for(let k=0;k&lt;diffQueue.length;k++){
+            let difference = diffQueue[k];
+            switch(difference.type){
+              case types.INSERT:
+                this.insertChildAt(difference.parentNode,$(difference.markUp),difference.toIndex);
+                break;
+              case types.MOVE:
+                this.insertChildAt(difference.parentNode,deleteMap[difference.fromIndex],difference.toIndex);
+                break;
+              default:
+               break;   
+            }
+        }
+    }
+    insertChildAt(parentNode,childNode,index){
+        let oldChild = parentNode.children().get(index);
+        oldChild?childNode.insertBefore(oldChild):childNode.appendTo(parentNode);
+    }
</span><span class="token unchanged">    diff(diffQueue,newChildrenElements){
        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);
        let {newChildrenMap,newChildren} = this.getNewChildren(oldChildUnitsMap,newChildrenElements);
        // lastIndex里存放着被复用的子元素的最大索引
        let lastIndex = 0;
        for(let i=0;i&lt;newChildren.length;i++){
            let newChild = newChildren[i];//取得新元素
            let newKey = (newChild._currentElement.props&amp;&amp;newChild._currentElement.key)||i.toString();//取得新key
            let oldChild = oldChildUnitsMap[newKey];
            if(oldChild === newChild){
                if(oldChild._mountIndex &lt; lastIndex){
                    diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.MOVE,
                        fromIndex:oldChild._mountIndex,
                        toIndex:i
                    });
                }
                lastIndex = Math.max(oldChild._mountIndex,lastIndex);
                //否则根本不用移动，直接修改挂载索引为新索引i即可
            }else{
                if(oldChild){
                    diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.REMOVE,
                        fromIndex:oldChild._mountIndex
                    });
                    $(document).undelegate(`.${oldChild._reactid}`);
                }
                 diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.INSERT,
                        toIndex:i,
                        markUp:newChild.getMarkUp(`${this._reactid}.${i}`)
                });
            }
            newChild._mountIndex = i;
        }
        for(let oldKey in oldChildUnitsMap){
            if(!newChildrenMap.hasOwnProperty(oldKey)){
                let oldChild = oldChildUnitsMap[oldKey];
                diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.REMOVE,
                        fromIndex:oldChild._mountIndex
                });
            }
        }
    }
    getNewChildren(oldChildUnitsMap,newChildrenElements){
        let newChildren = [];
        let newChildrenMap={};
        newChildrenElements.forEach((newElement,index)=&gt;{
            let newKey = newElement.key||index.toString();
            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit
            let oldElement = oldUnit&amp;&amp;oldUnit._currentElement;//获得老的element
            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较
                oldUnit.update(newElement);
                newChildren.push(oldUnit);
                newChildrenMap[newKey]=oldUnit;
            }else{
                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit
                newChildren.push(newChildUnit);
                 newChildrenMap[newKey]=newChildUnit;
            }
        });
        return {newChildrenMap,newChildren};
    }
    getChildrenMap(childUnits=[]){
        let map = {};
        for(let i=0;i&lt;childUnits.length;i++){
            let key = (childUnits[i]._currentElement.props&amp;&amp;childUnits[i]._currentElement.props.key)||i.toString();
            map[key]=childUnits[i];
        }
        return map;
    }
    updateDOMproperties(oldProps,newProps){
        let propName;
        //把新属性对象上没有属性给删除掉
        for(propName in oldProps){
            if(!newProps.hasOwnProperty(propName)){
                $(`[data-reactid=&quot;${this._reactid}&quot;]`).removeAttr(propName);
            }
            if(/^on[A-Z]/.test(propName)){
                $(document).undelegate(`.${this._reactid}`);
            }
        }
        for(propName in newProps){
            if(propName == 'children'){
</span>
<span class="token unchanged">            }else if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).undelegate(`.${this._reactid}`);
                $(document).delegate(`[data-reactid=&quot;${this._reactid}&quot;]`,`${eventName}.${this._reactid}`,newProps[propName]);
            }else if(propName === 'style'){
                let styleObj = newProps[propName];
                Object.entries(styleObj).forEach(([attr,value])=&gt;{
                  $(`[data-reactid=&quot;${this._reactid}&quot;]`).css(attr,value);
                })
            }else{
                $(`[data-reactid=&quot;${this._reactid}&quot;]`).prop(propName,newProps[propName]);
            }
        }
    }
</span>}

class CompositeUnit extends Unit{
<span class="token unchanged">    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数
    update(nextElement,partialState){
        //如果传过来了新的元素，则使用新的元素
        this._currentElement = nextElement||this._currentElement;
        //获取新的状态对象和属性对象
        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);
        let nextProps = this._currentElement.props;
        //如果shouldComponentUpdate返回了false则不需要继续更新
        if(this._componentInstance.shouldComponentUpdate&amp;&amp;this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}
        //获得上次渲染出来的unit实例 
        let prevRenderedUnitInstance = this._renderedUnitInstance;
        //从unit实例中获取
        let prevRenderedElement = prevRenderedUnitInstance._currentElement;
        //获取新的虚拟DOM
        let nextRenderElement = this._componentInstance.render();
        //进行domdiff对比
        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){
            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点
            prevRenderedUnitInstance.update(nextRenderElement);
            this._componentInstance.componentDidUpdate&amp;&amp;this._componentInstance.componentDidUpdate();
        }else{
            //如果发现不需要对比，干脆重新渲染
            this._renderedUnitInstance =  createUnit(nextRenderElement);
            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);
            //替换整个节点
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).replaceWith(nextMarkUp);
        }
</span>
<span class="token unchanged">    }
    getMarkUp(reactid){
        this._reactid = reactid;
        //type是一个自定义组件的类的定义
        let {type:Component,props} = this._currentElement;
        //创建Component类的实例
        let componentInstance = this._componentInstance = new Component(props);
        //组件实例关联上自己的unit实例
        componentInstance._currentUnit  = this;
        //组件将要渲染
        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
        //执行render方法获得虚拟DOM元素实例
        let renderedElement = componentInstance.render();
        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
        //获得此unit的HTML标记字符串
        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
        //注册挂载完成的监听，越底层的组件越先监听，越先执行
        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
        return renderedMarkUp;
    }
</span>}

function shouldDeepCompare(prevElement,nextElement){
<span class="token unchanged">   if(prevElement!==null &amp;&amp; nextElement!=null){
       let prevType = typeof prevElement;
       let nextType = typeof nextElement;
       //如果新老节点都是文本可以进行比较
       if((prevType === 'string' ||prevType === 'number')&amp;&amp;(nextType === 'string' ||nextType === 'number')){
           return true;
       }
       if(prevElement instanceof Element &amp;&amp; nextElement instanceof Element){
           return prevElement.type === nextElement.type;
       }
   }  
   return false;
</span>}
function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
      return new CompositeUnit(element);
  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h2 id="_11-todos"><a href="#_11-todos" class="header-anchor">#</a> 11. todos</h2> <p><a href="https://gitee.com/zhufengpeixun/zhufeng_react2/commit/466915a20e4bb8d0d019b3325ad47867a3891fae" target="_blank" rel="noopener noreferrer">commit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="_11-1-src-index-js"><a href="#_11-1-src-index-js" class="header-anchor">#</a> 11.1 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'./react'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Todos</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>text<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">.</span>length<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>list<span class="token operator">:</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">]</span><span class="token punctuation">,</span>text<span class="token operator">:</span><span class="token string">''</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">onChange</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>text<span class="token operator">:</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">onDel</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>list<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> <span class="token function-variable function">createItem</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">itemText<span class="token punctuation">,</span>index</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> itemText<span class="token punctuation">,</span>React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>onClick<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onDel</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'X'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> lists <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>list<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>createItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> input <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;input&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>onKeyup<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>value<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>text<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> button <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>onClick<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'Add'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>input<span class="token punctuation">,</span>button<span class="token punctuation">,</span><span class="token operator">...</span>lists<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> todos <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>Todos<span class="token punctuation">)</span><span class="token punctuation">;</span>
React<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>todos<span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_11-2-react-unit-js"><a href="#_11-2-react-unit-js" class="header-anchor">#</a> 11.2 react/unit.js</h3> <p>src/react/unit.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>import {Element} from './element';
import $ from 'jquery';
import types from './types';
let diffQueue = [];
let updateDepth=0;
class Unit {
<span class="token unchanged">    constructor(element){
        this._currentElement = element;
    }
    getMarkUp(){
        throw new Error('不能调用此方法');
    }
</span>}
class TextUnit extends Unit{
<span class="token unchanged">    getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        return `&lt;span data-reactid=&quot;${reactid}&quot;&gt;${this._currentElement}&lt;/span&gt;`;
    }
    update(nextElement){
        if(this._currentElement != nextElement){
            this._currentElement = nextElement;
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).html(this._currentElement);
        }
    }
</span>
}
class NativeUnit extends Unit {
<span class="token unchanged">     getMarkUp(reactid){
         this._reactid = reactid;//保存记录reactid
        //返回文本节点对应的HTML字符串
        let {type,props} = this._currentElement;
        let tagOpen = `&lt;${type} data-reactid=&quot;${reactid}&quot; `;
        let tagClose = `&lt;/$type&gt;`;
        let content = '';
        let renderedChildUnits=[];
        for(let propName in props){
            if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).delegate(`[data-reactid=&quot;${reactid}&quot;]`,`${eventName}.${reactid}`,props[propName]);
            }else if(propName === 'style'){
                let styleObj = props[propName];
                let styles = Object.keys(styleObj).map(attr=&gt;{
                    let attrName = attr.replace(/([A-Z])/g,function(matched,group){
                        return `-${group.toLowerCase()}`;
                    })
                    return `${attrName}:${styleObj[attr]}`;
                }).join(';');
                tagOpen += (` style=&quot;${styles}&quot; `);
            }else if (propName === 'children'){
                let children = props.children||[];
                children.map((child,index)=&gt;{
                    let childUnit = createUnit(child);
                    childUnit._mountIndex = index;
                    renderedChildUnits.push(childUnit);
                    let childMarkUp = childUnit.getMarkUp(`${reactid}.${index}`);
                    content += childMarkUp;
                });
            }else{
                tagOpen += ` ${propName}=${props[propName]} `;
            }
        }
        this._renderedChildUnits = renderedChildUnits;
        return tagOpen + '&gt;' + content + tagClose;
    }
    update(nextElement){
        let oldProps = this._currentElement.props;
        let newProps = nextElement.props;
        this.updateDOMproperties(oldProps,newProps);
        this.updateDOMChildren(nextElement.props.children);
    }
    //对比子元素
    updateDOMChildren(newChildrenElements){
        updateDepth++;
        this.diff(diffQueue,newChildrenElements);
        updateDepth--;
        if(updateDepth===0){
            console.log('diffQueue',diffQueue);
            this.patch(diffQueue);
            diffQueue=[];
        }
    }
    patch(diffQueue){
        let deleteChildren = [];
        let deleteMap={};
        for(let i=0;i&lt;diffQueue.length;i++){
            let difference = diffQueue[i];
            if(difference.type===types.MOVE || difference.type===types.REMOVE){
                let fromIndex = difference.fromIndex;
</span><span class="token inserted-sign inserted">+                let parentId = difference.parentId;
+                let oldChild = $(difference.parentNode.children().get(fromIndex));
+                deleteMap[parentId]={};
+                deleteMap[parentId][fromIndex]=oldChild;
</span><span class="token unchanged">                deleteChildren.push(oldChild);
            }
        }
        $.each(deleteChildren,(idx,child)=&gt;{
            $(child).remove();
        });
</span>
<span class="token unchanged">        for(let k=0;k&lt;diffQueue.length;k++){
            let difference = diffQueue[k];
            switch(difference.type){
              case types.INSERT:
                this.insertChildAt(difference.parentNode,$(difference.markUp),difference.toIndex);
                break;
              case types.MOVE:
</span><span class="token inserted-sign inserted">+                this.insertChildAt(difference.parentNode,deleteMap[difference.parentId][difference.fromIndex],difference.toIndex);
</span><span class="token unchanged">                break;
              default:
               break;   
            }
        }
    }
    insertChildAt(parentNode,childNode,index){
        let oldChild = parentNode.children().get(index);
        oldChild?childNode.insertBefore(oldChild):childNode.appendTo(parentNode);
    }
    diff(diffQueue,newChildrenElements){
        let oldChildUnitsMap = this.getChildrenMap(this._renderedChildUnits);
        let {newChildrenMap,newChildren} = this.getNewChildren(oldChildUnitsMap,newChildrenElements);
        // lastIndex里存放着被复用的子元素的最大索引
        let lastIndex = 0;
        for(let i=0;i&lt;newChildren.length;i++){
            let newChild = newChildren[i];//取得新元素
            let newKey = (newChild._currentElement.props&amp;&amp;newChild._currentElement.key)||i.toString();//取得新key
            let oldChild = oldChildUnitsMap[newKey];
            if(oldChild === newChild){
                if(oldChild._mountIndex &lt; lastIndex){
                    diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.MOVE,
                        fromIndex:oldChild._mountIndex,
                        toIndex:i
                    });
                }
                lastIndex = Math.max(oldChild._mountIndex,lastIndex);
                //否则根本不用移动，直接修改挂载索引为新索引i即可
            }else{
                if(oldChild){
                    diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.REMOVE,
                        fromIndex:oldChild._mountIndex
                    });
                    $(document).undelegate(`.${oldChild._reactid}`);
                }
                 diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.INSERT,
                        toIndex:i,
                        markUp:newChild.getMarkUp(`${this._reactid}.${i}`)
                });
            }
            newChild._mountIndex = i;
        }
        for(let oldKey in oldChildUnitsMap){
            if(!newChildrenMap.hasOwnProperty(oldKey)){
                let oldChild = oldChildUnitsMap[oldKey];
                diffQueue.push({
                        parentId:this._reactid,
                        parentNode:$(`[data-reactid=&quot;${this._reactid}&quot;]`),
                        type:types.REMOVE,
                        fromIndex:oldChild._mountIndex
                });
</span><span class="token inserted-sign inserted">+                this._renderedChildUnits = this._renderedChildUnits.filter(item=&gt;item != oldChild);
+                $(document).undelegate(`.${oldChild._reactid}`);
</span><span class="token unchanged">            }
        }
    }
    getNewChildren(oldChildUnitsMap,newChildrenElements){
        let newChildren = [];
        let newChildrenMap={};
        newChildrenElements.forEach((newElement,index)=&gt;{
            let newKey = newElement.key||index.toString();
            let oldUnit = oldChildUnitsMap[newKey];//获得老的unit
            let oldElement = oldUnit&amp;&amp;oldUnit._currentElement;//获得老的element
            if(shouldDeepCompare(oldElement,newElement)){//如果可以更进一步深比较
                oldUnit.update(newElement);
                newChildren.push(oldUnit);
                newChildrenMap[newKey]=oldUnit;
            }else{
                let newChildUnit = createUnit(newElement);//如果不需要深比较则直接创建新的unit
                newChildren.push(newChildUnit);
                newChildrenMap[newKey]=newChildUnit;
                this._renderedChildUnits[index]=newChildUnit;
            }
        });
        return {newChildrenMap,newChildren};
    }
    getChildrenMap(childUnits=[]){
        let map = {};
        for(let i=0;i&lt;childUnits.length;i++){
            let key = (childUnits[i]._currentElement.props&amp;&amp;childUnits[i]._currentElement.props.key)||i.toString();
            map[key]=childUnits[i];
        }
        return map;
    }
    updateDOMproperties(oldProps,newProps){
        let propName;
        //把新属性对象上没有属性给删除掉
        for(propName in oldProps){
            if(!newProps.hasOwnProperty(propName)){
                $(`[data-reactid=&quot;${this._reactid}&quot;]`).removeAttr(propName);
            }
            if(/^on[A-Z]/.test(propName)){
                $(document).undelegate(`.${this._reactid}`);
            }
        }
        for(propName in newProps){
            if(propName == 'children'){
</span>
<span class="token unchanged">            }else if(/^on[A-Z]/.test(propName)){
                let eventName = propName.slice(2).toLowerCase();
                $(document).undelegate(`.${this._reactid}`);
                $(document).delegate(`[data-reactid=&quot;${this._reactid}&quot;]`,`${eventName}.${this._reactid}`,newProps[propName]);
            }else if(propName === 'style'){
                let styleObj = newProps[propName];
                Object.entries(styleObj).forEach(([attr,value])=&gt;{
                  $(`[data-reactid=&quot;${this._reactid}&quot;]`).css(attr,value);
                })
            }else{
                $(`[data-reactid=&quot;${this._reactid}&quot;]`).prop(propName,newProps[propName]);
            }
        }
    }
</span>}

class CompositeUnit extends Unit{
<span class="token unchanged">    //接收到新的更新，自定义组件传第二个参数，原生组件和text传处一个参数
    update(nextElement,partialState){
        //如果传过来了新的元素，则使用新的元素
        this._currentElement = nextElement||this._currentElement;
        //获取新的状态对象和属性对象
        let nextState = this._componentInstance.state= Object.assign(this._componentInstance.state,partialState);
        let nextProps = this._currentElement.props;
        //如果shouldComponentUpdate返回了false则不需要继续更新
        if(this._componentInstance.shouldComponentUpdate&amp;&amp;this._componentInstance.shouldComponentUpdate(nextProps,nextState)===false){return;}
        //获得上次渲染出来的unit实例 
        let prevRenderedUnitInstance = this._renderedUnitInstance;
        //从unit实例中获取
        let prevRenderedElement = prevRenderedUnitInstance._currentElement;
        //获取新的虚拟DOM
        let nextRenderElement = this._componentInstance.render();
        //进行domdiff对比
        if(shouldDeepCompare(prevRenderedElement,nextRenderElement)){
            //如果需要更新，则继续调用子节点的upate方法进行更新,传入新的element更新子节点
            prevRenderedUnitInstance.update(nextRenderElement);
            this._componentInstance.componentDidUpdate&amp;&amp;this._componentInstance.componentDidUpdate();
        }else{
            //如果发现不需要对比，干脆重新渲染
            this._renderedUnitInstance =  createUnit(nextRenderElement);
            let nextMarkUp = this._renderedUnitInstance.getMarkUp(this._reactid);
            //替换整个节点
            $(`[data-reactid=&quot;${this._reactid}&quot;]`).replaceWith(nextMarkUp);
        }
</span>
<span class="token unchanged">    }
    getMarkUp(reactid){
        this._reactid = reactid;
        //type是一个自定义组件的类的定义
        let {type:Component,props} = this._currentElement;
        //创建Component类的实例
        let componentInstance = this._componentInstance = new Component(props);
        //组件实例关联上自己的unit实例
        componentInstance._currentUnit  = this;
        //组件将要渲染
        componentInstance.componentWillMount&amp;&amp;componentInstance.componentWillMount();
        //执行render方法获得虚拟DOM元素实例
        let renderedElement = componentInstance.render();
        //根据虚拟DOM元素得到unit,可能是TextUnit NativeUnit CompositeUnit
        let renderedUnitInstance = this._renderedUnitInstance= createUnit(renderedElement);
        //获得此unit的HTML标记字符串
        let renderedMarkUp = renderedUnitInstance.getMarkUp(reactid);
        //注册挂载完成的监听，越底层的组件越先监听，越先执行
        $(document).on('mounted',()=&gt;componentInstance.componentDidMount&amp;&amp;componentInstance.componentDidMount());
        return renderedMarkUp;
    }
</span>}

function shouldDeepCompare(prevElement,nextElement){
<span class="token unchanged">   if(prevElement!==null &amp;&amp; nextElement!=null){
       let prevType = typeof prevElement;
       let nextType = typeof nextElement;
       //如果新老节点都是文本可以进行比较
       if((prevType === 'string' ||prevType === 'number')&amp;&amp;(nextType === 'string' ||nextType === 'number')){
           return true;
       }
       if(prevElement instanceof Element &amp;&amp; nextElement instanceof Element){
           return prevElement.type === nextElement.type;
       }
   }  
   return false;
</span>}
function createUnit(element){
<span class="token unchanged">  if(typeof element =='string' || typeof element =='number'){
      return new TextUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'string'){
      return new NativeUnit(element);
  }
  if(element instanceof Element &amp;&amp; typeof element.type === 'function'){
      return new CompositeUnit(element);
  }
</span>}

export {
<span class="token unchanged">    createUnit
</span>}
</code></pre></div><h2 id="_10-diff-策略"><a href="#_10-diff-策略" class="header-anchor">#</a> 10. diff 策略</h2> <ul><li>Web UI 中 DOM 节点跨层级的移动操作特别少，可以忽略不计。</li> <li>拥有相同类的两个组件将会生成相似的树形结构，拥有不同类的两个组件将会生成不同的树形结构。</li> <li>对于同一层级的一组子节点，它们可以通过唯一<code>key</code>进行区分。</li></ul> <h3 id="_10-1-tree-diff"><a href="#_10-1-tree-diff" class="header-anchor">#</a> 10.1 tree diff</h3> <ul><li>React 对树的算法进行了简洁明了的优化，即对树进行分层比较，两棵树只会对同一层次的节点进行比较</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013924.png" alt="sametree"></p> <ul><li>当出现节点跨层级移动时，并不会出现想象中的移动操作，而是以 A 为根节点的树被整个重新创建</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013928.png" alt="movemytree"></p> <h3 id="_10-2-component-diff"><a href="#_10-2-component-diff" class="header-anchor">#</a> 10.2 component diff</h3> <ul><li>如果是同一类型的组件，按照原策略继续比较 <code>virtual DOM tree</code></li> <li>如果不是，则将该组件判断为<code>dirty component</code>,从而替换整个组件下的所有子节点</li></ul> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013932.png" alt="deleteall"></p> <h3 id="_10-3-element-diff"><a href="#_10-3-element-diff" class="header-anchor">#</a> 10.3 element diff</h3> <ul><li>当节点处于同一层级时，React diff 提供了三种节点操作,分别为：INSERT(插入)、MOVE(移动)和 REMOVE(删除)</li> <li>INSERT 新的 component 类型不在老集合里， 即是全新的节点，需要对新节点执行插入操作</li> <li>MOVE 在老集合有新 component 类型，就需要做移动操作，可以复用以前的 DOM 节点</li> <li>REMOVE 老 component 不在新集合里的，也需要执行删除操作</li></ul> <h3 id="_10-4-key"><a href="#_10-4-key" class="header-anchor">#</a> 10.4 key</h3> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013936.png" alt="oldnewmove"></p> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013941.png" alt="oldnewmove2"></p> <p><img src="https://wsk-mweb.oss-cn-hangzhou.aliyuncs.com/ipic/2020-04-23-013945.png" alt="oldnewmove3"></p> <h2 id="_11-delegate"><a href="#_11-delegate" class="header-anchor">#</a> 11.delegate</h2> <ul><li>delegate() 方法为指定的元素(属于被选元素的子元素)添加一个或多个事件处理程序，并规定当这些事件发生时运行的函数，使用 delegate() 方法的事件处理程序适用于当前或未来的元素(比如由脚本创建的新元素)</li></ul> <table><thead><tr><th style="text-align:left;">参数名称</th> <th style="text-align:left;">参数含义</th></tr></thead> <tbody><tr><td style="text-align:left;">childSelector</td> <td style="text-align:left;">必需,规定要附加事件处理程序的一个或多个子元素</td></tr> <tr><td style="text-align:left;">event</td> <td style="text-align:left;">必需,规定附加到元素的一个或多个事件,由空格分隔多个事件值。必须是有效的事件</td></tr> <tr><td style="text-align:left;">data</td> <td style="text-align:left;">可选,规定传递到函数的额外数据</td></tr> <tr><td style="text-align:left;">function</td> <td style="text-align:left;">必需,规定当事件发生时运行的函数</td></tr></tbody></table> <ul><li><a href="https://api.jquery.com/delegate/" target="_blank" rel="noopener noreferrer">delegate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://api.jquery.com/undelegate/" target="_blank" rel="noopener noreferrer">undelegate<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>参数<code>events</code>还支持为事件类型附加额外的命名空间</li> <li>当为同一元素绑定多个相同类型的事件处理函数时。使用命名空间，可以在触发事件、移除事件时限定触发或移除的范围。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> $document <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//为#btn1元素绑定click事件，定义在foo和bar两个命名空间下</span>
$document<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;#btn1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;click.foo.bar&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//为#btn1元素绑定click事件，定义在test命名空间下</span>
$document<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;#btn1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;click.test&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click-2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//为#btn1元素绑定click事件，定义在test和foo两个命名空间下</span>
$document<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span><span class="token string">&quot;#btn1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;click.test.foo&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;click-3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// 触发所有click事件</span>
$btn1<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发A和B (event.namespace = &quot;&quot;)</span>
<span class="token comment">// 触发定义在foo命名空间下的click事件</span>
$btn1<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click.foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发A (event.namespace = &quot;foo&quot;)</span>
<span class="token comment">// 触发定义在bar命名空间下的click事件</span>
$btn1<span class="token punctuation">.</span><span class="token function">trigger</span><span class="token punctuation">(</span><span class="token string">&quot;click.bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 触发A (event.namespace = &quot;bar&quot;)</span>
<span class="token comment">// 移除所有btn1元素定义在foo命名空间下的click事件处理函数</span>
$btn1<span class="token punctuation">.</span><span class="token function">undelegate</span><span class="token punctuation">(</span> <span class="token string">&quot;click.foo&quot;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 移除A</span>

<span class="token comment">// $document.undelegate(&quot;.test&quot;); // 移除click-2、click-3</span>

<span class="token comment">// $document.undelegate(&quot;.foo&quot;);  // 移除click-1、click-3</span>

<span class="token comment">// $document.undelegate(&quot;.foo.bar&quot;);  // 移除click-1</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">4/23/2020, 9:57:22 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/basic/06-react-immutable.html" class="prev">
        06. React Immutable
      </a></span> <span class="next"><a href="/react/fiber/01-fiber.html">
        01. Fiber
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2af561cb.js" defer></script><script src="/assets/js/2.b2a5c435.js" defer></script><script src="/assets/js/30.33cb1c11.js" defer></script>
  </body>
</html>
