<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redux Saga | 珠峰架构</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.1657c744.css" as="style"><link rel="preload" href="/assets/js/app.2af561cb.js" as="script"><link rel="preload" href="/assets/js/2.b2a5c435.js" as="script"><link rel="preload" href="/assets/js/51.37ba1a59.js" as="script"><link rel="prefetch" href="/assets/js/10.2b2c8443.js"><link rel="prefetch" href="/assets/js/11.689524dc.js"><link rel="prefetch" href="/assets/js/12.849e2da9.js"><link rel="prefetch" href="/assets/js/13.c798d95d.js"><link rel="prefetch" href="/assets/js/14.380c4ee7.js"><link rel="prefetch" href="/assets/js/15.d5753b2e.js"><link rel="prefetch" href="/assets/js/16.49eb1f17.js"><link rel="prefetch" href="/assets/js/17.5ecf2b4f.js"><link rel="prefetch" href="/assets/js/18.da9c8265.js"><link rel="prefetch" href="/assets/js/19.59d827ef.js"><link rel="prefetch" href="/assets/js/20.73eb42bb.js"><link rel="prefetch" href="/assets/js/21.8570b5b4.js"><link rel="prefetch" href="/assets/js/22.34094913.js"><link rel="prefetch" href="/assets/js/23.5209939b.js"><link rel="prefetch" href="/assets/js/24.53d92201.js"><link rel="prefetch" href="/assets/js/25.7241adf1.js"><link rel="prefetch" href="/assets/js/26.fecc2611.js"><link rel="prefetch" href="/assets/js/27.e50fca48.js"><link rel="prefetch" href="/assets/js/28.4c168acc.js"><link rel="prefetch" href="/assets/js/29.f5186710.js"><link rel="prefetch" href="/assets/js/3.ba1dcccd.js"><link rel="prefetch" href="/assets/js/30.33cb1c11.js"><link rel="prefetch" href="/assets/js/31.c088791d.js"><link rel="prefetch" href="/assets/js/32.3b724af5.js"><link rel="prefetch" href="/assets/js/33.f975c942.js"><link rel="prefetch" href="/assets/js/34.7d1f4bd2.js"><link rel="prefetch" href="/assets/js/35.26c11750.js"><link rel="prefetch" href="/assets/js/36.e8890e58.js"><link rel="prefetch" href="/assets/js/37.516eba46.js"><link rel="prefetch" href="/assets/js/38.4f8b8525.js"><link rel="prefetch" href="/assets/js/39.26f95568.js"><link rel="prefetch" href="/assets/js/4.fca74266.js"><link rel="prefetch" href="/assets/js/40.b9a8ffbb.js"><link rel="prefetch" href="/assets/js/41.fd02ea5f.js"><link rel="prefetch" href="/assets/js/42.d2483185.js"><link rel="prefetch" href="/assets/js/43.70bff2de.js"><link rel="prefetch" href="/assets/js/44.219702ca.js"><link rel="prefetch" href="/assets/js/45.aba93af9.js"><link rel="prefetch" href="/assets/js/46.447ba87c.js"><link rel="prefetch" href="/assets/js/47.519ddc28.js"><link rel="prefetch" href="/assets/js/48.fd8af347.js"><link rel="prefetch" href="/assets/js/49.b3783fa9.js"><link rel="prefetch" href="/assets/js/5.cc992e8b.js"><link rel="prefetch" href="/assets/js/50.0bb20f92.js"><link rel="prefetch" href="/assets/js/52.054af132.js"><link rel="prefetch" href="/assets/js/53.5aca78a0.js"><link rel="prefetch" href="/assets/js/54.78c43f89.js"><link rel="prefetch" href="/assets/js/55.8ecaadc1.js"><link rel="prefetch" href="/assets/js/56.e844f110.js"><link rel="prefetch" href="/assets/js/57.530db0e9.js"><link rel="prefetch" href="/assets/js/58.8c839289.js"><link rel="prefetch" href="/assets/js/59.6634b409.js"><link rel="prefetch" href="/assets/js/6.b8b36e50.js"><link rel="prefetch" href="/assets/js/60.7ebe5787.js"><link rel="prefetch" href="/assets/js/61.bfe89a8b.js"><link rel="prefetch" href="/assets/js/62.4cdf6e8c.js"><link rel="prefetch" href="/assets/js/63.a0e80f0d.js"><link rel="prefetch" href="/assets/js/64.62a1b782.js"><link rel="prefetch" href="/assets/js/65.7be0994b.js"><link rel="prefetch" href="/assets/js/66.5a592a8e.js"><link rel="prefetch" href="/assets/js/67.40b4291c.js"><link rel="prefetch" href="/assets/js/68.2ac34b58.js"><link rel="prefetch" href="/assets/js/69.728773d5.js"><link rel="prefetch" href="/assets/js/7.0414e914.js"><link rel="prefetch" href="/assets/js/70.30137f66.js"><link rel="prefetch" href="/assets/js/71.7735c9fc.js"><link rel="prefetch" href="/assets/js/72.e9f43339.js"><link rel="prefetch" href="/assets/js/73.2d754e71.js"><link rel="prefetch" href="/assets/js/74.bf70dd09.js"><link rel="prefetch" href="/assets/js/75.18c28356.js"><link rel="prefetch" href="/assets/js/76.a0626bc9.js"><link rel="prefetch" href="/assets/js/77.dfde57e0.js"><link rel="prefetch" href="/assets/js/78.b380a0d6.js"><link rel="prefetch" href="/assets/js/79.f7bafb5d.js"><link rel="prefetch" href="/assets/js/8.c3544379.js"><link rel="prefetch" href="/assets/js/80.ade6c33e.js"><link rel="prefetch" href="/assets/js/81.6335ba85.js"><link rel="prefetch" href="/assets/js/82.9d01c14e.js"><link rel="prefetch" href="/assets/js/83.47911fdd.js"><link rel="prefetch" href="/assets/js/9.844fca3b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1657c744.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">珠峰架构</span></a> <div class="links"><!----> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/react/" class="sidebar-heading clickable router-link-active open"><span>react</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/basic/" class="sidebar-heading clickable"><span>基础</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/fiber/" class="sidebar-heading clickable"><span>Fiber</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/router/" class="sidebar-heading clickable"><span>react router</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/redux/" class="sidebar-heading clickable router-link-active open"><span>redux</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/react/redux/手写Redux.html" class="sidebar-link">手写Redux</a></li><li><a href="/react/redux/Redux中间件.html" class="sidebar-link">Redux中间件</a></li><li><a href="/react/redux/Redux-hooks.html" class="sidebar-link">Redux-hooks</a></li><li><a href="/react/redux/Redux-saga.html" class="active sidebar-link">Redux Saga</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_1-redux-saga" class="sidebar-link">1. redux-saga</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_2-redux-saga工作原理" class="sidebar-link">2. redux-saga工作原理</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_3-redux-saga分类" class="sidebar-link">3. redux-saga分类</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_4-构建项目" class="sidebar-link">4. 构建项目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_4-1-初始化项目" class="sidebar-link">4.1 初始化项目</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_5-跑通saga" class="sidebar-link">5. 跑通saga</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_5-1-src-index-js" class="sidebar-link">5.1 src\index.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_5-2-store-index-js" class="sidebar-link">5.2 store\index.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_5-3-store-reducer-js" class="sidebar-link">5.3 store\reducer.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_5-4-store-sagas-js" class="sidebar-link">5.4 store\sagas.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-异步计数器" class="sidebar-link">6. 异步计数器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-1-components-counter-js" class="sidebar-link">6.1 components/Counter.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-2-src-index-js" class="sidebar-link">6.2 src/index.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-3-store-action-types-js" class="sidebar-link">6.3 store/action-types.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-4-store-actions-js" class="sidebar-link">6.4 store/actions.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-5-src-store-index-js" class="sidebar-link">6.5 src/store/index.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-6-store-reducer-js" class="sidebar-link">6.6 store/reducer.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_6-7-store-sagas-js" class="sidebar-link">6.7 store/sagas.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_7-单元测试" class="sidebar-link">7. 单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_7-1-安装模块" class="sidebar-link">7.1 安装模块</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_7-2-测试脚本" class="sidebar-link">7.2 测试脚本</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_7-3-utils-js" class="sidebar-link">7.3 utils.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_7-4-store-sagas-spec-js" class="sidebar-link">7.4 store\sagas.spec.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_8-声明式effects" class="sidebar-link">8. 声明式effects</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_8-1-src-store-sagas-js" class="sidebar-link">8.1 src/store/sagas.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_8-2-store-sagas-spec-js" class="sidebar-link">8.2 store/sagas.spec.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_8-3-src-utils-js" class="sidebar-link">8.3 src/utils.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_9-错误处理" class="sidebar-link">9. 错误处理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_9-1-try-catch" class="sidebar-link">9.1 try catch</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_9-2-错误标识" class="sidebar-link">9.2 错误标识</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_10-take" class="sidebar-link">10. take</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_10-1-store-sagas-js" class="sidebar-link">10.1 store/sagas.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-登陆流程" class="sidebar-link">11. 登陆流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-1-src-index-js" class="sidebar-link">11.1 src/index.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-2-store-action-types-js" class="sidebar-link">11.2 store/action-types.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-3-store-actions-js" class="sidebar-link">11.3 store/actions.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-4-store-reducer-js" class="sidebar-link">11.4 store/reducer.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-5-store-sagas-js" class="sidebar-link">11.5 store/sagas.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-6-src-api-js" class="sidebar-link">11.6 src/Api.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_11-7-components-login-js" class="sidebar-link">11.7 components/Login.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_12-fork" class="sidebar-link">12. fork</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_12-1-store-sagas-js" class="sidebar-link">12.1 store/sagas.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_13-取消任务" class="sidebar-link">13. 取消任务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_13-1-components-login-js" class="sidebar-link">13.1 components/Login.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_13-2-store-sagas-js" class="sidebar-link">13.2 store/sagas.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_14-race" class="sidebar-link">14. race</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_14-1-src-index-js" class="sidebar-link">14.1 src/index.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_14-2-store-action-types-js" class="sidebar-link">14.2 store/action-types.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_14-3-store-actions-js" class="sidebar-link">14.3 store/actions.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_14-4-store-sagas-js" class="sidebar-link">14.4 store/sagas.js</a></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#_14-5-components-counter-js" class="sidebar-link">14.5 components/Counter.js</a></li></ul></li><li class="sidebar-sub-header"><a href="/react/redux/Redux-saga.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/react/redux/Redux-saga-hand.html" class="sidebar-link">Redux saga hand</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/ssr/" class="sidebar-heading clickable"><span>SSR</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/nextjs/" class="sidebar-heading clickable"><span>nextjs</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/dva/" class="sidebar-heading clickable"><span>dva</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/umi/" class="sidebar-heading clickable"><span>umi</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/component/" class="sidebar-heading clickable"><span>组件</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/react/interview/" class="sidebar-heading clickable"><span>面试</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/vue/" class="sidebar-heading clickable"><span>vue</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/webpack/" class="sidebar-heading clickable"><span>webpack</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/flutter/" class="sidebar-heading clickable"><span>flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/interview/" class="sidebar-heading clickable"><span>interview</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/other/" class="sidebar-heading clickable"><span>other</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redux-saga"><a href="#redux-saga" class="header-anchor">#</a> Redux Saga</h1> <h2 id="_1-redux-saga"><a href="#_1-redux-saga" class="header-anchor">#</a> 1. redux-saga</h2> <ul><li><a href="https://redux-saga-in-chinese.js.org/" target="_blank" rel="noopener noreferrer">redux-saga<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个 redux 的中间件，而中间件的作用是为 redux 提供额外的功能。</li> <li>在 reducers 中的所有操作都是同步的并且是纯粹的，即 reducer 都是纯函数，纯函数是指一个函数的返回结果只依赖于它的参数，并且在执行过程中不会对外部产生副作用，即给它传什么，就吐出什么。</li> <li>但是在实际的应用开发中，我们希望做一些异步的（如Ajax请求）且不纯粹的操作（如改变外部的状态），这些在函数式编程范式中被称为“副作用”。</li></ul> <blockquote><p>redux-saga 就是用来处理上述副作用（异步任务）的一个中间件。它是一个接收事件，并可能触发新事件的过程管理者，为你的应用管理复杂的流程。</p></blockquote> <h2 id="_2-redux-saga工作原理"><a href="#_2-redux-saga工作原理" class="header-anchor">#</a> 2. redux-saga工作原理</h2> <ul><li>sages 采用 Generator 函数来 yield Effects（包含指令的文本对象）</li> <li>Generator 函数的作用是可以暂停执行，再次执行的时候从上次暂停的地方继续执行</li> <li>Effect 是一个简单的对象，该对象包含了一些给 middleware 解释执行的信息。</li> <li>你可以通过使用 effects API 如 fork，call，take，put，cancel 等来创建 Effect。</li></ul> <h2 id="_3-redux-saga分类"><a href="#_3-redux-saga分类" class="header-anchor">#</a> 3. redux-saga分类</h2> <ul><li>worker saga 做实际的工作，如调用API，进行异步请求，获取异步封装结果</li> <li>watcher saga 监听被dispatch的actions,当接受到action或者知道其被触发时，调用worker执行任务</li> <li>root saga 立即启动saga的唯一入口</li></ul> <h2 id="_4-构建项目"><a href="#_4-构建项目" class="header-anchor">#</a> 4. 构建项目</h2> <h3 id="_4-1-初始化项目"><a href="#_4-1-初始化项目" class="header-anchor">#</a> 4.1 初始化项目</h3> <div class="language-js extra-class"><pre class="language-js"><code>cnpm install create<span class="token operator">-</span>react<span class="token operator">-</span>app <span class="token operator">-</span>g 
create<span class="token operator">-</span>react<span class="token operator">-</span>app zhufeng<span class="token operator">-</span>saga<span class="token operator">-</span>start
cd zhufeng<span class="token operator">-</span>saga<span class="token operator">-</span>start
cnpm i redux react<span class="token operator">-</span>redux redux<span class="token operator">-</span>saga tape <span class="token operator">--</span>save
</code></pre></div><h2 id="_5-跑通saga"><a href="#_5-跑通saga" class="header-anchor">#</a> 5. 跑通saga</h2> <h3 id="_5-1-src-index-js"><a href="#_5-1-src-index-js" class="header-anchor">#</a> 5.1 src\index.js</h3> <p>src\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-2-store-index-js"><a href="#_5-2-store-index-js" class="header-anchor">#</a> 5.2 store\index.js</h3> <p>src\store\index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">'redux-saga'</span><span class="token punctuation">;</span>
<span class="token comment">//首先我们引入 ./sagas 模块中的 Saga。然后使用 redux-saga 模块的 createSagaMiddleware 工厂函数来创建一个 Saga middleware</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>helloSaga<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./sagas'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//运行 helloSaga 之前，我们必须使用 applyMiddleware 将 middleware 连接至 Store。然后使用 sagaMiddleware.run(helloSaga) 运行 Saga。</span>
<span class="token keyword">let</span> store<span class="token operator">=</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>helloSaga<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> store<span class="token punctuation">;</span>
</code></pre></div><h3 id="_5-3-store-reducer-js"><a href="#_5-3-store-reducer-js" class="header-anchor">#</a> 5.3 store\reducer.js</h3> <p>src\store\reducer.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-4-store-sagas-js"><a href="#_5-4-store-sagas-js" class="header-anchor">#</a> 5.4 store\sagas.js</h3> <p>src\store\sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//helloSaga它只是打印了一条消息，然后退出。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">helloSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello Saga!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-异步计数器"><a href="#_6-异步计数器" class="header-anchor">#</a> 6. 异步计数器</h2> <h3 id="_6-1-components-counter-js"><a href="#_6-1-components-counter-js" class="header-anchor">#</a> 6.1 components/Counter.js</h3> <p>src/components/Counter.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> actions <span class="token keyword">from</span> <span class="token string">'../store/actions'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>incrementAsync<span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">,</span>
    actions
<span class="token punctuation">)</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-2-src-index-js"><a href="#_6-2-src-index-js" class="header-anchor">#</a> 6.2 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Counter <span class="token keyword">from</span> <span class="token string">'./components/Counter'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Counter<span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-3-store-action-types-js"><a href="#_6-3-store-action-types-js" class="header-anchor">#</a> 6.3 store/action-types.js</h3> <p>src/store/action-types.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INCREMENT</span><span class="token operator">=</span><span class="token string">'INCREMENT'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INCREMENT_ASYNC</span><span class="token operator">=</span><span class="token string">'INCREMENT_ASYNC'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-4-store-actions-js"><a href="#_6-4-store-actions-js" class="header-anchor">#</a> 6.4 store/actions.js</h3> <p>src/store/actions.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">incrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT_ASYNC</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-5-src-store-index-js"><a href="#_6-5-src-store-index-js" class="header-anchor">#</a> 6.5 src/store/index.js</h3> <p>src/store/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">,</span> applyMiddleware<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> reducer <span class="token keyword">from</span> <span class="token string">'./reducer'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> createSagaMiddleware <span class="token keyword">from</span> <span class="token string">'redux-saga'</span><span class="token punctuation">;</span>
<span class="token comment">//首先我们引入 ./sagas 模块中的 Saga。然后使用 redux-saga 模块的 createSagaMiddleware 工厂函数来创建一个 Saga middleware</span>
<span class="token keyword">import</span> rootSaga <span class="token keyword">from</span> <span class="token string">'./sagas'</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sagaMiddleware <span class="token operator">=</span> <span class="token function">createSagaMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//运行 rootSaga 之前，我们必须使用 applyMiddleware 将 middleware 连接至 Store。然后使用 sagaMiddleware.run(helloSaga) 运行 Saga。</span>
<span class="token keyword">let</span> store<span class="token operator">=</span><span class="token function">applyMiddleware</span><span class="token punctuation">(</span>sagaMiddleware<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
sagaMiddleware<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>rootSaga<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> store<span class="token punctuation">;</span>
</code></pre></div><h3 id="_6-6-store-reducer-js"><a href="#_6-6-store-reducer-js" class="header-anchor">#</a> 6.6 store/reducer.js</h3> <p>src/store/reducer.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span><span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>number<span class="token operator">:</span> state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-7-store-sagas-js"><a href="#_6-7-store-sagas-js" class="header-anchor">#</a> 6.7 store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> delay<span class="token punctuation">,</span>all<span class="token punctuation">,</span>put<span class="token punctuation">,</span> takeEvery <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>

<span class="token comment">//worker Saga: 将执行异步的 increment 任务</span>
<span class="token comment">//incrementAsync Saga 通过 delay(1000) 延迟了 1 秒钟，然后 dispatch 一个叫 INCREMENT 的 action。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">incrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//工具函数 delay，这个函数返回一个延迟 1 秒再 resolve 的 Promise 我们将使用这个函数去 block(阻塞) Generator</span>
    <span class="token comment">//Sagas 被实现为 Generator functions，它会 yield 对象到 redux-saga middleware。 被 yield 的对象都是一类指令，指令可被 middleware 解释执行。当 middleware 取得一个 yield 后的 Promise，middleware 会暂停 Saga，直到 Promise 完成</span>
    <span class="token comment">//incrementAsync 这个 Saga 会暂停直到 delay 返回的 Promise 被 resolve，这个 Promise 将在 1 秒后 resolve</span>
    <span class="token comment">//当 middleware 拿到一个被 Saga yield 的 Effect，它会暂停 Saga，直到 Effect 执行完成，然后 Saga 会再次被恢复</span>
    <span class="token keyword">yield</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token comment">//一旦 Promise 被 resolve，middleware 会恢复 Saga 接着执行，直到遇到下一个 yield</span>
    <span class="token comment">//在这里下一个语句是另一个被 yield 的对象：调用 put({type: 'INCREMENT'}) 的结果，意思是告诉 middleware 发起一个 INCREMENT 的 action</span>
    <span class="token comment">//put 就是我们称作 Effect 的一个例子。Effects 是一些简单 Javascript 对象，包含了要被 middleware 执行的指令</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'INCREMENT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//takeEvery，用于监听所有的 INCREMENT_ASYNC action，并在 action 被匹配时执行 incrementAsync 任务</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">watchIncrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">takeEvery</span><span class="token punctuation">(</span><span class="token string">'INCREMENT_ASYNC'</span><span class="token punctuation">,</span> incrementAsync<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">helloSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Hello Saga!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//这个 Saga yield 了一个数组，值是调用 helloSaga 和 watchIncrementAsync 两个 Saga 的结果。意思是说这两个 Generators 将会同时启动</span>
    <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token function">helloSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">watchIncrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_7-单元测试"><a href="#_7-单元测试" class="header-anchor">#</a> 7. 单元测试</h2> <ul><li><a href="https://babeljs.io/docs/en/next/babel-node.html" target="_blank" rel="noopener noreferrer">babel-node<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：提供一个支持ES6的REPL环境，支持Node的REPL环境的所有功能，可以直接运行ES6代码</li></ul> <h3 id="_7-1-安装模块"><a href="#_7-1-安装模块" class="header-anchor">#</a> 7.1 安装模块</h3> <div class="language-js extra-class"><pre class="language-js"><code>cnpm i @babel<span class="token operator">/</span>core @babel<span class="token operator">/</span>node @babel<span class="token operator">/</span>plugin<span class="token operator">-</span>transform<span class="token operator">-</span>modules<span class="token operator">-</span>commonjs <span class="token operator">--</span>save<span class="token operator">-</span>dev
</code></pre></div><h3 id="_7-2-测试脚本"><a href="#_7-2-测试脚本" class="header-anchor">#</a> 7.2 测试脚本</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;babel-node src/store/sagas.spec.js --plugins @babel/plugin-transform-modules-commonjs&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-3-utils-js"><a href="#_7-3-utils-js" class="header-anchor">#</a> 7.3 utils.js</h3> <p>src\utils.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span>   <span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_7-4-store-sagas-spec-js"><a href="#_7-4-store-sagas-spec-js" class="header-anchor">#</a> 7.4 store\sagas.spec.js</h3> <p>src\store\sagas.spec.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> test <span class="token keyword">from</span> <span class="token string">'tape'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> all<span class="token punctuation">,</span>put<span class="token punctuation">,</span> takeEvery<span class="token punctuation">,</span>call <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> incrementAsync <span class="token punctuation">}</span>  <span class="token keyword">from</span> <span class="token string">'./sagas'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>delay<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * incrementAsync 是一个 Generator 函数。执行的时候返回一个 iterator object，这个 iterator 的 next 方法返回一个对象
 * gen.next() // =&gt; { done: boolean, value: any }
 * value 字段包含被 yield 后的表达式，也就是 yield 后面那个表达式的结果。
 * done 字段指示 generator 是结束了，还是有更多的 yield 表达式
 */</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'incrementAsync Saga test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">assert</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">incrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span>
    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'incrementAsync should return a Promise that will resolve after 3 second'</span>
  <span class="token punctuation">)</span> 

   assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span>
    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'INCREMENT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'incrementAsync Saga must dispatch an INCREMENT action'</span>
  <span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span>
    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>done<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>value<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'incrementAsync Saga must be done'</span>
  <span class="token punctuation">)</span>

  assert<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-声明式effects"><a href="#_8-声明式effects" class="header-anchor">#</a> 8. 声明式effects</h2> <ul><li>在 redux-saga 的世界里，Sagas 都用 Generator 函数实现。我们从 Generator 里 yield 纯 JavaScript 对象以表达 Saga 逻辑</li> <li>我们称呼那些对象为 Effect。Effect 是一个简单的对象，这个对象包含了一些给 middleware 解释执行的信息</li> <li>你可以把 Effect 看作是发送给 middleware 的指令以执行某些操作（调用某些异步函数，发起一个 action 到 store，等等）</li> <li><code>cps(fn, ...args)</code> 创建一个 Effect 描述信息，用来命令 middleware 以 Node 风格的函数（Node style function）的方式调用 fn</li> <li><code>call(fn, ...args)</code> 创建一个 Effect 描述信息，用来命令 middleware 以参数 args 调用函数 fn</li> <li><code>call([context, fn], ...args)</code> 类似 call(fn, ...args)，但支持传递 this 上下文给 fn,在调用对象方法时很有用</li> <li><code>apply(context, fn, [args])</code> call([context, fn], ...args) 的另一种写法</li></ul> <h3 id="_8-1-src-store-sagas-js"><a href="#_8-1-src-store-sagas-js" class="header-anchor">#</a> 8.1 src/store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>all<span class="token punctuation">,</span>put<span class="token punctuation">,</span> takeEvery<span class="token punctuation">,</span>call<span class="token punctuation">,</span>takeLatest<span class="token punctuation">,</span>cps<span class="token punctuation">,</span>apply <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>delay<span class="token punctuation">,</span>read<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">readAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">cps</span><span class="token punctuation">(</span>read<span class="token punctuation">,</span><span class="token string">'1.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//cps(fn, ...args)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'content='</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">incrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//工具函数 delay，这个函数返回一个延迟 1 秒再 resolve 的 Promise 我们将使用这个函数去 block(阻塞) Generator</span>
    <span class="token comment">//Sagas 被实现为 Generator functions，它会 yield 对象到 redux-saga middleware。 被 yield 的对象都是一类指令，指令可被 middleware 解释执行。当 middleware 取得一个 yield 后的 Promise，middleware 会暂停 Saga，直到 Promise 完成</span>
    <span class="token comment">//incrementAsync 这个 Saga 会暂停直到 delay 返回的 Promise 被 resolve，这个 Promise 将在 1 秒后 resolve</span>
    <span class="token comment">//put 还是 call 都不执行任何 dispatch 或异步调用，它们只是简单地返回 plain Javascript 对象</span>
    <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//call(fn, ...args)</span>
    <span class="token comment">//yield call([null,delay],3000);  call([context, fn], ...args)</span>
    <span class="token comment">//yield apply(null,delay,3000); apply(context, fn, args)</span>
    <span class="token comment">//yield delay(3000);</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'INCREMENT'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-2-store-sagas-spec-js"><a href="#_8-2-store-sagas-spec-js" class="header-anchor">#</a> 8.2 store/sagas.spec.js</h3> <p>src/store/sagas.spec.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> test <span class="token keyword">from</span> <span class="token string">'tape'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> all<span class="token punctuation">,</span>put<span class="token punctuation">,</span> takeEvery<span class="token punctuation">,</span>call<span class="token punctuation">,</span>cps<span class="token punctuation">,</span>apply <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> incrementAsync<span class="token punctuation">,</span>readAsync <span class="token punctuation">}</span>  <span class="token keyword">from</span> <span class="token string">'./sagas'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>delay<span class="token punctuation">,</span>read<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils'</span><span class="token punctuation">;</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'readAsync Saga test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">assert</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> gen <span class="token operator">=</span> <span class="token function">readAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span>
    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">,</span>
    <span class="token function">cps</span><span class="token punctuation">(</span>read<span class="token punctuation">,</span><span class="token string">'1.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'readAsync should be done  after 3 second'</span>
  <span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">deepEqual</span><span class="token punctuation">(</span>
    gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>done<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>value<span class="token operator">:</span><span class="token keyword">undefined</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'readAsync Saga must be done'</span>
  <span class="token punctuation">)</span>
  assert<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-3-src-utils-js"><a href="#_8-3-src-utils-js" class="header-anchor">#</a> 8.3 src/utils.js</h3> <p>src/utils.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'read'</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre></div><h2 id="_9-错误处理"><a href="#_9-错误处理" class="header-anchor">#</a> 9. 错误处理</h2> <h3 id="_9-1-try-catch"><a href="#_9-1-try-catch" class="header-anchor">#</a> 9.1 try catch</h3> <ul><li>我们可以使用熟悉的 try/catch 语法在 Saga 中捕获错误</li></ul> <p>src\store\sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">delay2</span><span class="token operator">=</span><span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">incrementAsync2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span><span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>delay2<span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span><span class="token string">'INCREMENT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'操作成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'操作失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//takeEvery，用于监听所有的 INCREMENT_ASYNC action，并在 action 被匹配时执行 incrementAsync 任务</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">watchIncrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//yield takeEvery('INCREMENT_ASYNC', incrementAsync);</span>
    <span class="token comment">//只想得到最新那个请求的响应,如果已经有一个任务在执行的时候启动另一个 fetchData ，那之前的这个任务会被自动取消</span>
    <span class="token keyword">yield</span> <span class="token function">takeLatest</span><span class="token punctuation">(</span><span class="token string">'INCREMENT_ASYNC'</span><span class="token punctuation">,</span> incrementAsync2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_9-2-错误标识"><a href="#_9-2-错误标识" class="header-anchor">#</a> 9.2 错误标识</h3> <ul><li><p>你也可以让你的 API 服务返回一个正常的含有错误标识的值 src\store\sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">delay3</span><span class="token operator">=</span><span class="token parameter">ms</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          code<span class="token operator">:</span>data<span class="token operator">&gt;</span><span class="token number">.5</span><span class="token operator">?</span><span class="token number">0</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">,</span>
          data
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">incrementAsync3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span>data<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>delay3<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span><span class="token string">'INCREMENT'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'操作成功 data='</span><span class="token operator">+</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'操作失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//takeEvery，用于监听所有的 INCREMENT_ASYNC action，并在 action 被匹配时执行 incrementAsync 任务</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">watchIncrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//yield takeEvery('INCREMENT_ASYNC', incrementAsync);</span>
  <span class="token comment">//只想得到最新那个请求的响应,如果已经有一个任务在执行的时候启动另一个 fetchData ，那之前的这个任务会被自动取消</span>
  <span class="token keyword">yield</span> <span class="token function">takeLatest</span><span class="token punctuation">(</span><span class="token string">'INCREMENT_ASYNC'</span><span class="token punctuation">,</span> incrementAsync3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="_10-take"><a href="#_10-take" class="header-anchor">#</a> 10. take</h2> <ul><li>takeEvery 只是一个在强大的低阶 API 之上构建的 <code>wrapper effect</code></li> <li>take 就像我们更早之前看到的 call 和 put。它创建另一个命令对象，告诉 middleware 等待一个特定的 action</li></ul> <h3 id="_10-1-store-sagas-js"><a href="#_10-1-store-sagas-js" class="header-anchor">#</a> 10.1 store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>all<span class="token punctuation">,</span>put<span class="token punctuation">,</span>take<span class="token punctuation">,</span>select <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">INCREMENT_ASYNC</span><span class="token punctuation">,</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">watchIncrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">INCREMENT_ASYNC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'最多只能点三次!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">watchAndLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//take 就像我们更早之前看到的 call 和 put。它创建另一个命令对象，告诉 middleware 等待一个特定的 action</span>
    <span class="token comment">//在 take 的情况中，它将会暂停 Generator 直到一个匹配的 action 被发起了</span>
    <span class="token comment">//在 takeEvery 的情况中，被调用的任务无法控制何时被调用， 它们将在每次 action 被匹配时一遍又一遍地被调用。并且它们也无法控制何时停止监听</span>
    <span class="token comment">//在 take 的情况中，控制恰恰相反。与 action 被 推向（pushed） 任务处理函数不同，Saga 是自己主动 拉取（pulling） action 的。 看起来就像是 Saga 在执行一个普通的函数调用 action = getNextAction()，这个函数将在 action 被发起时 resolve</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">let</span> action <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'action'</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'state after'</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">watchAndLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">watchIncrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="_11-登陆流程"><a href="#_11-登陆流程" class="header-anchor">#</a> 11. 登陆流程</h2> <h3 id="_11-1-src-index-js"><a href="#_11-1-src-index-js" class="header-anchor">#</a> 11.1 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Login <span class="token keyword">from</span> <span class="token string">'./components/Login'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Login<span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_11-2-store-action-types-js"><a href="#_11-2-store-action-types-js" class="header-anchor">#</a> 11.2 store/action-types.js</h3> <p>src/store/action-types.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INCREMENT</span><span class="token operator">=</span><span class="token string">'INCREMENT'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">INCREMENT_ASYNC</span><span class="token operator">=</span><span class="token string">'INCREMENT_ASYNC'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LOGIN_REQUEST</span><span class="token operator">=</span><span class="token string">'LOGIN_REQUEST'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LOGIN_SUCCESS</span><span class="token operator">=</span><span class="token string">'LOGIN_SUCCESS'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">SET_USERNAME</span><span class="token operator">=</span><span class="token string">'SET_USERNAME'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LOGIN_ERROR</span><span class="token operator">=</span><span class="token string">'LOGIN_ERROR'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">LOGOUT</span><span class="token operator">=</span><span class="token string">'LOGOUT'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_11-3-store-actions-js"><a href="#_11-3-store-actions-js" class="header-anchor">#</a> 11.3 store/actions.js</h3> <p>src/store/actions.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">incrementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">INCREMENT_ASYNC</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span>password</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">,</span>username<span class="token punctuation">,</span>password<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">LOGOUT</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_11-4-store-reducer-js"><a href="#_11-4-store-reducer-js" class="header-anchor">#</a> 11.4 store/reducer.js</h3> <p>src/store/reducer.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> types <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token operator">=</span><span class="token punctuation">{</span>number<span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span>username<span class="token operator">:</span><span class="token keyword">null</span><span class="token punctuation">}</span><span class="token punctuation">,</span>action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">INCREMENT</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>number<span class="token operator">:</span> state<span class="token punctuation">.</span>number<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">LOGIN_ERROR</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>error<span class="token operator">:</span> action<span class="token punctuation">.</span>error<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> types<span class="token punctuation">.</span><span class="token constant">SET_USERNAME</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>username<span class="token operator">:</span> action<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_11-5-store-sagas-js"><a href="#_11-5-store-sagas-js" class="header-anchor">#</a> 11.5 store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> call<span class="token punctuation">,</span> all<span class="token punctuation">,</span> put<span class="token punctuation">,</span> take <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;redux-saga/effects&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">LOGIN_ERROR</span><span class="token punctuation">,</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">,</span><span class="token constant">SET_USERNAME</span><span class="token punctuation">,</span><span class="token constant">LOGOUT</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./action-types&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Api <span class="token keyword">from</span> <span class="token string">&quot;../Api&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//首先我们创建了一个独立的 Generator login，它将执行真实的 API 调用并在成功后通知 Store。</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">//如果 Api 调用成功了，login 将发起一个 LOGIN_SUCCESS action 然后返回获取到的 token。 如果调用导致了错误，将会发起一个 LOGIN_ERROR action。</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>Api<span class="token punctuation">.</span>login<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> token<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在 login 失败的情况下，它将返回一个 undefined 值，这将导致 loginFlow 跳过当前处理进程并等待一个新的 LOGIN_REQUEST action</span>
    <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token constant">LOGIN_ERROR</span><span class="token punctuation">,</span>
      error
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">loginFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//一旦到达流程最后一步（LOGOUT），通过等待一个新的 LOGIN_REQUEST action 来启动一个新的迭代</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//loginFlow 首先等待一个 LOGIN_REQUEST action,然后调用一个 call 到 login 任务</span>
    <span class="token comment">//call 不仅可以用来调用返回 Promise 的函数。我们也可以用它来调用其他 Generator 函数</span>
    <span class="token comment">//loginFlow 将等待 login 直到它终止或返回（即执行 api 调用后，发起 action 然后返回 token 至 loginFlow）</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>login<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//在 login 失败的情况下，它将返回一个 undefined 值，这将导致 loginFlow 跳过当前处理进程并等待一个新的 LOGIN_REQUEST action</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token constant">SET_USERNAME</span><span class="token punctuation">,</span>
        username
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//如果调用 login 成功，loginFlow 将在 DOM storage 中存储返回的 token，并等待 LOGOUT action</span>
      Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//当用户登出，我们删除存储的 token 并等待一个新的用户登录</span>
      <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">LOGOUT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Api<span class="token punctuation">.</span><span class="token function">clearItem</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token constant">SET_USERNAME</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token keyword">null</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">loginFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_11-6-src-api-js"><a href="#_11-6-src-api-js" class="header-anchor">#</a> 11.6 src/Api.js</h3> <p>src/Api.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">.5</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span>username<span class="token operator">+</span><span class="token string">'-'</span><span class="token operator">+</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'登录失败'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span>value</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">clearItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_11-7-components-login-js"><a href="#_11-7-components-login-js" class="header-anchor">#</a> 11.7 components/Login.js</h3> <p>src/components/Login.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> actions <span class="token keyword">from</span> <span class="token string">'../store/actions'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Login</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token operator">=</span>React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token operator">=</span>React<span class="token punctuation">.</span><span class="token function">createRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> username <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">let</span> password <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">.</span>current<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function-variable function">logout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">{</span>username<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
        <span class="token keyword">let</span> loginForm <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>form<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>用户名<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span><span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>label<span class="token operator">&gt;</span>密码<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span><span class="token operator">&lt;</span>input ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">}</span><span class="token operator">/</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>login<span class="token punctuation">}</span><span class="token operator">&gt;</span>登录<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">let</span> logoutForm <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>form <span class="token operator">&gt;</span>
                 用户名<span class="token operator">:</span><span class="token punctuation">{</span>username<span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">/</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>logout<span class="token punctuation">}</span><span class="token operator">&gt;</span>退出<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            username<span class="token operator">?</span>logoutForm<span class="token operator">:</span>loginForm
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">,</span>
    actions
<span class="token punctuation">)</span><span class="token punctuation">(</span>Login<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_12-fork"><a href="#_12-fork" class="header-anchor">#</a> 12. fork</h2> <ul><li>当 loginFlow 在 login 中被阻塞了，最终发生在开始调用和收到响应之间的 <code>LOGOUT</code> 将会被错过</li> <li>我们需要的是一些非阻塞调用login</li> <li>为了表示无阻塞调用，redux-saga 提供了另一个 Effect：<code>fork</code>,当我们 fork 一个 任务，任务会在后台启动，调用者也可以继续它自己的流程，而不用等待被 fork 的任务结束</li></ul> <h3 id="_12-1-store-sagas-js"><a href="#_12-1-store-sagas-js" class="header-anchor">#</a> 12.1 store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>call<span class="token punctuation">,</span>all<span class="token punctuation">,</span>put<span class="token punctuation">,</span>take<span class="token punctuation">,</span>fork<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">LOGIN_ERROR</span><span class="token punctuation">,</span><span class="token constant">LOGOUT</span><span class="token punctuation">,</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">,</span><span class="token constant">LOGIN_SUCCESS</span><span class="token punctuation">,</span><span class="token constant">SET_USERNAME</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Api <span class="token keyword">from</span> <span class="token string">'../Api'</span>
<span class="token comment">//首先我们创建了一个独立的 Generator login，它将执行真实的 API 调用并在成功后通知 Store。</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果 Api 调用成功了，login 将发起一个 LOGIN_SUCCESS action 然后返回获取到的 token。 如果调用导致了错误，将会发起一个 LOGIN_ERROR action。</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>Api<span class="token punctuation">.</span>login<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">LOGIN_SUCCESS</span><span class="token punctuation">,</span> token<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">SET_USERNAME</span><span class="token punctuation">,</span> username<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果调用 login 成功，loginFlow 将在 DOM storage 中存储返回的 token，并等待 LOGOUT action   </span>
        Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//在 login 失败的情况下，它将返回一个 undefined 值，这将导致 loginFlow 跳过当前处理进程并等待一个新的 LOGIN_REQUEST action</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">LOGIN_ERROR</span><span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">loginFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//一旦到达流程最后一步（LOGOUT），通过等待一个新的 LOGIN_REQUEST action 来启动一个新的迭代</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//loginFlow 首先等待一个 LOGIN_REQUEST action,然后调用一个 call 到 login 任务</span>
        <span class="token comment">//call 不仅可以用来调用返回 Promise 的函数。我们也可以用它来调用其他 Generator 函数</span>
        <span class="token comment">//loginFlow 将等待 login 直到它终止或返回（即执行 api 调用后，发起 action 然后返回 token 至 loginFlow）</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//自从 login 的 action 在后台启动之后，我们获取不到 token 的结果,所以我们需要将 token 存储操作移到 login 任务内部</span>
        <span class="token keyword">yield</span> <span class="token function">fork</span><span class="token punctuation">(</span>login<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//yield take(['LOGOUT', 'LOGIN_ERROR'])。意思是监听 2 个并发的 action</span>
        <span class="token comment">//如果 login 任务在用户登出之前成功了，它将会发起一个 LOGIN_SUCCESS action 然后结束。 然后 loginFlow Saga 只会等待一个未来的 LOGOUT action 被发起</span>
        <span class="token comment">//如果 login 在用户登出之前失败了，它将会发起一个 LOGIN_ERROR action 然后结束</span>
        <span class="token comment">//如果在 login 结束之前，用户就登出了，那么 loginFlow 将收到一个 LOGOUT action 并且也会等待下一个 LOGIN_REQUEST</span>
        <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">LOGOUT</span><span class="token punctuation">,</span><span class="token constant">LOGIN_ERROR</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Api<span class="token punctuation">.</span><span class="token function">clearItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">loginFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_13-取消任务"><a href="#_13-取消任务" class="header-anchor">#</a> 13. 取消任务</h2> <ul><li>如果我们在 API 调用期间收到一个 LOGOUT action，我们必须要 取消 login 处理进程,否则将有 2 个并发的任务， 并且 login 任务将会继续运行，并在成功的响应（或失败的响应）返回后发起一个 LOGIN_SUCCESS action（或一个 LOGIN_ERROR action），而这将导致状态不一致</li> <li>cancel Effect 不会粗暴地结束我们的 login 任务，相反它会给予一个机会执行清理的逻辑,在 finally 区块可以处理任何的取消逻辑（以及其他类型的完成逻辑）</li></ul> <h3 id="_13-1-components-login-js"><a href="#_13-1-components-login-js" class="header-anchor">#</a> 13.1 components/Login.js</h3> <p>src/components/Login.js</p> <div class="language-diff extra-class"><pre class="language-diff"><code>class Login extends Component{
<span class="token unchanged">    render() {
        let {token} = this.props;
        let loginForm = (
            &lt;form&gt;
                &lt;label&gt;用户名&lt;/label&gt;&lt;input ref={this.username}/&gt;&lt;br/&gt;
                &lt;label&gt;密码&lt;/label&gt;&lt;input ref={this.password}/&gt;&lt;br/&gt;
                &lt;button onClick={this.login}&gt;登录&lt;/button&gt;
</span><span class="token inserted-sign inserted">+                &lt;button onClick={this.logout}&gt;退出&lt;/button&gt;
</span><span class="token unchanged">            &lt;/form&gt;
        )
  }
</span>}
</code></pre></div><h3 id="_13-2-store-sagas-js"><a href="#_13-2-store-sagas-js" class="header-anchor">#</a> 13.2 store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>call<span class="token punctuation">,</span>all<span class="token punctuation">,</span>put<span class="token punctuation">,</span>take<span class="token punctuation">,</span>fork<span class="token punctuation">,</span>cancel<span class="token punctuation">,</span>cancelled<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">LOGIN_ERROR</span><span class="token punctuation">,</span><span class="token constant">LOGOUT</span><span class="token punctuation">,</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">,</span><span class="token constant">LOGIN_SUCCESS</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Api <span class="token keyword">from</span> <span class="token string">'../Api'</span>

<span class="token comment">//首先我们创建了一个独立的 Generator login，它将执行真实的 API 调用并在成功后通知 Store。</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">//如果 Api 调用成功了，login 将发起一个 LOGIN_SUCCESS action 然后返回获取到的 token。 如果调用导致了错误，将会发起一个 LOGIN_ERROR action。</span>
        Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span><span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>Api<span class="token punctuation">.</span>login<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">LOGIN_SUCCESS</span><span class="token punctuation">,</span> token<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果调用 login 成功，loginFlow 将在 DOM storage 中存储返回的 token，并等待 LOGOUT action   </span>
        Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span><span class="token string">'xx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//在 login 失败的情况下，它将返回一个 undefined 值，这将导致 loginFlow 跳过当前处理进程并等待一个新的 LOGIN_REQUEST action</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token constant">LOGIN_ERROR</span><span class="token punctuation">,</span> error<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span><span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">cancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">yield</span> <span class="token function">cancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// ... put special cancellation handling code here</span>
          Api<span class="token punctuation">.</span><span class="token function">storeItem</span><span class="token punctuation">(</span><span class="token string">'loading'</span><span class="token punctuation">,</span><span class="token string">'false'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">loginFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//一旦到达流程最后一步（LOGOUT），通过等待一个新的 LOGIN_REQUEST action 来启动一个新的迭代</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//loginFlow 首先等待一个 LOGIN_REQUEST action,然后调用一个 call 到 login 任务</span>
        <span class="token comment">//call 不仅可以用来调用返回 Promise 的函数。我们也可以用它来调用其他 Generator 函数</span>
        <span class="token comment">//loginFlow 将等待 login 直到它终止或返回（即执行 api 调用后，发起 action 然后返回 token 至 loginFlow）</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>username<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">LOGIN_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//自从 login 的 action 在后台启动之后，我们获取不到 token 的结果,所以我们需要将 token 存储操作移到 login 任务内部</span>
        <span class="token comment">//yield fork 的返回结果是一个 Task Object</span>
        <span class="token keyword">const</span> task <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">fork</span><span class="token punctuation">(</span>login<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//yield take(['LOGOUT', 'LOGIN_ERROR'])。意思是监听 2 个并发的 action</span>
        <span class="token comment">//如果 login 任务在用户登出之前成功了，它将会发起一个 LOGIN_SUCCESS action 然后结束。 然后 loginFlow Saga 只会等待一个未来的 LOGOUT action 被发起</span>
        <span class="token comment">//如果 login 在用户登出之前失败了，它将会发起一个 LOGIN_ERROR action 然后结束</span>
        <span class="token comment">//如果在 login 结束之前，用户就登出了，那么 loginFlow 将收到一个 LOGOUT action 并且也会等待下一个 LOGIN_REQUEST</span>
        <span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token constant">LOGOUT</span><span class="token punctuation">,</span><span class="token constant">LOGIN_ERROR</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//将task 传入给 cancel Effect。 如果任务仍在运行，它会被中止,如果任务已完成，那什么也不会发生</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token constant">LOGOUT</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">yield</span> <span class="token function">cancel</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Api<span class="token punctuation">.</span><span class="token function">clearItem</span><span class="token punctuation">(</span><span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token function">loginFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_14-race"><a href="#_14-race" class="header-anchor">#</a> 14. race</h2> <ul><li>有时候我们同时启动多个任务，但又不想等待所有任务完成，我们只希望拿到 胜利者：即第一个被 resolve（或 reject）的任务</li> <li>race 的另一个有用的功能是，它会自动取消那些失败的 Effects</li></ul> <h3 id="_14-1-src-index-js"><a href="#_14-1-src-index-js" class="header-anchor">#</a> 14.1 src/index.js</h3> <p>src/index.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Login <span class="token keyword">from</span> <span class="token string">'./components/Login'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Recorder <span class="token keyword">from</span> <span class="token string">'./components/Recorder'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>Provider<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'./store'</span><span class="token punctuation">;</span>
ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">{</span>store<span class="token punctuation">}</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>Recorder<span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">&gt;</span><span class="token punctuation">,</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_14-2-store-action-types-js"><a href="#_14-2-store-action-types-js" class="header-anchor">#</a> 14.2 store/action-types.js</h3> <p>src/store/action-types.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">CANCEL_TASK</span><span class="token operator">=</span><span class="token string">'CANCEL_TASK'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_14-3-store-actions-js"><a href="#_14-3-store-actions-js" class="header-anchor">#</a> 14.3 store/actions.js</h3> <p>src/store/actions.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token operator">:</span>types<span class="token punctuation">.</span><span class="token constant">CANCEL_TASK</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_14-4-store-sagas-js"><a href="#_14-4-store-sagas-js" class="header-anchor">#</a> 14.4 store/sagas.js</h3> <p>src/store/sagas.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>call<span class="token punctuation">,</span>all<span class="token punctuation">,</span>put<span class="token punctuation">,</span>take<span class="token punctuation">,</span>race<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux-saga/effects'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token constant">INCREMENT</span><span class="token punctuation">,</span><span class="token constant">CANCEL_TASK</span><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./action-types'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>delay<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../utils'</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 有时候我们同时启动多个任务，但又不想等待所有任务完成，我们只希望拿到 胜利者：即第一个被 resolve（或 reject）的任务
 * a=1000 b=undefined
 */</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">raceFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">yield</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        a<span class="token operator">:</span> <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        b<span class="token operator">:</span> <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'a='</span><span class="token operator">+</span>a<span class="token punctuation">,</span><span class="token string">'b='</span><span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//每隔一秒钟让数字加1</span>

<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token function">call</span><span class="token punctuation">(</span>delay<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span><span class="token constant">INCREMENT</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//race 的另一个有用的功能是，它会自动取消那些失败的 Effects</span>
<span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">recorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">yield</span> <span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        start<span class="token operator">:</span> <span class="token function">call</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span>
        stop<span class="token operator">:</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token constant">CANCEL_TASK</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token operator">*</span> <span class="token function">rootSaga</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//yield all([raceFlow()])</span>
    <span class="token keyword">yield</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">recorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_14-5-components-counter-js"><a href="#_14-5-components-counter-js" class="header-anchor">#</a> 14.5 components/Counter.js</h3> <p>src/components/Counter.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span><span class="token punctuation">{</span>Component<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>connect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-redux'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> actions <span class="token keyword">from</span> <span class="token string">'../store/actions'</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span><span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>number<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>stop<span class="token punctuation">}</span><span class="token operator">&gt;</span>停止<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
      <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">connect</span><span class="token punctuation">(</span>
    <span class="token parameter">state</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">,</span>
    actions
<span class="token punctuation">)</span><span class="token punctuation">(</span>Counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://gitee.com/zhufengpeixun/zhufeng-saga-start" target="_blank" rel="noopener noreferrer">zhufeng-saga-start<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">4/21/2020, 10:47:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/react/redux/Redux-hooks.html" class="prev">
        Redux-hooks
      </a></span> <span class="next"><a href="/react/redux/Redux-saga-hand.html">
        Redux saga hand
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2af561cb.js" defer></script><script src="/assets/js/2.b2a5c435.js" defer></script><script src="/assets/js/51.37ba1a59.js" defer></script>
  </body>
</html>
